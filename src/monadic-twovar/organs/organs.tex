% Organs

Let $\US = \seq{\suu1,\suu2,\dots,\suu\szu}$ be a monadic predicate signature.
Let $\ES = \seq{\see1,\see2,\dots,\see\sze}$ be a predicate signature consisting
of builtin equivalence symbols in refinement, where $\sze \geq 2$.
Let $\SigS = \US + \ES$.
Abbreviate the finest two equivalence symbols as $\sd = \see1$ and $\se =
\see2$.

\begin{definition}
Let $\StrA$ be a $\SigS$-structure and let $\relD = \at\StrA\sd$ and
$\relE = \at\StrA\se$.
Recall that the set of $\relD$-classes is $\Ecl\relD$.
Two $D$-classes $\eclX, \eclY \in \Ecl\relD$ are \emph{organ-equivalent},
if $X \times Y \subseteq E$ and the induced substructures 
$(\StrA \restriction \eclX)$ and $(\StrA \restriction \eclY)$ are isomorphic.
The organ-equivalence relation is
$\gls{organ-equivalence} \subseteq \domXX{\Ecl\relD}$.
Since $\relD$ refines $\relE$, the organ-equivalence is an equivalence relation
on $\Ecl\relD$.
An \emph{organ} is an organ-equivalence-class. That is, an organ
is a maximal set of isomorphic $\relD$-classes, included in the same
$\relE$-class.
For any two organ-equivalent $\relD$-classes $(\eclX, \eclY) \in \Org$,
fix an isomorphism
$\isoh\eclX\eclY : (\StrA \restriction \eclX) \to (\StrA \restriction \eclY)$
consistently, so that $\isoh\eclX\eclX = \id\eclX$,
$\isoh\eclY\eclX = \inv{\isoh\eclX\eclY}$
and if $(\eclY, \eclZ) \in \Org$ then
$\isoh\eclX\eclZ = \isoh\eclY\eclZ \comp \isoh\eclX\eclY$.
Two elements $\ea, \eb \in \domA$ are \emph{sub-organ-equivalent}
if $(\relD[\ea], \relD[\eb]) \in \Org$ and
$\isoh{\relD[\ea]}{\relD[\eb]}(\ea) = \eb$.
Since the isomorphisms $\isoh\eclX\eclY$ are chosen consistently, the
sub-organ-equivalence relation
$\gls{sub-organ-equivalence} \subseteq \domAA$ is an equivalence relation on
$\domA$ that refines $\relE$.
\end{definition}

\begin{remark}\label{rem:twovar-same-organ-tp2}
If $\StrA$ is a $\SigS$-structure and $\ea, \eb, \eap, \ebp \in \domA$ be such
that $\ea$ and $\eb$ are sub-organ-equivalent, $\eap$ and $\ebp$ are
sub-organ-equivalent and $\relD[\ea]$ and $\relD[\eap]$ are not
organ-equivalent, then $\tpIab\StrA\ea\eap = \tpIab\StrA\eb\ebp$.
\end{remark}
\begin{proof}
Since $\ea$ and $\eb$ are sub-organ-equivalent, we have
$\isoh{\relD[\ea]}{\relD[\eb]}(\ea) = \eb$,
hence $\tpIa\StrA\ea = \tpIa\StrA\eb$.
Similarly, $\tpIa\StrA\eap = \tpIa\StrA\ebp$.
Since $\relD[\ea]$ and $\relD[\eap]$ are not organ-equivalent,
in particular $\relD[\ea] \neq \relD[\eap]$,
so $\StrA \vDash \lnot \sd(\ea,\eap)$.
Since $\relD[\eb]$ is organ-equivalent to $\relD[\ea]$, $\relD[\ebp]$ is
organ-equivalent to $\relD[\eap]$ and organ-equivalence is equivalence relation,
we have $\StrA \vDash \lnot \sd(\eb, \ebp)$.
Since the sub-organ-equivalence $\sOrg$ is an equivalence relation on $\domA$
that refines $\relE$ and the equivalence symbols $\see\jj$ are in refinement,
$\StrA \vDash \see\jj(\ea, \eap)$  iff $\StrA \vDash \see\jj(\eb, \ebp)$ for all 
$\jj \in [2,\sze]$.
\end{proof}

\begin{lemma}\label{lem:twovar-organ-2}
Let $\StrA$ be a $\SigS$-structure. There is some $\StrB \subseteq \StrA$ such
that $\StrA \vequiv2 \StrB$ and every $\StrB$-organ has cardinality at most
$2$.
\end{lemma}
\begin{proof}
Let $\relD = \at\StrA\sd$, $\relE = \at\StrA\se$ and 
let $\EclA = \Ecl\relD$ be the set of $\relD$-classes.
Let $\Org \subseteq \domXX\EclA$ be the
$\StrA$-organ-equivalence relation on $\EclA$.
Execute the following process: for every $\StrA$-organ, if it has cardinality
$1$, select the $\relD$-class from that organ; otherwise select two distinct
$\relD$-classes from that organ (note that these will be isomorphic).
Let $\EclB \subseteq \EclA$ be the set of selected $\relD$-classes.
Let $\domB = \cup \EclB \subseteq \domA$ be the set of elements in the
selected classes and let $\StrB = (\StrA \restriction \domB)$.
By construction, every $\StrB$-organ has cardinality at most $2$.
We claim that $\StrA \vequiv2 \StrB$.
Let $\selH = \Org \cap \EclA\cprod\EclB$ relates the $\relD$-classes with the
$\relD$-classes from $\EclB$ in the same organ.
Let $\selh = \cup \setbd{\isoh{\eclX}{\eclY}}{(\eclX,\eclY) \in \selH}$, so
$\selh$ relates the elements of $\domA$ with their isomorphic elements from
$\domB$.
Note that for all $\relD$-classes $\relD[\ea] \in \EclA$:
\begin{equation}\label{eq:twovar-organ-2}
  \mifff{
  \card{\Org[\relD[\ea]]} \geq 2}{
  \card{\selH[\relD[\ea]]} = 2}{
  \card{\selh[\ea]} = 2}.
\end{equation}
Recall that a $2$-partial isomorphism $\pisop$ from $\StrA$ to $\StrB$ is an
object $\many\ea \mapsto \many\eb$, where
$\many\ea = \eaa1\eaa2 \in (\domA \cup \set{\bot})^2$,
$\many\eb  = \ebb1\ebb2 \in (\domB \cup \set{\bot})^2$,
$\supp\many\ea = \supp\many\eb$
and we think of $\pisop$ as a relation between $\domA$ and $\domB$.
Consider the set $\pisoI$ of $2$-partial isomorphisms from
$\StrA$ to $\StrB$ that are included in $\selh$.
This set is nonempty, since $\seq{\bot,\bot}\mapsto\seq{\bot,\bot} \in \pisoI$.

Let $\nr \in \pNats$.
We claim that the sequence $\pisoII0 = \pisoII0 = \dots = \pisoII\nr = \pisoI$
satisfies the back-and-forth conditions of \Cref{thm:game-2}.
Let $\ii \in [1,2]$ and $\many\ea \mapsto \many\eb \in \pisoI$.
Without loss of generality, suppose $i = 1$.
Let $\many\ea = \eaa1\eaa2$ and $\many\eb = \ebb1\ebb2$.
\begin{enumerate}
  \item For the forth condition, let $\ea \in \domA$.
  We have to find some $\eb \in \domB$ such that
  $\vectsub{\many\ea}\ii\ea \mapsto \vectsub{\many\ea}\ii\eb \in \pisoI$.
  If $\eaa2 = \bot$ then $\ebb2 = \bot$ and $\eb = \ea$ works.
  Suppose $\eaa2 \in \domA$. Then $(\eaa2,\ebb2) \in \selh$, so
  $\relD[\eaa2]$ and $\relD[\ebb2]$ are in the same $\StrA$-organ
  $\Org[\relD[\eaa2]]$.
  Let $\sizes = \card{\Org[\relD[\eaa2]]}$ be the cardinality of that organ.
 
  If $\ea = \eaa2$ then $\eb = \ebb2$ works.
 
  If $\ea \neq \eaa2$ and $\relD[\ea] \in \Org[\relD[\eaa2]]$, then
  $\sizes \geq 2$.
  By \cref{eq:twovar-organ-2} there is $\eb \in \selh[\eaa2]$ such that
  $\eb \neq \ebb2$. This $\eb$ works.

  If $\relD[\ea] \not\in \Org[\relD[\eaa2]]$, let $\eb \in \selh[\ea]$ be any.
  Then $\relD[\ebb2] \in \Org[\relD[\eaa2]]$, $\relD[\eb] \in \Org[\relD[\ea]]$,
  $\Org[\relD[\eaa2]] \neq \Org[\relD[\ea]]$ and by
  \Cref{rem:twovar-same-organ-tp2}, this $\eb$ works.
  
  \item For the back condition, let $\eb \in \domB$.
  We have to find some $\ea \in \domA$ such that
  $\vectsub{\many\ea}\ii\ea \mapsto \vectsub{\many\eb}\ii\eb \in \pisoI$.
  If $\ebb2 = \bot$ then $\eaa2 = \bot$ and $\ea = \eb$ works.
  Suppose $\ebb2 \in \domB$. Then $\relD[\eaa2]$ and $\relD[\ebb2]$ are in the
  same $\StrA$-organ $\Org[\relD[\ebb2]]$.
  Let $\sizes = \card{\Org[\relD[\ebb2]]}$ be the cardinality of that organ.
  
  If $\eb = \ebb2$ then $\ea = \eaa2$ works.
  
  If $\eb \neq \ebb2$ and $\relD[\eb] \in \Org[\relD[\ebb2]]$, then
  $\sizes \geq 2$.
  Thus there is $\ea \in \domA$ such that $\eb \in \selh[\ea]$ and
  $\ea \neq \eaa2$.
  This $\ea$ works.
  
  If $\relD[\eb] \not\in \Org[\relD[\ebb2]]$, then $\eaa2 \neq \eb$.
  By \Cref{rem:twovar-same-organ-tp2}, $\ea = \eb$ works.
\end{enumerate}
By \Cref{thm:game-2}, $\StrA \rvequiv\nr2 \StrB$.
Since $\nr \in \pNats$ was arbitrary, $\StrA \vequiv2 \StrB$.
\end{proof}