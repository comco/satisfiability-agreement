% Local to refine

In this section we demonstrate how (finite) satisfiability in logics featuring
built-in equivalence symbols in local agreement reduces to (finite)
satisfiability in logics featuring built-in equivalence symbols in refinement.
Our strategy is to start with the level equivalences which form a refinement,
and to encode a permutation specifying the local chain structure for every
element in the structure.

Let $\SigS$ be a predicate signature for the logics $\Fo\Eea\sze\aglocal$ and
$\Fo\Eea\sze\agrefine$. The $\sze$ built-in equivalence symbols of $\SigS$ are
$\see1, \see2, \dots, \see\sze$.

Let $\fphi$ be a $\SigS$-sentence.
The class of $\Fo\Eea\sze\agrefine$-structures satisfying $\fphi$ coincides with
the class of $\Fo\Eea\sze\aglocal$-structures satisfying
\[
  \fphi \land \frefine{\see1,\see2,\dots,\see\sze}.
\] 
Hence:
\[
  \FinASat{\Fo\Eea\sze\agrefine} \red\cP
  \FinASat{\Fo\Eea\sze\aglocal}.
\]
Since $\frefine{\see1,\see2,\dots,\see\sze}$ is constructible in deterministic
polynomial time from the sequence of equivalence symbols, we have:
\[
  \FinASat{\Fo\Eea\nosze\agrefine} \red\cP
  \FinASat{\Fo\Eea\nosze\aglocal}.
\]

Consider the opposite direction.
Let $\ES = \seq{\see1,\see2,\dots,\see\sze}$ be a predicate signature consisting
of the binary predicate symbols $\see\ii$ (later, we will need these to be
not necessarily interpreted as equivalences, but for now we will interpret
them as such).
Let $\StrA$ be an $\ES$-structure and suppose that the symbols $\see\ii$ are
interpreted in $\StrA$ as equivalence relations on $\domA$ in local agreement.
Let $\relEE\ii = \at\StrA{\see\ii}$ for $\ii \in [1,\sze]$.
Recall that for every $\ea \in \domA$ there is a permutation
$\permnu \in \Perms\sze$ satisfying \cref{eq:local-perm}:
\begin{equation}\label{eq:local-perm-1}
  \relEE{\permnu(1)}[\ea] \subseteq
  \relEE{\permnu(2)}[\ea] \subseteq \dots \subseteq
  \relEE{\permnu(\sze)}[\ea].
\end{equation}
\begin{definition}
The \emph{characteristic $\ES$-permutation} of $\ea$ in $\StrA$ is
the antilexicographically smallest permutation $\permnu \in \Perms\sze$
satisfying \cref{eq:local-perm-1}.
Define the function $\gls{chperm-E-A} : \domA \to \Perms\sze$ so
that $\chperm\ES\StrA\ea$ is the characteristic $\ES$-permutation of $\ea$ in
$\StrA$.
\end{definition}
\begin{remark}\label{rem:local-eq-perm}
Let $\ea \in \domA$, $\permnu = \chperm\ES\StrA\ea$ and
$\ii < \jj \in [1,\sze]$.
Suppose that $\relEE{\permnu(\ii)}[\ea] = \relEE{\permnu(\jj)}[\ea]$.
Then $\permnu(\ii) < \permnu(\jj)$.
\end{remark}
\begin{proof}
Suppose not. For some $\ii < \jj \in [1,\sze]$ we have
$\permnu(\ii) \geq \permnu(\jj)$.
Since $\permnu$ is a permutation and $\ii \neq \jj$,
we have $\permnu(\ii) > \permnu(\jj)$.
Since $\relEE{\permnu(\ii)}[\ea] = \relEE{\permnu(\jj)}[\ea]$,
by \cref{eq:local-perm-1} we have $\relEE{\permnu(\kk)} = \relEE{\permnu(\ii)}$
for all $\kk \in [\ii, \jj]$.
Consider the permutation $\permmu \in \Perms\sze$ defined by:
\[
  \permmu(\kk) = \begin{cases}
    \permnu(\jj) &\text{if } \kk = \ii \\
    \permnu(\ii) &\text{if } \kk = \jj \\
    \permnu(\kk) &\text{otherwise.}
  \end{cases}
\]
Clearly, $\permmu$ is a permutation satisfying \cref{eq:local-perm-1} that is
antilexicographically smaller than $\permnu$ --- a contradiction.
\end{proof}

\begin{remark}\label{rem:local-inv-perm}
Let $\ea, \eb \in \domA$ and let
$\perma = \chperm\ES\StrA\ea$ and $\permb = \chperm\ES\StrA\eb$.
Let $\ii \in [1,\sze]$ and suppose that $(\ea, \eb) \in \relEE\ii$.
Then $\inv\perma(\ii) = \inv\permb(\ii)$.
\end{remark}
\begin{proof}
Suppose not, so $\inv\perma(\ii) \neq \inv\permb(\ii)$.
Let $\posp = \inv\perma(\ii)$ and $\posq = \inv\permb(\ii)$.
Without loss of generality, suppose that $\posp < \posq$.
Thus $\posp$ is the position of $\ii$ in the permutation $\perma$ and 
$\posq > \posp$ is the position of $\ii$ in the permutation $\permb$. 
By the pigeonhole principle, there is $\kk \in [1,\sze]$ that occurs after $\ii$
in $\perma$ and before $\jj$ in $\permb$:
$\posp < \inv\perma(\kk)$ and $\inv\permb(\kk) < \posq$.
Since $\permb$ is the characteristic $\ES$-permutation of $b$ in $\StrA$, by
\cref{eq:local-perm-1} we have $\relEE\kk[\eb] \subseteq \relEE\ii[\eb]$.
Since $(\ea, \eb) \in \relEE\ii$, we have $\relEE\kk[\eb] \subseteq
\relEE\ii[\ea]$.
Since $\relEE\kk[\eb] \subseteq \relEE\ii[\ea]$ are equivalence classes,
$\relEE\kk[\ea] \subseteq \relEE\ii[\ea]$.
Since $\kk$ occurs after $\ii$ in $\perma$, which is the characteristic
$\ES$-permutation of $\ea$ in $\StrA$, 
by \cref{eq:local-perm-1} we have $\relEE\kk[\ea] = \relEE\ii[\ea]$.
By \Cref{rem:local-eq-perm}, $\ii < \kk$.
By the contrapositive of \Cref{rem:local-eq-perm},
$\relEE\kk[\eb] = \relEE\ii[\eb]$ is impossible.
Since $\kk$ occurs before $\ii$ in $\permb$, 
by \cref{eq:local-perm-1} we have $\relEE\kk[\eb] \subset \relEE\ii[\eb]$.
Hence
\[
  \relEE\kk[\eb] \subset \relEE\ii[\eb] = \relEE\ii[\ea] = \relEE\kk[\ea]
\]
--- a contradiction --- since the equivalence classes $\relEE\kk[\eb]$ and
$\relEE\kk[\ea]$ are either equal or disjoint.
\end{proof}

Let
$\seqL = \seq{\relLL1,\relLL2,\dots,\relLL\sze}$ be the levels of
$\seqE = \seq{\relEE1, \relEE2, \dots, \relEE\sze}$.
Recall that by \Cref{lem:local-lvl-refine}, the levels are equivalence relations
on $\domA$ in refinement.

\begin{remark}\label{rem:local-lvl-perm}
Let $\ea \in \domA$, $\perma = \chperm\ES\StrA\ea$ and let $\kk \in [1,\sze]$.
Then $\relLL\kk[\ea] = \relEE{\perma(\kk)}[\ea]$.
\end{remark}
\begin{proof}
Since $\perma$ satisfies \cref{eq:local-perm-1}, by \Cref{lem:local-lvl-perm}:
\[
  \relLL\kk[\ea] = 
  \relLL{\inv\perma(\perma(\kk))}[\ea] =
  \relEE{\perma(\kk)}[\ea].
\]
\end{proof}

\begin{remark}\label{rem:local-lvl-agree}
Let $\ea, \eb \in \domA$, $\perma = \chperm\ES\StrA\ea$,
$\permb = \chperm\ES\StrA\eb$ and $\kk \in [1,\sze]$.
Suppose that $(\ea, \eb) \in \relLL\kk$.
Then $\perma(\kk) = \permb(\kk)$.
That is, the elements connected at level $\kk$ agree at position $\kk$ in their
characteristic permutations.
\end{remark}
\begin{proof}
By \Cref{rem:local-lvl-perm}, $\relLL\kk[\ea] = \relEE{\perma(\kk)}[\ea]$, thus
$(\ea, \eb) \in \relEE{\perma(\kk)}$. 
By \Cref{rem:local-eq-perm},
\[
  \kk = \inv\perma(\perma(\kk)) = \inv\permb(\perma(\kk)).
\]
Hence $\permb(\kk) = \perma(\kk)$.
\end{proof}

Let $\PS = \seq{\suu{11}, \suu{12}, \dots, \suu{\sze\tbit}}$ be an
$\sze$-permutation setup.
Let $\LS = \seq{\slee1, \slee2, \dots, \slee\sze} + \PS$ be a predicate
signature containing the binary predicate symbols $\slee\kk$ (not necessarily
interpreted as equivalence relations) together with the symbols from $\PS$.
\begin{definition}
Define the $\vFoF2\LS$-sentence $\gls{ffixperm-L}$ by:
\[
  \ffixperm\LS = \forall\xx \forall\yy \bigwedge_{1 \leq \kk \leq \sze}
  \left(\slee\kk(\xx,\yy) \limp \feq{\PSp{\kk}}(\xx,\yy)\right).
\]
Note that $\ffixperm\LS$ is constructible in deterministic polynomial time from
$\LS$.
\end{definition}
\begin{definition}
Define the $\vFoF2\LS$-sentence $\gls{flocperm-L}$ by:
\[
  \flocperm\LS = \fperm\PS \land \ffixperm\LS.
\]
Note that $\flocperm\LS$ is constructible in deterministic polynomial time from
$\LS$.
\end{definition}
\begin{remark}\label{rem:local-perm-val-fixed}
Let $\StrA$ be an $\LS$-structure and suppose that $\StrA \vDash \flocperm\LS$.
Let $\ea, \eb \in \domA$, $\kk \in [1,\sze]$ and suppose that
$\StrA \vDash \slee\kk(\ea, \eb)$.
Let $\perma = \data\PS\StrA\ea$ and $\permb = \data\PS\StrA\eb$ be the
$\sze$-permutations at $\ea$ and $\eb$,
\emph{encoded by the permutation setup $\PS$}.
Then $\perma(\kk) = \permb(\kk)$.
\end{remark}
\begin{proof}
Since $\StrA \vDash \ffixperm\LS$ and $\StrA \vDash \slee\kk(\ea,\eb)$, we have
$\StrA \vDash \feq{\PS(\kk)}(\ea,\eb)$, which means $\perma(\kk) =
\permb(\kk)$.
\end{proof}

\begin{definition}
For $\ii \in [1,\sze]$, define the quantifier-free $\vFoF2\LS$-formula
$\gls{fel-L-i}$ by:
\[
  \fel\LS\ii(\xx,\yy) = \bigwedge_{1 \leq \kk \leq \sze}
  \left(\feqA{\PS(\kk)}\ii(\xx) \limp \slee\kk(\xx,\yy)\right).
\]
Note that $\fel\LS\ii(\xx,\yy)$ is constructible in deterministic polynomial
time from $\LS$ and $\ii$.
\end{definition}

\begin{remark}\label{rem:local-e-m}
Let $\StrA$ be an $\LS$-structure and suppose that $\StrA \vDash \flocperm\LS$
and that the binary symbols $\slee\kk$ are interpreted in $\StrA$ as equivalence
relations on $\domA$ in refinement.
Define $\permnu : \domA \to \Perms\sze$ by $\permnu(\ea) = \data\PS\StrA\ea$
for $\ea \in \domA$.
Let $\ea \in \domA$ be arbitrary.
Then for all $\ii \in [1,\sze]$:
\[
  \at\StrA{\fel\LS\ii}[\ea] = \at\StrA{\slee{\inv{\permnu(\ea)}(\ii)}}[\ea].
\]
\end{remark}
\begin{proof}
Let $\relEE\ii = \at\StrA{\fel\LS\ii}$ and $\relLL\ii = \at\StrA{\slee\ii}$
for every $\ii \in [1,\sze]$.
Let $\ii \in [1,\sze]$ be arbitrary. 
Let $\perma = \permnu(\ea)$ and $\kk = \inv\perma(\ii)$,
so $\perma = \data\PS\StrA\ea$ and $\perma(\kk) = \ii$.
We have to show that $\relEE\ii[\ea] = \relLL\kk[\ea]$.
Since $\perma$ is a permutation, for every $\kkp \in [1,\sze]$ we have:
\begin{equation}\label{eq:local-e-equiv}
  \mifff{
  \StrA \vDash \feqA{\PS(\kkp)}\ii(\ea)}{
  \perma(\kkp) = \ii}{ 
  \kkp = \kk}.
\end{equation}
First, suppose $\eb \in \relEE\ii[\ea]$.
Then $\StrA \vDash \fel\LS\ii(\ea,\eb)$ and by \cref{eq:local-e-equiv} we have
$\StrA \vDash \slee\kk(\ea,\eb)$, hence $\eb \in \relLL\kk[\ea]$.

Next, suppose $\eb \not\in \relEE\ii[\ea]$.
Then $\StrA \vDash \lnot\fel\LS\ii(\ea,\eb)$, so there is some
$\kkp \in [1,\sze]$ such that 
$\StrA \vDash \lnot(\feqA{\PS(\kkp)}\ii(\ea) \limp \slee\kkp(\ea,\eb)) 
\equiv \feqA{\PS(\kkp)}\ii(\ea) \land \lnot\slee\kkp(\ea,\eb)$.
By \cref{eq:local-e-equiv} we have $\kkp = \kk$.
Hence $\StrA \vDash \lnot \slee\kk(\ea,\eb)$, so $\eb \not\in \relLL\kk[\ea]$.
\end{proof}

\begin{remark}\label{rem:local-e-local}
Let $\StrA$ and $\permnu$ are declared as in \Cref{rem:local-e-m}.
Then the sequence of interpretations
$\seqsm{\at\StrA{\fel\LS1},\at\StrA{\fel\LS2},\dots,\at\StrA{\fel\LS\sze}}$ is a
sequence of equivalence relations on $\domA$ in local agreement.
\end{remark}
\begin{proof}
Let $\relEE\ii = \at\StrA{\fel\LS\ii}$ and $\relLL\ii = \at\StrA{\slee\ii}$ for
every $\ii \in [1,\sze]$.
Let $\ii \in [1,\sze]$ be arbitrary.
We check that $\relEE\ii$ is reflexive, symmetric and transitive.
\begin{itemize}
  \item For reflexivity, let $\ea \in \domA$.
  By \Cref{rem:local-e-m},
  $\relEE\ii[\ea] = \relLL\kk[\ea]$ for $\kk = \inv{\permnu(\ea)}(\ii)$. 
  But $\relLL\kk[\ea]$ is an equivalence class, hence $\ea \in \relLL\kk[\ea]$,
  so $(\ea,\ea) \in \relEE\ii$.

  \item For symmetry, let $\ea, \eb \in \domA$ and $(\ea,\eb) \in \relEE\ii$.
  Let $\kk = \inv{\permnu(\ea)}(\ii)$ so that $\ii = \permnu(\kk)$.
  By \Cref{rem:local-e-m}, $\relEE\ii[\ea] = \relLL\kk[\ea]$.
  Thus $\StrA \vDash \slee\kk(\ea,\eb)$ and by
  \Cref{rem:local-perm-val-fixed}, $\ii = \permnu(\ea)(\kk) =
  \permnu(\eb)(\kk)$.
  By \Cref{rem:local-e-m}:
  \[
    \relEE\ii[\eb] =
    \at\StrA{\fel\LS\ii}[\eb] =
    \at\StrA{\slee{\inv{\permnu(\eb)}(\ii)}}[\eb] =
    \relLL\kk[\eb] = \relLL\kk[\ea].
  \]
  Since $\ea \in \relLL\kk[\ea] = \relEE\ii[\eb]$, we have $(\eb,\ea) \in
  \relEE\ii$.
   
  \item For transitivity, continue the argument for symmetry.
  Let $\ec \in \relEE\ii[\eb]$.
  Then $\ec \in \relEE\ii[\eb] = \relLL\kk[\ea] = \relEE\ii[\ea]$,
  thus $(\ea,\ec) \in \relEE\ii$.
\end{itemize}
By \Cref{rem:local-e-m}, since the relations $\relLL\kk$ are in refinement, we
have that $\relEE1, \relEE2, \dots, \relEE\sze$ are in local agreement.
\end{proof}

Let $\ES = \seq{\see1,\see2,\dots,\see\sze}$ be a predicate signature consisting
of binary predicate symbols.
Let $\SigS$ be a predicate signature enriching $\ES$
and not containing any symbols from $\LS$. 
Let $\SigSp = \SigS + \LS$ and $\LSp = \SigSp - \ES$.

\begin{definition}
Define the syntactic operation $\gls{ltr} : \FoF\SigS \to \FoF\LSp$ by:
\[
  \ltr\fphi = \fphip \land \flocperm\LS,
\]
where $\fphip$ is obtained from $\fphi$ by replacing all occurrences of a
subformula of the form $\see\ii(\gx,\gy)$ by the formula $\fel\LS\ii(\gx,\gy)$, 
where $\gx$ and $\gy$ are (not necessarily distinct) variable symbols and
$\ii \in [1,\sze]$.
Note that this translation can be performed in deterministic polynomial time.
\end{definition}
\begin{remark}
Let $\fphi$ be a $\SigS$-formula and let $\StrA$ be a $\SigS$-structure.
Suppose that $\StrA \vDash \fphi$ and that the symbols 
$\see1, \see2, \dots, \see\sze$ are interpreted in $\StrA$ as equivalence
relations on $\domA$ in local agreement.
Then there is a $\SigSp$-enrichment $\StrAp$ of $\StrA$ such that
$\StrAp \vDash \ltr\fphi$ and that the symbols 
$\slee1, \slee2, \dots, \slee\sze$ are interpreted in $\StrAp$ as equivalence
relations on $\domA$ in refinement.
\end{remark}
\begin{proof}
Since the binary symbols $\see1, \see2, \dots, \see\sze$ are interpreted as
equivalence relations on $\domA$ in local agreement in $\StrA$, we may define
the levels $\relLL1, \relLL2, \dots, \relLL\sze \subseteq \domAA$
and the characteristic $\ES$-permutation mapping 
$\permnu = \chperm\ES\StrA : \domA \to \Perms\sze$.
Consider an enrichment $\StrAp$ of $\StrA$ where 
$\at\StrAp{\slee\ii} = \relLL\ii$.
By \Cref{lem:local-lvl-refine}, $\relLL\ii$ are equivalences on $\domA$ in
refinement.
We interpret the unary symbols from the
permutation setup $\PS$ so that $\data\PS\StrAp\ea = \permnu(\ea)$ for all
$\ea \in \domA$.
By \Cref{rem:local-lvl-agree}, $\StrAp \vDash \ffixperm\LS$.
By \Cref{rem:local-e-m}, followed by \Cref{lem:local-lvl-perm},
for every $\ii \in [1,\sze]$ and $\ea \in \domA$ we have:
\[
  \at\StrAp{\fel\LS\ii}[\ea] =
  \at\StrAp{\slee{\inv{\permnu(\ea)}(\ii)}}[\ea] =
  \at\StrAp{\see{\permnu(\ea)(\inv{\permnu(\ea)}(\ii))}}[\ea] =
  \at\StrAp{\see\ii}[\ea].
\]
By \Cref{rem:local-e-local}, the interpretations $\at\StrAp{\fel\LS\ii}$ are
equivalence relations. Since the interpretation of the formula
$\fel\LS\ii$ has the same classes as the interpretation of the symbol $\see\ii$,
we have $\StrAp \vDash \forall\xx \forall\yy
\left(\see\ii(\xx,\yy) \lequ \fel\LS\ii(\xx,\yy)\right)$.
Since $\StrAp \vDash \fphi$ we have $\StrAp \vDash \ltr\fphi$.
\end{proof}

\begin{remark}
Let $\fphi$ be a $\SigS$-formula and let $\StrA$ be an $\LSp$-structure.
Suppose that $\StrA \vDash \ltr\fphi$ and that the symbols
$\slee1, \slee2, \dots, \slee\sze$ are interpreted as equivalence relations on
$\domA$ in refinement in $\StrA$.
Then there is a $\SigSp$-enrichment $\StrAp$ of $\StrA$ such that
$\StrAp \vDash \fphi$ and that the binary symbols
$\see1, \see2, \dots, \see\sze$
are interpreted as equivalence relations on $\domA$ in global agreement in
$\StrAp$.
\end{remark}
\begin{proof}
Consider an enrichment $\StrAp$ of $\StrA$ to a $\SigSp$-structure where
$\at\StrAp{\see\ii} = \at\StrA{\fel\LS\ii}$.
By \Cref{rem:local-e-local}, $\at\StrAp{\see\ii}$ are equivalence
relations on $\domA$ in local agreement. 
For every $\ii \in [1,\sze]$ we have
$\StrAp \vDash \forall\xx\forall\yy \left(\see\ii(\xx,\yy) \lequ
\fel\LS\ii(\xx,\yy)\right)$ by definition.
Since $\StrAp \vDash \ltr\fphi$ we have $\StrAp \vDash \fphi$.
\end{proof}

The last two remarks show that a $\Fo\Eea\sze\aglocal$-formula $\fphi$
has essentially the same models as the $\Fo\Eea\sze\agrefine$-formula
$\ltr\fphi$, so we have shown:

\begin{proposition}\label{prop:local-to-refine-n}
The logic $\Fo\Eea\sze\aglocal$ has the finite model property iff
the logic $\Fo\Eea\sze\agrefine$ has the finite model property.
The corresponding satisfiability problems are polynomial-time equivalent:
$\FinASat{\Fo\Eea\sze\aglocal} \redeq\cP \FinASat{\Fo\Eea\sze\agrefine}$.
\end{proposition}

Since the translation $\ltr$ can be performed in deterministic polynomial
time, we have:
\begin{proposition}\label{prop:local-to-refine}
The logic $\Fo\Eea\nosze\aglocal$ has the finite model property iff
the logic $\Fo\Eea\nosze\agrefine$ has the finite model property.
The corresponding satisfiability problems are polynomial-time equivalent:
$\FinASat{\Fo\Eea\nosze\aglocal} \redeq\cP \FinASat{\Fo\Eea\nosze\agrefine}$.
\end{proposition}

The reduction is two-variable first-order and uses additional $(\sze\tbit)$
unary predicate symbols for the permutation setup $\PS$, so it is also valid
for the two-variable fragments $\Lvp\Fo20\Eea\sze\ag$, $\Lvp\Fo21\Eea\sze\ag$
and $\Lvp\Fo21\Eea\nosze\ag$ for $\ag \in \set{\aglocal, \agrefine}$.
