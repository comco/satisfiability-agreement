% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featuring $\sze \geq 1$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement.By convention let $\see0$ be the formal equality, so that$\Lvp\Fo2\nopow\Eea0\agrefine$ means $\vFo2$.Abbreviate the coarsest equivalence symbol $\se = \see\sze$.The following reductions carry over from the previous section:\begin{align*}  \FinASat{\vFo2\Eea\sze\agrefine} &\red\cNP \FinAClSat{\vFo2\Eea\sze\agrefine}  \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNExpTime  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.\end{align*}We proceed to define new terms.The terminology is based on~\cite{MALQ:MALQ201400102}.Let $\ClSig\SigS\sms$ be a predicate signature.A \twotype/ $\tpt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in \tpt$.Otherwise, that is if $(\lnot\se(\xx,\yy)) \in \tpTt$, the \twotype/ is a\emph{cosmic type}.Let $\TI$ be a type instance over $\ClSig\SigS\sms$.The sets of galactic and cosmic types in $\TI$ are $\TIg$ and $\TIc$,respectively.Two \onetypes/ $\tpp, \tppp \in \TP\TI$ are \emph{cosmically connectable} ifsome cosmic $\tpt \in \TIc$ connects them.A \onetype/ $\tpn \in \TP\TI$ is a \emph{noble type} if it is not cosmicallyconnectable with itself; the set of noble types is $\TN\TI$.A \onetype/ that is not noble is a \emph{peasant type} and the set of peasanttypes is $\TPs\TI$.Any king type is a noble type.We think of the $\se$-classes in a structure as \emph{galaxies}; of the wholestructure as the \emph{cosmos}; of the galactic \twotypes/ as characterizing theinteractions in the interior of the galaxies,  while cosmic \twotypes/characterize the interactions between different galaxies.Let $\StrA$ be a model for $\TI$. An element $\ea \in \domA$ is \emph{noble} if it realizes a noble type;otherwise $\ea$ is \emph{peasant}.Then $\TN\TI$ is the set of \onetypes/ realized in a unique galaxy of $\StrA$and $\TPs\TI$ is the set of \onetypes/ realized in at least $2$ galaxies of$\StrA$.\begin{definition}The model $\StrA$ for $\TI$ is \emph{peasantly united} if whenever $\tpp \in \TP\TI$ is a peasant type that is realized insome peasant galaxy $\galX \in \GalsP$, then $\tpp$ is also realized in some other peasant galaxy $\galY \in \GalsP \sub \set\eclX$.\end{definition}\begin{lemma}[Peasant unitedness]\label{lem:peasant-unitedness}If the type instance $\TI$ has a (finite) model, then it has a (finite)peasantly united model.\end{lemma}\begin{proof}Suppose that $\StrA$ is a (finite) model for $\TI$.We copy its peasant galaxies.We describe the (finite) model $\StrAp$ by describing its galaxies $\Galsp$.The noble galaxies $\GalsNp$ of $\StrAp$ coincide with the noble galaxies$\GalsN$ of $\StrA$.The peasant galaxies $\GalsPp$ of $\StrAp$ consist of two copies $\galXX1,\galXX2$ of each peasant galaxy $\galX \in \GalsP$ of $\StrA$.This naturally induces the \onetype/ of every $\ea \in \domAp$ and the\twotype/ between distinct elements that do not come from the twocopies of the same peasant galaxy.Already at this point, the partial structure $\StrAp$ already satisfiesthe existential parts~\cref{eq:twovar-ms-iinter}, so it is a \emph{partial}$\ClSig\SigS\sms$-structure.We proceed to complete $\StrAp$.Let $\galX \in \GalsP$ be a peasant $\StrA$-galaxy and let$\eaa1 \in \galXX1$ and $\ebb2 \in \galXX2$ be any elements from the differentcopies of $\galX$ in $\StrAp$.Note that $\ea, \eb \in \galX$ and let $\tpp = \tpIa\StrAp\ea = \tpIa\StrA\ea$.Since $\galX$ is a peasant galaxy, we have that $\tpp$ is a peasant type.Hence $\tpp$ is realized in at least $2$ $\StrA$-galaxies. Let $\eap \in \domA\sub \galX$ realizes $\tpp$. Then $\tpIab\StrAp{\eaa1}{\ebb2} =\tpIab\StrA\eap\eb$ is appropriate.The model $\StrAp$ is peasantly united by construction: any peasant type that isrealized in a peasant galaxy $\galXX\ii$ is also realized in $\galXX{3-\ii}$.\end{proof}\begin{definition}The model $\StrA$ for $\TI$ is \emph{nobly distinguished} if every noble galaxycontains only noble elements.That is, if $\relE = \at\StrA\se$ and $\ea \in \domA$ has $\tpIa\StrA\ea \in \TN\TI$,then $\tpIa\StrA\eb \in \TN\TI$ for every $\eb \in \relE[\ea]$.\end{definition}\begin{definition}The (finite) nobly distinguished type realizability problem for the fragment$\vFo2\Eea\sze\agrefine$ is: given a classified signature$\ClSig\SigS\sms$ and a type instance $\TI$ over $\ClSig\SigS\sms$,is there a (finite) nobly distinguished model for $\TI$.Denote the nobly distinguished type realizability problem by$\NDReal{\vFo2\Eea\sze\agrefine}$ and its finite version by$\FinNDReal{\vFo2\Eea\sze\agrefine}$.\end{definition}Let $\TI$ be a type instance over $\ClSig\SigS\sms$.For every noble type $\tpn \in \TN\TI$,let $\spp\tpn$ be a new unary predicate symbol.Let $\SigSp = \SigS + \seqbd{\spp\tpn}{\tpn \in \TN\TI}$ be anenrichment of $\SigS$ featuring these new symbols. Consider the following setsof literal over $\SigSp$:\[  \sPe\tpn(\xx) = \set{\spp\tpn(\xx)} \cup  \setbd{\lnot\spp\tpnp(\xx)}{\tpnp \in \TN\TI \sub \set\tpn}.\]Let $\bot$ be a special element and define the special set of literals:\[  \sPe\bot(\xx) =  \setbd{\lnot\spp\tpn(\xx)}{\tpn \in \TN\TI}.\]If $\tpp \in \TP\TI$ is a \onetype/ and $\tpr \in \TN\TI\cup\set\bot$, let $\mr\tpp\tpr$ be the following \onetype/ over $\SigSp$:\[  \mr\tpp\tpr = \tpp \cup \sPe\tpr(\xx).\]We refer to $\mr\tpp\tpr$ as the $\tpr$-copy of $\tpp$.If $\tpt \in \TI$ and $\tpr, \tprp \in \TN\TI\cup\set\bot$,let $\mrr\tpt\tpr\tprp$ be the following \twotype/ over $\SigS$:\[  \mrr\tpt\tpr\tprp = \tpt \cup \sPe\tpr(\xx) \cup \sPe\tprp(\yy).\]So we have $\tpx{(\mrr\tpt\tpr\tprp)} = \mr{(\tpx\tpt)}\tpr$.Define the type instance $\TIpm$ over $\ClSig\SigSp\sms$ as follows:\[  \TIpm = \setbd{\mrr\tpt\tpr\tprp}{\tpt \in \TI; \tpr,\tprp \in  \TN\TI\cup\set\bot}.\]The size of $\TIpm$ is quadratic with respect to the size of $\TI$.\begin{definition}A \emph{promotion} for the type instance $\TI$ over $\ClSig\SigS\sms$is a type instance $\TIp \subseteq \TIpm$ over $\ClSig\SigSp\sms$ such that forevery $\tpt \in \TI$ there are some $\tpr,\tprp \in \TN\TI\cup\set\bot$ suchthat $\mrr\tpt\tpr\tprp \in \TIp$.\end{definition}\begin{lemma}[Noble distinguishability]\label{lem:noble-distinguishability}The type instance $\TI$ has a (finite) model iff there is some promotion $\TIp$for $\TI$ that has a (finite) nobly distinguished model.\end{lemma}\begin{proof}First, suppose that $\StrA$ is (finite) a model for $\TI$ and let$\Gals = \Ecl{\at\StrA\se}$ be the set of its galaxies.By~\Cref{lem:peasant-unitedness} we may without loss of generality assume that$\StrA$ is peasantly united.We define a promotion $\TIp$ for $\TI$ and a $\SigSp$-enrichment $\StrAp$ thatis a nobly distinguished model for $\TIp$.For every noble type $\tpn \in \TN\TI$, let $\galXX\tpn \in \GalsN$ be theunique (noble) galaxy realizing it.Note that there might be distinct noble types realized in the same galaxy:$\galXX\tpn = \galXX\tpnp$ for $\tpn \neq \tpnp \in \TN\TI$.For every noble galaxy $\galX \in \GalsN$ choose an arbitrary noble type $\tpn$ realized in it: $\galX = \galXX\tpn$.Define the enrichment $\StrAp$ as follows: for every $\ea \in \domA$:\begin{itemize}  \item If $\ea \in \galXX\tpn$ is an element of some noble galaxy, then let  $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\tpn$.  \item Otherwise, if $\ea \in \galX$ is an element of a peasant galaxy, then  let $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\bot$.\end{itemize}Let $\TIp = \TIS\StrAp$ be the type instance of $\StrAp$. Then $\TIp$ is apromotion for $\TI$ by construction.We claim that the noble types of $\TIp$ are exactly the types of the form$\mr\tpp\tpn$ for $\tpn \in \TN\TI$. By construction any $\mr\tpp\tpn \in\TP{\TIp}$ must be a noble type. On the other hand, by construction if$\mr\tpp\bot \in \TP{\TIp}$ then $\tpp$ must be realized by an element $\ea$ insome peasant galaxy $\galX \in \Gals$ of $\StrA$ and since $\StrA$ is peasantlyunited, $\tpp$ must also be realized by some other element $\eb \in \domA \sub\galX$ in another peasant galaxy of $\StrA$. Hence we have a cosmic \twotype/$\tpIab\StrAp\ea\eb \in \TIp$ that connects $\mr\tpp\bot$ with itself, so$\mr\tpp\bot$ is a peasant type. Then by construction $\StrAp$ is noblydistinguished.Next, the reduct of any model $\StrAp$ for $\TIp$ to a $\SigS$-structure is amodel for $\TI$ by the promotion definition condition.\end{proof}\begin{corollary}The (finite) type realizability problem is reducible in nondeterministicpolynomial time to the (finite) nobly distinguished type realizability problem.\[  \FinAReal{\vFo2\Eea\sze\agrefine} \red\cNP  \FinANDReal{\vFo2\Eea\sze\agrefine}.\]\end{corollary}Observe that any nobly distinguished model is peasantly united.\subsection{Cosmic spectrums}Let $\TI$ be a type instance over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.\begin{definition}A \emph{cosmic spectrum} over $\TI$ is a triple of \twotypes/$\csps = (\dii\csps,\die\csps,\dee\csps)$ such that the following conditions aresatisfied:\begin{itemize}  \item[\condcspII]\label{cond:cspII}  The set of \emph{internal types} $\dii\csps \subseteq \TIg$ is a set of  galactic types that is closed under inversion.  \item[\condcspIE]\label{cond:cspIE}  The set of \emph{boundary types} $\die\csps \subseteq \TIc$ is a nonempty set  of cosmic types.  \item[\condcspEE]\label{cond:cspEE}  The set of \emph{external types} $\dee\csps \subseteq \TI$ is a set of  \twotypes/ that is closed under inversion.  \item[\condcspT]\label{cond:cspT}  Let $\dei\csps = \setbd{\inv\tpt}{\tpt \in \die\csps}$.  We require that  $\dii\csps\cup\die\csps\cup\dei\csps\cup\dee\csps = \TI$.  \item[\condcspNP]\label{cond:cspNP}  The (nonempty) set $\Tpx\csps = (\tpx\restriction{\die\csps})$ the set  of \emph{internal \onetypes/} of~$\csps$.  The (nonempty) set $\Tpy\csps = (\tpy\restriction{\die\csps})$ the set of  \emph{external \onetypes/} of~$\csps$.  We require that either $\Tpx\csps \subseteq \TN\TI$, in which case $\csps$ is  a \emph{noble cosmic spectrum}, or $\Tpx\csps \subseteq \TPs\TI$, in which  case $\csps$ is a \emph{peasant cosmic spectrum}.\end{itemize}\end{definition}For any \onetype/ $\tpp$ or a \twotype/ $\tpt$ over $\SigS$ denote by $\noe\tpp$or $\noe\tpt$ the reducts of $\tpp$ and $\tpt$ to the language $\SigS -\seq{\se}$. That is, $\noe\tpp \subset \tpp$ and $\noe\tpt \subset \tpt$ consistof those literals that do not feature $\se$.Let $\si$ be a new unary predicate symbol and let $\SigSp = \SigS - \seq{\se} +\seq{\si}$ be the predicate signature obtained from $\SigS$ by removing thecoarsest equivalence symbol $\se$ and adding the new predicate symbol $\si$.\begin{definition}The \emph{spectral type instance} $\TIs\csps$ of the cosmic spectrum $\csps$is a type instance over the \emph{simpler}$\vFo2\Eea{(\sze-1)}\agrefine$-classified signature $\ClSig\SigSp\sms$ definedas follows:\begin{itemize}  \item For every internal $\tpt \in \dii\csps$, add  $\cii\tpt = \noe\tpt \cup \set{\si(\xx), \si(\yy)}$ to $\TIs\csps$.  \item For every boundary $\tpt \in \die\csps$, add $\cie\tpt =  \noe\tpt \cup \set{\si(\xx), \lnot\si(\yy)}$ and its inverse to $\TIs\csps$.  \item For every external $\tpt \in \dee\csps$, add $\cee\tpt =  \noe\tpt \cup \set{\lnot\si(\xx), \lnot\si(\yy)}$ to $\TIs\csps$.\end{itemize}This is indeed a type instance since $\die\csps$ is nonempty and since$\dii\csps$ and $\dee\csps$ are closed under inversion.We also denote $\ci\tpp = \noe\tpp \cup \set{\si(\xx)}$ and $\ce\tpp = \noe\tpp\cup \set{\lnot\si(\xx)}$ for any \onetype/ $\tpp\in\TP\TI$.The size of a cosmic spectrum over a type instance is linear withrespect to the size of the type instance.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\TIs\csps$ has a model.\end{definition}Let $\StrA$ be a nobly distinguished model for $\TI$ such that $\relE = \at\StrA\ea \neq\domAA$ is not full on $\domA$ (equivalently, there are at least $2$ galaxies).If $\galX \in \Gals$ is any galaxy, the \emph{cosmic spectrum} $\csps =\cspIX\StrA\galX$ of $\galX$ is defined by:\begin{align*}  \dii\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \galX, \eb \in \galX \sub  \set\ea} \\  \die\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \galX, \eb \in \domA \sub  \galX} \\  \dee\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \domA \sub \galX, \eb \in  (\domA \sub \galX) \sub \set\ea}.\end{align*}\begin{remark}Then indeed $\csps$ is a locally consistent cosmic spectrum over $\TI$.\end{remark}\begin{proof}First we check that $\csps$ is a cosmic spectrum over $\TI$:\begin{itemize}  \item[\refcondcspII]  Let $\tpt\in\dii\csps$. Then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea,\eb\in\galX$, so $\tpt$ is galactic.  Also $\inv\tpt=\tpIab\StrA\eb\ea\in\dii\csps$, so $\dii\csps$ is closed under  inversion.  \item[\refcondcspIE]  Let $\tpt\in\die\csps$. Then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea\in\galX$ and $\eb\in\domA\sub\galX$, so $\tpt$ is cosmic.  Since $\relE$ is not full on $\domA$, there is some $\ea\in\galX$ and  $\eb\in\domA\sub\galX$. Then $\tpIab\StrA\ea\eb\in\die\csps$, so $\die\csps$  is nonempty.  \item[\refcondcspEE]  If $\tpt\in\dee\csps$, then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea\in\domA\sub\galX$ and $\eb\in(\domA\sub\galX)\sub\set\ea$, so  $\inv\tpt=\tpIab\StrA\eb\ea\in\dee\csps$ and hence $\dee\csps$ is closed under  inversion.  \item[\refcondcspT]  follows since $\StrA$ is a model for $\TI$.  \item[\refcondcspNP]  follows since $\StrA$ is nobly distinguished.\end{itemize}We transform $\StrA$ to a $\SigSp$-structure $\StrAp$ by forgetting theinterpretation of $\se$ and by interpreting $\at\StrAp\si = \galX$.It is immediate that $\StrAp$ is a model for $\TIs\csps$.\end{proof}\begin{remark}\label{rem:csp-xy}Let $\csps$ be a locally consistent cosmic spectrum over the type instance$\TI$.Then $(\tpx\restriction{\dii\csps}) \subseteq \Tpx\csps$ and$(\tpx\restriction{\dee\csps}) \subseteq \Tpy\csps$.\end{remark}\begin{proof}Let $\StrA$ be a model for $\TIs\csps$.Note that $\die\csps$ is nonempty and let $\tpt\in\die\csps$ be any boundarytype, so $\cie\tpt \in \TIs\csps$.Let $\eap \neq \ebp \in \domA$ be elements such that $\tpIab\StrA\eap\ebp =\cie\tpt$.Note that $\StrA \vDash \si(\eap)$ and $\StrA \vDash \lnot\si(\ebp)$.First let $\tpp \in (\tpx\restriction{\dii\csps})$,so some $\tpt \in \dii\csps$ has $\tpx\tpt = \tpp$.By construction $\cii\tpt \in \TIs\csps$, so let $\ea \neq \eb \in \domA$ besuch that $\tpIab\StrA\ea\eb = \cii\tpt$, so $\tpIa\StrA\ea = \ci\tpp$.Note that $\StrA \vDash \si(\ea)$, so $\ea \neq \ebp$.Then $\tpIab\StrA\ea\ebp = \cie\tptp$ for some $\tptp \in \die\csps$ suchthat $\tpx\tptp = \tpp$, so $\tpp\in(\tpx\restriction\die\csps)=\Tpx\csps$.Next let $\tpp \in (\tpx\restriction{\dee\csps})$.Then some $\tpt \in \dee\csps$ has $\tpy\tpt = \tpp$.By construction $\cee\tpt \in \TIs\csps$, so let $\ea \neq \eb \in \domA$ besuch that $\tpIab\StrA\ea\eb = \ce\tpt$, so $\tpIa\StrA\eb = \ce\tpp$.Note that $\StrA \vDash \lnot\si(\eb)$, so $\eap \neq \eb$.Then $\tpIab\StrA\eap\eb = \cie\tptp$ for some $\tptp \in \die\csps$ such that$\tpy\tptp = \tpp$, so $\tpp\in(\tpy\restriction\die\csps)=\Tpy\csps$.\end{proof}\begin{remark}\label{rem:csp-tpxy}Let $\csps$ be a locally consistent cosmic spectrum over the type instance$\TI$.Then $\Tpx\csps \cup \Tpy\csps = \TP\TI$.\end{remark}\begin{proof}Let $\tpp\in\TP\TI$ be any \onetype/. Then some $\tpt\in\TI$ has$\tpx\tpt=\tpp$.By~\refcondcspT{} we have$\tpt \in \dii\csps \cup \die\csps \cup \dei\csps \cup \dee\csps$.If $\tpt\in\dii\csps$, then $\tpp\in(\tpx\restriction\dii\csps) \subseteq\Tpx\csps$ by~\Cref{rem:csp-xy}.If $\tpt\in\die\csps$, then $\tpp\in\Tpx\csps$.If $\tpt\in\dei\csps$, then $\inv\tpt\in\die\csps$ has $\tpy{(\inv\tpt)}=\tpp$,so $\tpp\in\Tpy\csps$.If $\tpt\in\dee\csps$, then $\tpp\in(\tpx\restriction\dee\csps) \subseteq\Tpy\csps$ by~\Cref{rem:csp-xy}.\end{proof}\begin{remark}\label{rem:lc-csp-iff}Let $\csps$ be a locally consistent cosmic spectrum over $\TI$ and let$\TIs\csps$ be the spectral type instance of $\csps$.Then the following are true:\begin{align*}  \miff{\tpt\in\dii\csps}{&\cii\tpt\in\TIs\csps} \\  \miff{\tpt\in\die\csps}{&\cie\tpt\in\TIs\csps} \\  \miff{\tpt\in\dee\csps}{&\cee\tpt\in\TIs\csps} \\  \miff{\tpp\in\Tpx\csps}{&\ci\tpp\in\TP{\TIs\csps}} \\  \miff{\tpp\in\Tpy\csps}{&\ce\tpp\in\TP{\TIs\csps}}.\end{align*}\end{remark}\begin{proof}The first three equivalences are clear by construction.Consider the forth equivalence.First let $\tpp\in\Tpx\csps$, so some $\tpt\in\die\csps$ has $\tpx\tpt=\tpp$, so$\cie\tpt\in\TIs\csps$ has $\tpx{(\cie\tpt)} = \ci\tpp$, so$\ci\tpp\in\TIs\csps$.Next let $\ci\tpp\in\TP{\TIs\csps}$, so some $\tptp\in\TIs\csps$ has$\tpx\tptp=\ci\tpp$.Then either $\tptp=\cii\tpt$ for some $\tpt\in\dii\csps$ or $\tptp=\cie\tpt$ forsome $\tpt\in\die\csps$.In both cases $\tpp=\tpx\tpt$ and by~\Cref{rem:csp-xy}, $\tpp\in\Tpx\csps$.Consider the last equivalence.First let $\tpp\in\Tpy\csps$, so some $\tpt\in\die\csps$ has $\tpy\tpt=\tpp$, so$\cie\tpt\in\TIs\csps$ has $\tpy{(\cie\tpt)}=\ce\tpp$, so$\ce\tpp\in\TIs\csps$.Next let $\ce\tpp\in\TP{\TIs\csps}$, so some $\tptp\in\TIs\csps$ has$\tpy\tptp = \ce\tpp$.Then either $\tptp=\cei\tpt$ for some $\tpt\in\dei\csps$, or$\tptp=\cee\tpt$ for some $\tpt\in\dee\csps$.In both cases $\tpp=\tpy\tpt$ and by~\Cref{rem:csp-xy}, $\tpp\in\Tpy\csps$.\end{proof}Let $\TPi{\TIs\csps} = \setbd{\ci\tpp\in\TP{\TIs\csps}}{\tpp\in\TP\TI}$ be theset of \emph{internal spectral \onetypes/} over the spectral type instance$\TIs\csps$ and let$\TPe{\TIs\csps} = \setbd{\ce\tpp\in\TP{\TIs\csps}}{\tpp\in\TP\TI}$ be the setof \emph{external spectral \onetypes/} over $\TIs\csps$.\begin{remark}\label{rem:lc-csp-char}If $\StrA$ be a model for $\TIs\csps$ and $\galX = \at\StrA\si$, then$\TPi{\TIs\csps}$ is the set of \onetypes/ realized by elements in $\galX$;$\TPe{\TIs\csps}$ is the set of \onetypes/ realized by elements outside of$\galX$.\end{remark}\begin{remark}\label{rem:csp-pp}If $\tpp \in \Tpx\csps$ and $\tppp \in \Tpy\csps$, then some $\tpt \in\die\csps$ has $\tpx\tpt = \tpp$ and $\tpy\tpt = \tppp$.\end{remark}\begin{proof}Let $\StrA$ be a model for $\TIs\csps$, and let by~\Cref{rem:lc-csp-char}$\ea \in \domA$ realizes $\ci\tpp$ and let $\eb \in \domA$ realizes $\ce\tppp$.Then by~\Cref{rem:lc-csp-iff} $\tpIab\StrA\ea\eb = \cie\tpt$ for some $\tpt \in\die\csps$. But then $\tpx\tpt = \tpp$ and $\tpy\tpt = \tppp$.\end{proof}\begin{remark}\label{rem:lc-csp-n}If $\tpn\in\TN\TI$ is noble, then either $\tpn\not\in\Tpx\csps$ or$\tpn\not\in\Tpy\csps$.\end{remark}\begin{proof}Suppose that $\tpn\in\Tpx\csps$ and $\tpn\in\Tpy\csps$.By~\Cref{rem:csp-pp}, some $\tpt\in\die\csps$ has $\tpx\tpt=\tpy\tpt=\tpn$.Then $\tpt$ is a cosmic type connecting $\tpn$ with itself --- a contradiction.\end{proof}\begin{remark}\label{rem:lc-csp-ki}If $\tpk\in\Tpx\csps\cap\TK\TI$ is an internal king type, then$\ci\tpk\in\TK{\TIs\csps}$ is an \emph{internal spectral king type}.\end{remark}\begin{proof}Suppose not. Then some $\tptp\in\TIs\csps$ connects $\ci\tpk$ with itself.By~\Cref{rem:lc-csp-iff}, $\tptp=\cii\tpt$ for some$\tpt\in\dii\csps$.Then $\tpt$ connects $\tpk$ with itself --- a contradiction.\end{proof}\begin{remark}\label{rem:lc-csp-ke}If $\tpk \in \Tpy\csps\cap\TK\TI$ is an external king type, then$\ce\tpk\in\TK{\TIs\csps}$ is an \emph{external spectral king type}.\end{remark}\begin{proof}Suppose not. Then some $\tptp\in\TIs\csps$ connects $\ce\tpk$ with itself.By~\Cref{rem:lc-csp-iff}, $\tptp=\cee\tpt$ for some $\tpt\in\cee\tpt$.Then $\tpt$ connects $\tpk$ with itself --- a contradiction.\end{proof}\begin{lemma}[Preservation of kings]\label{rem:csp-k-noble}If $\csps$ is noble, then\[  \TK{\TIs\csps} = \setbd{\ci\tpk}{\tpk \in \Tpx\csps \cap \TK\TI}  \cup \setbd{\ce\tpk}{\tpk \in \Tpy\csps \cap \TK\TI}.\]That is, the notion of a king type is preserved in the spectral type instance ofa noble spectrum.\end{lemma}\begin{proof}By~\Cref{rem:lc-csp-ki} and~\Cref{rem:lc-csp-ke}, it is sufficient to prove theleft-to-right inclusion.First let $\ci\tpp \in \TK{\TIs\csps}$ be any internal spectral king type andassume towards a contradiction that $\tpp\in\TW\TI$ is a worker type.Then some $\tpt \in \TI$ connects $\tpp$ with itself.By~\refcondcspT, $\tpt \in \dii\csps \cup \die\csps \cup \dei\csps \cup \dee\csps$.If $\tpt \in \dii\csps$, then by~\Cref{rem:lc-csp-iff} $\cii\tpt \in \TIs\csps$connects $\ci\tpp$ with itself --- a contradiction.In the remaining cases we must have that $\ce\tpp \in \TP{\TIs\csps}$, soby~\Cref{rem:csp-pp} some (cosmic) $\tpt \in \die\csps$ connects $\tpp$ withitself.But then $\tpp \in \Tpx\csps$ is a peasant type --- a contradiction withthe nobility of $\csps$.Next let $\ce\tpp \in \TK{\TIs\csps}$ be any external spectral king type andassume towards a contradiction that $\tpp\in\TW\TI$ is a worker type.Then some $\tpt \in \TI$ connects $\tpp$ with itself.By~\refcondcspT, $\tpt \in \dii\csps \cup \die\csps \cup \dei\csps \cup \dee\csps$.If $\tpt \in \dee\csps$ then by~\Cref{rem:lc-csp-iff} $\cee\tpt \in \TIs\csps$connects $\ce\tpp$ with itself --- a contradiction.In the remaining cases we must have that $\ci\tpp \in \TP{\TIs\csps}$, soby~\Cref{rem:csp-pp} some (cosmic) $\tpt\in\die\csps$ connects $\tpp$ withitself.But then $\tpp\in\Tpx\csps$ is a peasant type --- a contradiction with thenobility of $\csps$.\end{proof}If $\csps$ is a cosmic spectrum over the type instance $\TI$ over$\ClSig\SigS\sms$ and$\tpp \in \TP{\TIs\csps}$ is a \onetype/ or$\tpt \in \TIs\csps$ is a \twotype/ over the spectral type instance$\TIs\csps$ over $\ClSig\SigSp\sms$,denote by $\noin\tpp$ and $\noin\tpt$ thereducts of $\tpp$ and $\tpt$ to the language $\SigSp - \seq{\si}$.Define the following notations:\begin{align*}\di\tpp &= \de\tpp = \noin\tpp \cup \set{\se(\xx)} \\\dii\tpt &= \noin\tpt \cup \set{\se(\xx),\se(\yy),\se(\xx,\yy),\se(\yy,\xx)}\\\die\tpt &= \noin\tpt \cup \set{\se(\xx),\se(\yy),\lnot\se(\xx,\yy),  \lnot\se(\yy,\xx)}.\end{align*}That is, these are \emph{inverses} of the previous operations:$\di{(\ci\tpp)} = \de{(\ce\tpp)} = \tpp$ for $\tpp \in \TP\TI$ and$\dii{(\cii\tpt)} = \die{(\cie\tpt)} = \tpt$ for $\tpt \in \ci\csps$.\begin{definition}Let $\csps$ be a locally consistent cosmic spectrum and let $\StrA$ be a modelfor its spectral type instance $\TIs\csps$.Let $\galX = \at\StrA\si$ be the set of elements $\ea \in \domA$ such that$\StrA \vDash \si(\ea)$. This set is nonempty since $\cie\tpt \in \TIs\csps$ forevery $\tpt \in \cie\csps \neq \eset$, so $\cie\tpt$ must be realized in $\StrA$and $\si(\xx) \in \cie\tpt$.Also $\domA \sub \galX$ is nonempty since $\lnot\si(\yy) \in \cie\tpt$.Extend $\galX$ to a model for $\SigS$ by interpreting $\at\galX\se = \galX\cprod \galX$ as the full relation on $\galX$.Call $\galX$ the \emph{galaxy} of the model $\StrA$.Note that $\galX$ is a $\SigS$-structure, but is not necessarily a$\ClSig\SigS\sms$-structure.For any $\ea \in \galX$, define the \emph{intended star-type} $\stps(\ea)$ by:\[  \stps(\ea) = \setbd{\dii{\tpIab\StrA\ea\eb}}{\eb \in \galX \sub \set\ea}  \cup \setbd{\die{\tpIab\StrA\ea\eb}}{\eb \in \domA \sub \galX}.\]\end{definition}\begin{lemma}\label{rem:istp-stp}The intended star-type $\stps=\stps(\ea)$ is a star-type over $\TI$.\end{lemma}\begin{proof}That $\stps$ is nonempty follows from $\domA \sub \galX \neq \eset$.We verify the conditions for a star-type over $\TI$:\begin{itemize}  \item[\refcondstpx]  If $\tpt, \tptp \in \stps(\ea)$, then $\tpx\tpt = \tpx\tptp =  \di{\tpIa\StrA\ea}\in\TP\TI$.  Let $\tpp = \tpx\stps = \tpx\tpt$ be the intended \onetype/ of $\ea$.  \item[\refcondstppy]  Let $\tppp \in \nb\TI\tpp$. We have to find some $\tpt\in\stps$ such that  $\tpy\tpt=\tppp$.  First, if $\tppp=\tpp$, then $\tpp$ is not a king type, so some $\tpt\in\TI$  connects $\tpp$ with itself.  By~\refcondcspT, $\tpt \in \dii\csps \cup \die\csps \cup \dei\csps \cup  \dee\csps$.  If $\tpt\in\dii\csps$, then by~\Cref{rem:lc-csp-iff}, $\cii\tpt\in\TIs\csps$.  Since $\StrA$ is a model for $\TIs\csps$,  some $\eb\neq\ec\in\domA$ have $\tpIab\StrA\eb\ec=\cii\tpt$.  By~\Cref{rem:lc-csp-char}, $\eb,\ec\in\galX$.  Let $\ebp\in\set{\eb,\ec}\sub\set\ea$.  Then $\tpt = \dii{\tpIab\StrA\ea\ebp} \in \stps$ has $\tpy\tpt=\tppp$.  If $\tpt\in\die\csps$, then by~\Cref{rem:lc-csp-iff}, $\cie\tpt\in\TIs\csps$,  so some $\eb\neq\ec\in\domA$ have $\tpIab\StrA\eb\ec=\cie\tpt$, so  $\tpIa\StrA\ec=\ce\tpp$ and by~\Cref{rem:lc-csp-char}, $\ec\in\domA\sub\galX$.  Then $\tpt=\die{\tpIab\StrA\ea\ec} \in \stps$ has $\tpy\tpt=\tppp$.  If $\tpt\in\dei\csps$, then $\inv\tpt\in\die\csps$ connects $\tpp$ with itself  and the argument reduces to the previous case.  If $\tpt\in\dee\csps$, then by~\Cref{rem:lc-csp-iff}, $\cee\tpt\in\TIs\csps$,  so some $\eb\neq\ec\in\domA$ have $\tpIab\StrA\eb\ec=\cee\tpt$, so  $\tpIa\StrA\eb=\ce\tpp$ and by~\Cref{rem:lc-csp-char}, $\eb\in\domA\sub\galX$.  Then $\tpt=\die{\tpIab\StrA\ea\eb} \in \stps$ has $\tpy\tpt=\tppp$.    Next, if $\tppp\neq\tpp$, by~\Cref{rem:csp-tpxy},  $\tppp\in\Tpx\csps\cup\Tpy\csps$.  If $\tppp\in\Tpx\csps$ then by~\Cref{rem:lc-csp-iff}  $\ci\tppp\in\TP{\TIs\csps}$.  By~\Cref{rem:lc-csp-char} some $\eb\in\galX$ has $\tpIa\StrA\eb=\ci\tppp$ and  $\eb\neq\ea$ since $\tppp\neq\tpp$.  Then $\tpt=\dii{\tpIab\StrA\ea\eb} \in \stps$ has $\tpy\tpt=\tppp$.  If $\tppp\in\Tpy\csps$ then by~\Cref{rem:lc-csp-iff}  $\ce\tppp\in\TP{\TIs\csps}$.  By~\Cref{rem:lc-csp-char} some $\eb\in\domA\sub\galX$ has  $\tpIa\StrA\eb=\ce\tppp$.  Then $\tpt=\die{\tpIab\StrA\ea\eb}\in\stps$ has $\tpy\tpt=\tppp$.    \item[\refcondstpky]  Let $\tpkp \in \nb\TI\tpp\cap\TK\TI$, hence $\tpkp\neq\tpp$.  By~\Cref{rem:csp-tpxy} $\tpkp\in\Tpx\csps\cup\Tpy\csps$.  Since $\tpkp$ is noble, by~\Cref{rem:lc-csp-n} either  $\tpkp\in\Tpx\csps\sub\Tpy\csps$ or $\tpkp\in\Tpy\csps\sub\Tpx\csps$.  First let $\tpkp\in\Tpx\csps\sub\Tpy\csps$.  Then by~\Cref{rem:lc-csp-iff} we have that $\ci\tpkp\in\TP{\TIs\csps}$ and  $\ce\tpkp\not\in\TP{\TIs\csps}$.  Let $\tpt,\tptp\in\stps$ be such that $\tpy\tpt=\tpy\tptp=\tpkp$.  We claim that $\tpt=\tptp$.  By~\Cref{rem:lc-csp-iff} we must have that $\cii\tpt,\cii\tptp\in\TIs\csps$,  since $\ce\tpkp\not\in\TP{\TIs\csps}$.  By~\Cref{rem:lc-csp-ki} $\ci\tpkp \in \TK{\TIs\csps}$ is an internal spectral  king type, so there is a unique $\eb\in\domA$ having $\tpIa\StrA\eb=\ci\tpkp$.  By~\Cref{rem:lc-csp-char} $\eb\in\galX$ and since $\tpkp\neq\tpp$,  $\eb\neq\ea$.  Since $\tpy{(\cii\tpt)}=\tpy{(\cii\tptp)}=\ci\tpkp$, we must have that  $\cii\tpt=\cii\tptp=\tpIab\StrA\ea\eb$, hence $\tpt=\tptp$.    Next let $\tpkp\in\Tpy\csps\sub\Tpx\csps$, so by~\Cref{rem:lc-csp-iff}  we have that $\ce\tpkp\in\TP{\TIs\csps}$ and $\ci\tpkp\not\in\TP{\TIs\csps}$.  Let $\tpt,\tptp\in\stps$ be such that $\tpy\tpt=\tpy\tptp=\tpkp$.  We claim that $\tpt=\tptp$.  By~\Cref{rem:lc-csp-iff} we must have that $\cie\tpt,\cie\tptp\in\TIs\csps$,  since $\ci\tpkp\not\in\TP{\TIs\csps}$.  By~\Cref{rem:lc-csp-ke} $\ce\tpkp \in \TK{\TIs\csps}$ is an external spectral  king type, so there is a unique $\eb\in\domA$ having $\tpIa\StrA\eb=\ce\tpkp$.  By~\Cref{rem:lc-csp-char} $\eb\in\domA\sub\galX$.  Since $\tpy{(\cie\tpt)} = \tpy{(\cie\tptp)}=\ci\tpkp$, we must have that  $\cie\tpt=\cie\tptp=\tpIab\StrA\ea\eb$, hence $\tpt=\tptp$.     \item[\refcondstpm]  Let $\sm\in\sms$. Since $\StrA$ is a model for $\TIs\csps$, some  $\eb\in\domA\sub\set\ea$ has $\sm(\xx,\yy)\in\tpIab\StrA\ea\eb$.  If $\eb\in\galX$, then $\sm(\xx,\yy)\in\dii{\tpIab\StrA\ea\eb}\in\stps(\ea)$.  If $\eb\in\domA\sub\galX$, then  $\sm(\xx,\yy)\in\die{\tpIab\StrA\ea\eb}\in\stps(\ea)$.\end{itemize}\end{proof}Let $\csps$ be a locally consistent cosmic spectrum, let $\StrA$ be a model for$\TIs\csps$ and let $\galXs\csps$ be the galaxy of $\StrA$.\begin{remark}\label{rem:istp-gal}If $\ea\in\galXs\csps$ and $\tpt\in\stps(\ea)$ is galactic, then some$\eb\in{\galXs\csps}\sub\set\ea$ has $\tpIab\StrA\ea\eb=\tpt$.\end{remark}\begin{proof}By construction we must have $\tpt = \dii{\tpIab\StrA\ea\eb}$ for some$\eb\in\galXs\csps\sub\set\ea$.\end{proof}\begin{remark}\label{rem:istp-cos}Let $\tpt\in\TIc$ be any cosmic type.Then $\tpt\in\die\csps$ iff some $\ea\in\galXs\csps$ has $\tpt\in\stps(\ea)$.\end{remark}\begin{proof}First let $\tpt\in\die\csps$. Then $\cie\tpt\in\TIs\csps$, so some$\ea\in\galXs\csps$ and some $\eb\in\domA\sub\galXs\csps$ has$\tpIab\StrA\ea\eb = \cie\tpt$, so$\tpt = \die{\tpIab\StrA\ea\eb} \in \stps(\ea)$.Next let $\ea\in\galXs\csps$ and let $\tpt\in\stps(\ea)$ be any cosmic type.Then $\tpt = \die{\tpIab\StrA\ea\eb}$ for some $\ea\in\galXs\csps$ and$\eb\in\domA\sub\galXs\csps$, so by construction $\tpt \in \die\csps$.\end{proof}\begin{remark}\label{rem:istp-p}Let $\StrA$ be a model for $\TIs\csps$ and let $\ea\in\galX$ be such that$\StrA\vDash\si(\ea)$.Then $\tpIa\StrA\ea=\ci\tpp$ iff $\tpp(\ea)=\tpp$.\end{remark}\begin{remark}\label{rem:istp-p-eq}$\tpp\in\Tpx\csps$ iff some $\ea\in\galXs\csps$ has $\tpp(\ea)=\tpp$.\end{remark}\begin{remark}\label{rem:istp-k-eq}$\tpk\in\Tpx\csps\cap\TK\TI$ iff a unique $\ea\in\galXs\csps$ has$\tpp(\ea)=\tpk$.\end{remark}\begin{definition}A \emph{certificate} $\Cert$ for the type instance~$\TI$ is a nonempty set oflocally consistent cosmic spectrums over $\TI$ satisfying the followingconditions:\begin{itemize}  \item[\condcertTc]\label{cond:certTc}  If $\tpt\in\TIc$, then some $\csps\in\Cert$ has $\tpt\in\die\csps$.  \item[\condcertTg]\label{cond:certTg}  If $\tpt\in\TIg$, then some $\csps\in\Cert$ has $\tpt\in\dii\csps$.  \item[\condcertn]\label{cond:certn}  If $\tpn\in\TN\TI$, then a unique $\csps\in\Cert$ has $\tpn\in\Tpx\csps$.\end{itemize}\end{definition}\begin{lemma}[Certificate extraction]\label{lem:cert-ext-many}TODO: Formulate\[\Cert = \setbd{\cspIX\StrA{\relE[\eat\tpt]}}{\tpt \in \TIc}.\]\end{lemma}\begin{proof}TODO\end{proof}\begin{lemma}[Certificate expansion]\label{lem:cert-exp-many}Let $\Cert$ be a certificate for the type instance $\TI$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$. Then $\Cert$has a finite model.More precisely, let $\pt \geq \card{T}$ be a parameter.Then $\TI$ has a finite model in which each worker type is realized at least$\pt$ times.\end{lemma}\begin{proof}We use induction on $\sze$.We have shown the base case $\sze = 0$, $\vFo2\Eea\sze\agrefine = \vFo2$in~\Cref{lem:cert-expand}.Now let $\sze \geq 1$ and assume the hypothesis for $(\sze-1)$.We build a model $\StrA$ for $\TI$.For every $\csps \in \Cert$,let $\StrAs\csps$ be a model for $\TIs\csps$ in which every worker type isrealized at least $3\pt$ times and let $\galXs\csps = \at{\StrAs\csps}\si$ bethe galaxy of that model.% TODO: More formallySuch a model exists by induction hypothesis and by~\Cref{lem:cert-ext-many}.The galaxies of $\StrA$ are:\begin{itemize}  \item A single galaxy $\galXs\csps$ for every noble $\csps \in \Cert$.  These galaxies are the \emph{noble galaxies}.  \item $3\pt$ copies $\galXsij\csps\ii\jj$ of $\galXs\csps$ for every peasant  $\csps \in \Cert$, where $\ii \in \set{0,1,2}$ and $\jj \in [1,\pt]$.  These galaxies are the \emph{peasant galaxies}.\end{itemize}Let $\stps(\ea)$ be the intended star-type of $\ea$ and let$\tpp(\ea) = \tpx{(\stps(\ea))}$ be the intended \onetype/ of $\ea$ for$\ea\in\domA$.We continue by observing that the worker types are realized numerous times inthis structure.First consider any noble type that is not king type $\tpn\in\TN\TI\sub\TK\TI$.By~\refcondcertn, there is a unique $\csps\in\Cert$ having $\tpn\in\Tpx\csps$.Let $\ea\in\domA$ be any element such that $\tpp(\ea)=\tpn$.By~\Cref{rem:istp-p-eq}, $\ea\in\galXs\csps$.Since $\csps$ is noble, by~\Cref{rem:csp-k-noble} we must have that$\ci\tpn\in\TPs{\TIs\csps}$ is a worker type.Since each worker type is realized at least $3\pt$ times in $\StrAs\csps$, wemay choose a partition$\domA^\tpn=\domA_0^\tpn\cup\domA_1^\tpn\cup\domA_2^\tpn\subseteq\galXs\csps$ ofall the elements of $\domA$ having intended \onetype/ $\tpn$ such that$\card{\domA_\ii^\tpn}\geq\pt$ for $\ii\in\set{0,1,2}$.That is, we arbitrary distribute the noble elements having intended \onetype/$\tpn$ into three groups of at least $\pt$ elements.Next consider any peasant type $\tpp\in\TPs\TI$.Let $\csps\in\Cert$ be any peasant cosmic spectrum such that $\tpp\in\Tpx\csps$.By construction, there are $3\pt$ copies $\galXsij\csps\ii\jj$ of $\galXs\csps$in $\domA$ that contain an element that realizes $\tpp$.Hence we may partition all elements $\ea\in\domA$ realizing $\tpp$ in threegroups $\domA^\tpp=\domA_0^\tpp\cup\domA_1^\tpp\cup\domA_2^\tpp$ such that$\card{\domA_\ii^\tpp}\geq\pt$ and any two elements from consecutive copies comefrom consecutive galaxies:\[  \domA_\ii^\tpp =  \setbd{\ea\in\galXsij\csps\ii\jj}{\tpp(\ea)=\tpp\in\Tpx\csps,\jj\in[1,\pt]}.\]We consistently assign the remaining cosmic types between elements in differentgalaxies on stages.\begin{description}\item[Realization of kings]Let $\tpk\in\TK\TI$ be any king type and let $\ea\in\domA$ be any element suchthat $\tpp(\ea)=\tpk$. We claim that such $\ea$ is unique.By~\refcondcertn, there is a unique $\csps\in\Cert$ having $\tpk\in\Tpx\csps$.By~\Cref{rem:istp-p-eq}, $\ea\in\galXs\csps$.By~\Cref{rem:istp-k-eq}, such $\ea\in\galX\csps$ is unique.We proceed to assign a cosmic type consistently between $\ea$ and every element$\eb\in\domA\sub\galXs\csps$ outside the galaxy of $\ea$.Then either $\eb\in\galXs\cspsp$ comes from a noble galaxy,or $\eb\in\galXsij\cspsp\ii\jj$ comes from a peasant galaxy;in both cases $\cspsp\neq\csps$.Consider the intended star-type $\stpsp = \stps(\eb)$ of $\eb$.Since $\tpx\stpsp=\tpp(\eb)\neq\tpk$, by~\refcondstpky{} there is a unique$\tptp\in\stpsp$ having $\tpy\tptp=\tpk$.By~\Cref{rem:istp-gal}, $\tptp$ must be cosmic.Assign $\tpIab\StrA\eb\ea=\tptp$.This assignment is appropriate for $\eb$, since $\tpt$ was the unique with$\tpy\tpt=\tpk$.We claim that it is also appropriate for $\ea$.Indeed, let $\tpt\in\stps$ be any cosmic type.Then $\tptp=\inv\tpt\in\TIc$ and by~\refcondcertTc, some $\cspsp\in\Cert$ has$\tptp\in\cie\cspsp$.By~\Cref{rem:istp-cos}, some $\eb\in\galXs\cspsp$ has $\tptp\in\stps(\eb)$.Since $\tpy\tptp=\tpk\neq\tpp(\eb)$, by~\refcondstpky{} the\twotype/ $\tptp\in\stps(\eb)$ is the unique having $\tpy\tptp=\tpk$.Hence we had assigned $\tpIab\StrA\eb\ea=\tptp$.\item[Realization of workers]We now proceed to realize the star-types of the workers.Let $\tpp\in\TW\TI$ be a worker type and let $\ea\in\domA^\tpp_\ii$ be anyelement with intended \onetype/ $\tpp$.Let $\stps=\stps(\ea)$ be the intended star-type of $\ea$.By~\Cref{rem:istp-gal}, any galactic $\tpt\in\stps$ is realized in the galaxy of$\ea$.Any cosmic $\tpt\in\stps$ such that $\tpy\tpt$ is a king type is realized duringthe realization of kings.Suppose that $\tpt\in\stps$ is any cosmic \twotype/ such that$\tpy\tpt=\tppp\in\TW\TI$ is a worker type.Let $\TU=\setbd{\tpu\in\stps\cap\TIc}{\tpy\tpu=\tppp}$ be the set of cosmictypes parallel to $\tpt$ in $\stps$.Let $\iip = (\ii+1\bmod3)\in\set{0,1,2}$ and consider $\domA_\iip^\tppp$ the setof workers from the next copy. Note that since $\TU\subseteq\TI$ we have$\card{\TU}\leq\card{\domA_\iip^\tppp}$, so there are enough distinct elements$\ebt\tpn\in\domA_\iip^\tppp$ for the assignment$\tpIab\StrA\ea{\ebt\tpu}=\tpu$.We check that this assignments are appropriate.First, none of these assignments clashes with each other, since they are betweenelements from consecutive copies.Next, none of these assignments is between elements of the same galaxy.Indeed, if both $\tpp$ and $\tppp$ are noble, then since $\tpt$ is cosmic, wemust have that $\tpp\in\Tpx\csps$ and $\tppp\in\Tpx\cspsp$ for different noblecosmic spectrums $\csps$ and $\cspsp$, so all the elements realizing $\tpp$ comefrom $\galXs\csps$ and all elements realizing $\tppp$ come from $\galXs\cspsp$.On the other hand, if both $\tpp$ and $\tppp$ are peasant, then this isimmediate by construction.\item[Completion] TODO\end{description}\end{proof}\begin{comment}\section{TODO}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.A \emph{cosmic spectrum} $\csps \subseteq \TpiTc$ over$\Tpi\TpiP\TpiT$ is a nonempty set of cosmic $2$-types satisfying the followingconditions:\begin{itemize}  \item[\condcspx]\label{cond:cspx}  An \emph{internal type} for $\csps$ is any $1$-type  $\tpIp \in (\xtp\restriction\csps)$. Denote the set of internal types for  $\csps$ by $\xTp\csps = (\xtp\restriction\csps)$.    An \emph{external type} for $\csps$ is any $1$-type  $\tpIp \in (\ytp\restriction\csps)$. Denote the set of external types for  $\csps$ by $\yTp\csps = (\ytp\restriction\csps)$.    We require that either $\xTp\csps \subseteq \TNoi\TpiP\TpiT$ (in which case we  refer to $\csps$ as \emph{noble}),   or $(\xTp\csps) \cap \TNoi\TpiP\TpiT = \eset$, equivalently $\xTp\csps  \subseteq \TPsi\TpiP\TpiT$ (it which case we refer to $\csps$ as  \emph{peasant}).  This is the analogue of Condition~\refcondstpx for star-types.  \item[\condcspnx]\label{cond:cspnx}  If $\csps$ is noble and $\tpIn \in \xTp\csps$ is any (noble) internal type,  then no $\tpTt \in \stps$ has $\ytp\tpTt = \tpIn$.  This is the analogue of Condition~\refcondstpkx for star-types.  This implies that if $\csps$ is noble, then $\xTp\csps \cap \yTp\csps =  \eset$, that is the internal and external types are disjoint.  \item[\condcspny]\label{cond:cspny}  If $\tpIn \in \TNoi\TpiP\TpiT \sub \xTp\csps$ is any noble type  that is not internal and $\tpIp \in \xTp\csps$ is any internal type, then  some (possibly many) $\tpTt \in \stps$ has $\xtp\tpTt = \tpIp$ and $\ytp\tpTt  = \tpIn$.  This is the analogue of Condition~\refcondstpky for star-types.  \item[\condcspm]\label{cond:cspm}  This is not a condition. The notion of local consistency  will be the analogue of Condition~\refcondstpm for star-types.\end{itemize}\end{definition}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,let $\StrA$ be a nobly distinguished model for $\Tpi\TpiP\TpiT$ and suppose that$\relE = \at\StrA\se \neq (\domAA)$ is not full on $\domA$, equivalently that $\relE$ has at least$2$ equivalence classes.The \emph{cosmic spectrum} $\csps = \cspIX\StrA\eclX$ of a galaxy$\galX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpiTc}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]\end{definition}\begin{remark}\label{rem:many-csp-str}Then $\csps$ is indeed a cosmic spectrum over $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}That $\csps$ is nonempty follows from the assumption that $\relE$ is not full on$\domA$. We verify the conditions for a cosmic spectrum:\begin{itemize}  \item[\refcondcspx]   Let $\csps \in \Cert$, so $\csps = \cspIX\StrA\eclX$ for some galaxy $\eclX  \in \Ecl\relE$. Since $\StrA$ is nobly distinguished, either $\eclX$ is a  noble galaxy in which case it only realizes noble types, or is a peasant  galaxy in which case it only realizes peasant types.  \item[\refcondcspnx]  Suppose that $\csps$ is noble and let $\tpIn \in \xTp\csps$ be any (noble)  internal type. Then no cosmic $\tpTt \in \TpiTc$ connects $\tpIn$ with itself.  \item[\refcondcspny]  Let $\tpIn \in \TNoi\TpiP\TpiT \sub \xTp\csps$ be any noble type that is not  internal and let $\tpIp \in \xTp\csps$ be any internal $1$-type.  Then some $\ea \in \galX$ has $\tpIa\StrA\ea = \tpIp$ and no $\eb \in \galX$  has $\tpIa\StrA\eb = \tpIn$.  Since $\StrA$ is a $\Tpi\TpiP\TpiT$-model, some $\eb \in \domA \sub \galX$ has  $\tpIa\StrA\eb = \tpIn$.  Then the cosmic $2$-type $\tpTt = \tpIab\StrA\ea\eb \in \csps$ has $\xtp\tpTt  = \tpIp$ and $\ytp\tpTt = \tpIn$.\end{itemize}\end{proof}\begin{remark}\label{rem:many-csp-part}Let $\csps$ be a cosmic spectrum over $\Tpi\TpiP\TpiT$.Let $\TNoii\csps\TpiP\TpiT = \TNoi\TpiP\TpiT \cap \xTp\csps$ be the set ofinternal noble types and let $\TNoio\csps\TpiP\TpiT = \TNoi\TpiP\TpiT \cap\yTp\csps$ be the set of external noble types.Then the sets $\TNoii\csps\TpiP\TpiT$ and $\TNoio\csps\TpiP\TpiT$ partition$\TNoi\TpiP\TpiT$.Let $\TKgii\csps\TpiP\TpiT = \TKgi\TpiP\TpiT \cap \xTp\csps$ be the set ofinternal king types and let $\TKgio\csps\TpiP\TpiT = \TKgi\TpiP\TpiT \cap\yTp\csps$ be the set of external king types.Then the sets $\TKgii\csps\TpiP\TpiT$ and $\TKgio\csps\TpiP\TpiT$ partition$\TKgi\TpiP\TpiT$.\end{remark}\begin{proof}It is sufficient to show that $\TNoio\csps\TpiP\TpiT = \TNoi\TpiP\TpiT \sub\TNoii\csps\TpiP\TpiT$.First, let $\tpIn \in \TNoio\csps\TpiP\TpiT$ be any external noble type, so$\tpIn \in \yTp\csps$.Suppose towards a contradiction that $\tpIn \in \TNoii\csps\TpiP\TpiT$. Then$\tpIn \in \xTp\csps$, so $\csps$ must be noble. By Condition~\refcondcspnx,no $\tpTt \in \csps$ has $\ytp\tpTt = \tpIn$ --- a contradiction.Next, let $\tpIn \in \TNoi\TpiP\TpiT \sub \TNoii\csps\TpiP\TpiT$ be any nobletype that is not internal.Let $\tpIp \in \xTp\csps$ be any internal type (recall that $\csps$ isnonempty).By Condition~\refcondcspny, some $\tpTt \in \csps$ has $\xtp\tpTt = \tpIn$,hence $\tpIn \in \TNoio\csps\TpiP\TpiT$.\end{proof}\begin{remark}\label{rem:many-csp-sub}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\TpiTp\subseteq \TpiT$ be a nonempty subset that is closed under inversion.According to~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is a type instance over$\ClSig\SigS\sms$.Suppose that $\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$.Then if $\csps \subseteq \TpiTpc$ is a cosmic spectrum over$\Tpi\TpiP\TpiT$, then it is also a cosmic spectrum over $\Tpi\TpiP\TpiTp$.This is the analogue of~\Cref{rem:stp-sub} for cosmic spectrums.\end{remark}\begin{proof}We verify the conditions for a cosmic spectrum $\csps$ over $\Tpi\TpiP\TpiTp$:\begin{itemize}  \item[\refcondcspx]  By Condition~\refcondcspx~ for the $\Tpi\TpiP\TpiT$-cosmic spectrum $\csps$,  we have that either $\xTp\csps \subseteq \TNoi\TpiP\TpiT = \TNoi\TpiP\TpiTp$,   or $\xTp\csps \subseteq \TPsi\TpiP\TpiT = \TPsi\TpiP\TpiTp$.  \item[\refcondcspnx]  If $\csps$ is noble and $\tpIn \in \xTp\csps \subseteq \TNoi\TpiP\TpiTp =  \TNoi\TpiP\TpiT$ is any (noble) internal type, then by Condition~\refcondcspnx  for the $\Tpi\TpiP\TpiT$-cosmic spectrum $\csps$ we have that no $\tpTt \in  \csps$ has $\ytp\tpTt = \tpIn$.  \item[\refcondcspny]  If $\tpIn \in (\TNoi\TpiP\TpiTp \sub \xTp\csps) = (\TNoi\TpiP\TpiT \sub  \xTp\csps)$ is any noble type that is not internal and $\tpIp \in \xTp\csps$  is any internal type, then by Condition~\refcondcspny~ for the  $\Tpi\TpiP\TpiT$-cosmic spectrum $\csps$, we have that some $\tpTt \in \csps$  has $\xtp\tpTt = \tpIp$ and $\ytp\tpTt = \tpIn$.\end{itemize}\end{proof}\begin{remark}[Cosmic spectrum extension]\label{rem:many-csp-ext}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, let $\csps$ be acosmic spectrum over $\Tpi\TpiP\TpiT$ and let $\tpTt \in \TpiTc$ be acosmic $2$-type such that $\xtp\tpTt \in \xTp\csps$ and $\ytp\tpTt \in\TPsi\TpiP\TpiT$ is a peasant type.Then $\cspsp = \csps \cup \set\tpTt$ is a cosmic spectrum over $\Tpi\TpiP\TpiT$.This is the analogue of~\Cref{rem:star-type-ext} for cosmic spectrums.\end{remark}\begin{proof}We verify the conditions for a cosmic spectrum $\cspsp$ over $\Tpi\TpiP\TpiT$:\begin{itemize}  \item[\refcondcspx]  Since $\xtp\tpTt \in \xTp\csps$ we have $\xTp\cspsp = \xTp\csps$.   Then either $\xTp\cspsp \subseteq \TNoi\TpiP\TpiT$ or  $\xTp\cspsp \subseteq \TNoi\TpiP\TpiT$ by Condition~\refcondcspx~ for the  cosmic spectrum $\csps$.  \item[\refcondcspnx]  Suppose that $\cspsp$ is noble and let $\tpIn \in \xTp\cspsp = \xTp\csps$ be  any (noble) internal type. Suppose towards a contradiction that some $\tpTtp \in \cspsp$  has $\ytp\tpTtp = \tpIn$. Since $\ytp\tpTt$ is a peasant type we must have  $\tpTt \in \csps$. This is a contradiction with Condition~\refcondcspnx~ for  the cosmic spectrum $\csps$.  \item[\refcondcspny]  Let $\tpIn \in \TNoi\TpiP\TpiT \sub \xTp\cspsp$ be any noble type that is not  internal and let $\tpIp \in \xTp\cspsp$ be any internal type. Since  $\xTp\cspsp = \xTp\csps$, by Condition~\refcondcspny~ for the cosmic spectrum  $\csps$ we have that some $\tpTt \in \csps \subseteq \cspsp$ has $\xtp\tpTt =  \tpIp$ and $\ytp\tpTt = \tpIn$.\end{itemize}\end{proof}\subsection{Locally consistent cosmic spectrums}We like to think about a cosmic spectrum of a galaxy as the \emph{reason why}that galaxy is possible. For this we need to define the notion of a\emph{locally consistent} cosmic spectrum. For this we extract a type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the \emph{simpler logic}$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$ out of the cosmic spectrum $\csps$.\begin{definition}[Spectral type instance]Let $\Tpi\TpiP\TpiT$ be a type instance over the$\Lvp\Fo2\nopow\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$and let $\csps \subseteq \TpiTc$ be a cosmic spectrum over $\Tpi\TpiP\TpiT$.Let $\si$ (intended to label the inside of the galaxy) and $\sbh$ (intended tolabel some \emph{black hole} outside the galaxy) be two new unary predicatesymbols. Define the following sets of literals: \begin{align*}  \tIN(\xx) &= \set{\si(\xx),\lnot\sbh(\xx)} \\  \tOUT(\xx) &= \set{\lnot\si(\xx), \lnot\sbh(\xx)} \\  \tBH(\xx) &= \set{\lnot\si(\xx), \sbh(\xx)}.\end{align*}For a $1$-type $\tpIp\in\TpiP$ or a $2$-type $\tpTt\in\TpiT$, denote by$\noe\tpIp$ and $\noe\tpTt$ the reducts of $\tpIp$ and $\tpTt$ to the language $\SigS - \set{\se}$.That is, $\noe\tpIp \subset \tpIp$ and $\noe\tpTt \subset \tpTt$ consist ofthose literals that do not feature the predicate symbol $\se$.Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$ be apredicate signature over $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$.Define the \emph{spectral type instance} $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ of thecosmic spectrum $\stps$ as a type instance over $\ClSig\SigSp\sms$ as follows:\begin{itemize}  \item[\sticondI]\label{sti-I}  For every internal $\tpIp \in \xTp\stps$   add $\tin\tpIp = (\noe\tpIp \cup \tIN(\xx))$ to $\TpiPs\csps$.  Call $\tin\tpIp$ an internal type.  \item[\sticondO]\label{sti-O}  For every external $\tpIp \in \yTp\stps$  add $\tout\tpIp = (\noe\tpIp \cup \tOUT(\xx))$ to $\TpiPs\csps$.  Call $\tout\tpIp$ an external type.     Note that a peasant type $\tpIp \in \TPsi\TpiP\TpiT$ might yield both an  internal and external type,  but by~\Cref{rem:many-csp-part}, an internal noble type $\tpIn \in  \TNoii\csps\TpiP\TpiT$ yields a unique (internal) type and an external noble  type $\tpIn \in \TNoio\csps\TpiP\TpiT$ yields a unique (external) type.  \item[\sticondB]\label{sti-B}  Let $\tpIb$ be an arbitrary but fixed $1$-type over $\SigSp$ that extends  $\tBH(\xx)$.  Call $\tpIb$ the \emph{black hole type} and add it to $\TpiPs\csps$.  \item[\sticondII]\label{sti-II}  For every galactic $\tpTt \in \TpiTg$  add $\tii\tpTt = (\noe\tpTt \cup \tIN(\xx) \cup \tIN(\yy))$ to $\TpiTs\csps$.  Note that also the inverse $\inv{(\tii\tpTt)} = \tii{(\inv\tpTt)}$ would be  added.  \item[\sticondIO]\label{sti-IO}  For every (cosmic) $\tpTt \in \stps$  add $\tio\tpTt = (\noe\tpTt \cup \tIN(\xx) \cup \tOUT(\yy))$ and its inverse  $\inv{(\tio\tpTt)} = \toi{(\inv\tpTt)}$ to $\TpiTs\csps$.  \item[\sticondOO]\label{sti-OO}  For every unordered pair of (not necessarily distinct) $1$-types $\tpIp,  \tpIpp \in \TpiP \sub \TNoii\csps\TpiP\TpiT$, let $\tpTt = \too\tpIp\tpIpp$   be an arbitrary but fixed $2$-type over $\SigSp$ that extends $\tOUT(\xx)  \cup \tOUT(\yy)$. The choice is made symmetrically, so that  $\inv{(\too\tpIp\tpIpp)} = \too\tpIpp\tpIp$.  Add $\too\tpIp\tpIpp$ to $\TpiTs\csps$ except in the case when $\tpIp =  \tpIpp \in \TKgio\csps\TpiP\TpiT$ denote the same external king type.  \item[\sticondIB]\label{sti-IB}  For every internal type $\tin\tpIp \in \TpiPs\csps$,  let $\tpTt = \tib\tpIp$ be an arbitrary but fixed $2$-type over $\SigSp$ that  connects $\tin\tpIp$ and the black hole type $\tpIb$, witnesses no message  symbol for $\tpIpp$ and every message symbol for $\tpIb$,   that is $\xtp\tpTt = \tin\tpIp$, $\ytp\tpTt = \tpIb$, $(\lnot\sm(\xx,\yy))  \in \tpTt$ and $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$.  Add $\tpTt$ and its inverse to $\TpiTs\csps$.  \item[\sticondOB]\label{sti-OB}  For every external type $\tout\tpIp \in \TpiPs\csps$,  let $\tpTt = \tob\tpIp$ be an arbitrary but fixed $2$-type over $\SigSp$ that  connects $\tout\tpIp$ and the black hole type $\tpIb$ and witnesses every  message symbol for $\tout\tpIp$,  that is $\xtp\tpTt = \tout\tpIp$, $\ytp\tpTt = \tpIb$ and $\sm(\xx,\yy) \in  \tpTt$ for every $\sm \in \sms$.  Add $\tpTt$ and its inverse to $\TpiTs\csps$.\end{itemize}This completes the description of the spectral type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-classified signature$\ClSig\SigSp\sms$ is realizable.\end{definition}\begin{remark}Let $\csps$ be a cosmic spectrum over $\Tpi\TpiP\TpiT$ and let$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ be the spectral type instance of $\csps$.Suppose that $\csps$ is noble and let $\tpIk \in \TKgii\csps\TpiP\TpiT$ be anyinternal king type.Then $\tin\tpIk \in \TKgi{\TpiPs\csps}{\TpiTs\csps}$ is an internalking type over $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.\end{remark}\begin{proof}The type $\tin\tpIk$ is added to $\TpiPs\csps$ at stage \refsticondI.Suppose towards a contradiction that some $\tpTtp \in \TpiTs\csps$ connects$\tin\tpIk$ with itself.By construction, $\tpTtp$  must be added at stage~\refsticondII, so$\tpTtp = \tii\tpTt$ for some galactic $\tpTt \in \TpiTg$. Then $\tpTt$ connects$\tpIk$ with itself --- a contradiction.\end{proof}\begin{remark}Let $\csps$ be a cosmic spectrum over $\Tpi\TpiP\TpiT$ and let$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ be the spectral type instance of $\csps$.Let $\tpIk \in \TKgio\csps\TpiP\TpiT$ be any external king type.Then $\tout\tpIk \in \TKgi{\TpiPs\csps}{\TpiTs\csps}$ is an external king typeover $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.\end{remark}\begin{proof}The type $\tout\tpIk$ is added to $\TpiPs\csps$ at stage \refsticondO.Suppose towards a contradiction that some $\tpTtp \in \TpiTs\csps$ connects$\tout\tpIk$ with itself.By construction, $\tpTtp$ must be added at stage~\refsticondOO, so$\tpTtp = \too\tpIk\tpIk$ --- a contradiction with the requirement at stage\refsticondOO~ that $\tpIp$ and $\tpIpp$~ must not denote the same external kingtype.\end{proof}\begin{remark}\label{rem:many-sti-int-kings}Let $\csps$ be a noble cosmic spectrum over $\Tpi\TpiP\TpiT$ and let$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ be the spectral type instance of $\csps$.If $\tin\tpIp \in \TKgi{\TpiPs\csps}{\TpiTs\csps}$ is an internal king type,then $\tpIp \in \TKgii\csps\TpiP\TpiT$ is an internal king type.\end{remark}\begin{proof}By construction $\tpIp \in \xTp\csps$ must be an internal type. Suppose towardsa contradiction that $\tpIp \not\in\TKgi\TpiP\TpiT$ is not a king type. Thensome $\tpTt \in \TpiT$ connects $\tpIp$ with itself. If $\tpTt \in \TpiTg$ isgalactic, then by construction $\tii\tpTt \in \TpiTs\csps$ connects $\tin\tpIp$with itself --- a contradiction.If $\tpTt \in \TpiTc$ is cosmic, then $\tpIp \in \xTp\csps$ is not noble, so$\csps$ is not noble --- a contradiction.Therefore $\tpIp \in \TKgi\TpiP\TpiT$ and since $\tpIp$ is internal, we have$\tpIp \in \TKgii\csps\TpiP\TpiT$.\end{proof}\begin{remark}\label{rem:many-nd-csp-sub}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\TpiTpc \subseteq \TpiTc$ be a nonempty subset of cosmic types that isclosed under inversion. Let $\TpiTp = \TpiTg \cup \TpiTpc$.According to~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is a type instance over$\ClSig\SigS\sms$.Suppose that $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$ and $\TNoi\TpiP\TpiTp =\TNoi\TpiP\TpiT$.According to~\Cref{rem:many-csp-sub}, if $\csps \subseteq \TpiTpc$ is a cosmicspectrum over $\Tpi\TpiP\TpiT$, then it is also a cosmic spectrum over$\Tpi\TpiP\TpiTp$.Then if $\csps \subseteq \TpiTpc$ is a locally consistent cosmicspectrum over $\Tpi\TpiP\TpiT$, then it is also a locally consistent cosmicspectrum over $\Tpi\TpiP\TpiTp$.This is the analogue of~\Cref{rem:stp-sub} for locally consistent cosmicspectrums.\end{remark}\begin{proof}Consider the spectral type instance $\Tpi{\TpiP^\csps}{\TpiTp^\csps}$ of $\csps$as a cosmic spectrum over $\Tpi\TpiP\TpiTp$.We claim that $\TpiTp^\csps = \TpiT^\csps$. We check this for every stage of theconstruction of $2$-types:\begin{itemize}  \item[\refsticondII]  The types of the form $\tii\tpTt \in \TpiTp^\csps$ are exactly the ones where  $\tpTt \in \TpiTpg = \TpiTg$, so are exactly the ones where $\tii\tpTt \in  \TpiT^\csps$.  \item[\refsticondIO]  The types of the form $\tio\tpTt \in \TpiTp^\csps$ are exactly the ones where  $\tpTt \in \csps$, so are exactly the ones where $\tio\tpTt \in \TpiT^\csps$.  \item[\refsticondOO]  The types of the form $\too\tpIp\tpIpp \in \TpiTp^\csps$ are exactly the ones  where $\tpIp,\tpIpp \in \TpiP \sub \TNoii\csps\TpiP\TpiTp =  \TNoii\csps\TpiP\TpiT$, except for $\tpIp = \tpIpp \in \TKgio\csps\TpiP\TpiTp  = \TKgio\csps\TpiP\TpiT$, so are exactly the ones where $\too\tpIp\tpIpp \in  \TpiT^\csps$.  \item[\refsticondIB]  The types of the form $\tib\tpIp \in \TpiTp^\csps$ are exactly the ones where  $\tpIp \in \xTp\csps$, so are exactly the ones where  $\tib\tpIp \in \TpiT^\csps$.  \item[\refsticondOB]  The types of the form $\tob\tpIp \in \TpiTp^\csps$ are exactly the ones where  $\tpIp \in \yTp\csps$, so are exactly the ones where  $\tob\tpIp \in \TpiT^\csps$.\end{itemize}\end{proof}\begin{remark}\label{rem:many-nd-csp-str}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,let $\StrA$ be a nobly distinguished model for $\Tpi\TpiP\TpiT$ such that $\relE= \at\StrA\se$ is not full on $\domA$ and let $\galX \in \Ecl\relE$ be anygalaxy.Then the cosmic spectrum $\csps = \cspIX\StrA\galX$ is a locally consistentcosmic spectrum over $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}By~\Cref{rem:many-csp-str}, $\csps$ is a cosmic spectrum over $\Tpi\TpiT\TpiP$.Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$.We build a $\SigSp$-structure $\StrAp$ based on $\StrA$ that realizes thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The domain of $\StrAp$ is $\domAp = \domA \cup \set{\eo}$, where $\eo$ is the new \emph{black hole}element.The $1$-type of every element $\ea \in \domAp$ is defined as follows:\begin{itemize}  \item[\refsticondI]  If $\ea \in \galX$ is inside the galaxy, then note that $\tpIp =  \tpIa\StrA\ea$ is internal and let $\tpIa\StrAp\ea = \tin\tpIp$.  \item[\refsticondO]  If $\ea \in \domA \sub \galX$ is outside the galaxy, then note that $\tpIp =  \tpIa\StrA\ea$ is external and let $\tpIa\StrAp\ea = \tout\tpIp$.  \item[\refsticondB]  If $\ea = \eo$ is the black hole, then let $\tpIa\StrAp\ea = \beta$.\end{itemize}The $2$-type between every pair of distinct elements $\ea \neq \eb \in \domA'$is defined as follows:\begin{itemize}  \item[\refsticondII]  If both $\ea,\eb \in \galX$ are inside, then let  $\tpIab\StrAp\ea\eb = \tii{\tpIab\StrA\ea\eb}$.  Note that we would symmetrically assign $\inv{\tpIab\StrAp\ea\eb}$ to  $\tpIab\StrAp\eb\ea$.  \item[\refsticondIO]  If $\ea \in \galX$ is inside and $\eb \in \domA \sub  \galX$ is outside, then let  $\tpIab\StrAp\ea\eb = \tio{\tpIab\StrA\ea\eb}$.  Note that this case covers the symmetric assignments where $\ea \in  \domA\sub\galX$ and $\eb \in \galX$.  \item[\refsticondOO]  Let both $\ea, \eb \in \domA\sub\galX$ be outside and let  $\tpIp = \tpIa\StrA\ea$ and $\tpIpp = \tpIa\StrA\eb$.  % TODO: nd-char for this  Note that $\tpIp, \tpIpp \not\in \TNoii\csps\TpiP\TpiT$.   Let $\tpIab\StrAp\ea\eb = \too\tpIp\tpIpp$.  Note that we would symmetrically assign $\inv{\tpIab\StrAp\ea\eb}$ to  $\tpIab\StrAp\eb\ea$.    \item[\refsticondIB]  If $\ea \in \galX$ is inside and $\eb = \eo$ is the black hole, then note  that $\tpIp = \tpIa\StrA\ea \in \xTp\csps$ is internal and let  $\tpIab\StrAp\ea\eb = \tib\tpIp$.  \item[\refsticondOB]  If $\ea \in \domA\sub\galX$ is outside and $\eb = \eo$ is the black hole,  then note that $\tpIp = \tpIa\StrA\ea$ is external and let  $\tpIab\StrAp\ea\eb = \tob\tpIp$.\end{itemize}We have to verify that $\StrAp$ is indeed a $\ClSig\SigSp\sms$-structure, thatis that the star-type of every element of $\ea \in \domAp$ contains$\sm(\xx,\yy)$ for every message symbol $\sm \in \sms$:\begin{itemize}  \item[\refsticondI]  Let $\ea \in \galX$ be inside. Since $\StrA$ is a $\ClSig\SigS\sms$-structure,  some $\eb \in \domA \sub \set\ea$ has $\sm(\xx,\yy) \in \tpTt =  \tpIab\StrA\ea\eb$.  If $\eb \in \galX$, then $\tpTt \in \TpiTg$ and $\tpIab\StrAp\ea\eb =  \tii\tpTt$ contains $\sm(\xx,\yy)$.  If $\eb \in \domA \sub \galX$, then $\tpTt \in \csps$ and $\tpIab\StrAp\ea\eb   = \tio\tpTt$ contains $\sm(\xx,\yy)$.  \item[\refsticondO]  Let $\ea \in \domA \sub \galX$ be outside. Then $\tpIab\StrAp\ea\eo$ contains  $\sm(\xx,\yy)$.  \item[\refsticondB]  Let $\ea = \eo$ be the black hole. Let $\eb \in \galX$ be any element inside  the galaxy (which is nonempty). Note that $\tpIp = \tpIa\StrA\eb \in  \xTp\csps$ is internal. So $\tpIab\StrAp\ea\eb = \inv{(\tin\tpIp)}$ contains  $\sm(\xx,\yy)$.\end{itemize}Next we verify that $\StrAp$ is a model for $\Tpi{\TpiPs\csps}{\TpiTs\csps}$:\begin{itemize}  \item[\refcondrealizI]  By construction $\tpIa\StrAp\ea \in \TpiPs\csps$ for every $\ea \in \domAp$.  \item[\refcondrealizII]  By construction $\tpIab\StrAp\ea\eb \in \TpiTs\csps$ for every $\ea \neq \eb  \in \domAp$.  \item[\refcondrealizp]  By construction every $\tpIpp \in \TpiPs\csps$ is realized in $\StrAp$.  \item[\refcondrealizk]  Let $\tpIpp \in \TpiPs\csps$ be realized by a unique element $\ea \in \domAp$  in $\StrAp$.  We have to show that $\tpIpp \in \TKgi{\TpiPs\csps}{\TpiTs\csps}$.  If $\tpIpp = \tpIb$, then $\tpIpp \in \TKgi{\TpiPs\csps}{\TpiTs\csps}$ by  construction.  Suppose towards a contradiction that some $\tpTtp \in \TpiTs\csps$ connects  $\tpIpp$ with itself.  If $\tpIpp = \tin\tpIp$, then $\ea \in \galX$, $\tpIa\StrA\ea = \tpIp$,  $\tpIp \in \xTp\csps$ and $\tpTtp = \tii\tpTt$  for some $\tpTt \in \TpiTg$, so $\tpIp$ is not a king type. Since $\StrA$ is a  $\Tpi\TpiP\TpiT$-model, there is some $\eb \in \domA \sub \set\ea$ such that  $\tpIa\StrA\eb = \tpIp$. If $\eb \in \galX$, then $\tpIa\StrAp\eb = \tpIpp$,  which is a contradiction.\end{itemize}\end{proof}\subsection{Certificates}\begin{definition}A certificate $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$ is a nonemptyset of cosmic spectrums over $\Tpi\TpiP\TpiT$ satisfying the followingconditions:\begin{itemize}  \item[\condcertmi]\label{cond:certmi}  If $\tpTt \in \csps$ for some $\csps \in \Cert$, then  $\inv\tpTt \in \cspsp$ for some $\cspsp \in \Cert$,   that is there are cosmic spectrums for the endpoints of every (cosmic)  $2$-type used in the certificate.  Equivalently, $\TpiTc' = \cup\Cert$ is closed under inversion.  By~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is also a type instance over  $\ClSig\SigS\sms$, where $\TpiTp = \TpiTg\cup\TpiTc'$.  Call $\Tpi\TpiP\TpiTp$ the \emph{filtered type instance} of $\Cert$.  \item[\condcertmN]\label{cond:certmN}  We require that $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiTp$ and $\TNoi\TpiP\TpiTp =  \TNoi\TpiP\TpiT$, that is the notion of a king type or a noble type with  respect to the filtered type instance coincides with the respective notion with respect  to the original type instance.  By~\Cref{rem:many-csp-sub}, every cosmic spectrum $\csps \in \Cert$ is also a  cosmic spectrum over $\Tpi\TpiP\TpiTp$.  We further require that every cosmic spectrum $\csps \in \Cert$ is locally  consistent with respect to $\Tpi\TpiP\TpiTp$.  \item[\condcertmp]\label{cond:certmp}  If $\tpIp \in \TpiP$, then some (possibly many) $\csps \in \Cert$ has $\tpIp  \in \xTp\csps$.  \item[\condcertmn]\label{cond:certmn}  If $\tpIn \in \TNoi\TpiP\TpiT$, then a unique $\csps \in \Cert$ has $\tpIn  \in \xTp\csps$. Note that the existence is already implied by~\refcondcertmp.  \item[\condcertmc]\label{cond:certmc}  Let $\tpIp, \tpIpp \in \TpiP$.   If it is not the case that $\tpIp = \tpIpp = \tpIn \in \csps \cap  \TNoi\TpiP\TpiTp$ for some (noble) cosmic spectrum $\csps \in \Cert$,  then some cosmic $2$-type $\tpTt \in \TpiTpc = \cup\Cert$ connects $\tpIp$ and  $\tpIpp$, that is if $\tpIp$ and $\tpIpp$ don't come from the  same noble galaxy, then they are cosmically connectable.\end{itemize}\end{definition}Again, in general the size of a certificate is only exponentially bounded interms of the size of the type instance. But again, polynomial certificatesexist:\begin{lemma}[Certificate extraction]\label{lem:cert-extr-many}Let $\Tpi\TpiP\TpiT$ be a type instance,let $\StrA$ be a nobly distinguished model for $\Tpi\TpiP\TpiT$such that $\relE = \at\StrA\se$ is not full on $\domA$and let $\Tpi\TpiP\TpiTp = \TpiP\TpiT[\StrA]$ be the type instance of $\StrA$.For every cosmic type $\tpTt \in \TpiTpc$, let $\eat\tpTt \neq \ebt\tpTt \in \domA$ be two distinct elementssuch that $\tpIab\StrA{\eat\tpTt}{\ebt\tpTt} = \tpTt$.Necessarily $\eat\tpTt$ and $\ebt\tpTt$ are in different galaxies.The choice is made symmetrically, that is $\eat{\inv\tpTt} = \ebt\tpTt$ and$\ebt\tpTt = \eat{\inv\tpTt}$. Let\[  \Cert = \setbd{\cspIX\StrA{\relE[\eat\tpTt]}}{\tpTt \in \TpiTpc}.\]Then $\Cert$ is a certificate for $\Tpi\TpiP\TpiT$.Moreover, its size is linearly bounded by $\card\TpiTp$, hence also by the sizeof $\Tpi\TpiP\TpiT$.\end{lemma}\begin{proof}The certificate $\Cert$ is nonempty since $\relE$ is not full on $\domA$.We check the conditions for a certificate:\begin{itemize}  \item[\refcondcertmi]  That $\cup\Cert = \TpiTpc$ is closed under inversion follows from  Condition~\refcondtpii for the type instance $\Tpi\TpiP\TpiTp$.  \item[\refcondcertmN]  That $\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$ follows  from~\Cref{rem:many-nd-tpi-str-ex}.  That $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$ follows  from~\Cref{rem:tpi-str-ex}.  \item[\refcondcertmp]  \item[\refcertcondIp] By construction, $\Tpi\TpiP\TpiTp$ is a type instance  and every $\csps \in \Cert$ is a locally consistent cosmic spectrum over  $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIp] Every $1$-type $\tpIp \in \TpiP$ is witnessed since  $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIIp] Every noble $1$-type $\tpIn \in \TNoi\TpiP\TpiTp$ is  witnessed uniquely, since the noble $1$-types are exactly those that are  realized at a single galaxy of $\StrA$.  \item[\refcertcondIVp] Suppose that $\tpIp, \tpIpp \in \TpiP$ is a pair of  $1$-types that are not cosmically connectable. Consider the elements realizing  these $1$-types in $\StrA$: $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \domA$.  These sets are nonempty, since $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  Next we claim that both $\at\StrA\tpIp$ and $\at\StrA\tpIpp$ are included in  the same galaxy of $\StrA$. Suppose not and let $\ea \in \at\StrA\tpIp$ and  $\eb \in \at\StrA\tpIpp$ be elements realizing the $1$-types from different  galaxies. Then $\tpIab\StrA\ea\eb \in \TpiTp$ is a cosmic type connecting  $\tpIp$ and $\tpIpp$ --- a contradiction.  Therefore $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \eclX$ for some $\eclX  \in \Ecl\relE$. Since $\StrA$ is nobly distinguished and $\Tpi\TpiP\TpiTp$ is  the type instance of $\StrA$, the $1$-types $\tpIp$ and $\tpIpp$ must be noble  over $\Tpi\TpiP\TpiTp$. By~\refcertcondIIIp, they are witnessed uniquely in  the certificate by the cosmic spectrum $\csps = \cspIX\StrA\eclX$.\end{itemize}\end{proof}\begin{lemma}[King lemma]Let $\Cert$ be a certificate for $\Tpi\TpiP\TpiT$,let $\TpiTp = \cup\Cert$.(Kings are the same since nobles are the same)Let $\tpIk \in \TKgi\TpiP\TpiT$, $\csps\in\Cert$ be the unique such that $\tpIk\in \xTp\csps$ and let $\tpIp \in \TpiP \sub \xTp\csps$.Then $\tpIk$ and $\tpIp$ are uniquely connecable -- NOPE!\end{lemma}\begin{lemma}[Certificate expansion]\label{lem:cert-exp-many}Let $\Cert$ be a certificate for the type instance $\Tpi\TpiP\TpiT$ over theclassified signature $\ClSig\SigS\sms$ over $\vFo2\Eea\sze\agrefine$. Then$\Tpi\TpiP\TpiT$ has a finite nobly distinguished model.More precisely, let $\TpiTp = \cup\Cert \subseteq \TpiT$ and let $\pt \geq\card\TpiTp$ be a parameter. Then the filtered type instance $\Tpi\TpiP\TpiTp$has a finite nobly distinguished model $\StrA$ in which every king type $\tpIk\in \TKgi\TpiP\TpiTp$ is realized once and every peasant type $\tpIp \in\TPsi\TpiP\TpiTp$ is realized at least $\pt$ times.\end{lemma}\begin{proof}Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$.For every locally consistent cosmic spectrum $\csps \in \Cert$, let$\StrAs\csps$ be a finite $\ClSig\SigSp\sms$-structure that is a model for thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$. Assume that the domainsof the structures $\StrAs\csps$ are disjoint.Let $\eclX^\csps = \at{\StrAs\csps}\si$ be the set of inside elements in themodel $\StrAs\csps$. We describe the domain $\domA$ of $\StrA$ and theinterpretation $\relE = \at\StrA\ea$ of the coarsest builtin equivalence symbolby specifying the galaxies $\eclX \in \Ecl\relE$ of $\StrA$:\begin{itemize}  \item For every noble $\csps \in \Cert$, there is a unique galaxy  $\eclX^\csps$ that has intended cosmic spectrum $\csps$.  That is $\mathcal{\eclX}^\csps = \set{\eclX^\csps}$.  Call the galaxies $\eclX^\csps$ the noble galaxies.  \item For every peasant $\csps \in \Cert$, there are three disjoint copies of  $\pt$ galaxies: $\mathcal{X}^\csps = \mathcal{X}^\csps_0 \cup  \mathcal{X}^\csps_1 \cup \mathcal{X}^\csps_2$,  $\mathcal{X}^\csps_i =  \set{\eclX^\csps_{i1},\eclX^\csps_{i2},\dots,\eclX^\csps_{it}}$ for $i \in  \set{0,1,2}$.  Call the galaxies $\eclX^\csps_{ij}$ the peasant galaxies.\end{itemize}Let $\csps : \Ecl\relE \to \Cert$ denote the intended cosmic spectrum of thegalaxies: $\csps(\eclX) = \csps$ on $\mathcal{X}^\csps$.Assign the $1$-types and the galactic $2$-types to the corresponding models forthe spectral instances:\begin{itemize}  \item $\tpIa\StrA\ea = \tpIa{\StrAs\csps}\ea \cup \set{\se(\xx,\xx)}$ and   \item $\tpIab\StrA\ea\eb = \tpIab{\StrAs\csps}\ea\eb \cup\set{\se(\xx,\xx),\se(\yy,\yy),\se(\xx,\yy),\se(\yy,\xx)}$ on $\eclX \in\mathcal{X}^\csps$.\end{itemize}It remains to assign cosmic types consistently between pairs of elements indistinct galaxies.\begin{description}\item[Realization of kings] TODO: lemmaLet $\tpIk \in \TKgi\TpiP\TpiTp$. There is a unique (noble) cosmic spectrum$\csps \in \Cert$ such that $\tpIk \in (\xtp\restriction\csps)$.Let $\tpIkp \in \TKgi\TpiP\TpiTp \sub \set{\tpIk}$. Then there is a unique(cosmic) $2$-type $\tpTt \in \cup\Cert$ connecting $\tpIk$ and $\tpIkp$.\item[Realization of noble galaxies] We first find witnesses for the intendedcosmic spectrums of noble galaxies. Let $\csps \in \Cert$,$(\xtp\restriction\csps) \subseteq \TNoi\TpiP\TpiTp$ be any noble cosmicspectrum. Its corresponding galaxy is $\eclX^\csps$.Let $\tpTt \in \csps$ be any (cosmic) type that needs to be realized.Since $\csps$ is noble, we have that $\tpIn = \xtp\tpTt \in \TNoi\TpiP\TpiTp$ isnoble.Let $Y = \eclX^\csps \cap \at\StrA\tpIn$ be the set of elements of $\StrA$ thathave intended $1$-type $\tpIn$.Let $\cspsp \in \Cert$ be a cosmic spectrumcontaining $\inv\tpTt$.Since $\csps$ is noble we must have that $\cspsp \neq \csps$. We consider twocases:\begin{itemize}  \item If $\tpInp = \ytp\tpTt \in \TNoi\TpiP\TpiTp$ is a noble type, then  $\cspsp \in \Cert$ is the unique (noble) cosmic spectrum such that $\tpInp \in  (\xtp\restriction\csps)$, so $\eclX^\cspsp$ is the unique galaxy having  intended cosmic spectrum $\cspsp$. Let $Z = \eclX^\cspsp \cap \at\StrA\tpInp$  be the set of elements of $\StrA$ having intended \end{itemize}\end{description}\end{proof}\section{TODO}Let $\tpIp,\tpIpp\in\TpiP$ be any unordered pair of $1$-types. Let$\Delta_\tpIp, \Delta_\tpIpp$ be the cosmic spectrums containing $\tpIp$ and$\tpIpp$ inside.We are going to assign $2$-types consistently between every pair or distinctelements $\ea\neq\eb \in \domA$ from distinct galaxies, in such a way that the$(\tpIp,\tpIpp)$-reduced star-type of them is realized.\begin{itemize}  \item[$(\mathcal{K}\mathcal{K})$] Suppose that $\tpIp = \tpIk \in  \TKgi\TpiP\TpiTp$ and $\tpIpp = \tpIkp \in \TKgi\TpiP\TpiTp$ are king types.  Suppose that $\tpIk \neq \tpIkp$.  \item[$(\mathcal{K})$]    If $\tpIk \in \TKgi\TpiP\TpiTp$ is a king type, then there is a unique    element $\ea \in \domA$ having $\tpIp(\ea) = \tpIk$.  \item[$(\mathcal{N})$] If $\tpIn \in \TNoi\TpiP\TpiTp$ is any noble type, then  there is a unique (noble) cosmic spectrum $\csps$ containing it inside; that  is there is a unique galaxy $\eclX$ that contains all the elements having  intended $1$-type $\tpIn$.\end{itemize}\end{comment}