% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featuring $\sze \geq 1$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement.By convention let $\see0$ be the formal equality, so that$\Lvp\Fo2\nopow\Eea0\agrefine$ means $\vFo2$.Abbreviate the coarsest equivalence symbol $\se = \see\sze$.The following reductions carry over from the previous section:\begin{align*}  \FinASat{\vFo2\Eea\sze\agrefine} &\red\cNP \FinAClSat{\vFo2\Eea\sze\agrefine}  \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNExpTime  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.\end{align*}We proceed to define new terms.The terminology is based on~\cite{MALQ:MALQ201400102}.Let $\ClSig\SigS\sms$ be a predicate signature over $\vFo2\Eea\sze\agrefine$.A \twotype/ $\tpt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in \tpt$.Otherwise, that is if $(\lnot\se(\xx,\yy)) \in \tpTt$,the \twotype/ $\tpt$ is a \emph{cosmic type}.Let $\TI$ be a type instance over $\ClSig\SigS\sms$.The sets of galactic and cosmic types in $\TI$ are $\TIg$ and $\TIc$,respectively.Two \onetypes/ $\tpp, \tppp \in \TP\TI$ are \emph{cosmically connectable} ifsome cosmic $\tpt \in \TIc$ connects them.A \onetype/ $\tpn$ is a \emph{noble type} if it is not cosmicallyconnectable with itself;the set of noble types is $\TN\TI$.A \onetype/ $\tpp$ that is not a noble type is a \emph{peasant type};the set of peasant types is $\TPs\TI$.So we have $\TP\TI = \TN\TI \cup \TPs\TI$,$\TK\TI \subseteq \TN\TI$ and $\TPs\TI \subseteq \TW\TI$.We think of the $\se$-classes in a $\ClSig\SigS\sms$-structure as\emph{galaxies};of the whole structure as the \emph{cosmos};of the galactic \twotypes/ as characterizing theinteractions in the interior of the galaxiesand of cosmic \twotypes/ characterize the interactions between differentgalaxies.Let $\StrA$ be a model for $\TI$.An element realizing a noble type is a \emph{noble element}.An element realizing a peasant type is a \emph{peasant element}.We denote the galaxies of $\StrA$ by $\Gals\StrA = \Ecl{\at\StrA\se}$.A galaxy $\galX\in\Gals\StrA$ is a \emph{noble galaxy} if it contains a nobleelement.Otherwise, that is if every $\ea\in\galX$ is a peasant,the galaxy $\galX$ is a \emph{peasant galaxy}.The sets of noble and peasant galaxies are $\GalsN\StrA$ and $\GalsP\StrA$,respectively.So we have $\Gals\StrA = \GalsN\StrA \cup \GalsP\StrA$.If $\galX \in \Gals\StrA$ is a galaxy, denote$\tpIa\StrA\galX = \setbd{\tpIa\StrA\ea}{\ea\in\galX}$ to be the set of\onetypes/ realized by elements of $\galX$.\begin{lemma}[Galaxy Characterization] Let $\StrA$ be a model for $\TI$.Then:\begin{enumerate}  \item  If $\galX\in\GalsP\StrA$,  then $\tpIa\StrA\galX \subseteq \TPs\TI$,  or equivalently every $\tpp\in\tpIa\StrA\galX$ has $\tpp\in\TPs\TI$.  \item  If $\galX\in\GalsN\StrA$,  then $\tpIa\StrA\galX \cap \TN\TI \neq \eset$,  or equivalently some $\tpn\in\tpIa\StrA\galX$ has $\tpn\in\TN\TI$.  \item  $\tpp\in\TP\TI$ iff some $\galX\in\Gals\StrA$ has  $\tpp\in\tpIa\StrA\galX$.    \item  $\tpn\in\TN\TI$ iff a unique $\galX\in\Gals\StrA$ has  $\tpn\in\tpIa\StrA\galX$.  \item  $\tpp\in\TPs\TI$ iff for every $\galX\in\Gals\StrA$ such that  $\tpp\in\tpIa\StrA\galX$ there is some $\galY\in\Gals\StrA\sub\set\galX$  having $\tpp\in\tpIa\StrA\galY$.\end{enumerate}We will be applying this lemma implicitly.\end{lemma}\begin{proof}\begin{enumerate}  \item This follows by the definition of peasant galaxy.    \item This follows by the definition of noble galaxy.    \item  If $\tpp\in\TP\TI$, then some $\ea\in\domA$ has $\tpIa\StrA\ea = \tpp$,  so $\galX = \at\StrA\se[\ea] \in \Gals\StrA$ has $\tpp\in\tpIa\StrA\galX$.  If some $\galX\in\Gals\StrA$ has $\tpp\in\tpIa\StrA\galX$, then some  $\ea\in\galX$ has $\tpIa\StrA\ea = \tpp$, so $\tpp\in\TP\TI$.    \item  If $\tpn\in\TN\TI$, then some $\galX\in\Gals\StrA$ has  $\tpn\in\tpIa\StrA\galX$, so some $\ea\in\galX$ has $\tpIa\StrA\ea = \tpn$.  Suppose towards a contradiction that some other  $\galY\in\Gals\StrA\sub\set\galX$ has $\tpn\in\tpIa\StrA\galY$,  so some $\eb\in\galY$ has $\tpIa\StrA\eb = \tpn$.  Then $\tpt = \tpIab\StrA\ea\eb \in \TI$ is a cosmic type connecting $\tpn$  with itself --- a contradiction.    Next suppose that $\tpp\in\TP\TI\sub\TN\TI = \TPs\TI$, so some cosmic  $\tpt\in\TI$ connects $\tpp$ with itself.  Then some $\ea\in\domA$ and $\eb\in\domA\sub\set\ea$  have $\tpIab\StrA\ea\eb = \tpt$.  Let $\galX = \at\StrA\se[\ea] \in \Gals\StrA$  and $\galY = \at\StrA\se[\eb] \in \Gals\StrA$.  Since $\tpt$ is cosmic, $\galX\neq\galY$.  So we have that $\tpp\in\tpIa\StrA\galX$  $\tpp\in\tpIa\StrA\galY$ is realized in at least $2$ galaxies.    \item  First suppose that $\tpp\in\TPs\TI$ and that $\galX\in\Gals\StrA$  has $\tpp \in \tpIa\StrA\galX$.  Since $\tpp\not\in\TN\TI$, $\galX$ is not unique,  so there must be some other $\galY\in\Gals\StrA\sub\set\galX$ such that  $\tpp\in\tpIa\StrA\galY$.    Next let $\tpp\in\TP\TI$ and suppose that for every $\galX\in\Gals\StrA$ such  that $\tpp\in\tpIa\StrA\galX$ there is some $\galY\in\Gals\StrA\sub\set\galX$  having $\tpp\in\tpIa\StrA\galY$.  Since $\tpp\in\TP\TI$, some $\galX\in\Gals\StrA$ has $\tpp\in\tpIa\StrA\galX$.  Then some $\galY\in\Gals\StrA\sub\set\galX$ has $\tpp\in\tpIa\StrA\galY$,  so $\tpp\not\in\TN\TI$, so $\tpp\in\TPs\TI$.\end{enumerate}\end{proof}Note that a noble galaxy might contain a peasant element.We will define a class of models --- the \emph{nobly distinguished} models--- where this doesn't happen.For this we first define \emph{peasantly united} models.\begin{definition}The model $\StrA$ for $\TI$ is \emph{peasantly united} if whenever $\tpp \in \TP\TI$ is a peasant type that is realized insome peasant galaxy:$\tpp \in \tpIa\StrA\galX$ for some $\galX\in\GalsP\StrA$,then $\tpp$ is also realized in some other peasant galaxy:$\tpp \in \tpIa\StrA\galY$ for some $\galY\in\GalsP\StrA\sub\set\galX$.\end{definition}\begin{lemma}[Peasant unitedness]\label{lem:peasant-unitedness}If the type instance $\TI$ has a (finite) model, then it has a (finite)peasantly united model.\end{lemma}\begin{proof}Suppose that $\StrA$ is a (finite) model for $\TI$.We copy its peasant galaxies.We describe the (finite) model $\StrAp$ by describing its galaxies$\Gals\StrAp$.The noble galaxies $\GalsN\StrAp$ of $\StrAp$ coincide with the noble galaxies$\GalsN\StrA$ of $\StrA$.The peasant galaxies $\GalsP\StrAp$ of $\StrAp$ consist of two copies$\galXX1,\galXX2$ of each peasant galaxy $\galX\in\GalsP\StrA$ of $\StrA$.This naturally induces the \onetype/ of every $\ea \in \domAp$ and the\twotype/ between distinct elements that do not come from the twocopies of the same peasant galaxy.Already at this point, the partial structure $\StrAp$ satisfies the existentialparts~\cref{eq:twovar-ms-iinter}, so it is a \emph{partial}$\ClSig\SigS\sms$-structure.We proceed to complete $\StrAp$.Let $\galX\in\GalsP\StrA$ be any peasant $\StrA$-galaxy and let$\eaa1\in\galXX1$ and $\ebb2\in\galXX2$ be any elements from the differentcopies of $\galX$ in $\StrAp$.Note that $\ea, \eb \in \galX$ and let $\tpp = \tpIa\StrAp\ea = \tpIa\StrA\ea$.Since $\galX$ is a peasant galaxy,$\tpp$ must be a peasant type,so some $\galY\in\Gals\StrA\sub\set\galX$ has $\tpp\in\tpIa\StrA\galY$,so some $\eap\in\galY$ has $\tpIa\StrA\eap = \tpp$.Then $\tpt = \tpIab\StrA\eap\eb$ is cosmic and the assignment$\tpIab\StrAp{\eaa1}{\ebb2} = \tpIab\StrA\eap\eb$ is appropriate.The model $\StrAp$ is peasantly united by construction:any peasant type that is realized in a peasant galaxy $\galXX\ii$ is alsorealized in the peasant galaxy $\galXX{3-\ii}$.\end{proof}\begin{definition}The model $\StrA$ for $\TI$ is \emph{nobly distinguished} if every noble galaxycontains only noble elements.That is if $\galX\in\GalsN\StrA$, then $\tpIa\StrA\galX \subseteq \TN\TI$.\end{definition}\begin{definition}The (finite) nobly distinguished type realizability problem for the logic$\vFo2\Eea\sze\agrefine$ is the following: given a classified signature$\ClSig\SigS\sms$ and a type instance $\TI$ over $\ClSig\SigS\sms$,is there a (finite) nobly distinguished model for $\TI$.Denote the nobly distinguished type realizability problem by$\NDReal{\vFo2\Eea\sze\agrefine}$ and its finite version by$\FinNDReal{\vFo2\Eea\sze\agrefine}$.\end{definition}Let $\TI$ be a type instance over $\ClSig\SigS\sms$.For every noble type $\tpn \in \TN\TI$,let $\spp\tpn$ be a new unary predicate symbol.Let $\SigSp = \SigS + \seqbd{\spp\tpn}{\tpn \in \TN\TI}$ be anenrichment of $\SigS$ featuring these new symbols. Consider the following setsof literals over $\SigSp$:\[  \sPe\tpn(\xx) = \set{\spp\tpn(\xx)} \cup  \setbd{\lnot\spp\tpnp(\xx)}{\tpnp \in \TN\TI \sub \set\tpn}.\]Let $\bot$ be a special element and define the special set of literals:\[  \sPe\bot(\xx) =  \setbd{\lnot\spp\tpn(\xx)}{\tpn \in \TN\TI}.\]If $\tpp \in \TP\TI$ is a \onetype/ and $\tpr \in \TN\TI\cup\set\bot$, let $\mr\tpp\tpr$ be the following \onetype/ over $\SigSp$:\[  \mr\tpp\tpr = \tpp \cup \sPe\tpr(\xx).\]We refer to $\mr\tpp\tpr$ as the $\tpr$-copy of $\tpp$.If $\tpt \in \TI$ and $\tpr, \tprp \in \TN\TI\cup\set\bot$,let $\mrr\tpt\tpr\tprp$ be the following \twotype/ over $\SigS$:\[  \mrr\tpt\tpr\tprp = \tpt \cup \sPe\tpr(\xx) \cup \sPe\tprp(\yy).\]So we have$\tpx{(\mrr\tpt\tpr\tprp)} = \mr{(\tpx\tpt)}\tpr$ and$\tpy{(\mrr\tpt\tpr\tprp)} = \mr{(\tpy\tpt)}\tprp$.Define the following set of \twotypes/ $\TIpm$ over $\ClSig\SigSp\sms$:\[  \TIpm = \setbd{\mrr\tpt\tpr\tprp}{\tpt\in\TI,  \tpr,\tprp\in\TN\TI\cup\set\bot}.\]The size of $\TIpm$ is quadratic with respect to the size of $\TI$.\begin{definition}A \emph{promotion} for the type instance $\TI$ over $\ClSig\SigS\sms$is a type instance $\TIp \subseteq \TIpm$ over $\ClSig\SigSp\sms$ such that forevery $\tpt \in \TI$ there are some $\tpr,\tprp \in \TN\TI\cup\set\bot$ suchthat $\mrr\tpt\tpr\tprp \in \TIp$.\end{definition}\begin{lemma}[Noble distinguishability]\label{lem:noble-distinguishability}The type instance $\TI$ has a (finite) model iff there is some promotion $\TIp$for $\TI$ that has a (finite) nobly distinguished model.\end{lemma}\begin{proof}First, suppose that $\StrA$ is (finite) a model for $\TI$.By~\Cref{lem:peasant-unitedness}, without loss of generality assume that $\StrA$is peasantly united.We define a promotion $\TIp$ for $\TI$ and a $\SigSp$-enrichment $\StrAp$ thatis a nobly distinguished model for $\TIp$.For every noble galaxy $\galX\in\GalsN\StrA$ choose any noble type $\tpn\in\tpIa\StrA{\galX}$ realized in it and define $\galX = \galXX\tpn$.Define the enrichment $\StrAp$ as follows: for every $\ea \in \domA$:\begin{enumerate}  \item  If $\ea \in \galXX\tpn$ is an element of some noble galaxy, then let  $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\tpn$.  \item  Otherwise, if $\ea \in \galX$ is an element of a peasant galaxy, then  let $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\bot$.\end{enumerate}Note that we have the following characterization of this construction:for every $\galX \in \Gals\StrAp$:\begin{enumerate}  \item  If $\tpn\in\TN\TI$ and  $\mr\tpp\tpn\in\tpIa\StrAp\galX$ for some $\tpp\in\TP\TI$,  then $\tpn\in\tpIa\StrA\galX$.    Indeed, if $\mr\tpp\tpn\in\tpIa\StrAp\galX$  then some $\ea\in\galX$ has $\tpIa\StrAp\ea = \mr\tpp\tpn$,  so by construction $\galX = \galXX\tpn$, so $\tpn\in\galX$.  \item  If $\tpp\in\TP\TI$ and $\mr\tpp\bot\in\tpIa\StrAp\galX$, then  $\galX\in\GalsP\StrA$ is a peasant galaxy and  $\tpp\in\tpIa\StrA\galX$ is a peasant type.    Indeed, if $\mr\tpp\bot\in\tpIa\StrAp\galX$  then some $\ea\in\galX$ has $\tpIa\StrAp\ea = \mr\tpp\bot$,  so by construction  $\galX\in\GalsP\StrA$ and  $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\bot$,  so $\tpp = \tpIa\StrA\ea \in \tpIa\StrA\galX$ is a peasant type.\end{enumerate}Let $\TIp = \TIS\StrAp$ be the type instance of $\StrAp$.By construction $\TIp \subseteq \TIpm$.If $\tpt\in\TI$, then some $\ea\in\domA$ and $\eb\in\domA\sub\set\ea$ have$\tpIab\StrA\ea\eb = \tpt$.Let $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\tpr$ and$\tpIa\StrAp\eb = \mr{\tpIa\StrA\eb}\tprp$,so $\mr\tpt{\tpr\tprp} = \tpIab\StrAp\ea\eb \in \TIp$.So $\TIp$ is a promotion of $\TI$.We claim that $\tppp\in\TP\TIp$ is a noble type iff$\tppp = \mr\tpp\tpn$ for some $\tpp\in\TP\TI$ and $\tpn\in\TN\TI$, orequivalently:\[  \TN\TIp = \setbd{\mr\tpp\tpn \in \TP\TIp}{\tpp\in\TP\TI,\tpn\in\TN\TI}.\]First, suppose that $\mr\tpp\tpn\in\TP\TIp$ for some $\tpp\in\TP\TI$ and$\tpn\in\TN\TI$.Let $\galX\in\Gals\StrAp$ be such that $\mr\tpp\tpn\in\tpIa\StrAp\galX$.Suppose towards a contradiction that $\mr\tpp\tpn\in\TPs\TIp$ is a peasant type.Then there is some $\galY\in\Gals\StrAp\sub\set\galX$ such that$\mr\tpp\tpn\in\tpIa\StrAp\galY$.Then by construction $\tpn\in\tpIa\StrA\galX$ and $\tpn\in\tpIa\StrA\galY$--- a contradiction.Next, suppose that $\mr\tpp\bot\in\TP\TIp$ and let $\galX\in\Gals\StrAp$ be suchthat $\mr\tpp\bot\in\tpIa\StrAp\galX$.Then by construction $\galX\in\GalsP\StrA$ is a peasant galaxy and$\tpp\in\tpIa\StrA\galX$ is a peasant type.Since $\StrA$ is peasantly united, there is some$\galY\in\GalsP\StrA\sub\set\galX$ having $\tpp\in\tpIa\StrA\galY$.So by construction $\mr\tpp\bot = \tpIa\StrAp\galY$,so $\mr\tpp\bot\in\TPs\TIp$.Finally, we check that $\StrAp$ is nobly distinguished.Indeed, let $\galX \in \GalsN\StrAp$ be any noble galaxy.Then some $\ea\in\galX$ has $\tpIa\StrAp\ea \in \TN\TIp$, so$\galX = \galXX\tpn$ for some noble $\tpn\in\TN\TI$.Let $\eb\in\galX$ be any.Then by construction $\tpIa\StrAp\eb = \mr{\tpIa\StrA\eb}\tpn$,so $\tpIa\StrAp\galX \subseteq \TN\TIp$.Next, the reduct of any model $\StrAp$ for $\TIp$ to a $\SigS$-structure is amodel for $\TI$ by the promotion condition:if $\tpt\in\TI$ then $\mr\tpt{\tpr\tprp}\in\TIp$ for some$\tpr,\tprp\in\TN\TI\cup\set\bot$.\end{proof}\begin{corollary}The (finite) type realizability problem is reducible in nondeterministicpolynomial time to the (finite) nobly distinguished type realizability problem.\[  \FinAReal{\vFo2\Eea\sze\agrefine} \red\cNP  \FinANDReal{\vFo2\Eea\sze\agrefine}.\]\end{corollary}\begin{remark}Suppose that $\StrA$ is a nobly distinguished model for $\TI$.Then $\StrA$ is peasantly united. \end{remark}\begin{proof}Suppose that $\tpp\in\TPs\TI$ is a peasant type,$\galX\in\GalsP\StrA$ is a peasant galaxyand $\tpp\in\tpIa\StrA\galX$.Since $\tpp$ is a peasant type, some $\galY\in\Gals\StrA\sub\set\galX$ has$\tpp\in\tpIa\StrA\galY$.Since $\StrA$ is nobly distinguished, $\galY\in\GalsP\StrA$ is a peasant galaxy.So $\StrA$ is peasantly united.\end{proof}\subsection{Cosmic spectrums}Let $\TI$ be a type instance over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.\begin{definition}A \emph{cosmic spectrum}$\csps = (\cii\csps,\cie\csps,\cei\csps,\cee\csps)$ over $\TI$ consists of foursets of \twotypes/ satisfying the following conditions:\begin{itemize}  \item[\condcspII]\label{cond:cspII}  The set of \emph{internal types} $\cii\csps \subseteq \TIg$ is a set of  galactic types that is closed under inversion.    \item[\condcspIE]\label{cond:cspIE}  The set of \emph{boundary types} $\cie\csps \subseteq \TIc$ is a nonempty set  of cosmic types.    \item[\condcspEI]\label{cond:cspEI}  The set of \emph{inverted boundary types} is:  $\cei\csps = \setbd{\inv\tpt}{\tpt\in\cie\csps}$.    \item[\condcspEE]\label{cond:cspEE}  The set of \emph{external types} $\cee\csps \subseteq \TI$ is a set of  \twotypes/ that is closed under inversion.  \item[\condcspT]\label{cond:cspT}  We require that  $\TI = \cii\csps \cup \cie\csps \cup \cei\csps \cup \cee\csps$.  \item[\condcspNP]\label{cond:cspNP}  The (nonempty) set $\Tpx\csps = (\tpx\restriction{\cie\csps})$ is the set  of \emph{internal \onetypes/} of~$\csps$.  The (nonempty) set $\Tpy\csps = (\tpy\restriction{\cie\csps})$ is the set of  \emph{external \onetypes/} of~$\csps$.  We require that either $\Tpx\csps \subseteq \TN\TI$, in which case $\csps$ is  a \emph{noble cosmic spectrum}, or $\Tpx\csps \subseteq \TPs\TI$, in which  case $\csps$ is a \emph{peasant cosmic spectrum}.\end{itemize}\end{definition}For any \onetype/ $\tpp$ or a \twotype/ $\tpt$ over $\SigS$ denote by $\noe\tpp$or $\noe\tpt$ the reducts of $\tpp$ and $\tpt$ to the language $\SigS -\seq{\se}$.That is, $\noe\tpp \subset \tpp$ and $\noe\tpt \subset \tpt$ consist of thoseliterals that do not feature $\se$.Let $\si$ be a new unary predicate symboland let $\SigSp = \SigS - \seq{\se} + \seq{\si}$ be the predicate signatureobtained from $\SigS$ by removing the coarsest equivalence symbol $\se$ andadding the new predicate symbol $\si$.Define the following \onetypes/ and \twotypes/ over $\SigSp$:\begin{align*}\di\tpp &= \noe\tpp\cup\set{\si(\xx)} \\\de\tpp &= \noe\tpp\cup\set{\lnot\si(\xx)} \\\dii\tpt &= \noe\tpt\cup\set{\si(\xx),\si(\yy)} \\\die\tpt &= \noe\tpt\cup\set{\lnot\si(\xx),\si(\yy)} \\\dei\tpt &= \noe\tpt\cup\set{\si(\xx),\lnot\si(\yy)} \\\dee\tpt &= \noe\tpt\cup\set{\lnot\si(\xx),\lnot\si(\yy)}.\end{align*}Note that we have $\tpx{(\tpt_{\mathcal{X}\mathcal{Y}})} =(\tpx\tpt)_{\mathcal{X}}$ and $\tpy{(\tpt_{\mathcal{X}\mathcal{Y}})} =(\tpy\tpt)_{\mathcal{Y}}$ for $\mathcal{X},\mathcal{Y} \in\set{\mathcal{I},\mathcal{E}}$.\begin{definition}The \emph{spectral type instance} $\TIs$ of the cosmic spectrum $\csps$ isa type instance over the \emph{simpler}$\vFo2\Eea{(\sze-1)}\agrefine$-classified signature $\ClSig\SigSp\sms$ definedas follows:\[  \TIs = \dii\TIs \cup \die\TIs \cup \dei\TIs \cup  \dee\TIs,\]where $\TIs_{\mathcal{X}\mathcal{Y}} =\setbd{\tpt_{\mathcal{X}\mathcal{Y}}}{\tpt \in\csps^{\mathcal{X}\mathcal{Y}}}$ for$\mathcal{X},\mathcal{Y}\in\set{\IntChar,\ExtChar}$.This is indeed a type instance, since $\die\TIs$ is nonemptyby~\refcondcspIE{}and since $\dii\TIs$, $(\die\TIs\cup\dei\TIs)$ and$\dee\TIs$ are closed under inversion by~\refcondcspII, \refcondcspEI{}and \refcondcspEE.The size of a cosmic spectrum over a type instance is linear withrespect to the size of the type instance.Define $\TPIs\csps = \setbd{\di\tpp}{\tpp\in\Tpx\csps} =(\tpx\restriction\die\TIs)$ to be the set of\emph{internal spectral \onetypes/}and $\TPEs\csps = \setbd{\de\tpp}{\tpp\in\Tpy\csps} =(\tpy\restriction\die\TIs)$ to be the set of \emph{external spectral\onetypes/}.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\TIs$ has a model.\end{definition}\begin{definition}Let $\StrA$ be a nobly distinguished model for $\TI$ such that $\relE =\at\StrA\se \neq \domAA$ is not full on $\domA$(equivalently, there are at least $2$ galaxies).If $\galX \in \Gals$ is any galaxy, the \emph{cosmic spectrum} $\csps =\cspIX\StrA\galX$ of $\galX$ is defined by:\begin{align*}  \cii\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \galX, \eb \in \galX \sub  \set\ea} \\  \cie\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \galX, \eb \in \domA \sub  \galX} \\  \cei\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \domA\sub\galX, \eb\in\galX} \\  \cee\csps &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \domA \sub \galX, \eb \in  (\domA \sub \galX) \sub \set\ea}.\end{align*}Then indeed $\csps$ is a locally consistent cosmic spectrum over $\TI$.\end{definition}\begin{proof}First we check that $\csps$ is a cosmic spectrum over $\TI$:\begin{itemize}  \item[\refcondcspII]  If $\tpt\in\cii\csps$,  then $\tpt = \tpIab\StrA\ea\eb$ for some $\ea\in\galX$ and  $\eb\in\galX\sub\set\ea$,  so $\tpt$ is galactic and $\inv\tpt = \tpIab\StrA\eb\ea\in\cii\csps$, so  $\cii\csps$ is closed under inversion.    \item[\refcondcspIE]  First, since $\relE$ is not full on $\domA$, there is some $\ea\in\galX$ and  $\eb\in\domA\sub\galX$, so $\tpIab\StrA\ea\eb\in\cie\csps$, so $\cie\csps$ is  nonempty.  Next, if $\tpt\in\cie\csps$ then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea\in\galX$ and $\eb\in\domA\sub\galX$, so $\tpt$ is cosmic.    \item[\refcondcspEI]  If $\tpt\in\cie\csps$, then $\tpt=\tpIab\StrA\ea\eb$ for some $\ea\in\galX$  and $\eb\in\domA\sub\galX$, so $\inv\tpt=\tpIab\StrA\eb\ea\in\cei\csps$.  If $\tpt\in\cei\csps$, then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea\in\domA\sub\galX$ and $\eb\in\galX$, so  $\inv\tpt=\tpIab\StrA\eb\ea\in\cie\csps$, so $\tpt = \inv\tptp$ for  $\tptp=\inv\tpt\in\cie\csps$.    \item[\refcondcspEE]  If $\tpt\in\cee\csps$, then $\tpt=\tpIab\StrA\ea\eb$ for some  $\ea\in\domA\sub\galX$ and $\eb\in(\domA\sub\galX)\sub\set\ea$, so  $\inv\tpt=\tpIab\StrA\eb\ea\in\cee\csps$ and hence $\cee\csps$ is closed under  inversion.    \item[\refcondcspT]  We have that $\cii\csps \cup \cie\csps \cup \cei\csps \cup \cee\csps =  \setbd{\tpIab\StrA\ea\eb}{\ea\in\domA,\eb\in\domA\sub\set\ea} = \TI$ since  $\StrA$ is a model for $\TI$.    \item[\refcondcspNP]  First suppose that $\galX$ is a noble galaxy.  Let $\tpp\in\Tpx\csps$, so some $\tpt\in\cie\csps$ has $\tpx\tpt=\tpp$, so  some $\ea\in\galX$ and $\eb\in\domA\sub\galX$ has $\tpIab\StrA\ea\eb=\tpt$, so  $\tpp=\tpIa\StrA\ea$ is noble, since $\StrA$ is nobly distinguished.  Next suppose that $\galX$ is a peasant galaxy.  Similarly, let $\tpp\in\Tpx\csps$, so some $\tpt\in\cie\csps$ has  $\tpx\tpt=\tpp$, so some $\ea\in\galX$ and $\eb\in\domA\sub\galX$ has  $\tpIab\StrA\ea\eb=\tpt$, so $\tpp=\tpIa\StrA\ea$ is peasant, since $\galX$ is  a peasant galaxy.\end{itemize}We transform $\StrA$ to a $\ClSig\SigSp\sms$-structure $\StrAp$ by forgettingthe interpretation of $\se$ and by interpreting $\at\StrAp\si = \galX$.Then:\begin{align*}\tpIab\StrAp\ea\eb &= \dii{\tpIab\StrA\ea\eb}\text{ if } \ea\in\galX,\eb\in\galX\sub\set\ea \\\tpIab\StrAp\ea\eb &= \die{\tpIab\StrA\ea\eb}\text{ if } \ea\in\galX,\eb\in\domA\sub\galX \\\tpIab\StrAp\ea\eb &= \dei{\tpIab\StrA\ea\eb}\text{ if } \ea\in\domA\sub\galX,\eb\in\galX \\\tpIab\StrAp\ea\eb &= \dee{\tpIab\StrA\ea\eb}\text{ if } \ea\in\domA\sub\galX,\eb\in(\domA\sub\galX)\sub\set\ea.\end{align*}This shows that $\StrAp$ is a model for $\TIs$, so $\csps$ is locallyconsistent.\end{proof}\subsection{Locally consistent cosmic spectrums}Let $\csps$ be a locally consistent cosmic spectrum over $\TI$.\begin{lemma}[Spectral Characterization]\label{rem:lccsp-char}Let $\StrAs$ be a model for the spectral type instance $\TIs$and let $\galXs = \at\StrAs\si$ be the set of \emph{internalspectral elements}.Then:\begin{align*}\dii\TIs &=\setbd{\tpIab\StrAs\ea\eb}{  \ea\in\galXs,  \eb\in\galXs\sub\set\ea} \\\die\TIs &=\setbd{\tpIab\StrAs\ea\eb}{  \ea\in\galXs,  \eb\in\domAs\sub\galXs} \\\dei\TIs &=\setbd{\tpIab\StrAs\ea\eb}{  \ea\in\domAs\sub\galXs,  \eb\in\galXs} \\\dee\TIs &=\setbd{\tpIab\StrAs\ea\eb}{  \ea\in\domAs\sub\galXs,  \eb\in(\domAs\sub\galXs)\sub\set\ea} \\\TPIs\csps &=  \setbd{\tpIa\StrAs\ea}{\ea\in\galXs} \\\TPEs\csps &=  \setbd{\tpIa\StrAs\ea}{\ea\in\domAs\sub\galXs}.\end{align*}Equivalently:\begin{enumerate}  \item  $\tpt \in \cii\csps$ iff $\tpIab\StrAs\ea\eb = \dii\tpt$  for some $\ea \in \galXs$ and $\eb \in \galXs\sub\set\ea$.  \item  $\tpt \in \cie\csps$ iff $\tpIab\StrAs\ea\eb = \die\tpt$  for some $\ea \in \galXs$ and $\eb \in \domAs\sub\galXs$.  \item  $\tpt \in \cei\csps$ iff $\tpIab\StrAs\ea\eb = \dei\tpt$  for some $\ea \in \domAs\sub\galXs$ and $\eb \in \galXs$.  \item  $\tpt \in \cee\csps$ iff $\tpIab\StrAs\ea\eb = \dee\tpt$  for some $\ea \in \domAs\sub\galXs$  and $\eb \in (\domAs\sub\galXs)\sub\set\ea$.  \item  Both $\galXs$ and $\domAs\sub\galXs$ are nonempty.  \item  $\tpp \in \Tpx\csps$ iff $\tpIa\StrAs\ea = \di\tpp$  for some $\ea \in \galXs$.  \item  $\tpp \in \Tpy\csps$ iff $\tpIa\StrAs\ea = \de\tpp$  for some $\ea \in \domAs\sub\galXs$.\end{enumerate}We will be applying this lemma implicitly.\end{lemma}\begin{proof}\begin{enumerate}  \item  If $\tpt\in\cii\csps$ then $\dii\tpt\in\dii\TIs\subseteq\TIs$,  so some $\ea\in\domAs$ and $\eb\in\domAs\sub\set\ea$ have  $\tpIab\StrAs\ea\eb = \dii\tpt$.  We have that  $\si(\xx)\in\di{(\tpx\tpt)}=\tpx{(\cii\tpt)}=\tpIa\StrAs\ea$,  so $\ea\in\galXs$.  Similarly,  $\si(\xx)\in\di{(\tpy\tpt)}=\tpy{(\cii\tpt)}=\tpIa\StrAs\eb$,  so $\eb\in\galXs\sub\set\ea$.    Next, suppose that $\ea\in\galXs$ and $\eb\in\galXs\sub\set\ea$  and let $\tptp = \tpIab\StrAs\ea\eb$.  Then $\si(\xx) \in \tpIa\StrAs\ea = \tpx\tptp$  and $\si(\xx) \in \tpIa\StrAs\eb = \tpy\tptp$, so  $\tptp = \dii\tpt$ for some $\tpt\in\cii\csps$.    \item  If $\tpt\in\cie\csps$ then $\die\tpt\in\die\TIs\subseteq\TIs$,  so some $\ea\in\domAs$ and $\eb\in\domAs\sub\set\ea$ have  $\tpIab\StrA\ea\eb = \die\tpt$.  We have that  $\si(\xx)\in\di{(\tpx\tpt)}=\tpx{(\cie\tpt)}=\tpIa\StrAs\ea$,  so $\ea\in\galXs$.  Similarly,  $(\lnot\si(\xx))\in\de{(\tpy\tpt)}=\tpy{(\die\tpt)}=\tpIa\StrA\eb$,  so $\eb\in\domAs\sub\galXs$.    Next, suppose that $\ea\in\galXs$ and $\eb\in\domAs\sub\galXs$.  and let $\tptp = \tpIab\StrAs\ea\eb$.  Then $\si(\xx) \in \tpIa\StrAs\ea = \tpx\tptp$  and $\se(\xx) \in \tpIa\StrA\eb = \tpy\tptp$, so  $\tptp = \die\tpt$ for some $\tpt\in\cie\csps$.    \item  $\tpt\in\cei\csps$ iff $\inv\tpt\in\cie\csps$  iff some $\eb\in\galXs$ and $\ea\in\domAs\sub\galXs$  have $\tpIab\StrAs\eb\ea = \inv\tpt$  iff some $\ea\in\domAs\sub\galXs$ and $\eb\in\galXs$  have $\tpIab\StrAs\ea\eb = \tpt$.    \item  If $\tpt\in\cee\csps$ then $\dee\tpt\in\dee\TIs\subseteq\TIs$,  so some $\ea\in\domAs$ and $\eb\in\domAs\sub\set\ea$  have $\tpIab\StrAs\ea\eb = \dee\tpt$.  We have that  $(\lnot\si(\xx))\in\de{(\tpx\tpt)} = \tpx{(\dee\tpt)} = \tpIa\StrAs\ea$, so  $\ea\in\domAs\sub\galXs$.  Similarly,  $(\lnot\si(\xx))\in\de{(\tpy\tpt)} = \tpy{(\dee\tpt)} = \tpIa\StrAs\eb$, so  $\eb\in(\domAs\sub\galXs)\sub\set\ea$.  \item   By~\refcondcspIE, $\cie\csps$ is nonempty,  so let $\tpt\in\cie\csps$ be any.  Then some $\ea\in\galXs$ and  $\eb\in\domAs\sub\galXs$ have $\tpIab\StrAs\ea\eb = \die\tpt$,  so in particular both $\galXs$ and $\domAs\sub\galXs$ are nonempty.    \item  If $\tpp\in\Tpx\csps$, then some $\tpt\in\cie\csps$ has $\tpx\tpt=\tpp$,  so some $\ea\in\galXs$ and $\eb\in\domA\sub\galXs$ have  $\tpIab\StrA\ea\eb = \die\tpt$,  so $\tpIa\StrAs\ea = \di\tpp$.    Next, suppose that $\ea\in\galXs$.  Let $\eb\in\domAs\sub\galXs$, which is nonempty.  Then $\tpIab\StrAs\ea\eb = \die\tpt$ for some $\tpt\in\cie\csps$.  Then $\tpp = \tpx\tpt \in \Tpx\csps$.  Then $\tpIa\StrAs\ea = \tpx{(\die\tpt)} = \di\tpp$.    \item   If $\tpp\in\Tpy\csps$, then some $\tpt\in\cie\csps$ has $\tpy\tpt=\tpp$,  so some $\ea\in\galXs$ and $\eb\in\domA\sub\galXs$ have  $\tpIab\StrA\ea\eb = \die\tpt$,  so $\tpIa\StrAs\eb = \de\tpp$.    Next, suppose that $\eb\in\galXs$.  Let $\ea\in\galXs$, which is nonempty.  Then $\tpIab\StrAs\ea\eb = \die\tpt$ for some $\tpt\in\cie\csps$.  Then $\tpp = \tpy\tpt \in \Tpy\csps$.  Then $\tpIa\StrAs\eb = \tpy{(\die\tpt)} = \de\tpp$.\end{enumerate}\end{proof}\begin{remark}\label{rem:lccsp-pcup}We have that $\TP\TIs = \TPIs\csps \cup \TPEs\csps$.\end{remark}\begin{proof}Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.By~\Cref{rem:type-char}, $\TP\TIs =\setbd{\tpIa\StrAs\ea}{\ea\in\domA} = \TPIs\csps \cup \TPEs\csps$by~\Cref{rem:lccsp-char}.\end{proof}\begin{remark}\label{rem:lccsp-ne}Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.Then both $\galXs$ and $\domAs\sub\galXs$ are nonempty.\end{remark}\begin{proof}By~\refcondcspIE, $\cie\csps$ is nonempty,so let $\tpt\in\cie\csps$ be any.By~\Cref{rem:lccsp-char},some $\ea\in\galXs$ and $\eb\in\domAs\sub\galXs$ have $\tpIab\StrAs\ea\eb = \die\tpt$,so in particular both $\galXs$ and $\domAs\sub\galXs$ are nonempty.\end{proof}\begin{remark}\label{rem:lccsp-tpcup}We have that $\TP\TI = \Tpx\csps \cup \Tpy\csps$.\end{remark}\begin{proof}Let $\tpp\in\TP\TI$ be any \onetype/,so some $\tpt\in\TI$ has $\tpx\tpt = \tpp$.By~\refcondcspT{} we have that$\tpt \in \cii\csps \cup \cie\csps \cup \cei\csps \cup \cee\csps$.If $\tpt \in \cii\csps$,then by~\Cref{rem:lccsp-char} some $\ea \in \galXs$ and$\eb \in \galXs\sub\set\ea$ have $\tpIab\StrAs\ea\eb = \dii\tpt$,so $\tpIa\StrAs\ea = \di\tpp$,so by~\Cref{rem:lccsp-char}, $\tpp \in \Tpx\csps$.If $\tpt \in \cie\csps$,then by~\Cref{rem:lccsp-char} some $\ea \in \galXs$ and$\eb \in \domAs\sub\galXs$ have $\tpIab\StrAs\ea\eb = \die\tpt$,so $\tpIa\StrAs\ea = \di\tpp$,so by~\Cref{rem:lccsp-char}, $\tpp \in \Tpx\csps$.If $\tpt \in \cei\csps$,then by~\Cref{rem:lccsp-char} some $\ea \in \domAs\sub\galXs$ and$\eb \in \galXs$ have $\tpIab\StrAs\ea\eb = \dei\tpt$,so $\tpIa\StrAs\ea = \de\tpp$,so by~\Cref{rem:lccsp-char}, $\tpy \in \Tpx\csps$.If $\tpt \in \cee\csps$,then by~\Cref{rem:lccsp-char} some $\eb \in \domAs\sub\galXs$ and$\eb \in (\domAs\sub\galXs)\sub\set\ea$ have $\tpIab\StrAs\ea\eb = \dee\tpt$,so $\tpIa\StrAs\ea = \de\tpp$,so by~\Cref{rem:lccsp-char}, $\tpp \in \Tpy\csps$.\end{proof}\begin{remark}\label{rem:lccsp-xy}If $\tpp\in\Tpx\csps$ and $\tppp\in\Tpy\csps$, then some $\tpt\in\cie\csps$ has$\tpx\tpt=\tpp$ and $\tpy\tpt=\tppp$.\end{remark}\begin{proof}Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.By~\Cref{rem:lccsp-char},some $\ea\in\galXs$ has $\tpIa\StrAs\ea = \di\tpp$and some $\eb\in\domAs\sub\galXs$ has $\tpIa\StrAs\eb = \de\tpp$.Then $\tpIab\StrAs\ea\eb \in \die\TIs$ by~\Cref{rem:lccsp-char},so $\tpIab\StrAs\ea\eb = \die\tpt$ for some $\tpt\in\cie\csps$.Then $\tpx\tpt = \tpp$ and $\tpy\tpt = \tppp$.\end{proof}\begin{remark}\label{rem:lccsp-ps}If $\tpp\in\TPs\TI$ is any peasant type, then $\tpp\in\Tpy\csps$.\end{remark}\begin{proof}Let $\tpt \in \TIc$ be any cosmic type connecting the peasant type $\tpp$ withitself.Then by~\refcondcspT,$\tpt \in \cie\csps \cup \cei\csps \cup \cee\csps$.If $\tpt \in \cie\csps$, then $\tpp = \tpy\tpt \in \Tpy\csps$.If $\tpt \in \cei\csps$, then $\tpp = \tpy(\inv\tpt) \in \Tpy\csps$.Suppose that $\tpt \in \cee\csps$, so $\dee\tpt \in \dee\TIs$.Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.By~\Cref{rem:lccsp-ne}, let $\ea \in \galXs$ be any internal spectral element.By~\Cref{rem:lccsp-char} some $\eb \in \domAs\sub\galXs$and $\ec \in (\domAs\sub\galXs)\sub\set\ea$have $\tpIab\StrAs\eb\ec = \dee\tpt$.Then $\tpIa\StrAs\eb = \de\tpp$.Consider $\tptp = \tpIab\StrAs\ea\eb$.By~\Cref{rem:lccsp-char}, $\tptp = \die\tpt$ for some $\tpt \in \cie\csps$,so $\tpp = \tpy\tpt \in \Tpy\csps$.\end{proof}\begin{remark}\label{rem:lc-csp-n}If $\tpn\in\Tpx\csps \cap \TN\TI$ is an internal noble type, then$\tpn\not\in\Tpy\csps$.\end{remark}\begin{proof}Suppose towards a contradiction that $\tpn\in\Tpy\csps$,so some $\tpt\in\cie\csps$ has $\tpy\tpt = \tpn$.Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.By~\Cref{rem:lccsp-char}, some $\ea\in\galXs$ has $\tpIa\StrAs\ea = \di\tpn$.By~\Cref{rem:lccsp-char}, some $\eap\in\galXs$ and $\eb\in\domAs\sub\galXs$ have$\tpIab\StrAs\eap\eb = \die\tpt$.Then $\tpIab\StrAs\ea\eb = \die\tpt$ for some cosmic $\tpt \in \cie\csps$ having$\tpx\tpt = \tpy\tpt = \tpn$ --- a contradiction.\end{proof}\begin{remark}\label{rem:lccsp-ki}If $\tpk\in\Tpx\csps\cap\TK\TI$ is an internal king type, then$\di\tpk\in\TK\TIs$ is an internal spectral king type.\end{remark}\begin{proof}Suppose towards a contradiction that $\di\tpk$ is not a king type, so some$\tptp \in \TIs$ connects $\di\tpk$ with itself.We must have that $\tptp \in \dii\TIs$, so $\tptp = \dii\tpt$for some $\tpt \in \cii\csps$, so $\tpt$ connects $\tpk$ with itself--- a contradiction.\end{proof}\begin{remark}\label{rem:lccsp-ke}If $\tpk \in \Tpy\csps\cap\TK\TI$ is an external king type, then$\de\tpk\in\TK\TIs$ is an external spectral king type.\end{remark}\begin{proof}Suppose towards a contradiction that $\de\tpk$ is not a king type, so some$\tptp \in \TIs$ connects $\de\tpk$ with itself.We must have that $\tptp \in \dee\TIs$, so $\tptp = \dee\tpt$for some $\tpt \in \cee\csps$, so $\tpt$ connects $\tpk$ with itself--- a contradiction.\end{proof}\begin{remark}\label{rem:lccsp-nw}If $\csps$ is noble and if $\tpn\in\Tpx\csps \sub \TK\TI$ is an internal workertype, then $\di\tpn \in \TW\TIs$ is an internal spectral worker type.\end{remark}\begin{proof}Since $\csps$ is noble, $\tpn$ must be noble.Since $\tpn$ is not a king type, there must be some galactic $\tpt \in \TIg$connecting $\tpn$ with itself.Then by~\refcondcspT, $\tpt \in \cii\csps \cup \cee\csps$.If $\tpt \in \cii\csps$, then $\dii\tpt \in \dii\TIs$ connects $\di\tpn$ withitself, so $\di\tpn$ is a worker type.Suppose that $\tpt \in \cee\csps$.Let $\StrAs$ be a model for $\TIs$and let $\galXs = \at\StrAs\si$ be the set of internal spectral elements.Since $\tpn\in\Tpx\csps$, by~\Cref{rem:lccsp-char} some $\ea \in \galXs$ has$\tpIa\StrAs\ea = \di\tpn$.Since $\tpt \in \cee\csps$, by~\Cref{rem:lccsp-char}some $\eap \in \domAs\sub\galXs$ and $\eb \in (\domAs\sub\galXs)\sub\set\ea$have $\tpIab\StrAs\eap\eb = \dee\tpt$.Then $\tpIab\StrAs\ea\eb = \die\tpt'$ for some $\tptp \in \cie\csps$.So $\tptp$ is a cosmic type connectinf $\tpn$ with itself --- a contradiction.\end{proof}For any $\tpps\csps \in \TP\TIs$ or $\tpts\csps \in \TIs$,denote by $\noin{\tpps\csps}$ and $\noin{\tpts\csps}$ thereducts of $\tpps\csps$ and $\tpts\csps$ to the language$\SigS - \seq{\se} = \SigSp - \seq{\si}$.Define the following types over $\SigS$:\begin{align*}\ci{\tpps\csps} &= \ce{\tpps\csps} =  \noin{\tpps\csps} \cup \set{\se(\xx)} \\\cii{\tpts\csps} &= \noin{\tpts\csps} \cup\set{\se(\xx),\se(\yy),\se(\xx,\yy),\se(\yy,\xx)}\\\cie{\tpts\csps} &= \noin{\tpts\csps} \cup\set{\se(\xx),\se(\yy),\lnot\se(\xx,\yy), \lnot\se(\yy,\xx)}.\end{align*}That is, these are \emph{inverses} of the previous operations:$\ci{(\di\tpp)} = \ce{(\de\tpp)} = \tpp$ for $\tpp \in \TP\TI$ and$\cii{(\dii\tpt)} = \cie{(\die\tpt)} = \tpt$ for $\tpt \in \TI$.\begin{definition}Let $\StrAs$ be a model for $\TIs$, and let $\galXs =\at\StrAs\si$ be the set of internal spectral elements.By~\Cref{rem:lccsp-ne}, $\galXs$ is nonempty.Transform$(\StrAs\restriction\galXs)$ to a model $\StrXs$ for $\SigS$ by forgetting the interpretation of $\si$ and byinterpreting $\at\StrXs\se = \galXs \cprod \galXs$ as the fullrelation on $\galXs$.Call $\StrXs$ the \emph{galaxy} of the model $\StrAs$.Note that $\StrXs$ is a $\SigS$-structure,but is not necessarily a $\ClSig\SigS\sms$-structure, since some message symbolsmight be witnessed only by an element outside of $\galXs$ in $\StrAs$.For any internal spectral element $\ea\in\galXs$ define its \emph{intendedstar-type} $\stps(\ea)$ by:\[  \stps(\ea) =  \setbd{\cii{\tpIab\StrAs\ea\eb}}{\eb \in \galXs \sub \set\ea} \cup  \setbd{\cie{\tpIab\StrAs\ea\eb}}{\eb \in \domAs \sub \galXs}.\]Define the \emph{intended \onetype/} of $\ea$ by:$\tpp(\ea) = \tpx\stps(\ea) = \ci{\tpIa\StrAs\ea}$.\end{definition}\begin{lemma}\label{rem:istp-stp}The intended star-type $\stps=\stps(\ea)$ is a star-type over $\TI$.\end{lemma}\begin{proof}By~\Cref{rem:lccsp-ne}, $\domAs\sub\galXs$ is nonempty, so $\csps$ isnonempty.We verify the conditions for a star-type over $\TI$:\begin{itemize}  \item[\refcondstpx]  If $\tpt, \tptp \in \stps$,  then $\tpx\tpt = \tpx\tptp = \ci{\tpIa\StrA\ea} = \tpp(\ea)$.  Let $\tpp = \tpp(\ea)$ be the intended \onetype/ of $\ea$.  \item[\refcondstppy]  TODO  \item[\refcondstpky]  TODO  \item[\refcondstpm]  Let $\sm\in\sms$. Since $\StrA$ is a model for $\TIs$, some  $\eb\in\domA\sub\set\ea$ has $\sm(\xx,\yy)\in\tpIab\StrA\ea\eb$.  If $\eb\in\galX$, then $\sm(\xx,\yy)\in\dii{\tpIab\StrA\ea\eb}\in\stps(\ea)$.  If $\eb\in\domA\sub\galX$, then  $\sm(\xx,\yy)\in\die{\tpIab\StrA\ea\eb}\in\stps(\ea)$.\end{itemize}\end{proof}Let $\StrAs$ be a model for $\TIs$, let $\galXs$ be the set ofinternal spectral elements and let $\StrXs$ be the galaxy of $\StrAs$.\begin{remark}[Galaxy Characterization]TODO: Use this to prove the others.Note: $\tpp(\ea) = \tpIa\StrXs\ea$.\begin{itemize}  \item  $\tpp \in \Tpx\csps$ iff some $\ea \in \galXs$ has $\tpp(\ea) = \tpp$.  \item  $\tpt \in \cii\csps$ iff some $\ea \in \galXs$  and $\eb \in \galXs\sub\set\ea$ has $\tpIab\StrXs\ea\eb = \tpt$.  \item  If $\tpt \in \TIc$ is cosmic, then  $\tpt \in \cie\csps$ iff some $\ea \in \galX$  has $\tpt \in \stps(\ea)$.\end{itemize}\end{remark}\begin{remark}\label{rem:istp-p}$\Tpx\csps = \setbd{\tpp(\ea)}{\ea\in\galXs}$.\end{remark}\begin{proof}TODO\end{proof}\begin{remark}\label{rem:istp-int}If $\ea\in\galXs$, then$\tpIa\StrAs\ea = \di{\tpp(\ea)}$.\end{remark}\begin{remark}\label{rem:istp-gal}If $\ea\in\galXs$ and $\tpt\in\stps(\ea)$ is galactic,then some $\eb\in\galXs\sub\set\ea$ has $\tpIab\StrXs\ea\eb=\tpt$.\end{remark}\begin{proof}TODO\end{proof}\begin{remark}\label{rem:istp-cos}If $\ea\in\galXs$ and $\tpt\in\stps(\ea)$ is cosmic, then$\tpt\in\cie\csps$.\end{remark}\begin{proof}TODO\end{proof}\begin{remark}\label{rem:istp-cos-inv}If $\tpt\in\cie\csps$, then some $\ea\in\galXs$ has $\tpt\in\csps(\ea)$.\end{remark}\begin{definition}A \emph{certificate} $\Cert$ for the type instance~$\TI$ is a nonempty set oflocally consistent cosmic spectrums over $\TI$ satisfying the followingconditions:\begin{itemize}  \item[\condcertTc]\label{cond:certTc}  If $\tpt\in\TIc$, then some $\csps\in\Cert$ has $\tpt\in\die\csps$.  \item[\condcertTg]\label{cond:certTg}  If $\tpt\in\TIg$, then some $\csps\in\Cert$ has $\tpt\in\dii\csps$.  \item[\condcertn]\label{cond:certn}  If $\tpn\in\TN\TI$ and $\csps,\cspsp\in\Cert$ have $\tpn\in\Tpx\csps$ and  $\tpn\in\Tpx\cspsp$, then $\cspsp = \csps$.\end{itemize}\end{definition}\begin{remark}\label{rem:many-cert-p}If $\tpp\in\TP\TI$ then some $\csps\in\Cert$ has $\tpp\in\Tpx\csps$.\end{remark}\begin{proof}TODO\end{proof}\begin{remark}\label{rem:many-cert-n}If $\tpn\in\TN\TI$, then a unique $\csps\in\Cert$ has $\tpn\in\Tpx\csps$.\end{remark}\begin{proof}TODO\end{proof}\begin{lemma}[Certificate extraction]\label{lem:cert-ext-many}Let $\StrA$ be a model for the type instance $\TI$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$ such that$\relE=\at\StrA\se$ is not full on $\domA$.For each \twotype/ $\tpt\in\TI$ let $\eat\tpt\neq\ebt\tpt\in\domA$realize $\tpt$, that is $\tpIab\StrA{\eat\tpt}{\ebt\tpt}=\tpt$.Let\[\Cert = \setbd{\cspIX\StrA{\relE[\eat\tpt]}}{\tpt \in \TIc}.\]Then $\Cert$ is a certificate for $\TI$.The size of $\Cert$ is quadratic with respect to the size of the type instance.\end{lemma}\begin{proof}That $\Cert$ is nonempty follows since $\relE$ is not full on $\domA$.We check the conditions for a certificate:\begin{itemize}  \item[\refcondcertTc]  Let $\tpt\in\TIc$ be any cosmic type, let $\eat\tpt\in\domA$ be the  selected $\xx$-element for $\tpt$ and let  $\csps=\cspIX\StrA{\relE[\eat\tpt]}$.  Then $\ebt\tpt\in\domA\sub\relE[\eat\tpt]$ and so  $\tpt=\tpIab\StrA{\eat\tpt}{\ebt\tpt} \in \die\csps$.  \item[\refcondcertTg]  Let $\tpt\in\TIg$ be any galactic type, and consider $\eat\tpt$ and  $\ebt\tpt$. Then $(\eat\tpt,\ebt\tpt)\in\relE$, so  $\tpt=\tpIab\StrA{\eat\tpt}{\ebt\tpt}\in\dii\csps$ for $\csps =  \cspIX\StrA{\eat\tpt}$.  \item[\refcondcertn]  Let $\tpn\in\TN\TI$ be any noble type.  Then a unique galaxy $\galX$ realizes $\tpn$.  Then if $\csps\in\Cert$ has $\tpn\in\Tpx\csps$, then $\csps=\cspIX\StrA\galX$.\end{itemize}\end{proof}\begin{lemma}[Certificate expansion]\label{lem:cert-exp-many}Let $\Cert$ be a certificate for the type instance $\TI$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$. Then $\Cert$has a finite model.More precisely, let $\pt \geq \card{T}$ be a parameter.Then $\TI$ has a finite model in which each worker type is realized at least$\pt$ times.\end{lemma}\begin{proof}We use induction on $\sze$.We have shown the base case $\sze = 0$, $\vFo2\Eea\sze\agrefine = \vFo2$in~\Cref{lem:cert-expand}.Now let $\sze \geq 1$ and assume the hypothesis for $(\sze-1)$.We build a model $\StrA$ for $\TI$.For every $\csps \in \Cert$,let $\StrAs$ be a model for $\TIs$ in which every worker type isrealized at least $3\pt$ times.Such a model exists.Indeed let $\StrB$ be any model for the spectral type instance $\TIs$ ofthe locally consistent cosmic spectrum $\csps$.By certificate extraction (if $\sze = 1$ by~\Cref{lem:cert-extract} or if $\sze\geq 2$ by~\Cref{lem:cert-ext-many}), we can extract a certificate from $\StrB$and then by induction hypothesis we can build a model $\StrAs$ based on thecertificate with the desired properties.Let $\StrXs$ be the galaxy of $\StrAs$.The galaxies of $\StrA$ are:\begin{itemize}  \item  A single copy of $\StrXs$ for every noble $\csps \in \Cert$.  These galaxies are the \emph{noble galaxies}.  \item  $3\pt$ copies $\StrXsij\csps\ii\jj$ of $\StrXs$ for every peasant  $\csps \in \Cert$, where $\ii \in \set{0,1,2}$ and $\jj \in [1,\pt]$.  These galaxies are the \emph{peasant galaxies}.\end{itemize}Let $\stps(\ea)$ be the intended star-type of $\ea$ and let$\tpp(\ea) = \tpx{(\stps(\ea))}$ be the intended \onetype/ of $\ea$ for$\ea\in\domA$.Let $\domAs\tpp = \setbd{\ea\in\domA}{\tpp(\ea)=\tpp}$ be the set of elementshaving intended \onetype/ $\tpp$ for $\tpp\in\TP\TI$.Consider any noble $\tpn\in\TN\TI$.By~\Cref{rem:many-cert-n}, a unique $\csps\in\Cert$ has $\tpn\in\Tpx\csps$.Note that $\csps$ is noble and by~\Cref{rem:istp-p}$\domAs\tpn \subseteq \galXs$.If $\tpk\in\TK\TI$ is any king type, then by~\Cref{rem:lccsp-ki}$\di\tpk\in\TK\TIs$ is an internal spectral king type for the unique$\csps\in\Cert$ having $\tpk\in\Tpx\csps$, so$\domAs\tpk = \set{\ea^\tpk}$ is a singleton, so $\ea=\ea^\tpk$ is the unique$\ea\in\domA$ having $\tpp(\ea) = \tpk$.If $\tpn\in\TN\TI\sub\TK\TI$ is any noble type that is not a king type,then by~\Cref{rem:lccsp-nw}$\di\tpn\in\TW\TIs$ is an internal worker spectral type for the unique(noble) $\csps\in\Cert$ having $\tpn\in\Tpx\csps$.So $\domAs\tpn = \setbd{\ea\in\galXs}{\tpIa\StrAs\ea=\di\tpn}$ andsince there are at least $3\pt$ elements from $\StrAs$ realizing the workertype $\di\tpn$, we may choose a partition$\domAs\tpn = \domAs\tpn_0 \cup \domAs\tpn_1 \cup \domAs\tpn_2$ such that$\card{\domAs\tpn_\ii} \geq \pt$ for $\ii\in\set{0,1,2}$.If $\tpp\in\TPs\TI$ is any peasant type, let $\Cert^\tpp =\setbd{\csps\in\Cert}{\tpp\in\Tpx\csps}$ be the set of (peasant) cosmicspectrums including $\tpp$.By~\Cref{rem:istp-p}:\[  \domAs\tpp = \setbd{\ea\in\galXsij\csps\ii\jj}{\csps\in\Cert^\tpp,  \ii\in\set{0,1,2}, \jj\in[1,\pt],\tpp(\ea)=\tpp}.\]By~\Cref{rem:istp-int}:\[  \domAs\tpp = \setbd{\ea\in\galXsij\csps\ii\jj}{\csps\in\Cert^\tpp,  \ii\in\set{0,1,2}, \jj\in[1,\pt],\tpIa\StrAs\ea=\di\tpp}.\]Since $\di\tpp\in\TP\TIs$ for $\csps\in\Cert^\tpp$, we have that some$\ea\in\galXsij\csps\ii\jj$ has $\tpp(\ea)=\tpp$ for $\ii\in\set{0,1,2}$ and$\jj\in[1,\pt]$.Consider the partition $\domAs\tpp = \domAs\tpp_0 \cup \domAs\tpp_1 \cup\domAs\tpp_2$, where:\[  \domAs\tpp_\ii = \setbd{\ea\in\galXsij\csps\ii\jj}{\csps\in\Cert^\tpp,  \jj\in[1,\pt],\tpp(\ea)=\tpp}.\]Then $\card{\domAs\tpp_\ii} \geq \pt$.\begin{description}\item[Realization of kings]Let $\tpk\in\TK\TI$ be any king type,let $\csps\in\Cert$ be the unique (noble) cosmic spectrum having$\tpk\in\Tpx\csps$and let $\ea=\ea^\tpk \in \galXs$ be the unique element in $\domA$ having$\tpp(\ea) = \tpk$.Let $\eb\in\domA\sub\galXs$ be any element outside the galaxy of $\ea$.Let $\StrXss\cspsp$ be the galaxy of $\eb$.consider its intended star-type $\stps(\eb)$.By~\refcondstpky, there is a unique $\tpt\in\stps(\eb)$ having $\tpy\tpt=\tpk$.By~\Cref{rem:istp-gal}, $\tpt$ must be cosmic.Assign $\tpIab\StrA\eb\ea = \tpt$.We claim that this assignments are appropriate.First, these assignments are symmetric between kings:suppose that $\eb$ is a king and let $\tpkp = \tpp(\eb) \neq \tpk$ be itsintended \onetype/.Then there is a unique $\tptp\in\stps(\ea)$ such that $\tpy\tptp = \tpkp$.We claim that $\tptp = \inv\tpt$.Indeed, since $\tpt\in\stps(\eb)$ is cosmic, by~\Cref{rem:istp-cos}$\tpt\in\cie\cspsp$, so $\inv\tpt \in \TIc$ is cosmic and by~\refcondcertTc,some $\cspspp\in\Cert$ has $\inv\tpt \in \cie\cspspp$.So $\tpk = \tpx{(\inv\tpt)} \in \Tpx\cspspp$, so $\cspspp=\csps$.By~\Cref{rem:istp-cos-inv}, some $\eap\in\galXs$ has$\inv\tpt\in\csps(\eap)$.But then $\tpp(\eap) = \tpk$, so $\eap=\ea$.So $\inv\tpt\in\csps(\ea)$ and since $\tpy{(\inv\tpt)} = \tpkp$,$\tptp=\inv\tpt$.Next, every $\tpt\in\stps(\ea)$ is realized.Indeed, if $\tpt$ is galactic, then by~\Cref{rem:istp-gal} some$\eb\in\galXs\sub\set\ea$ has $\tpIab\StrXs\ea\eb=\tpt$, so $\tpt$is realized within the galaxy of $\ea$.If $\tpt$ is cosmic, then $\inv\tpt$ is cosmic and by~\refcondcertTc{} some$\cspsp\in\Cert$ has $\inv\tpt\in\cie\cspsp$.By~\Cref{rem:istp-cos-inv}, some $\eb\in\galXs$ has$\inv\tpt\in\stps(\eb)$, so some $\eb\in\domA\sub\galXs$ has$\inv\tpt\in\stps(\eb)$.But $\tpy{(\inv\tpt)}=\tpk$, to $\inv\tpt\in\stps(\eb)$ is unique, so we wouldassign $\tpIab\StrA\eb\ea=\inv\tpt$.\item[Realization of workers]Let $\tpp\in\TW\TI$ be any worker type and let $\ea \in \domAs\tpp_\ii$ be anyelement with intended \onetype/ $\tpp$.Let $\iip = (\ii+1\bmod3)\in\set{0,1,2}$ be the index of the next copy ofelements.Consider $\stps=\stps(\ea)$ and let $\tpt\in\stps$.If $\tpt$ is galactic, by~\Cref{rem:istp-gal}, it is realized by some otherelement in the galaxy of $\ea$.If $\tpy\tpt\in\TK\TI$ is a king type, then it is realized at the realization ofkings.So only the case where $\tpt$ is galactic and $\tppp=\tpy\tpt \in \TW\TI$ is aworker type remains.Let $\TU=\setbd{\tpu\in\csps}{\tpy\tpu=\tppp}$ be the set of all \twotypes/parallel to $\tpt$ in $\csps$.Note that $\card{\TU} \leq \pt$.We simultaneously find distinct $\ebt\tpu$ from the \emph{next copy} of elementsfor the assignments $\tpIab\StrA\ea{\ebt\tpu} = \tpu$:Since $\card{\domAs\tppp_\iip} \geq \pt$, there are enough such elements.These assignments are consistent, since they have been made between elementsfrom consecutive copies.\item[Completion]Suppose that $\ea\neq\eb\in\domA$ are any elements that have not yet beenassigned a \twotype/.Then $\ea$ and $\eb$ come from distinct galaxies.We claim that some $\tpt\in\TIg$ has $\tpx\tpt=\tpp$ and $\tpy\tpt=\tppp$.Let $\tpp=\tpp(\ea)$ and $\tppp=\tpp(\eb)$ and let $\StrXs$ be the galaxyof $\ea$.First suppose that $\tppp$ is noble.If $\tppp\in\Tpx\csps$, then $\csps$ is noble, so $\eb$ and $\ea$ come from thesame galaxy --- a contradiction.Otherwise $\tppp\in\Tpy\csps$ and by~\Cref{rem:lccsp-xy} some $\tpt\in\cie\csps$has $\tpx\tpt=\tpp$ and $\tpy\tpt=\tppp$.Next suppose that $\tppp$ is peasant.Then by~\Cref{rem:lccsp-ps} $\tppp\in\Tpy\csps$ and so by~\Cref{rem:lccsp-xy}some $\tpt\in\cie\csps$ has $\tpx\tpt=\tpp$ and $\tpy\tpt=\tppp$.\end{description}\end{proof}\begin{proposition}The type realizability problem for $\vFo2\Eea\sze\agrefine$ coincides with thefinite type realizability problem and is in $\cNP$.\end{proposition}\begin{proof}We use induction on $\sze$.If $\sze=0$, this is~\Cref{prop:tprealiz-1}.Suppose that $\sze\geq1$ and assume the induction hypothesis.Let $\TI$ be a type instance over the classified signature $\ClSig\SigS\sms$over $\vFo2\Eea\sze\agrefine$ and let $\se$ be the coarsest equivalence symbolin $\SigS$.First by induction in nondeterministic polynomial type check if $\TI$ has amodel $\StrA$ where $\at\StrA\se = \domAA$ is full on $\StrA$.This is reducible to $\vFo2\Eea{(\sze-1)}\agrefine$ by consideringonly the \twotypes/ from $\TI$ that contain the literal $\se(\xx,\yy)$.If this fails to yield a model, then guess a polynomial certificate for $\TI$.Check that each cosmic spectrum of the certificate is locally consistent byinduction hypothesis in nondeterministic polynomial time.The full version coincides with the finite version since the model constructedin~\Cref{lem:cert-exp-many} is finite.\end{proof}\begin{corollary}For any $\sze \geq 1$, the logic $\vFo2\Eea\sze\agrefine$ has the finite modelproperty and its (finite) satisfiability problem is in $\cNExpTime$.By~\Cref{prop:global-to-refine-n} and~\Cref{prop:local-to-refine-n}, the sameholds for $\vFo2\Eea\sze\agglobal$ and$\vFo2\Eea\sze\aglocal$.\end{corollary}\begin{corollary}The logic $\vFo2\Eea\nosze\agrefine$ has the finite model property and its(finite) satisfiability problem is in $\ceNExpTime{2}$.By~\Cref{prop:global-to-refine} and~\Cref{prop:local-to-refine}, the same holdsfor $\vFo2\Eea\nosze\agglobal$ and$\vFo2\Eea\sze\aglocal$.\end{corollary}