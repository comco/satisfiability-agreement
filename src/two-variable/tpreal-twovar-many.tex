% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featureing $\sze \geq 2$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement. Abbreviate the coarsest equivalence symbol $\se = \see\sze$.Recall from the previous section that every $\vFo2$-sentence $\fphi$ can bereduced in polynomial time to an equisatisfiable sentence in the form:\begin{equation*}  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy  (\smm\ii(\xx,\yy) \land \xx \neq \yy),\end{equation*}that may use additional unary predicate symbols and the new message symbols$\smm\ii$, where the $\forall\forall$-part $\falp$ is quantifier-free.\begin{definition}A \emph{classified signature} for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ is apredicate signature $\SigS$ together with a sequence $\sms =\smm1\smm2\dots\smm\nm$ of distinct binary predicate symbols \emph{distinctfrom the equivalence symbols} from $\SigS$ having the intended interpretation\begin{equation*}  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy   (\smm\ii(\xx,\yy) \land \xx \neq \yy).\end{equation*}\end{definition}Again, note that a classified signature \emph{automatically includes} the$\forall\exists$-part of formulas and $\seq{\SigS,\sms}$-structures\emph{automatically satisfy} the $\forall\exists$-part.The (finite) classified satisfiability problem for$\Lvp\Fo2\nopow\Eea\sze\agrefine$ is defined as in~\Cref{def:clsig-twovar}.Again we have the reduction:\[  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.\]Let $\ClSig\SigS\sms$ be a classified signature for$\Lvp\Fo2\nopow\Eea\sze\agrefine$.A type instance $\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$ is defined asin~\Cref{def:tpinst-twovar}; also the notions of a model for a type instance,full realization, characteristic type instance of a model and the (finite)(full) type realizibility problem for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ aredefined. Again, the reductions from~\Cref{rem:red-real-to-full-real}and~\Cref{rem:red-sat-to-real} hold:\begin{align*}  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNP   \FinAFullReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cExpTime
  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.
\end{align*}We proceed to define new terms, specific to the case of many equivalencesymbols.The terminology is loosely based on~\cite{MALQ:MALQ201400102}.\begin{definition}A $2$-type $\tpTt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in\tau$.Otherwise, if $(\lnot\se(\xx,\yy)) \in \tpTt$, the type is a \emph{cosmic type}.The set of galactic $2$-types is $\TpTg\SigS$.The set of cosmic $2$-types is $\TpTc\SigS$.\end{definition}Informally, we think of the $\se$-classes in a structure as galaxies, thewhole structure as the cosmos, of the galactic $2$-types as characterizing theinteractions in the internals of the $\se$-classes of a structure, while cosmic $2$-types characterize the interactions between elements in different$\se$-classes.Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.\begin{definition}Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{galactically connectable}(written $\tpIp \gconn \tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$for some galactic $\tpTt \in \TpiT$.The types are \emph{cosmically connectable} (written $\tpIp \cconn \tpIpp$), if$\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some cosmic $\tpTt \in \TpiT$.\end{definition}Note that the types may be both galactically and cosmically connectible and the(unqualified) definition of connectible types from~\Cref{def:connectable} isequivalent to:\[\miff{\tpIp \conn \tpIpp}{\tpIp \gconn \tpIpp \text{ or } \tpIp \cconn\tpIpp}.\]Recall that a $1$-type $\tpIp$ is a \emph{king type} if $\tpIp \not\conn \tpIp$.A $1$-type $\tpIp$ is a \emph{noble type} if $\tpIp \not\cconn \tpIp$.We now generalize~\Cref{rem:twovar-king-once}:\begin{remark}\label{rem:twovar-noble-once}If $\StrA$ is a full model for $\Tpi\TpiP\TpiT$ then every king type$\tpIk \in \TpiP$ is realized once in $\StrA$ and every noble type $\tpId \in\TpiP$ is realized (possibly many times) in a single $\se$-class of $\StrA$.\end{remark}Recall that $\Tpi\TpiP\TpiT$ is connected if every two distinct $1$-types areconnectible. Again, if $\Tpi\TpiP\TpiT$ is not connected then $\Tpi\TpiP\TpiT$is not fully realizable.Our strategy to resolve the type realizability problem would be to encode thegalactic structure of enough $\se$-classes of into instances of the typerealizability problem for the logic featuring one less equivalence symbol.\begin{definition}Let $\StrA$ be a $\ClSig\SigS\sms$-structure and let $\relE = \at\StrA\se$.The \emph{cosmic spectrum} $\cspIX\StrA\eclX$ of an $\relE$-class$\eclX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpTc\SigS}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]Note that the cosmic spectrum is empty iff $\relE = \domA\cprod\domA$.TODO: WLOG, we may assume that the cosmic spectrum is nonempty, because thefull relation is definable in $\vFo2$.\end{definition}We now extract the essential features of a cosmic spectrum:\begin{definition}A \emph{cosmic spectrum} $\stps \subseteq (\TpiT \cap \TpTc\SigS)$ for thetype instance $\Tpi\TpiP\TpiT$ is a nonempty set of cosmic types satisfyingadditional conditions:\begin{enumerate}  \item\label{cond:cspec-1} If $\tpIn \in (\xtp\restriction\stps)$ is a noble  type, then no $\tpTt \in \stps$ has $\ytp\tpTt = \tpIn$.  \item\label{cond:cspec-2} If $\tpIn \not\in (\xtp\restriction\stps)$ is any  noble type, then some (possibly many) $\tpTt \in \stps$ has $\ytp\tpTt =  \tpIn$.  \item\label{cond:cspec-3} If $\tpIk \not\in \xTp\stps$ is any king type, then  one $\tpTt \in \stps$ has $\ytp\tpTt = \tpIk$. Note that the existence follows  anyway from Condition~\ref{cond:cspec-2}. TODO: Check if this isn't implied by  local consistency below.\end{enumerate}\end{definition}TODO: Verify that $\cspIX\StrA\eclX$ is a cosmic spectrum in this sense.TODO: Define locally-consistent cosmic spectrum. Verify that $\cspIX\StrA\eclX$is locally-consistent.TODO: Local consistency: extract a $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-typeinstance $(\TpiP', \TpiT')$ from the cosmic spectrum. Let $in$ be a new unarypredicate symbol.For every internal $1$-type $\tpIp \in \xTp\stps$, add an internal $1$-type$\tpIp' = \tpIp \cup \set{in(\xx)}$ to $\TpiP'$.For every external $1$-type $\tpIp \in(\ytp\restriction\stps)$, add an external$1$-type $\tpIp' = \tpIp \cup \set{\lnot in(\xx)}$ to $\TpiP'$.Take easy care of external $1$-types by adding \emph{external black hole}$1$-type with relations that fully-witness external types $\tpTt =\pi(\xx) \cup \pi'(\yy) \cup \setbd{\sm(\xx,\yy) \land \sm(\yy,\xx)}{\sm \in \sms} \cup \set{\text{stuff to make it maximalconsistent}}$.For every \emph{galactic} $2$-type $\tpTt \in \TpiT$, add$\tpTt' = \tpTt \cup \set{in(\xx), in(\yy)} \sub \set{\text{everything containing }\se}$.For every (cosmic) $2$-type $\tpTt \in \stps$, add$\tpTt' = \tpTt \cup \set{in(\xx),out(\yy)} \sub \set{\text{everythingcontaining }\se}$.Call a cosmic spectrum locally consistent if $(\TpiP', \TpiT')$ is$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-realizable (THIS IS WHERE WE USE THESUBPROBLEM FOR ONE LESS EQUIVALENCE).\begin{definition}A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is anonempty set of locally consistent cosmic spectrums satisfying the followingconditions:\begin{enumerate}  \item If $\tpIp \in \TpiP$ then some (possibly many) $\stps \in \Cert$ have  $\tpIp \in (\xtp \restriction \stps)$.  \item If $\tpIn \in \TpiP$ is noble, then one $\stps \in \Cert$ has   $\tpIn \in (\xtp \restriction \stps)$.  \item If $\stps \in \Cert$ and $\tpTt \in \stps$,  then $\inv\tpTt \in \stps'$ for some $\stps' \in \Cert$.\end{enumerate}\end{definition}TODO: Certificate extraction: for every cosmic $2$-type $\tpTt$ realized in$\StrA$, let $\ea_\tpTt, \eb_\tpTt$ be a pair of distinct elements (and indistinct $\se$-classes, since $\tpTt$ is cosmic) realizing it. Take:\[  \Cert = \setbd{\cspIX\StrA{E[\ea_\tpTt]}, \cspIX\StrA{E[\eb_\tpTt]}}{\tpTt  \dots}\]