% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featureing $\sze \geq 2$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement. Abbreviate the coarsest equivalence symbol $\se = \see\sze$.Recall from the previous section that every $\vFo2$-sentence $\fphi$ can bereduced in polynomial time to an equisatisfiable sentence in the form:\begin{equation*}  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy  (\smm\ii(\xx,\yy) \land \xx \neq \yy),\end{equation*}that may use additional unary predicate symbols and the new message symbols$\smm\ii$, where the $\forall\forall$-part $\falp$ is quantifier-free.\begin{definition}A \emph{classified signature} for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ is apredicate signature $\SigS$ together with a sequence $\sms =\smm1\smm2\dots\smm\nm$ of distinct binary predicate symbols \emph{distinctfrom the equivalence symbols} from $\SigS$ having the intended interpretation\begin{equation*}  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy   (\smm\ii(\xx,\yy) \land \xx \neq \yy).\end{equation*}\end{definition}Again, note that a classified signature \emph{automatically includes} the$\forall\exists$-part of formulas and $\seq{\SigS,\sms}$-structures\emph{automatically satisfy} the $\forall\exists$-part.The (finite) classified satisfiability problem for$\Lvp\Fo2\nopow\Eea\sze\agrefine$ is defined as in~\Cref{def:clsig-twovar}.Again we have the reduction:\[  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.\]Let $\ClSig\SigS\sms$ be a classified signature for$\Lvp\Fo2\nopow\Eea\sze\agrefine$.A type instance $\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$ is defined asin~\Cref{def:tpinst-twovar}; also the notions of a model for a type instance,full realization, characteristic type instance of a model and the (finite)(full) type realizibility problem for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ aredefined. Again, the reductions from~\Cref{rem:red-real-to-full-real}and~\Cref{rem:red-sat-to-real} hold:\begin{align*}  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNP   \FinAFullReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cExpTime
  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.
\end{align*}We proceed to define new terms, specific to the case of many equivalencesymbols.The terminology is loosely based on~\cite{MALQ:MALQ201400102}.\begin{definition}A $2$-type $\tpTt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in\tau$.Otherwise, if $(\lnot\se(\xx,\yy)) \in \tpTt$, the type is a \emph{cosmic type}.The set of galactic $2$-types is $\TpTg\SigS$.The set of cosmic $2$-types is $\TpTc\SigS$.\end{definition}Informally, we think of the $\se$-classes in a structure as galaxies, thewhole structure as the cosmos, of the galactic $2$-types as characterizing theinteractions in the internals of the $\se$-classes of a structure, while cosmic $2$-types characterize the interactions between elements in different$\se$-classes.Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.\begin{definition}Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{galactically connectable}(written $\tpIp \gconn \tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$for some galactic $\tpTt \in \TpiT$.The types are \emph{cosmically connectable} (written $\tpIp \cconn \tpIpp$), if$\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some cosmic $\tpTt \in \TpiT$.\end{definition}Note that the types may be both galactically and cosmically connectible and the(unqualified) definition of connectible types from~\Cref{def:connectable} isequivalent to:\[\miff{\tpIp \conn \tpIpp}{\tpIp \gconn \tpIpp \text{ or } \tpIp \cconn\tpIpp}.\]Recall that a $1$-type $\tpIp$ is a \emph{king type} if $\tpIp \not\conn \tpIp$.A $1$-type $\tpIp$ is a \emph{noble type} if $\tpIp \not\cconn \tpIp$.We now generalize~\Cref{rem:twovar-king-once}:\begin{remark}\label{rem:twovar-noble-once}If $\StrA$ is a full model for $\Tpi\TpiP\TpiT$ then every king type$\tpIk \in \TpiP$ is realized once in $\StrA$ and every noble type $\tpIn \in\TpiP$ is realized (possibly many times) in a single $\se$-class of $\StrA$.\end{remark}Recall that $\Tpi\TpiP\TpiT$ is connected if every two distinct $1$-types areconnectible. Again, if $\Tpi\TpiP\TpiT$ is not connected then $\Tpi\TpiP\TpiT$is not fully realizable.Our strategy to resolve the type realizability problem would be to encode thegalactic structure of enough $\se$-classes of into instances of the typerealizability problem for the logic featuring one less equivalence symbol.\begin{definition}A \emph{cosmic spectrum} $\stps \subseteq (\TpiT \cap \TpTc\SigS)$ for thetype instance $\Tpi\TpiP\TpiT$ is a nonempty set of cosmic types satisfyingthe following conditions:\begin{enumerate}  \item\label{cond:cspec-1} If $\tpIn \in (\xtp\restriction\stps)$ is a noble  type, then no $\tpTt \in \stps$ has $\ytp\tpTt = \tpIn$.  \item\label{cond:cspec-2} If $\tpIn \not\in (\xtp\restriction\stps)$ is any  noble type, then some (possibly many) $\tpTt \in \stps$ has $\ytp\tpTt =  \tpIn$.  \item\label{cond:cspec-3} If $\tpIk \not\in (\xtp\restriction\stps)$ is any  king type, then one $\tpTt \in \stps$ has $\ytp\tpTt = \tpIk$. Note that the existence follows  anyway from Condition~\ref{cond:cspec-2}.   % TODO: Check if this isn't implied by local consistency below.\end{enumerate}\end{definition}\begin{definition}Let $\StrA$ be a $\ClSig\SigS\sms$-structure and let $\relE = \at\StrA\se$.The \emph{cosmic spectrum} $\cspIX\StrA\eclX$ of an $\relE$-class$\eclX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpTc\SigS}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]Note that the cosmic spectrum is empty iff $\relE = \domA\cprod\domA$.Without loss of generality, we may assume that $\relE$ is not the full relation,because the full relation is trivially definable in $\vFo2$. So without loss ofgenerality, we will consider models with nonempty cosmic spectrums of their$\se$-classes.\end{definition}\begin{remark}If $\StrA$ is a full $\Tpi\TpiP\TpiT$-model, $\relE = \at\StrA\se$ is not thefull relation on $\domA$ and $\eclX \in \Ecl\relE$ is a galaxy, then$\cspIX\StrA\eclX$ is a cosmic spectrum for $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}We check the conditions for a cosmic spectrum. First, $\stps = \cspIX\StrA\eclX$is nonempty since $\relE$ is not the full relation on $\domA$.\begin{enumerate}  \item If $\tpIn \in (\xtp\restriction\stps)$ is a noble type, then all  elements realizing $\tpIn$ in $\StrA$ are in $\eclX$, hence there is no cosmic  $\tpTt \in \stps$ having $\ytp\tpTt = \tpIn$.  \item If $\tpIn \not\in (\xtp\restriction\stps)$ is a noble type,  since $\StrA$ is a full model, there is some element $\eb \in \domA \sub  \eclX$ realizing $\tpIn$. Then $\tpTt = \tpIab\StrA\ea\eb$ is a $2$-type  having $\tpTt \in \stps$ and $\ytp\tpTt = \tpIn$.  \item If $\tpIk \not\in (\xtp\restriction\stps)$ is a king type, then there is  a unique element $\eb \in \domA$ realizing $\tpIk$.  Note that $\eb \not\in \eclX$ and the $2$-type  $\tpTt = \tpIab\StrA\ea\eb$ is the unique $\tpTt \in \stps$ such that  $\ytp\tpTt = \tpIk$.\end{enumerate}\end{proof}We like to think about a cosmic spectrum of a galaxy as the \emph{reason why}that galaxy is possible. For this we need to define the notion of a\emph{locally-consistent} cosmic spectrum. For this we extract a type instance$(\TpiP_\stps,\TpiT_\stps)$ over the \emph{simpler logic}$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$ out of the cosmic spectrum $\stps$:\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and $\stps\subseteq (\TpiT \cap \TpTc\SigS)$ be a cosmic spectrum for $\Tpi\TpiP\TpiT$.Let $\si$ (intended to label the inside of the galaxy) and $\sbh$ (intended tolabel some \emph{black hole} outside the galaxy) be two new unary predicatesymbols.For a $1$-type $\tpIp$ or a $2$-type $\tpTt$, denote by $\noe\tpIp$ and $\noe\tpTt$ the reducts of $\tpIp$ and$\tpTt$ to the language $\SigS - \set{\se}$.That is, $\noe\tpIp \subset \tpIp$ and $\noe\tpTt \subset \tpTt$ consist ofthose literals that do not feature the predicate symbol $\se$.We define the \emph{spectral type instance} $(\TpiP_\stps,\TpiT_\stps)$corresponding to the cosmic spectrum $\stps$ as a type instance overthe $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-signature $\ClSig{\SigS - \set{\se} + \set{\si,\sbh}}\sms$ as follows:\begin{description}  \item[(I)] For every $\tpIp \in (\xtp\restriction\stps)$,  the $1$-type $\noe\tpIp \cup \set{\si(\xx),\lnot\sbh(\xx)}$ is added to $\TpiP_\stps$.  \item[(O)] For every $\tpIp \in (\ytp\restriction\stps)$,  the $1$-type $\noe\tpIp \cup \set{\lnot\si(\xx),\lnot\sbh(\xx)}$ is added to $\TpiP_\stps$.  \item[(B)] Let $\beta$ be an arbitrary $1$-type extending  $\set{\lnot\si(\xx),\sbh(\xx)}$. Call $\beta$ the \emph{black hole type}.  The black hole type is added to $\TpiP_\stps$.  \item[(II)] For every (galactic) $\tpTt \in (\TpiT \cap  \TpTg\SigS)$, the $2$-type  \[    \noe\tpTt \cup \set{\si(\xx),\lnot\sbh(\xx),\si(\yy),\lnot\sbh(\yy)}  \]  is added to $\TpiT_\stps$.  \item[(IO),(OI)] For every (cosmic) $\tpTt \in \stps$,  the $2$-type  \[    \noe\tpTt \cup \set{\si(\xx),\lnot\sbh(\xx),\lnot\si(\yy),\lnot\sbh(\yy)}    \] and its inverse are added to $\TpiT_\stps$.  \item[(OO)] For every unordered pair of (not necessarly  distinct) $1$-types $\set{\tpIp_\stps, \tpIp_\stps'} \subseteq \TpiP_\stps$ that are  ``out''-types:  $\set{\lnot\si(\xx),\lnot\sbh(\xx)} \subseteq \tpIp_\stps$ and  $\set{\lnot\si(\xx),\lnot\sbh(\xx)} \subseteq \tpIp_\stps'$, add an arbitrary   $2$-type $\tpTt$ connecting them (so $\xtp\tpTt = \tpIp_\stps$ and $\ytp\tpTt  = \tpIp_\stps'$) and its inverse $\inv\tpTt$ to $\TpiT_\stps$.  \item[(IB)] For every $1$-type $\tpIp_\stps \in  \TpiP_\stps$ that is an ``in''-type, so  $\set{\si(\xx),\lnot\sbh(\xx)} \subseteq \tpIp_\stps$, let $\tpTt$ be an  arbitrary $2$-type connecting $\tpIp_\stps$ and the black hole type $\beta$  that witnesses no messages for $\tpIp_\stps$ and everything for $\beta$:  $(\lnot\sm(\xx,\yy)) \in \tpTt$ and $\sm(\yy,\xx) \in \tpTt$ for every $\sm  \in \sms$, add $\tpTt$ and $\inv\tpTt$ to $\TpiT_\stps$.  \item[(OB)] For every $1$-type $\tpIp_\stps \in  \TpiP_\stps$ that is an ``out''-type, so  $\set{\lnot\si(\xx),\lnot\sbh(\xx)} \subseteq \tpIp_\stps$,  let $\tpTt$ be an arbitrary $2$-type connecting $\tpIp_\stps$ and the black  hole type $\beta$ that witnesses every message for $\tpIp_\stps$ and for  $\beta$: $\sm(\xx,\yy) \in \tpTt$ and $\sm(\yy,\xx) \in \tpTt$ for every $\sm  \in \sms$, add $\tpTt$ and $\inv\tpTt$ to $\TpiT_\stps$.\end{description}\end{definition}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\Lvp\Fo2\nopow\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.The cosmic spectrum $\stps \subseteq (\TpiT \cap \TpTc\SigS)$ is\emph{locally consistent} if its spectral type instance$(\TpiP_\stps, \TpiT_\stps)$ is fully satisfiable (as a type instance for the$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-classified signature$\ClSig{\SigS - \set{\se} + \set{\si, \sbh}}\sms$.\end{definition}\begin{remark}Let $\StrA$ be a full $\Tpi\TpiP\TpiT$-model, $\relE = \at\StrA\se$ is not thefull relation of $\domA$ and $\eclX \in \Ecl\relE$ be a galaxy. Then$\cspIX\StrA\eclX$ is a locally consistent cosmic spectrum for $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}Let $\SigSp = \SigS - \set{\se} + \set{\si,\sbh}$. We build a $\SigSp$-structure$\StrAp$ based on $\StrA$ that fully realizes the spectral type instance$(\TpiP_\stps, \TpiT_\stps)$. The domain of $\StrAp$ is $\domA' = \domA \cup\set{\ec}$, where $\ec$ is a new \emph{black hole} element. The $1$-type ofevery element in $\StrAp$ is defined as follows:\begin{description}  \item[(I)] If $\ea \in \eclX$ is inside, then $\tpIa\StrAp\ea =  \noe{\tpIa\StrA\ea} \cup \set{\si(\xx),\lnot\sbh(\xx)}$,  that is the elements from the galaxy are inside.  \item[(O)] If $\ea \in \domA\sub\eclX$ is outside, then $\tpIa\StrAp\ea =  \noe{\tpIa\StrA\ea} \cup \set{\lnot\si(\xx),\lnot\sbh(\xx)}$, that is the  elements outside the galaxy are outside.  \item[(B)] If $\ea = \ec$, then $\tpIa\StrAp\ea = \beta$, that is the black  hole element has the black hole type.\end{description}The $2$-type between every pair of distinct elements $\ea \neq \eb \in \domA'$is defined as follows:\begin{description}  \item[(II)] If $\ea,\eb \in \eclX$ are inside, then:  \[    \tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup    \set{\si(\xx),\lnot\sbh(\xx),\si(\yy),\lnot\sbh(\yy)}.  \]  \item[(IO)] If $\ea \in \eclX$ is inside and $\eb \in \domA \sub \eclX$ is  outside, then:  \[    \tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup    \set{\si(\xx),\lnot\sbh(\xx),\lnot\si(\yy),\lnot\sbh(\yy)}.  \]  \item[(OI)] If $\ea \in \domA \sub \eclX$ is outside and $\eb \in \eclX$ is  inside, then:  \[    \tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup    \set{\lnot\si(\xx),\lnot\sbh(\xx),\si(\yy),\lnot\sbh(\yy)}.  \]  Note that this produces the $2$-type that is exactly the inverse of the  previous point.  \item[(OO)] If $\ea, \eb \in \domA \sub \eclX$ are outside, then let $\tpTt  \in \TpiT_\stps$ be the $2$-type connecting $\tpIp_\stps = \tpIa\StrAp\ea$ and  $\tpIp_\stps' = \tpIa\StrAp\eb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$. Note  that this assignment is symmetric, since the unique $2$-type connecting  $\tpIp_\stps'$ and $\tpIp_\stps$ in $\TpiT_\stps$ is $\inv\tpTt$.  \item[(IB)] If $\ea \in \eclX$ is inside and $\eb = \ec$ is the black hole,  then let $\tpTt \in \TpiT_\stps$ be the unique $2$-type connecting $\tpIp_\stps =  \tpIa\StrAp\ea$ and $\beta$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.  \item[(OB)] If $\ea \in \domA \sub \eclX$ is outside and $\eb = \ec$ is the  black hole, then let $\tpTt \in \TpiT_\stps$ be the unique $2$-type connecting  $\tpIp_\stps = \tpIa\StrAp\ea$ and $\beta$ and assign $\tpIab\StrAp\ea\eb =  \tpTt$.\end{description}We have to verify that $\StrAp$ is indeed a $\ClSig\SigSp\sms$-structure, thatis that the star-type of every element of $\StrAp$ contains $\sm(\xx,\yy)$ forevery $\sm \in \sms$. \begin{description}\item[(I)] For the in-elements $\ea \in \eclX \subset \domA'$, every$\sm \in \sms$ that is included in $\stpIa\StrA\ea$ is also included in$\stpIa\StrAp\ea$, since a $2$-type $\noe\tpTt$ contains $\sm(\xx,\yy)$ iff$\tpTt$ contains $\sm(\xx,\yy)$\footnote{this is where we use the conditionthat the message symbols of a classified signature are distinct from thebuiltin equivalence symbols}.\item[(O)] For the out-elements $\ea \in (\domA \sub \eclX) \subset \domA'$, wejust need to recall that in the (OB) case, we included a $2$-type $\tpTt$ thatwitnesses every message symbol for both of its ends: $\sm(\xx,\yy) \in \tpTt$and $\sm(\yy,\xx) \in \tpTt$. By construction, this is exactly the $2$-typebetween $\ea$ and the black hole $\ec$.\item[(B)] For the black hole $\ec \in \domA'$, we just have to recall that inthe (IB) and (OB) cases, all included $2$-types connecting to the black holetype contained $\sm(\yy,\xx)$ for every $\sm \in \sms$.\end{description}Since $\StrA$ was a full $\Tpi\TpiP\TpiT$-model, it is clear that $\StrAp$ is afull $(\TpiP_\stps,\TpiT_\stps)$-model.\end{proof}\section{NOTES}\begin{definition}A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is anonempty set of locally consistent cosmic spectrums satisfying the followingconditions:\begin{enumerate}  \item If $\tpIp \in \TpiP$, then some (possibly many) $\stps \in \Cert$ have  $\tpIp \in (\xtp \restriction \stps)$.  \item If $\tpIn \in \TpiP$ is noble, then one $\stps \in \Cert$ has   $\tpIn \in (\xtp \restriction \stps)$.  \item If $\stps \in \Cert$ and $\tpTt \in \stps$,  then $\inv\tpTt \in \stps'$ for some $\stps' \in \Cert$.\end{enumerate}\end{definition}TODO: Certificate extraction: for every cosmic $2$-type $\tpTt$ realized in$\StrA$, let $\ea_\tpTt, \eb_\tpTt$ be a pair of distinct elements (and indistinct $\se$-classes, since $\tpTt$ is cosmic) realizing it. Take:\[  \Cert = \setbd{\cspIX\StrA{E[\ea_\tpTt]}, \cspIX\StrA{E[\eb_\tpTt]}}{\tpTt  \dots}\]