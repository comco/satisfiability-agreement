% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featuring $\sze \geq 2$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement. Abbreviate the coarsest equivalence symbol $\se = \see\sze$.Recall from the previous section that every $\vFo2$-sentence $\fphi$ can bereduced in polynomial time to an equisatisfiable sentence in the form:\begin{equation*}  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy  (\smm\ii(\xx,\yy) \land \xx \neq \yy),\end{equation*}that may use additional unary predicate symbols and the new message symbols$\smm\ii$, where the $\forall\forall$-part $\falp$ is quantifier-free.\begin{definition}A \emph{classified signature} for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ is apredicate signature $\SigS$ together with a sequence $\sms =\smm1\smm2\dots\smm\nm$ of distinct binary predicate symbols \emph{distinctfrom the equivalence symbols} from $\SigS$ having the intended interpretation\begin{equation*}  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy   (\smm\ii(\xx,\yy) \land \xx \neq \yy).\end{equation*}\end{definition}Again, note that a classified signature \emph{automatically includes} the$\forall\exists$-part of formulas and $\seq{\SigS,\sms}$-structures\emph{automatically satisfy} the $\forall\exists$-part.The (finite) classified satisfiability problem for$\Lvp\Fo2\nopow\Eea\sze\agrefine$ is defined as in~\Cref{def:clsig-twovar}.Again we have the reduction:\[  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.\]Let $\ClSig\SigS\sms$ be a classified signature for$\Lvp\Fo2\nopow\Eea\sze\agrefine$.A type instance $\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$ is defined asin~\Cref{def:tpinst-twovar}; also the notions of a model for a type instance,and the (finite) type realizability problem for$\Lvp\Fo2\nopow\Eea\sze\agrefine$ are defined as before. Again, the reduction of~\Cref{rem:red-sat-to-real} holds:\[  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} \red\cNExpTime
  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.
\]We proceed to define new terms, specific to the case of many equivalencesymbols.The terminology is loosely based on~\cite{MALQ:MALQ201400102}.\begin{definition}A $2$-type $\tpTt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in\tau$.Otherwise, if $(\lnot\se(\xx,\yy)) \in \tpTt$, the type is a \emph{cosmic type}.The set of galactic $2$-types is $\TpTg\SigS$.The set of cosmic $2$-types is $\TpTc\SigS$.\end{definition}Informally, we think of the $\se$-classes in a structure as galaxies; of thewhole structure as the cosmos; of the galactic $2$-types as characterizing theinteractions in the internals of the galaxies, while cosmic $2$-typescharacterize the interactions between different galaxies.\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{galactically connectable}(written $\tpIp \gconn \tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$for some galactic $\tpTt \in \TpiT$.The types are \emph{cosmically connectable} (written $\tpIp \cconn \tpIpp$), if$\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some cosmic $\tpTt \in \TpiT$.\end{definition}Note that the types may be both galactically and cosmically connectable and the(unqualified) definition of connectable types from~\Cref{def:connectable} isequivalent to:\[\miff{\tpIp \conn \tpIpp}{\tpIp \gconn \tpIpp \text{ or } \tpIp \cconn\tpIpp}.\]Recall that a $1$-type $\tpIk$ is a \emph{king type} if $\tpIk \not\conn \tpIk$.A $1$-type $\tpIn$ is a \emph{noble type} if $\tpIn \not\cconn \tpIn$. Note thatevery king type is a noble type. A $1$-type $\tpIp \in \TpiP$ is a peasant typeif it is not a noble type.Note that this is a different definition of a peasant type from the definition in theno builtin equivalence symbols case.Let $\TKg = \TKgi\TpiP\TpiT$ be the set of king types, $\TNo = \TNoi\TpiP\TpiT$be the set of noble types and $\TPs = \TPsi\TpiP\TpiT$ be the set of peasanttypes. The following is a generalization of~\Cref{rem:twovar-king-once}including noble types:\begin{remark}\label{rem:twovar-noble-once}If $\StrA$ is a model for $\Tpi\TpiP\TpiT$, then every king type$\tpIk \in \TKgi\TpiP\TpiT$ is realized once in $\StrA$ and every noble type$\tpIn \in \TNoi\TpiP\TpiT$ is realized (possibly many times) in only one galaxyof $\StrA$.\end{remark}Our strategy to resolve the type realizability problem would be to encode thegalactic structure of enough galaxies into instances of the typerealizability problem for the logic featuring one less equivalence symbol.The following characterizes the local structure of a single galaxy ina model.\begin{definition}A \emph{cosmic spectrum} $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ for thetype instance $\Tpi\TpiP\TpiT$ is a nonempty set of cosmic types satisfyingthe following conditions:\begin{itemize}  \item[\cspcondIp]\label{cond:csp-Ip}  Call the set of $1$-types $(\xtp\restriction\stps)$ the inside of $\csps$.  This is not a condition and Condition~\refstpcond1 for star-types has no  analogue in this setting.  \item[\cspcondIIp]\label{cond:csp-IIp}  If $\tpIn \in (\xtp\restriction\csps) \cap \TNo$ is a noble type  inside $\stps$, then no $\tpTt \in \stps$ has $\ytp\tpTt = \tpIn$.  This is the analogue of Condition~\refstpcond2 for star-types.  \item[\cspcondIIIp]\label{cond:csp-IIIp}  If $\tpIn \in \TNo \sub (\xtp\restriction\stps)$ is any noble type outside  $\csps$ and $\tpIp \in (\xtp\restriction\stps)$ is any $1$-type inside  $\csps$, then some (possibly many) $\tpTt \in \stps$ have   $\xtp\tpTt = \tpIp$ and $\ytp\tpTt = \tpIn$.  This is the analogue of Condition~\refstpcond3 for star-types.  \item[\cspcondIVp]\label{cond:csp-IVp}  This is not a condition. The notion of local consistency  will be the analogue of Condition~\refstpcond4 for star-types.\end{itemize}The cosmic spectrum is \emph{noble} if there is a noble $1$-type $\tpIn \in(\xtp\restriction\stps)$.\end{definition}\begin{definition}Let $\StrA$ be a $\ClSig\SigS\sms$-structure and let $\relE = \at\StrA\se$.The \emph{cosmic spectrum} $\cspIX\StrA\eclX$ of an $\relE$-class$\eclX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpTc\SigS}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]Note that the cosmic spectrum is empty iff $\relE = \domA\cprod\domA$ is thefull relation on $\domA$.We will concentrate on the case where $\relE$ is not the full relation,since the full relation is trivially definable in $\vFo2$. This enables us toconsider models with nonempty cosmic spectrums of their galaxies without lossof generality.\end{definition}\begin{remark}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, let $\StrA$ be amodel for $\Tpi\TpiP\TpiT$ such that $\relE = \at\StrA\se$ is not full on$\domA$ and let $\eclX \in \Ecl\relE$ be any galaxy.Then $\csps = \cspIX\StrA\eclX$ is a cosmic spectrum for $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}That $\csps$ is nonempty follows from the assumption that $\relE$ is not full on$\domA$. We verify the conditions for a cosmic spectrum:\begin{itemize}  \item[\refcspcondIIp]   Let $\tpIn \in (\xtp\restriction\csps) \cap \TNo$ be a noble type inside   $\csps$. Since $\StrA$ is a $\Tpi\TpiP\TpiT$-model, we have that $\csps   \subseteq \TpiT$ and by noble type definition, no $\tpTt \in \TpiT$   connects $\tpIn$ with itself.   \item[\refcspcondIIIp]   Let $\tpIn \in \TNo \sub (\xtp\restriction\csps)$ be a noble type outside   $\csps$ and let $\tpIp \in (\xtp\restriction\csps)$ be a $1$-type inside   $\csps$.   Since $\StrA$ is a $\Tpi\TpiP\TpiT$-model, there is some   $\ea \in \eclX$ having $\tpIa\StrA\ea = \tpIp$ and some   $\eb \in \domA \sub \eclX$ having $\tpIa\StrA\eb = \tpIn$.   Then $\tpTt = \tpIab\StrA\ea\eb \in \csps$.\end{itemize}\end{proof}In order to simplify our construction, we are going to restrict our attentionto the class of nobly distinguished models.\begin{definition}\label{def:nobly-distinguished-csp}A cosmic spectrum $\csps$ for the type instance $\Tpi\TpiP\TpiT$ is \emph{noblydistinguished} if $(\xtp\restriction\csps) \cap \TNoi\TpiP\TpiT \neq \eset$implies $(\xtp\restriction\csps) \subseteq \TNoi\TpiP\TpiT$, that is if $\csps$is noble, then every $1$-type inside $\csps$ is noble.\end{definition}\begin{definition}\label{def:nobly-distinguished-structure}Let $\StrA$ be a $\ClSig\SigS\sms$-structure such that $\relE = \at\StrA\se$ isnot full on $\domA$ and let $\Tpi\TpiP\TpiT$ be the type instance of $\StrA$. Thestructure is \emph{nobly distinguished} if the cosmic spectrum of every galaxyis nobly distinguished, that is if $\cspIX\StrA\eclX$ is nobly distinguishedover $\Tpi\TpiP\TpiT$ for every $\eclX \in \Ecl\relE$.\end{definition}We use some new unary predicate symbols to color the peasants living along nobles to promote them to nobles.\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance for $\ClSig\SigS\sms$.For every $1$-type $\tpIp \in \TpiP$, let $\spp\tpIp$ be a new unary predicatesymbol. Let $\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$ be anenrichment of $\SigS$ featuring these new symbols. For every $\tpIp \in \TpiP$,define the following set of literals:\[  \sPe\tpIp(\xx) = \set{\spp\tpIp(\xx)} \cup  \setbd{\lnot\spp\tpIpp(\xx)}{\tpIpp \in \TpiP \sub \set{\tpIp}}.\]Let $\bot \not\in \TpiP$ be a special element and define the special set$\sPe\bot(\xx)$ of literals:\[  \sPe\bot(\xx) =   \setbd{\lnot\spp\tpIp(\xx)}{\tpIp \in \TpiP}.\]For every $\tpIp \in \TpiP$, $\tpIr \in \TpiP\cup\set{\bot}$,let $\mr\tpIp\tpIr$ be the following $1$-type over $\SigSp$:\[  \mr\tpIp\tpIr = \tpIp \cup \sPe\tpIr(\xx).\]We refer to $\mr\tpIp\tpIr$ as the $\tpIr$-copy of $\tpIp$.Define $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ as follows:\begin{align*}  \mr\TpiP\TpiP &=   \setbd{\mr\tpIp\tpIr}{\tpIp\in\TpiP, \tpIr\in\TpiP\cup\set{\bot}} \\  \mr\TpiT\TpiT &= \setbd{\tpTt \cup \sPe\tpIr(\xx) \cup  \sPe\tpIrp(\xx)}{\tpIr,\tpIrp \in \TpiP\cup\set{\bot}}.\end{align*}Then $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ is a type instance for$\ClSig\SigSp\sms$.Note that the size of $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ is quadratic, hencepolynomially bounded, with respect to the size of the original type instance$\Tpi\TpiP\TpiT$.\end{definition}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let$\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$.Let $\TpiPb \subseteq \mr\TpiP\TpiP$ and $\TpiTb \subseteq \mr\TpiT\TpiT$ besuch that $\Tpi\TpiPb\TpiTb$ is a type instance over $\ClSig\SigSp\sms$.Then $\Tpi\TpiPb\TpiTb$ is a \emph{promotion} of $\Tpi\TpiP\TpiT$ if$\TpiPb$ contains a copy of every $\tpIp \in \TpiP$, that is for every $\tpIp \in \TpiP$ there is some $\tpIr \in\TpiP\cup\set{\bot}$ such that $\mr\tpIp\tpIr \in \TpiPb$.\end{definition}\begin{lemma}[Noble distinguishability]\label{lem:noble-distinguishability}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let$\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$.Then $\Tpi\TpiP\TpiT$ has a (finite) model iff there is some promotion$\Tpi\TpiPb\TpiTb$ of $\Tpi\TpiP\TpiT$ that has a (finite) nobly distinguishedmodel.\end{lemma}\begin{proof}First, suppose that $\StrA$ is a model for $\Tpi\TpiP\TpiT$ and let $\relE= \at\StrA\se$.We define a promotion $\Tpi\TpiPb\TpiTb$ of $\Tpi\TpiP\TpiT$ anda $\SigSp$-enrichment $\StrAp$ of $\StrA$ that realizes $\Tpi\TpiPb\TpiTb$.Let $\Tpi\TpiP\TpiTp$ be the type instance of $\StrA$.For every noble $\tpIn \in \TNoi\TpiP\TpiTp$, let $\eclX_\tpIn \in \Ecl\relE$ bethe unique galaxy realizing it. Note that there might be distinct noble typesrealized in the same galaxy: $\eclX_\tpIn = \eclX_\tpInp$ for $\tpIn \neq \tpInp \in \TNoi\TpiP\TpiTp$.Let $\eclX_\TNo = \setbd{\eclX_\tpIn}{\tpIn \in \TNoi\TpiP\TpiTp}$ be the set ofgalaxies realizing some (possibly many) noble type. For every $\eclX \in\eclX_\TNo$ choose an arbitrary noble type $\tpIn$ realized in it: $\eclX =\eclX_\tpIn$.Define the enrichment $\StrAp$ as follows: for every $\ea \in \domA$:\begin{itemize}  \item if $\ea \in \eclX_\tpIn$ is an element of some noble galaxy, then let$\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\tpIn$  \item otherwise, let $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\bot$.\end{itemize}Let $\Tpi\TpiPb\TpiTb$ be the type instance of $\StrAp$. By construction,$\Tpi\TpiPb\TpiTb$ is a promotion of $\Tpi\TpiP\TpiT$ and $\StrAp$ is amodel of $\Tpi\TpiPb\TpiTb$.We need to check that $\StrAp$ is nobly distinguished.We claim that every peasant type $\tpIpp \in \TPsi\TpiPb\TpiTb$ has the form$\tpIpp = \mr\tpIp\bot$ for some $\tpIp\in\TpiP$.Suppose not and let $\tpIpp\in \TPsi\TpiPb\TpiTb$ be some peasant type havingthe form $\tpIpp = \mr\tpIp\tpIn$ for some $\tpIp\in\TpiP$ and$\tpIn\in\TNoi\TpiP\TpiTp$. Since $\tpIpp$ is a peasant type, there is some cosmic $\tpTtp \in \TpiTb$ suchthat $\xtp\tpTtp = \ytp\tpTtp$. Since $\Tpi\TpiPb\TpiTb$ is the type instance of$\StrAp$, there are some $\ea \neq \eb \in \domA$ such that $\tpIab\StrAp\ea\eb = \tpTtp$ andsince $\tpTtp$ is cosmic, $\ea$ and $\eb$ must lie in distinct $\relE$-classes.But $\tpIa\StrAp\ea = \tpIa\StrAp\eb = \tpIpp = \mr\tpIp\tpIn$ and byconstruction we must have that $\ea, \eb \in \eclX_\tpIn$ --- a contradiction.Therefore every peasant type $\tpIpp \in \TPsi\TpiPb\TpiTb$ has the form$\tpIpp = \mr\tpIp\bot$ for some $\tpIp \in \TpiP$. So every noble type $\tpInp\in \TNoi\TpiPb\TpiTb$ must have the form $\tpInp = \mr\tpIp\tpIn$ for some$\tpIp \in \TpiP$ and $\tpIn \in \TNoi\TpiP\TpiTp$. Now by construction it isimmediate that $\StrAp$ is nobly distinguished.Next, suppose that $\Tpi\TpiPb\TpiTb$ is a promotion of $\Tpi\TpiP\TpiT$ andthat $\StrAp$ is a model for $\Tpi\TpiPb\TpiTb$. Then the reduct of $\StrAp$to a $\SigS$-structure is a model for $\Tpi\TpiP\TpiT$.\end{proof}Denote the type realizability problem for $\vFo2\Eea\sze\agrefine$ restricted tothe class of nobly distinguished structures by $\NDReal{\vFo2\Eea\sze\agrefine}$ and the finiteversion of that problem by $\FinNDReal{\vFo2\Eea\sze\agrefine}$.The noble distinguishability lemma shows that the class of nobly distinguishedmodels is a nondeterministic polynomial time reduction class:\[  \FinAReal{\vFo2\Eea\sze\agrefine} \red{\cNP} \FinANDReal{\vFo2\Eea\sze\agrefine}.\]We like to think about a cosmic spectrum of a galaxy as the \emph{reason why}that galaxy is possible. For this we need to define the notion of a\emph{locally consistent} cosmic spectrum. For this we extract a type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the \emph{simpler logic}$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$ out of the cosmic spectrum $\csps$:\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\Lvp\Fo2\nopow\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.Let $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ be a cosmic spectrum over$\Tpi\TpiP\TpiT$.Let $\si$ (intended to label the inside of the galaxy) and $\sbh$ (intended tolabel some \emph{black hole} outside the galaxy) be two new unary predicatesymbols. Define the following sets of literals: \begin{align*}  \tIN(\xx) &= \set{\si(\xx),\lnot\sbh(\xx)} \\  \tOUT(\xx) &= \set{\lnot\si(\xx), \lnot\sbh(\xx)} \\  \tBH(\xx) &= \set{\lnot\si(\xx), \sbh(\xx)}.\end{align*}For a $1$-type $\tpIp\in\TpiP$ or a $2$-type $\tpTt\in\TpiT$, denote by$\noe\tpIp$ and $\noe\tpTt$ the reducts of $\tpIp$ and $\tpTt$ to the language $\SigS - \set{\se}$.That is, $\noe\tpIp \subset \tpIp$ and $\noe\tpTt \subset \tpTt$ consist ofthose literals that do not feature the predicate symbol $\se$.Define the \emph{spectral type instance} $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ of thecosmic spectrum $\stps$ as a type instance over the $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-signature $\ClSig{\SigS - \seq{\se} + \seq{\si,\sbh}}\sms$\footnote{Note that here we usethe condition that no builtin equivalence symbol $\se$ occurs as a messagesymbol.} as follows:\begin{itemize}  \item[\sticondI]\label{sti-I}  For every $\tpIp \in (\xtp\restriction\stps)$ inside $\csps$, add the  $1$-type $(\noe\tpIp \cup \tIN(\xx))$ to $\TpiPs\csps$.  \item[\sticondO]\label{sti-O}  For every $\tpIp \in (\ytp\restriction\stps)$ outside $\csps$, add the  $1$-type $(\noe\tpIp \cup \tOUT(\xx))$ to $\TpiPs\csps$. Note that some  $1$-types might occur both inside and outside of $\csps$.  \item[\sticondB]\label{sti-B}  Let $\tpIb$ be an arbitrary $1$-type extending $\tBH(\xx)$.  Call $\tpIb$ the \emph{black hole type} and add it to $\TpiPs\csps$.  \item[\sticondII]\label{sti-II}  For every galactic $\tpTt \in (\TpiT \cap \TpTg\SigS)$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tIN(\yy))$ to $\TpiTs\csps$.  \item[\sticondIO]\label{sti-IO}  For every (cosmic) $\tpTt \in \stps$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tOUT(\yy))$ and its inverse to $\TpiTs\csps$.  \item[\sticondOO]\label{sti-OO}  For every $2$-type $\tpTt \in \TpiT$, add the $2$-type  $(\noe\tpTt \cup \tOUT(\xx) \cup \tOUT(\yy))$ to $\TpiTs\csps$.  \item[\sticondIB]\label{sti-IB}  For every $1$-type $\tpIpp \in \TpiPs\csps$, $\tIN(\xx) \subseteq \tpIpp$ that  comes from the inside, let $\tpTt$ be an arbitrary $2$-type connecting $\tpIpp$ and the black hole type $\tpIb$ that witnesses no  message symbols for $\tpIpp$ and everything for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $(\lnot\sm(\xx,\yy)) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.  \item[\sticondOB]\label{sti-OB}  For every $1$-type $\tpIpp \in \TpiPs\csps$, $\tOUT(\xx) \subseteq \tpIpp$  that comes from the outside, let $\tpTt$ be an arbitrary $2$-type connecting  $\tpIpp$ and the black hole type $\tpIb$ that witnesses every message symbol for $\tpIpp$ and for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $\sm(\xx,\yy) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.\end{itemize}This completes the description of the spectral type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-classified signature$\ClSig{\SigS - \seq{\se} + \seq{\si, \sbh}}\sms$ is realizable.\end{definition}\begin{remark}\label{rem:csp-is-locally-consistent}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.Let $\StrA$ be a model for $\Tpi\TpiP\TpiT$ such that $\relE =\at\StrA\se$ is not full on $\domA$ and let $\eclX \in \Ecl\relE$ be any galaxy.Then the cosmic spectrum $\csps = \cspIX\StrA\eclX$ is a locally consistentcosmic spectrum over $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$.We build a $\SigSp$-structure $\StrAp$ based on $\StrA$ that realizes thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The domain of $\StrAp$ is $\domAp = \domA \cup \set{\eo}$, where $\eo$ is the new \emph{black hole}element.The $1$-type of every element $\ea \in \domAp$ is defined as follows:\begin{itemize}  \item[\refsticondI]  If $\ea \in \eclX$ is inside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tIN(\xx)$.  \item[\refsticondO]  If $\ea \in \domA \sub \eclX$ is outside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tOUT(\xx)$.  \item[\refsticondB] If $\ea = \eo$ is the black hole, then let  $\tpIa\StrAp\ea = \beta$.\end{itemize}The $2$-type between every pair of distinct elements $\ea \neq \eb \in \domA'$is defined as follows:\begin{itemize}  \item[\refsticondII]  If both $\ea,\eb \in \eclX$ are inside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tIN(\yy)$.  Note that this assignment is symmetric, that is we would assign  $\inv{\tpIab\StrAp\ea\eb}$ to $\tpIab\StrAp\eb\ea$.  \item[\refsticondIO]  If $\ea \in \eclX$ is inside and $\eb \in \domA \sub  \eclX$ is outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tOUT(\yy)$.  Note that this case covers the symmetric assignments where $\ea \in  \domA\sub\eclX$ and $\eb \in \eclX$.  \item[\refsticondOO]  If both $\ea, \eb \in \domA\sub\eclX$ are outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tOUT(\xx) \cup  \tOUT(\yy)$. Note that this assignment is symmetric.  \item[\refsticondIB]  If $\ea \in \eclX$ is inside and $\eb = \eo$ is the black hole, let $\tpTt  \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.  \item[\refsticondOB]  If $\ea \in \domA\sub\eclX$ is outside and $\eb = \eo$ is the black hole, let  $\tpTt \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.\end{itemize}We have to verify that $\StrAp$ is indeed a $\ClSig\SigSp\sms$-structure, thatis that the star-type of every element of $\ea \in \domAp$ contains$\sm(\xx,\yy)$ for every message symbol $\sm \in \sms$:\begin{itemize}\item[\refsticondI] If $\ea \in \eclX$ is inside, then every$\sm \in \sms$ that is included in $\stpIa\StrA\ea$ is also included in$\stpIa\StrAp\ea$, since the $2$-type $\noe\tpTt$ contains $\sm(\xx,\yy)$ iff$\tpTt$ contains $\sm(\xx,\yy)$.\item[\refsticondO] If $\ea \in \domA\sub\eclX$ is outside, then we just need torecall that at stage~\refsticondOB, we have used a $2$-type $\tpIab\StrAp\ea\eo= \tpTt$ that witnesses every message symbol for $\ea$: $\sm(\xx,\yy) \in\tpTt$ for every $\sm \in \sms$.\item[\refsticondB] If $\ea = \eo$ is the black hole, then we just need torecall that $\eclX$ is nonempty and at stage~\refsticondIB~for every $\ea \in\eclX$ we have used a $2$-type $\tpTt = \tpIab\StrAp\ea\eo$ that witnesses everymessage symbol for $\eo$: $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$.\end{itemize}Since $\StrA$ was a model for $\Tpi\TpiP\TpiT$, it is clear that $\StrAp$ is amodel for $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.\end{proof}\begin{definition}A certificate $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$ is a nonemptyset of cosmic spectrums for $\Tpi\TpiP\TpiT$ satisfying the followingconditions:\begin{itemize}  \item[\certcondIp]\label{cond:cert-Ip}  If $\tpTt \in \csps$ for some $\csps \in \Cert$, then  $\inv\tpTt \in \cspsp$ for some $\cspsp \in \Cert$, that is there are  witnesses for the endpoints of every (cosmic) $2$-type used in the  certificate. Equivalently, $\cup\Cert$ is closed under inversion.    Let $\TpiTp = \cup\Cert$. Clearly, $\TpiTp \subseteq \TpiT$. We require that  $\Tpi\TpiP\TpiTp$ is a type instance --- the filtered type instance --- and  that all cosmic spectrums $\csps \in \Cert$ be cosmic spectrums over the  filtered type instance. In this context we refer to the king types $\TKg =  \TKgi\TpiP\TpiTp$, the noble types $\TNo = \TNoi\TpiP\TpiTp$ and the peasant  types $\TPs = \TPsi\TpiP\TpiTp$ with respect to the filtered type instance.  This is the analogue of Condition~\refcertcond1 from the case with no  equivalence symbols.  \item[\certcondIIp]\label{cond:cert-IIp}  If $\tpIp \in \TpiP$ then some (possibly many) $\csps  \in \Cert$ has $\tpIp \in (\xtp\restriction\csps)$, that is every  $1$-type is witnessed. This is the analogue of  Condition~\refcertcond2 from the case with no equivalence symbols.  \item[\certcondIIIp]\label{cond:cert-IIIp}  If $\tpIn \in \TNoi\TpiP\TpiTp$ is a noble type, then only one $\csps \in  \Cert$ has $\tpIn \in (\xtp\restriction\csps)$, that is every noble type is  witnessed once. This is the analogue of Condition~\refcertcond3 from the case  with no equivalence symbols.  \item[\certcondIVp]\label{cond:cert-IVp}  If $\tpIp,\tpIpp \in \TpiP$ are (possibly the same) $1$-types that are not  cosmically connectable, that is no cosmic $\tpTt \in \TpiTp$ has $\xtp\tpTt =  \tpIp$ and $\ytp\tpTt = \tpIpp$, then $\tpIp, \tpIpp \in \TNoi\TpiP\TpiTp$ and  there is a (noble, unique by~\refcertcondIIIp) cosmic spectrum $\csps \in  \Cert$ such that $\tpIp, \tpIpp \in \csps$, that is two $1$-types are not   cosmically connectable iff they are noble and have the same witnessing cosmic   spectrum. This is the analogue of Condition~\refcertcond4 from the case with   no equivalence symbols.\end{itemize}\end{definition}Again, in general the size of a certificate is only exponentially bounded interms of the size of the type instance. But again, polynomial certificatesexist:\begin{lemma}[Certificate extraction]\label{lem:cert-extr-many}Let $\StrA$ be a nobly distinguished model for the type instance$\Tpi\TpiP\TpiT$ such that $\relE = \at\StrA\se$ is not full on $\domA$.Let $\Tpi\TpiP\TpiTp$ be the type instance of $\StrA$. For every cosmic $\tpTt\in \TpiTp$, let $\eat\tpTt \neq \ebt\tpTt \in \domA$ be two distinct elementsrealizing $\tpTt$: $\tpIab\StrA{\eat\tpTt}{\ebt\tpTt} = \tpTt$. Note thatnecessarily the elements $\eat\tpTt$ and $\ebt\tpTt$ are in different galaxies.The choice is made symmetrically, that is $\eat{\inv\tpTt} = \ebt\tpTt$ and$\ebt\tpTt = \eat{\inv\tpTt}$. Let\[  \Cert = \setbd{\cspIX\StrA{\relE[\eat\tpTt]}}{\tpTt \in \TpiTp \cap  \TpTc\SigS}.\]Then $\Cert$ is a certificate for $\Tpi\TpiP\TpiT$.Moreover, its size is linearly bounded by $\card\TpiTp$, hence also by the sizeof $\Tpi\TpiP\TpiT$.\end{lemma}\begin{proof}We check the conditions for a certificate:\begin{itemize}  \item[\refcertcondIp] By construction, $\Tpi\TpiP\TpiTp$ is a type instance  and every $\csps \in \Cert$ is a cosmic spectrum over $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIp] Every $1$-type $\tpIp \in \TpiP$ is witnessed since  $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIIp] Every noble $1$-type $\tpIn \in \TNoi\TpiP\TpiTp$ is  witnessed uniquely, since the noble $1$-types are exactly those that are  realized at a single galaxy of $\StrA$.  \item[\refcertcondIVp] Suppose that $\tpIp, \tpIpp \in \TpiP$ is a pair of  $1$-types that are not cosmically connectable. Consider the elements realizing  these $1$-types in $\StrA$: $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \domA$.  These sets are nonempty, since $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  Next we claim that both $\at\StrA\tpIp$ and $\at\StrA\tpIpp$ are included in  the same galaxy of $\StrA$. Suppose not and let $\ea \in \at\StrA\tpIp$ and  $\eb \in \at\StrA\tpIpp$ be elements realizing the $1$-types from different  galaxies. Then $\tpIab\StrA\ea\eb \in \TpiTp$ is a cosmic type connecting  $\tpIp$ and $\tpIpp$ --- a contradiction.  Therefore $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \eclX$ for some $\eclX  \in \Ecl\relE$. Since $\StrA$ is nobly distinguished and $\Tpi\TpiP\TpiTp$ is  the type instance of $\StrA$, the $1$-types $\tpIp$ and $\tpIpp$ must be noble  over $\Tpi\TpiP\TpiTp$. By~\refcertcondIIIp, they are witnessed uniquely in  the certificate by the cosmic spectrum $\csps = \cspIX\StrA\eclX$.\end{itemize}\end{proof}