% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featuring $\sze \geq 2$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement. Abbreviate the coarsest equivalence symbol $\se = \see\sze$.As the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$ relativizes the logic,terms from the previous section relativize.In this setting by convention the message symbols $\smm\ii$ of aclassified signature $\ClSig\SigS\sms$ must be disjoint from the builtinequivalence symbols.The following reductions relativize:\begin{align*}  \FinASat{\vFo2\Eea\sze\agrefine} &\red\cNP \FinAClSat{\vFo2\Eea\sze\agrefine}  \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNExpTime  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.\end{align*}We proceed to define new terms.The terminology is loosely based on~\cite{MALQ:MALQ201400102}.\begin{definition}Let $\SigS$ be a predicate signature.A $2$-type $\tpTt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in\tau$.Otherwise, if $(\lnot\se(\xx,\yy)) \in \tpTt$, the type is a \emph{cosmic type}.The set of galactic $2$-types is $\TpTg\SigS$.The set of cosmic $2$-types is $\TpTc\SigS$. These sets partition the set of all$2$-types $\TpT\SigS$.\end{definition}Informally, we think of the $\se$-classes in a structure as \emph{galaxies}; ofthe whole structure as the \emph{cosmos}; of the galactic $2$-types ascharacterizing the interactions in the internals of the galaxies, while cosmic $2$-types characterize the interactions between different galaxies.\begin{definition}\label{def:many-tpi-conn}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{galactically connectable}(written $\tpIp \gconn\TpiT \tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp =\ytp\tpTt$ for some galactic $\tpTt \in \TpiT \cap \TpTg\SigS$.The types are \emph{cosmically connectable} (written $\tpIp \cconn\TpiT\tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some cosmic$\tpTt \in \TpiT \cap \TpTc\SigS$.The galactic and cosmic connectability are symmetric since $\TpiT$ is closedunder inversions.Note that the types $\tpIp$ and $\tpIpp$ may be both galactically and cosmicallyconnectable. Also note that the general~\Cref{def:tpinst-twovar} of connectabletypes is equivalent to:\[  \miff{\tpIp \conn\TpiT \tpIpp}{  \tpIp \gconn\TpiT \tpIpp \text{ or } \tpIp \cconn\TpiT \tpIpp}.\]Recall that a $1$-type $\tpIk$ is a \emph{king type} if $\tpIk \not\conn\TpiT\tpIk$ and that the set of king types is $\TKgi\TpiP\TpiT$.A $1$-type $\tpIn$ is a \emph{noble type} if $\tpIn \not\cconn\TpiT \tpIn$.The set of noble types is $\TNoi\TpiP\TpiT$.Note that every king type is a noble type. A $1$-type $\tpIp \in \TpiP$ is apeasant type if it is not a noble type. The set of peasant types is$\TPsi\TpiP\TpiT = \TpiP \sub \TNoi\TpiP\TpiT$.\end{definition}\begin{remark}\label{rem:many-tpi-sub}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\TpiTp\subseteq \TpiT$ be a nonempty subset of $2$-types that is closed underinversion. According to~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is also a typeinstance over $\ClSig\SigS\sms$. Additionally,$\TNoi\TpiP\TpiT \subseteq \TNoi\TpiP\TpiTp$ and$\TPsi\TpiP\TpiTp \subseteq \TPsi\TpiP\TpiTp$.This is the analogue of~\Cref{rem:tpi-sub}.\end{remark}\begin{remark}\label{rem:many-tpi-char-part}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\StrA$be a model for $\Tpi\TpiP\TpiT$.Then every noble type $\tpIn \in \TNoi\TpiP\TpiT$ is realized (possibly manytimes) in a unique galaxy of $\StrA$.  Note that the opposite does not hold:there might be some peasant type that is realized in a unique galaxy.This is a partial analogue of~\Cref{rem:tpi-char}.\end{remark}\begin{remark}\label{rem:many-tpi-char-full}Let $\StrA$ be a $\ClSig\SigS\sms$-structure and let $\Tpi\TpiP\TpiT =\TpiP\TpiT[\StrA]$ be the type instance of $\StrA$.Then $\TNoi\TpiP\TpiT$ is the set of $1$-types that are realized in a uniquegalaxy of $\StrA$ and $\TPsi\TpiP\TpiT$ is the set of $1$-types that arerealized in at least $2$ galaxies in $\StrA$.This is an analogue of~\Cref{rem:tpi-char}, but restricted to the type instanceof the model.\end{remark}\begin{proof}By~\Cref{rem:many-tpi-char-part}, it suffices to show that any $1$-type that iscosmically connectable with itself is realized in at least $2$ galaxies:Let $\tpIp \in \TpiP$ be a $1$-type and $\tpTt \in \TpiT$ be a cosmic $2$-typesuch that $\xtp\tpTt = \ytp\tpTt = \tpIp$.Then $\tpTt = \tpIab\StrA\ea\eb$ for some $\ea \neq \eb \in \domA$. Since$\tpTt$ is cosmic, we must have that $\ea$ and $\eb$ are in different galaxies.\end{proof}\subsection{Nobly distinguished models}\begin{definition}A $\ClSig\SigS\sms$-structure $\StrA$ is a \emph{nobly distinguished model} forthe type instance $\Tpi\TpiP\TpiT$ if $\StrA$ is a model for $\Tpi\TpiP\TpiT$and the following conditions are satisfied:\begin{itemize}  \item[\condrealizd]\label{cond:realizd}  Let $\relE = \at\StrA\se$. We require that if $\ea \in  \domA$ has $\tpIa\StrA\ea \in \TNoi\TpiP\TpiT$, then every $\eb \in \relE[\ea]$  has $\tpIa\StrA\eb \in \TNoi\TpiP\TpiT$. That is, if some element in a galaxy  realizes a noble type, then all elements from that galaxy realize noble types.  \item[\condrealizn]\label{cond:realizn}  If $\tpIp \in \TpiP$ is realized  (possibly many times) in a unique galaxy, then $\tpIp \in \TNoi\TpiP\TpiT$ is  noble.\end{itemize}A $\ClSig\SigS\sms$-structure $\StrA$ is a \emph{nobly distinguished structure}if it is a nobly distinguished model for its type instance $\TpiP\TpiT[\StrA]$.%Note that the galaxies of $\StrA$ partition into \emph{noble galaxies}, whose%elements only realize noble types and \emph{peasant galaxies}, whose elements% only realize peasant types.\end{definition}\begin{remark}\label{rem:many-nd-tpi-char}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\StrA$be a nobly distinguished model for $\Tpi\TpiP\TpiT$.Then $\TNoi\TpiP\TpiT$ is the set of $1$-types that are realized in a uniquegalaxy of $\StrA$ and $\TPsi\TpiP\TpiT$ is the set of $1$-types that arerealized in at least $2$ galaxies of $\StrA$.This is the analogue of~\Cref{rem:tpi-char} for nobly distinguished models.\end{remark}\begin{proof}Immediate by~\Cref{rem:many-tpi-char-part} and Condition~\refcondrealizn for$\StrA$.\end{proof}\begin{remark}\label{rem:many-nd-tpi-sub-ex}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\TpiTp\subseteq \TpiT$ be a nonempty subset of $2$-types that is closed underinversion.Suppose that $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$. According to~\Cref{rem:tpi-sub-ex}, any model $\StrAp$ of $\Tpi\TpiP\TpiTp$ isalso a model for $\Tpi\TpiP\TpiT$.Note that $\TNoi\TpiP\TpiT \subseteq \TNoi\TpiP\TpiTp$ accordingto~\Cref{rem:many-tpi-sub}. Suppose that $\TNoi\TpiP\TpiTp \subseteq\TNoi\TpiP\TpiT$, or equivalently that $\TNoi\TpiP\TpiTp =\TNoi\TpiP\TpiT$. Then any nobly distinguished model $\StrAp$ for$\Tpi\TpiP\TpiTp$ is also a nobly distinguished model for $\Tpi\TpiP\TpiT$.This is the analogue of~\Cref{rem:tpi-sub-ex} for nobly distinguished models.\end{remark}\begin{proof}We verify the conditions for $\StrAp$ to be a nobly distinguished model for$\Tpi\TpiP\TpiT$.\begin{itemize}  \item[\refcondrealizd]  follows from Condition~\refcondrealizd for the $\Tpi\TpiP\TpiTp$-model  $\StrAp$ together with the assumption $\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$.  \item[\refcondrealizn]  follows from Condition~\refcondrealizn for the $\Tpi\TpiP\TpiTp$-model  $\StrAp$ together with the assumption $\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$.\end{itemize}\end{proof}\begin{remark}\label{rem:many-nd-tpi-str-ex}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, let $\StrA$ be anobly distinguished model for $\Tpi\TpiP\TpiT$ and let $(\TpiPp, \TpiTp) =\TpiP\TpiT[\StrA]$ be the type instance of $\StrA$.According to~\Cref{rem:tpi-str-ex}, we have that $\TpiPp = \TpiP$, $\TpiTp\subseteq \TpiT$ and also $\TKgi\TpiP\TpiT = \TKgi\TpiP\TpiTp$.Then $\StrA$ is a nobly distinguished model for $\Tpi\TpiP\TpiTp$,equivalently $\StrA$ is a nobly distinguished structure.Also we have that $\TNoi\TpiP\TpiT = \TNoi\TpiP\TpiTp$.This is the analogue of~\Cref{rem:tpi-str-ex} for nobly distinguished models.\end{remark}\begin{proof}By~\Cref{rem:many-tpi-char-full}, $\TNoi\TpiP\TpiTp$ is the set of $1$-typesthat are realized in a unique galaxy of $\StrA$. By~\Cref{rem:many-nd-tpi-char},$\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$.We verify the conditions for $\StrA$ to be a nobly distinguished model for$\Tpi\TpiP\TpiTp$.\begin{itemize}  \item[\refcondrealizd] follows from Condition~\refcondrealizd for the  $\Tpi\TpiP\TpiT$-model $\StrA$ together with $\TNoi\TpiP\TpiTp =  \TNoi\TpiP\TpiT$.  \item[\refcondrealizn] follows from Condition~\refcondrealizn for the  $\Tpi\TpiP\TpiT$-model $\StrA$ together with $\TNoi\TpiP\TpiTp =  \TNoi\TpiP\TpiT$.\end{itemize}\end{proof}\begin{remark}\label{rem:many-nd-tpi-str-inv}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, let $\StrA$ be anobly distinguished model for $\Tpi\TpiP\TpiT$ and let $\StrB$ be a noblydistinguished $\ClSig\SigS\sms$-structure. If $\TpiP\TpiT[\StrB] =\TpiP\TpiT[\StrA]$, then $\StrB$ is also a nobly distiguished model for$\Tpi\TpiP\TpiT$.This is the analogue of~\Cref{rem:tpi-str-inv} for nobly distinguished models.\end{remark}\begin{proof}By~\Cref{rem:many-nd-tpi-str-ex} we have that $\TpiP\TpiT[\StrB] =\TpiP\TpiT[\StrA] = \Tpi\TpiP\TpiTp$ where $\TpiTp \subseteq \TpiT$ and$\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$. Then by~\Cref{rem:many-nd-tpi-sub-ex} anynobly distinguished model for $\Tpi\TpiP\TpiTp$ is also a nobly distinguishedmodel for $\Tpi\TpiP\TpiT$.\end{proof}\subsection{Nobly distiguished type realizability}\begin{definition}The (finite) nobly distinguished type realizability problem for$\vFo2\Eea\sze\agrefine$ is the following: given a classified signature$\ClSig\SigS\sms$ and a type instance $\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$,is there a (finite) nobly distinguished model for $\Tpi\TpiP\TpiT$. Denote thenobly distinguished type realizability problem for the logic $\vFo2\Eea\sze\agrefine$ by$\NDReal{\vFo2\Eea\sze\agrefine}$ and its finite version by$\FinNDReal{\vFo2\Eea\sze\agrefine}$.\end{definition}We now proceed to reduce the (finite) type realizability problem to the (finite)nobly distinguished type realizability problem.\begin{definition}Let $\StrA$ be a $\ClSig\SigS\sms$-structure, let $\Tpi\TpiP\TpiT = \TpiP\TpiT[\StrA]$,let $\relE = \at\StrA\se$ and let$\Gals = \Ecl\relE$ be the set of galaxies of $\StrA$.A galaxy $\galX \in \Gals$ is a \emph{noble galaxy} if it contains anelement $\ea \in \eclX$ that realizes a noble type: $\tpIa\StrA\ea \in\TNoi\TpiP\TpiT$. Otherwise, if every element $\ea \in \eclX$ realizes a peasanttype, then the galaxy is a \emph{peasant galaxy}.Note that a noble galaxy may contain elements that realize peasant types.The set of noble galaxies is $\GalsN$ and the set of peasant galaxies is$\GalsP$.\end{definition}\begin{definition}Let $\StrA$ be $\ClSig\SigS\sms$-structure,let $\Tpi\TpiP\TpiT = \TpiP\TpiT[\StrA]$, let $\relE = \at\StrA\se$ and let $\Gals = \Ecl\relE$.The structure $\StrA$ is \emph{peasantly united} if whenever $\tpIp \in\TPsi\TpiP\TpiT$ is a peasant type that is realized in some peasant galaxy $\eclX \in \GalsP$, then $\tpIp$ is also realized by some element in someother peasant galaxy $\eclY \in \GalsP \sub \set\eclX$.\end{definition}\begin{lemma}[Peasant unitedness]\label{lem:peasant-unitedness}Let $\StrA$ be a (finite) $\ClSig\SigS\sms$-structure and let $\Tpi\TpiP\TpiT =\TpiP\TpiT[\StrA]$.Then there is a (finite) peasantly united $\ClSig\SigS\sms$-structure $\StrAp$such that $\TpiP\TpiT[\StrAp] = \Tpi\TpiP\TpiT$.\end{lemma}\begin{proof}The idea is to copy the peasant galaxies in order to witness the peasantunitedness condition.Let $\relE = \at\StrA\se$ and let $\Gals = \Ecl\relE$.We describe $\StrAp$ by describing its galaxies $\Galsp$.The noble galaxies $\GalsNp$ of $\StrAp$ coincide with the noble galaxies$\GalsN$ of $\StrA$.The peasant galaxies $\GalsPp$ of $\StrAp$ consist of two copies $\galXX1,\galXX2$ of each peasant galaxy $\galX \in \Gals$.This naturally assigns the $1$-type of every element $\ea \in \domAp$ and the$2$-types between any pair of distinct elements that do not come from the twocopies of the same galaxy. Note that already at this point, the partialstructure $\StrAp$ already satisfies the existential parts~\cref{eq:twovar-ms-iinter}, so it is already a partial$\ClSig\SigS\sms$-structure. We proceed to complete $\StrAp$.Let $\galX \in \GalsP$ be a peasant $\StrA$-galaxy and let$\ea_1 \in \eclX_1$ and $\eb_2 \in \eclX_2$ be any two elements from thecorresponding copies in $\StrAp$.Note that $\ea, \eb \in \galX$ and let $\tpIp = \tpIa\StrAp\ea = \tpIa\StrA\ea$and $\tpIpp = \tpIa\StrAp\eb = \tpIa\StrA\eb$. Since $\eclX$ is a peasant galaxy,we must have that $\tpIp, \tpIpp \in \TPs\Tpi\TpiP\TpiT$ are peasant $1$-types.By~\Cref{rem:many-tpi-char-full}, $\tpIp$ is realized in at least $2$galaxies in $\StrA$.So there is some element $\ec \in \domA$ realizing $\tpIp$ such that $\ec \not\in \eclX$. Now consider the $2$-type $\tpTt =\tpIab\StrA\ec\eb \in \TpiT$.Since $\eb \in \eclX$, we must have that this is a cosmic $2$-type connecting$\tpIp$ with $\tpIpp$. So we can assign $\tpIab\StrAp{\ea_1}{\eb_2} = \tpTt$.Note that $\StrAp$ is peasantly united by construction: any (peasant) typethat is realized in some peasant galaxy $\galXX\ii \in \GalsPp$ is also realizedin its copy $\galXX{3-\ii}$.Also note that $\StrAp$ is finite iff $\StrA$ is finite.\end{proof}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance for $\ClSig\SigS\sms$.For every $1$-type $\tpIp \in \TpiP$, let $\spp\tpIp$ be a new unary predicatesymbol. Let $\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$ be anenrichment of $\SigS$ featuring these new symbols. For every $\tpIp \in \TpiP$,define the following set of literals:\[  \sPe\tpIp(\xx) = \set{\spp\tpIp(\xx)} \cup  \setbd{\lnot\spp\tpIpp(\xx)}{\tpIpp \in \TpiP \sub \set{\tpIp}}.\]Let $\bot \not\in \TpiP$ be a special element and define the special set$\sPe\bot(\xx)$ of literals:\[  \sPe\bot(\xx) =   \setbd{\lnot\spp\tpIp(\xx)}{\tpIp \in \TpiP}.\]For every $\tpIp \in \TpiP$, $\tpIr \in \TpiP\cup\set{\bot}$,let $\mr\tpIp\tpIr$ be the following $1$-type over $\SigSp$:\[  \mr\tpIp\tpIr = \tpIp \cup \sPe\tpIr(\xx).\]We refer to $\mr\tpIp\tpIr$ as the $\tpIr$-copy of $\tpIp$.Define $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ as follows:\begin{align*}  \mr\TpiP\TpiP &=   \setbd{\mr\tpIp\tpIr}{\tpIp\in\TpiP, \tpIr\in\TpiP\cup\set{\bot}} \\  \mr\TpiT\TpiT &= \setbd{\tpTt \cup \sPe\tpIr(\xx) \cup  \sPe\tpIrp(\xx)}{\tpIr,\tpIrp \in \TpiP\cup\set{\bot}}.\end{align*}Clearly, $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ is a type instance over$\ClSig\SigSp\sms$.Note that the size of $\Tpi{\mr\TpiP\TpiP}{\mr\TpiT\TpiT}$ is quadratic, hencepolynomially bounded, with respect to the size of the original type instance$\Tpi\TpiP\TpiT$.\end{definition}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let$\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$.Let $\TpiPb \subseteq \mr\TpiP\TpiP$ and $\TpiTb \subseteq \mr\TpiT\TpiT$ besuch that $\Tpi\TpiPb\TpiTb$ is a type instance over $\ClSig\SigSp\sms$.Then $\Tpi\TpiPb\TpiTb$ is a \emph{promotion} of $\Tpi\TpiP\TpiT$ if thefollowing conditions are satisfied:\begin{itemize}  \item[\condpromp]\label{cond:promp}  If $\tpIp \in \TpiP$ then $\mr\tpIp\tpIr \in \TpiPb$  for some (possibly many) $\tpIr \in \TpiP \cup \set\bot$.  That is, $\TpiPb$ contains a copy of every $1$-type from $\TpiP$.  \item[\condpromn]\label{cond:promn}  If $\mr\tpIp\tpIr \in \TNoi\TpiPb\TpiTb$ is any noble type, then $\tpIr \neq  \bot$.  \item[\condpromk]\label{cond:promk}  If $\mr\tpIp\tpIr \in \TKgi\TpiPb\TpiTb$ is any king type such that  $\tpIp \not\in \TKgi\TpiP\TpiT$, then $\mr\tpIp\tpIrp \in \TpiPb$ for some  $\tpIrp \neq \tpIr$.\end{itemize}\end{definition}\begin{lemma}[Noble distinguishability]\label{lem:noble-distinguishability}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let$\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$.Then $\Tpi\TpiP\TpiT$ has a (finite) model iff there is some promotion$\Tpi\TpiPb\TpiTb$ of $\Tpi\TpiP\TpiT$ that has a (finite) nobly distinguishedmodel.\end{lemma}\begin{proof}First, suppose that $\StrA$ is a model for $\Tpi\TpiP\TpiT$,let $\relE = \at\StrA\se$ and let $\Gals = \Ecl\relE$ be the set of itsgalaxies. By~\Cref{lem:peasant-unitedness} together with~\Cref{rem:tpi-str-inv},we may without loss of generality assume that $\StrA$ is peasantly united.We define a promotion $\Tpi\TpiPb\TpiTb$ of $\Tpi\TpiP\TpiT$ and a$\SigSp$-enrichment $\StrAp$ that is a nobly distinguished model for $\Tpi\TpiPb\TpiTb$.Let $\Tpi\TpiP\TpiTp = \TpiP\TpiT[\StrA]$ be the type instance of $\StrA$.Recall that $\TNoi\TpiP\TpiT \subseteq \TNoi\TpiP\TpiTp$by~\Cref{rem:many-tpi-sub}.For every noble type $\tpIn \in \TNoi\TpiP\TpiTp$, let $\galXX\tpIn \in \GalsN$ be the unique(noble) galaxy realizing it.Note that there might be distinct noble types realized in the same galaxy:$\galXX\tpIn = \galXX\tpInp$ for $\tpIn \neq \tpInp \in \TNoi\TpiP\TpiTp$.For every noble galaxy $\galX \in \GalsN$ choose an arbitrary noble type $\tpIn$ realized in it: $\galX = \galXX\tpIn$.Define the enrichment $\StrAp$ as follows: for every $\ea \in \domA$:\begin{itemize}  \item If $\ea \in \galXX\tpIn$ is an element of some noble galaxy, then let  $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\tpIn$.  \item Otherwise, if $\ea \in \galX$ is an element of a peasant galaxy, then  let $\tpIa\StrAp\ea = \mr{\tpIa\StrA\ea}\bot$.\end{itemize}Let $\Tpi\TpiPb\TpiTb = \TpiP\TpiT[\StrAp]$ be the type instance of $\StrAp$.By~\Cref{rem:tpi-str}, $\StrAp$ is a model for $\Tpi\TpiPb\TpiTb$.First we verify that $\Tpi\TpiPb\TpiTb$ is a promotion of $\Tpi\TpiP\TpiT$:\begin{itemize}  \item[\refcondpromp]  Let $\tpIp \in \TpiP$. Since $\StrA$ is a model for $\Tpi\TpiP\TpiT$, there is  some $\ea \in \domA$ that realizes $\tpIp$.  By construction, $\tpIpp = \tpIa\StrAp\ea = \mr\tpIp\tpIr$ for some $\tpIr \in  \TpiP\cup\set\bot$.  Since $\StrAp$ is a model for $\Tpi\TpiPb\TpiTb$, we have $\tpIpp \in \TpiPb$.  \item[\refcondpromn]  Suppose towards a contradiction that $\mr\tpIp\bot \in \TNoi\TpiPb\TpiTb$ is a  noble type.  Since $\StrAp$ is a $\Tpi\TpiPb\TpiTb$-model, there is some $\ea  \in \domA$ such that $\tpIa\StrAp\ea = \mr\tpIp\bot$.  By construction $\tpIa\StrA\ea = \tpIp$ must be a peasant type and $\ea \in  \galX$ is an element of a peasant galaxy.  Since $\StrA$ is peasantly united, there is some other peasant galaxy $\galY  \neq \galX$ and an element $\eb \in \galY$ such that $\tpIa\StrA\eb = \tpIp$.  By construction $\tpIa\StrAp\eb = \mr\tpIp\bot$, so the cosmic $2$-type  $\tpTtp = \tpIab\StrAp\ea\eb$ connects $\mr\tpIp\bot$ with itself. Since  $\Tpi\TpiPb\TpiTb$ is the type instance of $\StrAp$, we have $\tpTtp \in  \TpiTb$ --- a contradiction.  \item[\refcondpromk]  Let $\mr\tpIp\tpIr \in \TKgi\TpiPb\TpiTb$ be any king type such that $\tpIp  \not\in \TKgi\TpiP\TpiT$. We have to find some $\tpIrp \neq \tpIr$ such that  $\mr\tpIp\tpIrp \in \TpiPb$.  Since $\StrAp$ is a $\Tpi\TpiPb\TpiTb$-model, we have that $\mr\tpIp\tpIr$ is  realized by a unique element $\ea \in \domA$.   Since king types are noble types, by Condition~\refcondpromn we must have  $\tpIr \neq \bot$.  By construction $\tpIr \in \TNoi\TpiP\TpiTp$ is noble, $\ea \in \galXX\tpIr$  and $\tpIa\StrA\ea = \tpIp$. Since $\StrA$ is a $\Tpi\TpiP\TpiT$-model and  $\tpIp$ is a worker type, by Condition~\refcondrealizk there is some $\eb  \neq \ea$ such that $\tpIa\StrA\eb = \tpIp$. Let $\mr\tpIp\tpIrp =  \tpIa\StrAp\eb \in \TpiPb$. We claim that $\tpIrp \neq \tpIr$. Suppose towards  a contradiction that $\tpIrp = \tpIr$. Then $\tpIab\StrAp\ea\eb \in \TpiTb$  connects $\mr\tpIp\tpIr$ with itself --- a contradiction.\end{itemize}Next we verify that $\StrAp$ is a nobly distinguished model for$\Tpi\TpiPb\TpiTb$.\begin{itemize}  \item[\refcondrealizd]  Let $\ea \in \domA$ has $\tpIa\StrAp\ea \in \TNoi\TpiPb\TpiTb$.   We have to show that every $\eb \in \relE[\ea]$ has $\tpIa\StrAp\eb \in  \TNoi\TpiPb\TpiTb$.  By Condition~\refcondpromn for the promotion $\Tpi\TpiPb\TpiTb$ and by  construction we must have $\tpIa\StrAp\ea = \tpIp_\tpIn$ for some noble $\tpIn  \in \TNoi\TpiP\TpiTp$.  Then by construction $\ea \in \galXX\tpIn$, so by construction any $\eb \in  \galXX\tpIn$ has $\tpIa\StrAp\eb = \tpIp_\tpIn'$ for some $\tpIpp \in \TpiP$,  and so again by Condition~\refcondpromn we must have that $\tpIa\StrAp\eb \in  \TNoi\TpiPb\TpiTb$.  \item[\refcondrealizn]  Let $\tpIpp \in \TpiPb$ be realized in a single galaxy in $\StrAp$.  We have to show that $\tpIpp \in \TNoi\TpiPb\TpiTb$ is noble. Suppose towards  a contradiction that $\tpIpp$ is not noble, that is that some cosmic $\tpTtp  \in \TpiTp$ connects $\tpIpp$ with itself. Since $\Tpi\TpiPp\TpiTp$ is the  type instance of $\StrA$, there are some $\ea \neq \eb \in \domA$ such that  $\tpIab\StrAp\ea\eb = \tpTtp$, so $\tpIa\StrAp\ea = \tpIa\StrAp\eb = \tpIpp  \in \TpiPb$ --- a contradiction.\end{itemize}Next, suppose that $\StrAp$ is a nobly distinguished model for$\Tpi\TpiPb\TpiTb$. We claim that the reduct $\StrA$ of $\StrAp$ to a$\SigS$-structure is a model for $\Tpi\TpiP\TpiT$.\begin{itemize}  \item[\refcondrealizI]  follows by Condition~\refcondrealizI for the $\Tpi\TpiPb\TpiTb$-model $\StrAp$  together with $\TpiPb \subseteq \mr\TpiP\TpiP$.  \item[\refcondrealizII]  follows by Condition~\refcondrealizII for the $\Tpi\TpiPb\TpiTb$-model  $\StrAp$ together with $\TpiTb \subseteq \mr\TpiT\TpiT$.  \item[\refcondrealizp]  follows by Condition~\refcondrealizp for the $\Tpi\TpiPb\TpiTb$-model  $\StrAp$ together with Condition~\refcondpromp for the promotion  $\Tpi\TpiPb\TpiTb$.  \item[\refcondrealizk]   Let $\tpIp \in \TpiP$ be realized by a unique element $\ea \in \domA$. We have  to show that $\tpIp \in \TKgi\TpiP\TpiT$ is a king type.  Consider $\tpIa\StrAp\ea = \mr\tpIp\tpIr \in \TpiPb$ for some $\tpIr \in  \TpiP \cup \set\bot$.  Then $\mr\tpIp\tpIr$ must be realized by a unique element in $\StrAp$, so  by~\Cref{rem:many-nd-tpi-char} we have $\mr\tpIp\tpIr \in \TKgi\TpiPb\TpiTb$.  Suppose towards a contradiction that $\tpIp \not\in \TKgi\TpiP\TpiT$.  Then by~\refcondpromk we must have that $\mr\tpIp\tpIrp \in \TpiPb$ for some  $\tpIrp \neq \tpIr$.  Since $\StrAp$ is a $\Tpi\TpiPb\TpiTb$-model, there is some $\eb \in \domA$  such that $\tpIa\StrAp\eb = \mr\tpIp\tpIrp$.   Then $\eb \neq \ea$ and the $2$-type $\tpTtp = \tpIab\StrAp\ea\eb$ connects  $\mr\tpIp\tpIr$ with $\mr\tpIp\tpIrp$. Then the $2$-type $\tpTt =  \tpIab\StrA\ea\eb \in \TpiT$ connects $\tpIp$ with itself --- a contradiction.\end{itemize}\end{proof}\begin{corollary}The (finite) type realizability problem is reducible in nondeterministicpolynomial time to the (finite) nobly distinguished type realizability problem.\[  \FinAReal{\vFo2\Eea\sze\agrefine} \red\cNP  \FinANDReal{\vFo2\Eea\sze\agrefine}.\]\end{corollary}\begin{comment}Denote the type realizability problem for $\vFo2\Eea\sze\agrefine$ restricted tothe class of nobly distinguished structures by $\NDReal{\vFo2\Eea\sze\agrefine}$ and the finiteversion of that problem by $\FinNDReal{\vFo2\Eea\sze\agrefine}$.The noble distinguishability lemma shows that the class of nobly distinguishedmodels is a nondeterministic polynomial time reduction class:\[  \FinAReal{\vFo2\Eea\sze\agrefine} \red{\cNP} \FinANDReal{\vFo2\Eea\sze\agrefine}.\]\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.A \emph{cosmic spectrum} $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ over$\Tpi\TpiP\TpiT$ is a nonempty set of cosmic $2$-types satisfying the followingconditions:\begin{itemize}  \item[\condcspx]\label{cond:cspx}  An \emph{internal type} for $\csps$ is any $1$-type  $\tpIp \in (\xtp\restriction\csps)$. Denote the set of internal types for  $\csps$ by $\xTp\csps = (\xtp\restriction\csps)$.  We require that either $\xTp\csps \subseteq \TNoi\TpiP\TpiT$ (in that case we  refer to $\csps$ as a \emph{noble cosmic spectrum}),   or $\xTp\csps \cap \TNoi\TpiP\TpiT = \eset$, equivalently $\xTp\csps  \subseteq \TPsi\TpiP\TpiT$ (and we refer to $\csps$ as a \emph{peasant cosmic  spectrum}).  This is the analogue of Condition~\refcondstpx for star-types.  \item[\condcspnx]\label{cond:cspnx}  If $\csps$ is a noble cosmic spectrum and $\tpIn \in \xTp\csps$   is any (noble) internal type, then no $\tpTt \in \stps$ has $\ytp\tpTt =  \tpIn$.  This is the analogue of Condition~\refcondstpkx for star-types.  \item[\condcspny]\label{cond:cspny}  If $\tpIn \in \TNoi\TpiP\TpiT \sub \xTp\csps$ is any noble type  that is not internal and $\tpIp \in \xTp\csps$ is any internal type, then  some (possibly many) $\tpTt \in \stps$ has $\xtp\tpTt = \tpIp$ and $\ytp\tpTt  = \tpIn$.  This is the analogue of Condition~\refcondstpky for star-types.  \item[\condcspm]\label{cond:cspm}  This is not a condition. The notion of local consistency  will be the analogue of Condition~\refcondstpm for star-types.\end{itemize}\end{definition}\begin{remark}\label{rem:str-noble-exact}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\StrA$be a nobly distinguished model for $\Tpi\TpiP\TpiT$. Then the noble types$\tpIn \in \TNoi\TpiP\TpiT$ are exactly the $1$-types that are realized in aunique galaxy in $\StrA$.\end{remark}\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.Let $\StrA$ be a nobly distinguished model for $\Tpi\TpiP\TpiT$ and suppose that$\relE = \at\StrA\se \neq (\domAA)$ is not full on $\domA$, equivalently that $\relE$ has at least$2$ equivalence classes.The \emph{cosmic spectrum} $\csps = \cspIX\StrA\eclX$ of an $\relE$-class$\eclX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpTc\SigS}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]\end{definition}\begin{remark}Then $\csps$ is indeed a cosmic spectrum over $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}That $\csps$ is nonempty follows from the assumption that $\relE$ is not full on$\domA$. We verify the conditions for a cosmic spectrum:\begin{itemize}  \item[\refcondcspx]   Let $\csps \in \Cert$, so $\csps = \cspIX\StrA\eclX$ for some galaxy $\eclX  \in \Ecl\relE$. Since $\StrA$ is nobly distinguished, either $\eclX$ is a  noble galaxy in which case it only realizes noble types, or is a peasant  galaxy in which case it only realizes peasant types.  \item[\refcondcspnx]  follows from~\Cref{rem:str-noble-exact}.  \item[\refcondcspny]  \end{itemize}\end{proof}We like to think about a cosmic spectrum of a galaxy as the \emph{reason why}that galaxy is possible. For this we need to define the notion of a\emph{locally consistent} cosmic spectrum. For this we extract a type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the \emph{simpler logic}$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$ out of the cosmic spectrum $\csps$:\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\Lvp\Fo2\nopow\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.Let $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ be a cosmic spectrum over$\Tpi\TpiP\TpiT$.Let $\si$ (intended to label the inside of the galaxy) and $\sbh$ (intended tolabel some \emph{black hole} outside the galaxy) be two new unary predicatesymbols. Define the following sets of literals: \begin{align*}  \tIN(\xx) &= \set{\si(\xx),\lnot\sbh(\xx)} \\  \tOUT(\xx) &= \set{\lnot\si(\xx), \lnot\sbh(\xx)} \\  \tBH(\xx) &= \set{\lnot\si(\xx), \sbh(\xx)}.\end{align*}For a $1$-type $\tpIp\in\TpiP$ or a $2$-type $\tpTt\in\TpiT$, denote by$\noe\tpIp$ and $\noe\tpTt$ the reducts of $\tpIp$ and $\tpTt$ to the language $\SigS - \set{\se}$.That is, $\noe\tpIp \subset \tpIp$ and $\noe\tpTt \subset \tpTt$ consist ofthose literals that do not feature the predicate symbol $\se$.Define the \emph{spectral type instance} $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ of thecosmic spectrum $\stps$ as a type instance over the $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-signature $\ClSig{\SigS - \seq{\se} + \seq{\si,\sbh}}\sms$\footnote{Note that here we usethe condition that no builtin equivalence symbol $\se$ occurs as a messagesymbol.} as follows:\begin{itemize}  \item[\sticondI]\label{sti-I}  For every $\tpIp \in (\xtp\restriction\stps)$ inside $\csps$, add the  $1$-type $(\noe\tpIp \cup \tIN(\xx))$ to $\TpiPs\csps$.  \item[\sticondO]\label{sti-O}  For every $\tpIp \in (\ytp\restriction\stps)$ outside $\csps$, add the  $1$-type $(\noe\tpIp \cup \tOUT(\xx))$ to $\TpiPs\csps$. Note that some  $1$-types might occur both inside and outside of $\csps$.  \item[\sticondB]\label{sti-B}  Let $\tpIb$ be an arbitrary $1$-type extending $\tBH(\xx)$.  Call $\tpIb$ the \emph{black hole type} and add it to $\TpiPs\csps$.  \item[\sticondII]\label{sti-II}  For every galactic $\tpTt \in (\TpiT \cap \TpTg\SigS)$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tIN(\yy))$ to $\TpiTs\csps$.  \item[\sticondIO]\label{sti-IO}  For every (cosmic) $\tpTt \in \stps$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tOUT(\yy))$ and its inverse to $\TpiTs\csps$.  \item[\sticondOO]\label{sti-OO}  For every $2$-type $\tpTt \in \TpiT$, add the $2$-type  $(\noe\tpTt \cup \tOUT(\xx) \cup \tOUT(\yy))$ to $\TpiTs\csps$.  \item[\sticondIB]\label{sti-IB}  For every $1$-type $\tpIpp \in \TpiPs\csps$, $\tIN(\xx) \subseteq \tpIpp$ that  comes from the inside, let $\tpTt$ be an arbitrary $2$-type connecting $\tpIpp$ and the black hole type $\tpIb$ that witnesses no  message symbols for $\tpIpp$ and everything for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $(\lnot\sm(\xx,\yy)) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.  \item[\sticondOB]\label{sti-OB}  For every $1$-type $\tpIpp \in \TpiPs\csps$, $\tOUT(\xx) \subseteq \tpIpp$  that comes from the outside, let $\tpTt$ be an arbitrary $2$-type connecting  $\tpIpp$ and the black hole type $\tpIb$ that witnesses every message symbol for $\tpIpp$ and for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $\sm(\xx,\yy) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.\end{itemize}This completes the description of the spectral type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-classified signature$\ClSig{\SigS - \seq{\se} + \seq{\si, \sbh}}\sms$ is realizable.\end{definition}\begin{remark}\label{rem:csp-is-locally-consistent}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.Let $\StrA$ be a model for $\Tpi\TpiP\TpiT$ such that $\relE =\at\StrA\se$ is not full on $\domA$ and let $\eclX \in \Ecl\relE$ be any galaxy.Then the cosmic spectrum $\csps = \cspIX\StrA\eclX$ is a locally consistentcosmic spectrum over $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$.We build a $\SigSp$-structure $\StrAp$ based on $\StrA$ that realizes thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The domain of $\StrAp$ is $\domAp = \domA \cup \set{\eo}$, where $\eo$ is the new \emph{black hole}element.The $1$-type of every element $\ea \in \domAp$ is defined as follows:\begin{itemize}  \item[\refsticondI]  If $\ea \in \eclX$ is inside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tIN(\xx)$.  \item[\refsticondO]  If $\ea \in \domA \sub \eclX$ is outside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tOUT(\xx)$.  \item[\refsticondB] If $\ea = \eo$ is the black hole, then let  $\tpIa\StrAp\ea = \beta$.\end{itemize}The $2$-type between every pair of distinct elements $\ea \neq \eb \in \domA'$is defined as follows:\begin{itemize}  \item[\refsticondII]  If both $\ea,\eb \in \eclX$ are inside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tIN(\yy)$.  Note that this assignment is symmetric, that is we would assign  $\inv{\tpIab\StrAp\ea\eb}$ to $\tpIab\StrAp\eb\ea$.  \item[\refsticondIO]  If $\ea \in \eclX$ is inside and $\eb \in \domA \sub  \eclX$ is outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tOUT(\yy)$.  Note that this case covers the symmetric assignments where $\ea \in  \domA\sub\eclX$ and $\eb \in \eclX$.  \item[\refsticondOO]  If both $\ea, \eb \in \domA\sub\eclX$ are outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tOUT(\xx) \cup  \tOUT(\yy)$. Note that this assignment is symmetric.  \item[\refsticondIB]  If $\ea \in \eclX$ is inside and $\eb = \eo$ is the black hole, let $\tpTt  \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.  \item[\refsticondOB]  If $\ea \in \domA\sub\eclX$ is outside and $\eb = \eo$ is the black hole, let  $\tpTt \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.\end{itemize}We have to verify that $\StrAp$ is indeed a $\ClSig\SigSp\sms$-structure, thatis that the star-type of every element of $\ea \in \domAp$ contains$\sm(\xx,\yy)$ for every message symbol $\sm \in \sms$:\begin{itemize}\item[\refsticondI] If $\ea \in \eclX$ is inside, then every$\sm \in \sms$ that is included in $\stpIa\StrA\ea$ is also included in$\stpIa\StrAp\ea$, since the $2$-type $\noe\tpTt$ contains $\sm(\xx,\yy)$ iff$\tpTt$ contains $\sm(\xx,\yy)$.\item[\refsticondO] If $\ea \in \domA\sub\eclX$ is outside, then we just need torecall that at stage~\refsticondOB, we have used a $2$-type $\tpIab\StrAp\ea\eo= \tpTt$ that witnesses every message symbol for $\ea$: $\sm(\xx,\yy) \in\tpTt$ for every $\sm \in \sms$.\item[\refsticondB] If $\ea = \eo$ is the black hole, then we just need torecall that $\eclX$ is nonempty and at stage~\refsticondIB~for every $\ea \in\eclX$ we have used a $2$-type $\tpTt = \tpIab\StrAp\ea\eo$ that witnesses everymessage symbol for $\eo$: $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$.\end{itemize}Since $\StrA$ was a model for $\Tpi\TpiP\TpiT$, it is clear that $\StrAp$ is amodel for $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.\end{proof}\begin{remark}Relation between kings in above.\end{remark}\begin{definition}A certificate $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ over the$\vFo2\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$ is a nonemptyset of cosmic spectrums over $\Tpi\TpiP\TpiT$ satisfying the followingconditions:\begin{itemize}  \item[\condcertmi]\label{cond:certmi}  If $\tpTt \in \csps$ for some $\csps \in \Cert$, then  $\inv\tpTt \in \cspsp$ for some $\cspsp \in \Cert$,   that is there are cosmic spectrums for the endpoints of every (cosmic)  $2$-type used in the certificate.  Equivalently, $\TpiTp = \cup\Cert$ is closed under inversion.  Note that then $\Tpi\TpiP\TpiTp$ is also a type instance over  $\ClSig\SigS\sms$ and also that every cosmic spectrum $\csps \in \Cert$ is a  cosmic spectum over $\Tpi\TpiP\TpiT$. Call $\Tpi\TpiP\TpiTp$ the  \emph{filtered type instance} of $\Cert$.  \item[\condcertmN]\label{cond:certmN}  We require that $\TNoi\TpiP\TpiTp = \TNoi\TpiP\TpiT$, that is the notion of a  noble type with respect to the filtered type instance coincides with the  notion of a noble type with respect to the original type instance.  \item[\condcertmp]\label{cond:certmp}  If $\tpIp \in \TpiP$, then some (possibly many) $\csps \in \Cert$ has $\tpIp  \in \xTp\csps$.  \item[\condcertmn]\label{cond:certmn}  If $\tpIn \in \TNoi\TpiP\TpiT$, then a unique $\csps \in \Cert$ has $\tpIn  \in \xTp\csps$. Note that the existence is already implied by~\refcondcertmp.  \item[\condcertmc]\label{cond:certmc}  Let $\tpIp, \tpIpp \in \TpiP$. If it is not the case that both $\tpIp$ and  $\tpIpp$ are noble and are internal for the same cosmic spectrum $\csps \in  \Cert$, then some cosmic $\tpTt \in \TpiTp$ has $\xtp\tpTt = \tpIp$ and  $\ytp\tpTt = \tpIpp$, that is if $\tpIp$ and $\tpIpp$ don't come from the  same noble galaxy, then they are cosmically connectable.\end{itemize}\end{definition}Again, in general the size of a certificate is only exponentially bounded interms of the size of the type instance. But again, polynomial certificatesexist:\begin{lemma}[Certificate extraction]\label{lem:cert-extr-many}Let $\StrA$ be a nobly distinguished model for the type instance$\Tpi\TpiP\TpiT$ such that $\relE = \at\StrA\se$ is not full on $\domA$.Let $\Tpi\TpiP\TpiTp$ be the type instance of $\StrA$. For every cosmic $\tpTt\in \TpiTp$, let $\eat\tpTt \neq \ebt\tpTt \in \domA$ be two distinct elementsrealizing $\tpTt$: $\tpIab\StrA{\eat\tpTt}{\ebt\tpTt} = \tpTt$. Note thatnecessarily the elements $\eat\tpTt$ and $\ebt\tpTt$ are in different galaxies.The choice is made symmetrically, that is $\eat{\inv\tpTt} = \ebt\tpTt$ and$\ebt\tpTt = \eat{\inv\tpTt}$. Let\[  \Cert = \setbd{\cspIX\StrA{\relE[\eat\tpTt]}}{\tpTt \in \TpiTp \cap  \TpTc\SigS}.\]Then $\Cert$ is a certificate for $\Tpi\TpiP\TpiT$.Moreover, its size is linearly bounded by $\card\TpiTp$, hence also by the sizeof $\Tpi\TpiP\TpiT$.\end{lemma}\begin{proof}We check the conditions for a certificate:\begin{itemize}  \item[\refcertcondIp] By construction, $\Tpi\TpiP\TpiTp$ is a type instance  and every $\csps \in \Cert$ is a locally consistent cosmic spectrum over  $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIp] Every $1$-type $\tpIp \in \TpiP$ is witnessed since  $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  \item[\refcertcondIIIp] Every noble $1$-type $\tpIn \in \TNoi\TpiP\TpiTp$ is  witnessed uniquely, since the noble $1$-types are exactly those that are  realized at a single galaxy of $\StrA$.  \item[\refcertcondIVp] Suppose that $\tpIp, \tpIpp \in \TpiP$ is a pair of  $1$-types that are not cosmically connectable. Consider the elements realizing  these $1$-types in $\StrA$: $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \domA$.  These sets are nonempty, since $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.  Next we claim that both $\at\StrA\tpIp$ and $\at\StrA\tpIpp$ are included in  the same galaxy of $\StrA$. Suppose not and let $\ea \in \at\StrA\tpIp$ and  $\eb \in \at\StrA\tpIpp$ be elements realizing the $1$-types from different  galaxies. Then $\tpIab\StrA\ea\eb \in \TpiTp$ is a cosmic type connecting  $\tpIp$ and $\tpIpp$ --- a contradiction.  Therefore $\at\StrA\tpIp, \at\StrA\tpIpp \subseteq \eclX$ for some $\eclX  \in \Ecl\relE$. Since $\StrA$ is nobly distinguished and $\Tpi\TpiP\TpiTp$ is  the type instance of $\StrA$, the $1$-types $\tpIp$ and $\tpIpp$ must be noble  over $\Tpi\TpiP\TpiTp$. By~\refcertcondIIIp, they are witnessed uniquely in  the certificate by the cosmic spectrum $\csps = \cspIX\StrA\eclX$.\end{itemize}\end{proof}\begin{lemma}[King lemma]Let $\Cert$ be a certificate for $\Tpi\TpiP\TpiT$,let $\TpiTp = \cup\Cert$.(Kings are the same since nobles are the same)Let $\tpIk \in \TKgi\TpiP\TpiT$, $\csps\in\Cert$ be the unique such that $\tpIk\in \xTp\csps$ and let $\tpIp \in \TpiP \sub \xTp\csps$.Then $\tpIk$ and $\tpIp$ are uniquely connecable -- NOPE!\end{lemma}\begin{lemma}[Certificate expansion]\label{lem:cert-exp-many}Let $\Cert$ be a certificate for the type instance $\Tpi\TpiP\TpiT$ over theclassified signature $\ClSig\SigS\sms$ over $\vFo2\Eea\sze\agrefine$. Then$\Tpi\TpiP\TpiT$ has a finite nobly distinguished model.More precisely, let $\TpiTp = \cup\Cert \subseteq \TpiT$ and let $\pt \geq\card\TpiTp$ be a parameter. Then the filtered type instance $\Tpi\TpiP\TpiTp$has a finite nobly distinguished model $\StrA$ in which every king type $\tpIk\in \TKgi\TpiP\TpiTp$ is realized once and every peasant type $\tpIp \in\TPsi\TpiP\TpiTp$ is realized at least $\pt$ times.\end{lemma}\begin{proof}Let $\SigSp = \SigS - \seq{\se} + \seq{\si,\sbh}$.For every locally consistent cosmic spectrum $\csps \in \Cert$, let$\StrAs\csps$ be a finite $\ClSig\SigSp\sms$-structure that is a model for thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$. Assume that the domainsof the structures $\StrAs\csps$ are disjoint.Let $\eclX^\csps = \at{\StrAs\csps}\si$ be the set of inside elements in themodel $\StrAs\csps$. We describe the domain $\domA$ of $\StrA$ and theinterpretation $\relE = \at\StrA\ea$ of the coarsest builtin equivalence symbolby specifying the galaxies $\eclX \in \Ecl\relE$ of $\StrA$:\begin{itemize}  \item For every noble $\csps \in \Cert$, there is a unique galaxy  $\eclX^\csps$ that has intended cosmic spectrum $\csps$.  That is $\mathcal{\eclX}^\csps = \set{\eclX^\csps}$.  Call the galaxies $\eclX^\csps$ the noble galaxies.  \item For every peasant $\csps \in \Cert$, there are three disjoint copies of  $\pt$ galaxies: $\mathcal{X}^\csps = \mathcal{X}^\csps_0 \cup  \mathcal{X}^\csps_1 \cup \mathcal{X}^\csps_2$,  $\mathcal{X}^\csps_i =  \set{\eclX^\csps_{i1},\eclX^\csps_{i2},\dots,\eclX^\csps_{it}}$ for $i \in  \set{0,1,2}$.  Call the galaxies $\eclX^\csps_{ij}$ the peasant galaxies.\end{itemize}Let $\csps : \Ecl\relE \to \Cert$ denote the intended cosmic spectrum of thegalaxies: $\csps(\eclX) = \csps$ on $\mathcal{X}^\csps$.Assign the $1$-types and the galactic $2$-types to the corresponding models forthe spectral instances:\begin{itemize}  \item $\tpIa\StrA\ea = \tpIa{\StrAs\csps}\ea \cup \set{\se(\xx,\xx)}$ and   \item $\tpIab\StrA\ea\eb = \tpIab{\StrAs\csps}\ea\eb \cup\set{\se(\xx,\xx),\se(\yy,\yy),\se(\xx,\yy),\se(\yy,\xx)}$ on $\eclX \in\mathcal{X}^\csps$.\end{itemize}It remains to assign cosmic types consistently between pairs of elements indistinct galaxies.\begin{description}\item[Realization of kings] TODO: lemmaLet $\tpIk \in \TKgi\TpiP\TpiTp$. There is a unique (noble) cosmic spectrum$\csps \in \Cert$ such that $\tpIk \in (\xtp\restriction\csps)$.Let $\tpIkp \in \TKgi\TpiP\TpiTp \sub \set{\tpIk}$. Then there is a unique(cosmic) $2$-type $\tpTt \in \cup\Cert$ connecting $\tpIk$ and $\tpIkp$.\item[Realization of noble galaxies] We first find witnesses for the intendedcosmic spectrums of noble galaxies. Let $\csps \in \Cert$,$(\xtp\restriction\csps) \subseteq \TNoi\TpiP\TpiTp$ be any noble cosmicspectrum. Its corresponding galaxy is $\eclX^\csps$.Let $\tpTt \in \csps$ be any (cosmic) type that needs to be realized.Since $\csps$ is noble, we have that $\tpIn = \xtp\tpTt \in \TNoi\TpiP\TpiTp$ isnoble.Let $Y = \eclX^\csps \cap \at\StrA\tpIn$ be the set of elements of $\StrA$ thathave intended $1$-type $\tpIn$.Let $\cspsp \in \Cert$ be a cosmic spectrumcontaining $\inv\tpTt$.Since $\csps$ is noble we must have that $\cspsp \neq \csps$. We consider twocases:\begin{itemize}  \item If $\tpInp = \ytp\tpTt \in \TNoi\TpiP\TpiTp$ is a noble type, then  $\cspsp \in \Cert$ is the unique (noble) cosmic spectrum such that $\tpInp \in  (\xtp\restriction\csps)$, so $\eclX^\cspsp$ is the unique galaxy having  intended cosmic spectrum $\cspsp$. Let $Z = \eclX^\cspsp \cap \at\StrA\tpInp$  be the set of elements of $\StrA$ having intended \end{itemize}\end{description}\end{proof}\section{TODO}Let $\tpIp,\tpIpp\in\TpiP$ be any unordered pair of $1$-types. Let$\Delta_\tpIp, \Delta_\tpIpp$ be the cosmic spectrums containing $\tpIp$ and$\tpIpp$ inside.We are going to assign $2$-types consistently between every pair or distinctelements $\ea\neq\eb \in \domA$ from distinct galaxies, in such a way that the$(\tpIp,\tpIpp)$-reduced star-type of them is realized.\begin{itemize}  \item[$(\mathcal{K}\mathcal{K})$] Suppose that $\tpIp = \tpIk \in  \TKgi\TpiP\TpiTp$ and $\tpIpp = \tpIkp \in \TKgi\TpiP\TpiTp$ are king types.  Suppose that $\tpIk \neq \tpIkp$.  \item[$(\mathcal{K})$]    If $\tpIk \in \TKgi\TpiP\TpiTp$ is a king type, then there is a unique    element $\ea \in \domA$ having $\tpIp(\ea) = \tpIk$.  \item[$(\mathcal{N})$] If $\tpIn \in \TNoi\TpiP\TpiTp$ is any noble type, then  there is a unique (noble) cosmic spectrum $\csps$ containing it inside; that  is there is a unique galaxy $\eclX$ that contains all the elements having  intended $1$-type $\tpIn$.\end{itemize}\end{comment}