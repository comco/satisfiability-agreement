% Type realizibility og the two-variable first-order logic with equivalences in% refinementIn this section we consider the logic $\Lvp\Fo2\nopow\Eea\sze\agrefine$featuring $\sze \geq 2$ equivalence symbols $\see1,\see2,\dots,\see\sze$ inrefinement. Abbreviate the coarsest equivalence symbol $\se = \see\sze$.Recall from the previous section that every $\vFo2$-sentence $\fphi$ can bereduced in polynomial time to an equisatisfiable sentence in the form:\begin{equation*}  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy  (\smm\ii(\xx,\yy) \land \xx \neq \yy),\end{equation*}that may use additional unary predicate symbols and the new message symbols$\smm\ii$, where the $\forall\forall$-part $\falp$ is quantifier-free.\begin{definition}A \emph{classified signature} for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ is apredicate signature $\SigS$ together with a sequence $\sms =\smm1\smm2\dots\smm\nm$ of distinct binary predicate symbols \emph{distinctfrom the equivalence symbols} from $\SigS$ having the intended interpretation\begin{equation*}  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy   (\smm\ii(\xx,\yy) \land \xx \neq \yy).\end{equation*}\end{definition}Again, note that a classified signature \emph{automatically includes} the$\forall\exists$-part of formulas and $\seq{\SigS,\sms}$-structures\emph{automatically satisfy} the $\forall\exists$-part.The (finite) classified satisfiability problem for$\Lvp\Fo2\nopow\Eea\sze\agrefine$ is defined as in~\Cref{def:clsig-twovar}.Again we have the reduction:\[  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.\]Let $\ClSig\SigS\sms$ be a classified signature for$\Lvp\Fo2\nopow\Eea\sze\agrefine$.A type instance $\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$ is defined asin~\Cref{def:tpinst-twovar}; also the notions of a model for a type instance,full realization, characteristic type instance of a model and the (finite)(full) type realizibility problem for $\Lvp\Fo2\nopow\Eea\sze\agrefine$ aredefined. Again, the reductions from~\Cref{rem:red-real-to-full-real}and~\Cref{rem:red-sat-to-real} hold:\begin{align*}  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cNP   \FinAFullReal{\Lvp\Fo2\nopow\Eea\sze\agrefine} \\  \FinAClSat{\Lvp\Fo2\nopow\Eea\sze\agrefine} &\red\cExpTime
  \FinAReal{\Lvp\Fo2\nopow\Eea\sze\agrefine}.
\end{align*}We proceed to define new terms, specific to the case of many equivalencesymbols.The terminology is loosely based on~\cite{MALQ:MALQ201400102}.\begin{definition}A $2$-type $\tpTt \in \TpT\SigS$ is a \emph{galactic type} if $\se(\xx,\yy) \in\tau$.Otherwise, if $(\lnot\se(\xx,\yy)) \in \tpTt$, the type is a \emph{cosmic type}.The set of galactic $2$-types is $\TpTg\SigS$.The set of cosmic $2$-types is $\TpTc\SigS$.\end{definition}Informally, we think of the $\se$-classes in a structure as galaxies; of thewhole structure as the cosmos; of the galactic $2$-types as characterizing theinteractions in the internals of the galaxies, while cosmic $2$-typescharacterize the interactions between different galaxies.\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{galactically connectable}(written $\tpIp \gconn \tpIpp$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$for some galactic $\tpTt \in \TpiT$.The types are \emph{cosmically connectable} (written $\tpIp \cconn \tpIpp$), if$\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some cosmic $\tpTt \in \TpiT$.\end{definition}Note that the types may be both galactically and cosmically connectible and the(unqualified) definition of connectible types from~\Cref{def:connectable} isequivalent to:\[\miff{\tpIp \conn \tpIpp}{\tpIp \gconn \tpIpp \text{ or } \tpIp \cconn\tpIpp}.\]Recall that a $1$-type $\tpIk$ is a \emph{king type} if $\tpIk \not\conn \tpIk$.A $1$-type $\tpIn$ is a \emph{noble type} if $\tpIn \not\cconn \tpIn$. Note thatevery king type is a noble type. A $1$-type $\tpIp \in \TpiP$ is a peasant typeif it is not a noble type.Note that this is a different definition of a peasant type from the definition in theno builtin equivalence symbols case.Let $\TKg = \TKgi\TpiP\TpiT$ be the set of king types, $\TNo = \TNoi\TpiP\TpiT$be the set of noble types and $\TPs = \TPsi\TpiP\TpiT$ be the set of peasanttypes. The following is a generalization of~\Cref{rem:twovar-king-once}including noble types:\begin{remark}\label{rem:twovar-noble-once}If $\StrA$ is a full model for $\Tpi\TpiP\TpiT$, then every king type$\tpIk \in \TKgi\TpiP\TpiT$ is realized once in $\StrA$ and every noble type$\tpIn \in \TNoi\TpiP\TpiT$ is realized (possibly many times) in only one galaxyof $\StrA$.\end{remark}Our strategy to resolve the type realizability problem would be to encode thegalactic structure of enough galaxies into instances of the full typerealizability problem for the logic featuring one less equivalence symbol.The following definition characterizes the local structure of a single galaxy ina full model.\begin{definition}A \emph{cosmic spectrum} $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ for thetype instance $\Tpi\TpiP\TpiT$ is a nonempty set of cosmic types satisfyingthe following conditions:\begin{itemize}  \item[\cspcondIp]\label{cond:csp-Ip}  Call the set of $1$-types $(\xtp\restriction\stps)$ the ``inside'' of $\csps$.  This is not a condition and Condition~\refstpcond1 for star-types has no  analogue in this setting.  \item[\cspcondIIp]\label{cond:csp-IIp}  If $\tpIn \in (\xtp\restriction\csps) \cap \TNo$ is a noble type  ``inside'' $\stps$, then no $\tpTt \in \stps$ has $\ytp\tpTt = \tpIn$.  This is the analogue of Condition~\refstpcond2 for star-types.  \item[\cspcondIIIp]\label{cond:csp-IIIp}  If $\tpIn \in \TNo \sub (\xtp\restriction\stps)$ is any noble type ``outside''  $\csps$ and $\tpIp \in (\xtp\restriction\stps)$ is any $1$-type ``inside''  $\csps$, then some (possibly many) $\tpTt \in \stps$ have   $\xtp\tpTt = \tpIp$ and $\ytp\tpTt = \tpIn$.  This is the analogue of Condition~\refstpcond3 for star-types.  \item[\cspcondIVp]\label{cond:csp-IVp}  This is not a condition. The notion of local consistency  will be the analogue of Condition~\refstpcond4 for star-types.\end{itemize}The cosmic spectrum is \emph{noble} if there is a noble $1$-type $\tpIn \in(\xtp\restriction\stps)$.\end{definition}\begin{definition}Let $\StrA$ be a $\ClSig\SigS\sms$-structure and let $\relE = \at\StrA\se$.The \emph{cosmic spectrum} $\cspIX\StrA\eclX$ of an $\relE$-class$\eclX \in \Ecl\relE$ is the set of cosmic types realized at $\eclX$:\[  \cspIX\StrA\eclX = \setbd{\tpIab\StrA\ea\eb \in \TpTc\SigS}{\ea\in\eclX, \eb   \in \domA\sub\set{\ea}} = \setbd{\tpIab\StrA\ea\eb}{\ea \in \eclX, \eb \in  \domA \sub \eclX}.\]Note that the cosmic spectrum is empty iff $\relE = \domA\cprod\domA$.Without loss of generality, we may assume that $\relE$ is not the full relation,because the full relation is trivially definable in $\vFo2$. So without loss ofgenerality, we will consider models with nonempty cosmic spectrums of theirgalaxies.\end{definition}\begin{remark}Let $\Tpi\TpiP\TpiT$ be a type instance for $\ClSig\SigS\sms$, $\StrA$ be a full$\Tpi\TpiP\TpiT$-model such that $\relE = \at\StrA\se$ is not full on $\domA$and let $\eclX \in \Ecl\relE$ be any galaxy.Then $\csps = \cspIX\StrA\eclX$ is a cosmic spectrum for $\Tpi\TpiP\TpiT$.\end{remark}\begin{proof}That $\csps$ is nonempty follows from the assumption that $\relE$ is not full on$\domA$. We verify the conditions for a cosmic spectrum:\begin{itemize}  \item[\refcspcondIIp]   Let $\tpIn \in (\xtp\restriction\csps) \cap \TNo$ be a noble type ``inside''   $\csps$. Since $\StrA$ is a $\Tpi\TpiP\TpiT$-model, we have that $\csps   \subseteq \TpiT$ and by noble type definition, no $\tpTt \in \TpiT$   connects $\tpIn$ with itself.   \item[\refcspcondIIIp]   Let $\tpIn \in \TNo \sub (\xtp\restriction\csps)$ be a noble type ``outside''   $\csps$ and let $\tpIp \in (\xtp\restriction\csps)$ be a $1$-type ``inside''   $\csps$.   Since $\StrA$ is a full $\Tpi\TpiP\TpiT$-model, there is some   $\ea \in \eclX$ having $\tpIa\StrA\ea = \tpIp$ and some   $\eb \in \domA \sub \eclX$ having $\tpIa\StrA\eb = \tpIn$.   Then $\tpTt = \tpIab\StrA\ea\eb \in \csps$.\end{itemize}\end{proof}We like to think about a cosmic spectrum of a galaxy as the \emph{reason why}that galaxy is possible. For this we need to define the notion of a\emph{locally consistent} cosmic spectrum. For this we extract a type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the \emph{simpler logic}$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$ out of the cosmic spectrum $\csps$:\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\Lvp\Fo2\nopow\Eea\sze\agrefine$-classified signature $\ClSig\SigS\sms$.Let $\csps \subseteq (\TpiT \cap \TpTc\SigS)$ be a cosmic spectrum for$\Tpi\TpiP\TpiT$.Let $\si$ (intended to label the inside of the galaxy) and $\sbh$ (intended tolabel some \emph{black hole} outside the galaxy) be two new unary predicatesymbols. Define the following sets of literals: \begin{align*}  \tIN(\xx) &= \set{\si(\xx),\lnot\sbh(\xx)} \\  \tOUT(\xx) &= \set{\lnot\si(\xx), \lnot\sbh(\xx)} \\  \tBH(\xx) &= \set{\lnot\si(\xx), \sbh(\xx)}.\end{align*}For a $1$-type $\tpIp$ or a $2$-type $\tpTt$, denote by $\noe\tpIp$ and $\noe\tpTt$ the reducts of $\tpIp$ and$\tpTt$ to the language $\SigS - \set{\se}$.That is, $\noe\tpIp \subset \tpIp$ and $\noe\tpTt \subset \tpTt$ consist ofthose literals that do not feature the predicate symbol $\se$.Define the \emph{spectral type instance} $\Tpi{\TpiPs\csps}{\TpiTs\csps}$corresponding to the cosmic spectrum $\stps$ as a type instance overthe $\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-signature $\ClSig{\SigS - \set{\se} + \set{\si,\sbh}}\sms$\footnote{Note that here we usethe condition that no builtin equivalence symbol $\se$ occurs as a messagesymbol.} as follows:\begin{itemize}  \item[\sticondI]\label{sti-I}  For every $\tpIp \in (\xtp\restriction\stps)$ ``inside'' $\csps$, add the  $1$-type $(\noe\tpIp \cup \tIN(\xx))$ to $\TpiPs\csps$.  \item[\sticondO]\label{sti-O}  For every $\tpIp \in (\ytp\restriction\stps)$ ``outside'' $\csps$, add the  $1$-type $(\noe\tpIp \cup \tOUT(\xx))$ to $\TpiPs\csps$. Note that some  $1$-types might occur both ``inside'' and ``outside'' of $\csps$.  \item[\sticondB]\label{sti-B}  Let $\tpIb$ be an arbitrary $1$-type extending $\tBH(\xx)$.  Call $\tpIb$ the \emph{black hole type} and add it to $\TpiPs\csps$.  \item[\sticondII]\label{sti-II}  For every galactic $\tpTt \in (\TpiT \cap \TpTg\SigS)$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tIN(\yy))$ to $\TpiTs\csps$.  \item[\sticondIO]\label{sti-IO}  For every (cosmic) $\tpTt \in \stps$, add the $2$-type  $(\noe\tpTt \cup \tIN(\xx) \cup \tOUT(\yy))$ and its inverse to $\TpiTs\csps$.  \item[\sticondOO]\label{sti-OO}  For every $2$-type $\tpTt \in \TpiT$, add the $2$-type  $(\noe\tpTt \cup \tOUT(\xx) \cup \tOUT(\yy))$ to $\TpiTs\csps$.  \item[\sticondIB]\label{sti-IB} For every ``inside'' $1$-type $\tpIpp \in  \TpiPs\csps$, $\tIN(\xx) \subseteq \tpIpp$, let $\tpTt$ be an arbitrary  $2$-type connecting $\tpIpp$ and the black hole type $\tpIb$ that witnesses no  message symbols for $\tpIpp$ and everything for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $(\lnot\sm(\xx,\yy)) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.  \item[\sticondOB]\label{sti-OB} For every ``outside'' $1$-type $\tpIpp \in  \TpiPs\csps$, $\tOUT(\xx) \subseteq \tpIpp$, let $\tpTt$ be an arbitrary  $2$-type connecting $\tpIpp$ and the black hole type $\tpIb$ that witnesses  every message symbol for $\tpIpp$ and for $\tpIb$, that is  $\xtp\tpTt = \tpIpp$, $\ytp\tpTt = \tpIb$, $\sm(\xx,\yy) \in \tpTt$ and  $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$. Add $\tpTt$ and its inverse  to $\TpiTs\csps$.\end{itemize}This completes the description of the spectral type instance$\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The cosmic spectrum $\csps$ is \emph{locally consistent} if its spectral typeinstance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$ over the$\Lvp\Fo2\nopow\Eea{(\sze-1)}\agrefine$-classified signature$\ClSig{\SigS - \set{\se} + \set{\si, \sbh}}\sms$ is fully satisfiable.TODO: Write stuff about king preservation: old king - new king; the black holetype is a king.\end{definition}\begin{remark}\label{rem:csp-is-locally-consistent}Let $\Tpi\TpiP\TpiT$ be a type instance over the$\vFo2\Eea\sze\agrefine$-classified signture $\ClSig\SigS\sms$.Let $\StrA$ be a full $\Tpi\TpiP\TpiT$-model such that $\relE = \at\StrA\se$ isnot the full relation on $\domA$ and $\eclX \in \Ecl\relE$ be any galaxy.Then the cosmic spectrum $\csps = \cspIX\StrA\eclX$ is locally consistent.\end{remark}\begin{proof}Let $\SigSp = \SigS - \set{\se} + \set{\si,\sbh}$.We build a $\SigSp$-structure $\StrAp$ based on $\StrA$ that fully realizes thespectral type instance $\Tpi{\TpiPs\csps}{\TpiTs\csps}$.The domain of $\StrAp$ is $\domAp = \domA \cup \set{\eo}$, where $\eo$ is a new\emph{black hole} element. The $1$-type of every element $\ea \in \domAp$is defined as follows:\begin{itemize}  \item[\refsticondI]  If $\ea \in \eclX$ is inside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tIN(\xx)$.  \item[\refsticondO]  If $\ea \in \domA \sub \eclX$ is outside the galaxy, then let  $\tpIa\StrAp\ea = \noe{\tpIa\StrA\ea} \cup \tOUT(\xx)$.  \item[\refsticondB] If $\ea = \eo$ is the black hole, then let  $\tpIa\StrAp\ea = \beta$.\end{itemize}The $2$-type between every pair of distinct elements $\ea \neq \eb \in \domA'$is defined as follows:\begin{itemize}  \item[\refsticondII]  If both $\ea,\eb \in \eclX$ are inside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tIN(\yy)$.  Note that this assignment is symmetric, that is we would assign  $\inv{\tpIab\StrAp\ea\eb}$ to $\tpIab\StrAp\eb\ea$.  \item[\refsticondIO]  If $\ea \in \eclX$ is inside and $\eb \in \domA \sub  \eclX$ is outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tIN(\xx) \cup \tOUT(\yy)$.  Note that this case covers the symmetric assignments where $\ea \in  \domA\sub\eclX$ and $\eb \in \eclX$.  \item[\refsticondOO]  If both $\ea, \eb \in \domA\sub\eclX$ are outside, then let  $\tpIab\StrAp\ea\eb = \noe{\tpIab\StrA\ea\eb} \cup \tOUT(\xx) \cup  \tOUT(\yy)$. Note that this assignment is symmetric.  \item[\refsticondIB]  If $\ea \in \eclX$ is inside and $\eb = \eo$ is the black hole, let $\tpTt  \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.  \item[\refsticondOB]  If $\ea \in \domA\sub\eclX$ is outside and $\eb = \eo$ is the black hole, let  $\tpTt \in \TpiTs\csps$ be the unique $2$-type connecting $\tpIa\StrAp\ea$ and  $\tpIb$ and assign $\tpIab\StrAp\ea\eb = \tpTt$.\end{itemize}We have to verify that $\StrAp$ is indeed a $\ClSig\SigSp\sms$-structure, thatis that the star-type of every element of $\ea \in \domAp$ contains$\sm(\xx,\yy)$ for every message symbol $\sm \in \sms$:\begin{itemize}\item[\refsticondI] If $\ea \in \eclX$ is inside, then every$\sm \in \sms$ that is included in $\stpIa\StrA\ea$ is also included in$\stpIa\StrAp\ea$, since the $2$-type $\noe\tpTt$ contains $\sm(\xx,\yy)$ iff$\tpTt$ contains $\sm(\xx,\yy)$.\item[\refsticondO] If $\ea \in \domA\sub\eclX$ is outside, then we just need torecall that at stage~\refsticondOB, we have used a $2$-type $\tpIab\StrAp\ea\eo= \tpTt$ that witnesses every message symbol for $\ea$: $\sm(\xx,\yy) \in\tpTt$ for every $\sm \in \sms$.\item[\refsticondB] If $\ea = \eo$ is the black hole, then we just need torecall that $\eclX$ is nonempty and at stage~\refsticondIB~for every $\ea \in\eclX$ we have used a $2$-type $\tpTt = \tpIab\StrAp\ea\eo$ that witnesses everymessage symbol for $\eo$: $\sm(\yy,\xx) \in \tpTt$ for every $\sm \in \sms$.\end{itemize}Since $\StrA$ was a full $\Tpi\TpiP\TpiT$-model, it is clear that $\StrAp$ is afull $\Tpi{\TpiPs\csps}{\TpiTs\csps}$-model.\end{proof}\begin{definition}Let $\StrA$ be a full model for the type instance $\Tpi\TpiP\TpiT$ and let$\relE = \at\StrA\se$.Let $\Nu \subseteq \TpiP$ be the set of noble types (realized in $\StrA$).For every noble type $\tpIn \in \Nu$, let $\eclX_\tpIn \in \Ecl\relE$ be the(unique) $\relE$-class containing a (not necessarly unique) element realizing$\tpIn$, that is the set $\setbd{\eclX_\tpIn}{\tpIn \in \Nu}$ is the set ofall $\relE$-classes containing a noble element. Note that the cardinality ofthis set is at most $\card\TpiP$, since by definition no noble type iscosmically connected to itself.The model $\StrA$ is \emph{nobly distinguished} if every element in $\eclX_\tpIn$ realizes a noble type for every $\tpIn \in \Nu$. That is, a model is nobly distinguished if every class that contains a noble element cointainsonly noble elements.\end{definition}We want to restrict our attention to the problem of nobly distinguished typerealizability. To do this we will use some new unary predicate symbols and will``color'' the elements living along with nobles in a single $\se$-class to makethem noble as well.For this we need to encode possible connections between noble types and$1$-types realized in the same class, so we enrich the type instance toaccommodate such information.\begin{definition}Let $\Tpi\TpiP\TpiT$ be a type instance for $\ClSig\SigS\sms$. For every$1$-type $\tpIp \in \TpiP$, let $\spp\tpIp$ be a new unary predicate symbol. Let$\SigSp = \SigS + \seqbd{\spp\tpIp}{\tpIp \in \TpiP}$ be an enrichment of$\SigS$ featuring the new predicate symbols.For every $\tpIp \in \TpiP$, let \[  \spe^\tpIp = \spe^\tpIp(\xx) = \set{\spp\tpIp(\xx)} \cup  \setbd{\lnot\spp\tpIr(\xx)}{\tpIr \in \TpiP \sub \set{\tpIp}}.\]For every pair of (not necessarily distinct) $1$-types $\tpIp, \tpIpp \in\TpiP$, let $\tpIp_\tpIp'$ be a $1$-type over $\SigSp$ defined as follows:\[  \tpIp_\tpIp' = \tpIp' \cup \spe^\tpIp(\xx).\]We refer to $\tpIp_\tpIp'$ as the \emph{$\tpIp$-copy of $\tpIp'$}. Let$\TpiP_\TpiP = \setbd{\tpIp'_\tpIp}{\tpIp',\tpIp \in \TpiP}$ be the set of allthe copies. Note that this is a set of $1$-types over $\SigSp$. Let$\TpiT_\TpiP$ be a set of $2$-types over $\SigSp$ defined as follows:\[  \TpiT_\TpiP = \setbd{\tpTt \cup \spe^\tpIp(\xx) \cup  \spe^\tpIpp(\yy)}{\tpIp,\tpIpp \in \TpiP}.\]Then $(\TpiP_\TpiP,\TpiT_\TpiP)$ is a type instance for $\ClSig\SigSp\sms$. Notethat the size of $(\TpiP_\TpiP,\TpiT_\TpiP)$ is polynomially bounded by the sizeof $\Tpi\TpiP\TpiT$.\end{definition}\begin{remark}Let $\StrA$ be a full model for the type instance $\Tpi\TpiP\TpiT$ over$\ClSig\SigS\sms$.Then there exists a$\ClSig\SigSp\sms$-type instance $(\TpiP',\TpiT')$ such that $\TpiP$ ``iscontained in'' $\TpiP'$, $\TpiP' \subseteq \TpiP_\TpiP$, $\TpiT' \subseteq\TpiT_\TpiT$ and a $\SigSp$-enrichment $\StrAp$ of $\StrA$ such that $\StrAp$ is a noblydistinguished full model of $(\TpiP',\TpiT')$.The set of $1$-types $\TpiP$ ``is contained in'' $\TpiP'$ if for every $\tpIp'\in \TpiP$ there is some $\tpIp \in \TpiP$ such $\tpIp_\tpIp' \in \TpiP'$.\end{remark}\begin{proof}TODO SKETCH:Let $\relE = \at\StrA\se$.Recall that for every noble $\tpIn \in \Nu \subseteq \TpiP$, $\eclX_\tpIn \in\Ecl\relE$ is the unique $\relE$-class containing a (not necessarly unique)element $\ec \in \eclX$ realizing $\tpIn$. For every $\relE$-class $\eclX$ thatcontains some noble element, arbitrary choose one noble type $\tpIn$ realized byit: $\eclX = \eclX_\tpIn$. For every other $\relE$-class $\eclY$ that containsno noble element, arbitrary choose one $1$-type $\tpIp$ realized in it.Define the enrichment $\StrAp$ as follows: for every $\ea \in \domA$, if $\ea\in \eclX_\tpIn$ is an element of an $\relE$-class containing a noble element,let $\tpIa\StrAp\ea = \tpIa\StrA\ea_\tpIn$. Otherwise $\ea \in \eclY$, where$\eclY$ is an $\relE$-class containing no noble elements; let $\tpIp$ be thechosen $1$-type realized in $\eclY$ and let $\tpIa\StrAp\ea =\tpIa\StrA\ea_\tpIp$. The characteristic type instance $(\TpiP',\TpiT')$ for$\StrAp$ satisfies the conditions of this remark.\end{proof}TODO: In nondeterministic polynomial time we may reduce the (full) (finite) typesatisfiability problem to the (full) (finite) type satisfiability problem overthe class of nobly distinguished structures. That is, the nobly distinguishedstructures form a nondeterministic polynomial time reduction class for (full)(finite) satisfiability.\begin{definition}A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is anonempty set of locally consistent cosmic spectrums satisfying the followingconditions:\begin{enumerate}  \item\label{cond:cert-many-1} If $\tpIp \in \TpiP$, then some (possibly many)  $\stps \in \Cert$ have $\tpIp \in (\xtp \restriction \stps)$.  \item\label{cond:cert-many-2} If $\tpIn \in \TpiP$ is noble, then only one  $\stps \in \Cert$ has $\tpIn \in (\xtp \restriction \stps)$. Note that the  existence is already implied by Condition~\ref{cond:cert-many-1}.  \item\label{cond:cert-many-3} If $\tpTt \in \cup\Cert$, then $\inv\tpTt \in  \cup\Cert$.  \item\label{cond:cert-many-4} (If $\stps\in\Cert$ is noble, then for every  $\tpTt \in \stps$ there is another $\stps'\in\Cert, \stps' \neq \stps$ such  that $\tpTt \in \stps'$.) TODO: we don't need this for nobly distinguished  structures!\end{enumerate}\end{definition}Again, a note that a certificate may have size that is exponential with respectto the size of the underlying type instance. However, polynomial certificatesexist:\begin{lemma}[Certificate extraction] Let $\StrA$ be a full model for the typeinstance $\Tpi\TpiP\TpiT$ and suppose that $\relE = \at\StrA\se$ is not the fullrelation on $\domA$. Recall that the cardinality of $\StrA$ is at least $2$.Let $\TpiTp \subseteq (\TpiT \cap \TpTc\SigS)$ be the set of cosmic $2$-typesfrom the type instance that are realized in $\StrA$. For every cosmic $2$-type$\tpTt \in \TpiTp$ consider two distinct elements $\ea_\tpTt \neq \eb_\tpTt \in\domA$ realizing $\tpTt$: $\tpIab\StrA{\ea_\tpTt}{\eb_\tpTt} = \tpTt$.Let\[  \Cert = \setbd{\cspIX\StrA{\relE[\ea_\tpTt]}}{\tpTt \in \TpiTp} \cup  \setbd{\cspIX\StrA{\relE[\eb_\tpTt]}}{\tpTt \in \TpiTp}.\]Then $\Cert$ is a certificate for the type instance. Moreover, its size islinearly bounded by $\card{\TpiT}$, hence also by the size of the type instance.\end{lemma}\begin{proof}By~\Cref{rem:csp-is-locally-consistent}, all elements $\stps \in \Cert$ arelocally consistent cosmic spectrums. We check the conditions for a certificate:\begin{enumerate}  \item If $\tpIp \in \TpiP$, since $\StrA$ is a full model for  $\Tpi\TpiP\TpiT$, there is some $\ea \in \domA$ such that $\tpIa\StrA\ea =  \tpIp$. Since $\relE$ is not the full relation on $\domA$, there is some $\eb  \in \domA \sub \relE[\ea]$ and so $\tpTt = \tpIab\StrA\ea\eb \in \TpiTp$, such  that $\tpIp = \xtp\tpTt$ and $\tpTt \in \cspIX\StrA{\relE[\ea_\tpTt]}$.  \item Let $\tpIn \in \TpiP$ be noble. Then all elements $\ea \in \domA$  realizing $\tpIn$ are in the same $\relE$-class: for every $\tpTt \in (\TpiT  \cup \TpTc\SigS)$ such that $\xtp\tpTt = \tpIn$, we have $\relE[\ea_\tpTt] =  \eclX$.  \item That $\tpTt \in \cup\Cert$ implies $\inv\tpTt \in \cup\Cert$ follows  immediately from the definition of $\Cert$.  \item Let $\stps \in \Cert$ be noble and let $\tpTt \in \stps$ be any cosmic  $2$-type. Then $\stps = \cspIX\StrA\eclX$ for some unique $\eclX \in  \Ecl\relE$ and $\tpTt = \tpIab\StrA{\ea_\tpTt}{\eb_\tpTt}$. If $\ea_\tpTt \in \eclX$, since  $\tpTt$ is cosmic, we must have that $\eb_\tpTt \not\in \eclX$, so  $\stps' = \cspIX\StrA{\relE[\eb_\tpTt]} \neq \stps$ is appropriate.  \item TODO: If $\ea_\tpTt \not\in \eclX$, this breaks! Need to define  certificate more precisely! For this we may define a weak form of  differentiation! In nobly distinguished structures this must work!\end{enumerate}\end{proof}\section{NOTES}TODO: Certificate extraction: for every cosmic $2$-type $\tpTt$ realized in$\StrA$, let $\ea_\tpTt, \eb_\tpTt$ be a pair of distinct elements (and indistinct $\se$-classes, since $\tpTt$ is cosmic) realizing it. Take:\[  \Cert = \setbd{\cspIX\StrA{E[\ea_\tpTt]}, \cspIX\StrA{E[\eb_\tpTt]}}{\tpTt  \dots}\]