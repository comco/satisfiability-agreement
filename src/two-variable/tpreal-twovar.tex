% Type realizibility of the two-variable first-order logic
Recall from~\Cref{sec:scott-nf} about normal forms that every $\vFo2$-sentence
$\fphi$ can be reduced in deterministic polynomial time to a sentence
$\sctr\fphi$ in Scott normal form:
\[
  \forall\xx\forall\yy (\falpp0(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy(
  \falpp\ii(\xx,\yy) \land \xx \neq \yy),
\]
where $\nm \geq 1$, all the formulas $\falpp\ii$ are quantifier-free and use at
most linearly many new unary predicate symbols.
The semantical connection between $\fphi$ and $\sctr\fphi$ is that they are
essentially equisatisfiable. More precisely, every model of $\fphi$ of
cardinality at least $2$ can be enriched to a model for $\sctr\fphi$ and also
every model of $\sctr\fphi$ (which by $\nm \geq 1$ must have cardinality at
least $2$) is a model for $\fphi$.
We refer to $\falpp0$ as the \emph{universal part}, or the
$\forall\forall$-part of the formula $\sctr\fphi$ and to $\falpp\ii$ as the \emph{existential parts}, or the $\forall\exists$-parts of the formula,
for $\ii \in [1,\nm]$.
\subsection{Classified signatures}
For any formula $\sctr\fphi$ in Scott normal form, we may replace its
existential parts by fresh binary predicate symbols: for $\ii \in [1,\nm]$, let $\smm\ii$ be a fresh binary predicate symbol with the intended interpretation $\forall\xx\forall\yy (\smm\ii(\xx,\yy) \lequ \falpp\ii(\xx,\yy))$.
Since this is a universal sentence, it can be incorporated into the
$\forall\forall$-part $\falpp0$ of the formula.
We refer to the symbols $\gls{message-symbol-m-i}$ as the \emph{message
symbols}.
Hence $\sctr\fphi$ can be transformed in deterministic polynomial time to the
form:
\begin{equation}\label{eq:twovar-msg-nf}
  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy
  (\smm\ii(\xx,\yy) \land \xx \neq \yy),
\end{equation}
where the $\forall\forall$-part $\falp$ is quantifier-free and over an extended
signature. For convenience, we make the existential parts of the formula part of
the signature, so we can focus only on the universal part. The following is a
term similar to the one defined in~\cite{MALQ:MALQ201400102}:
\begin{definition}
A \emph{classified signature} $\gls{classified-signature-S-m}$ for the
two-variable first-order logic $\vFo2$ is a predicate signature $\SigS$ together
with a nonempty sequence $\sms = \smm1\smm2\dots\smm\nm$ of distinct binary
predicate symbols from $\SigS$ having intended interpretation
\begin{equation}\label{eq:twovar-ms-iinter}
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy 
  (\smm\ii(\xx,\yy) \land \xx \neq \yy).
\end{equation}
\end{definition}
That is, a classified signature \emph{automatically includes} the
$\forall\exists$-parts of formulas and $\ClSig\SigS\sms$-structures
\emph{automatically satisfy} the $\forall\exists$-parts:
\begin{definition}
A structure $\StrA$ for the classified signature $\ClSig\SigS\sms$ is a
structure for the predicate signature $\SigS$ that satisfies the intended
interpretation~\cref{eq:twovar-ms-iinter} of the message symbols. Note that
$\StrA$ must have cardinality at least $2$.
\end{definition}

\begin{definition}\label{def:clsig-twovar}
The \emph{(finite) classified satisfiability problem for two-variable
first-order logic} is:
given a classified signature $\ClSig\SigS\sms$ and a quantifier-free
$\vFoF2\SigS$-formula $\falp(\xx,\yy)$, is there a (finite)
$\ClSig\SigS\sms$-structure $\StrA$ satisfying~\cref{eq:twovar-msg-nf}.
Note that since $\StrA$ is a $\ClSig\SigS\sms$-structure, it must also
satisfy~\cref{eq:twovar-ms-iinter} and must have cardinality at least $2$.
Denote the classified satisfiability problem by $\ClSat{\vFo2}$ and its finite
version by $\FinClSat{\vFo2}$.
\end{definition}

\begin{remark}
The problem of (finite) satisfiability reduces in nondeterministic polynomial
time to the problem of (finite) classified satisfiability:
\[
  \FinASat{\vFo2} \red\cNP \FinAClSat{\vFo2}.
\]
\end{remark}
\begin{proof}

Note that (finite) satisfiability in the class of models of cardinality $1$ is
trivially decidable in nondeterministic polynomial time --- just guess the
atomic $1$-type (whose size is polynomially bounded by the size of the
predicate signature) of the unique element of the structure and check (in
deterministic polynomial time) that it satisfies the original formula.

Scott normal form shows that (finite) satisfiability in the class of models of
cardinality at least $2$ reduces in deterministic polynomial time to (finite)
classified satisfiability.
Hence the following nondeterministic polynomial time procedure reduces an
instance $(\SigS, \fphi)$ of the (finite) satisfiability problem to an instance
$(\ClSig\SigSp\sms, \falp)$ of the (finite) classified satisfiability problem:
First check if $\fphi$ is satisfiable in the class of models of cardinality $1$.
If that is the case, then extend $\SigS$ to $\SigSp$ by adding a single message
symbol $\smm1$ and let $\falp = (\xx = \xx)$ be a fixed predicate tautology.
Otherwise transform $\fphi$ into Scott normal form and let $\falp$ be the
universal part of that normal form.
\end{proof}

\subsection{Type instances}
\begin{definition}\label{def:tpinst-twovar}
A \emph{type instance} $\Tpi\TpiP\TpiT$ over the classified signature
$\ClSig\SigS\sms$ is a pair of a nonempty set of $1$-types
$\TpiP\subseteq\TpI\SigS$ and a nonempty set of $2$-types $\TpiT\subseteq\TpT\SigS$ satisfying the following conditions:
\begin{itemize}
  \item[\condtpii]
  The set of $2$-types $\TpiT$ is closed under inversion, that is
  $\inv\tpTt\in\TpiT$ for every $\tpTt\in\TpiT$.
  \item[\condtpic]
  Every $2$-type $\tpTt\in\TpiT$ connects $1$-types
  from $\TpiP$, that is $\xtp\tpTt\in\TpiP$ and $\ytp\tpTt\in\TpiP$ for every
  $\tpTt\in\TpiT$.
  Equivalently, since $\TpiT$ is closed under inversion,
  we require that $(\xtp\restriction\TpiT)\subseteq\TpiP$.
\end{itemize}
Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{connectable} 
(written $\gls{connectable-p-pp}$),
if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some $\tpTt \in \TpiT$.
Connectability is symmetric since $\TpiT$ is closed under inversion.
However, connectability is not necessarily neither transitive nor reflexive:
A $1$-type $\tpIk \in \TpiP$ is a \emph{king type} if 
$\tpIk \not\conn\TpiT\tpIk$. 
The set of king types is $\TKgi\TpiP\TpiT$.
A $1$-type $\tpIp \in \TpiP$ that is not a king type is a \emph{worker type}
and the set of worker types is $\TWki\TpiP\TpiT = \TpiP \sub
\TKg(\TpiP,\TpiT)$.
\end{definition}
\begin{remark}\label{rem:tpi-sub}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let
$\TpiTp \subseteq \TpiT$ be a nonempty subset of $2$-types that is closed 
under inversion. Then $\Tpi\TpiP\TpiTp$ is also a type instance over
$\ClSig\SigS\sms$ and $\TKgi\TpiP\TpiT \subseteq \TKgi\TpiP\TpiTp$ and
$\TWki\TpiP\TpiTp \subseteq \TWki\TpiP\TpiT$.
\end{remark}

\begin{definition}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let
$\StrA$ be a $\ClSig\SigS\sms$-structure.
Then $\StrA$ \emph{realizes} (or is a model of) the type instance
$\Tpi\TpiP\TpiT$ if the following conditions are satisfied:
\begin{itemize}
  \item[\condrealizI]\label{cond:realizI}
  $\tpIa\StrA\ea \in \TpiP$ for every $\ea\in\domA$, that is the $1$-types
  realized in $\StrA$ are from $\TpiP$.
  \item[\condrealizII]\label{cond:realizII}
  $\tpIab\StrA\ea\eb \in \TpiT$ for every $\ea\in\domA$
  and $\eb \in \domA\sub\set{\ea}$, that is the $2$-types realized in $\StrA$
  are from $\TpiT$.
  \item[\condrealizp]\label{cond:realizp}
  If $\tpIp \in \TpiP$ then some (possibly many) $\ea \in \domA$ realizes it.
  We don't require an analogous condition for $2$-types.
  \item[\condrealizk]\label{cond:realizk}
  If $\tpIp \in \TpiP$ is realized by a unique element $\ea \in \domA$, then
  $\tpIp \in \TKgi\TpiP\TpiT$ is a king type.
\end{itemize}
\end{definition}
\begin{remark}\label{rem:tpi-char}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ and let $\StrA$
be a model for $\Tpi\TpiP\TpiT$.
Then $\TpiP$ is the set of $1$-types that are realized by some (possibly many)
element in $\StrA$,
$\TKgi\TpiP\TpiT$ is the set of $1$-types that are realized by a unique element
in $\StrA$ and 
$\TWki\TpiP\TpiT$ is the set of $1$-types that are realized by at least $2$
elements in $\StrA$.
A \emph{king} is an element that realizes a king type.
A \emph{worker} is an element that realizes a worker type.
\end{remark}
\begin{proof}
By Condition~\refcondrealizI and Condition~\refcondrealizp, $\TpiP$ is the set
of $1$-types that are realized by some element in $\StrA$.
By Condition~\refcondrealizk any $1$-type that is realized by a unique element
is a king type. Let $\tpIk$ be a king type. By Condition~\refcondrealizp there
is some $\ea \in \domA$ that realizes $\tpIk$. Suppose towards a contradiction
that some other $\eb \in \domA \sub \set\ea$ also realizes $\tpIk$. Then the
$2$-type $\tpTt = \tpIab\StrA\ea\eb$ connects $\tpIk$ with itself.
By Condition~\refcondrealizII we have that $\tpTt \in \TpiT$, hence $\tpIk
\conn\TpiT \tpIk$ --- a contradiction. Therefore $\TKgi\TpiP\TpiT$ is the set of
$1$-types that are realized by a unique element in $\StrA$, and so
$\TWki\TpiP\TpiT = \TpiP \sub \TKgi\TpiP\TpiT$ is the set of $1$-types that are
realized by at least $2$ elements in $\StrA$.
\end{proof}

\begin{remark}\label{rem:tpi-sub-ex}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$ 
and let $\TpiTp \subseteq \TpiT$ be a nonempty subset of $2$-types that is
closed under inversion.
Note that $\TKgi\TpiP\TpiT \subseteq \TKgi\TpiP\TpiTp$ according
to~\Cref{rem:tpi-sub}.
Suppose that $\TKgi\TpiP\TpiTp \subseteq \TKgi\TpiP\TpiT$, or equivalently that
$\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$.
Then any model $\StrAp$ for $\Tpi\TpiP\TpiTp$ is also a model for $\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
We verify the conditions for $\StrAp$ to be a model for the type instance
$\Tpi\TpiP\TpiT$:
\begin{itemize}
  \item[\refcondrealizI] follows from Condition~\refcondrealizI for the
  $\Tpi\TpiP\TpiTp$-model $\StrAp$.
  \item[\refcondrealizII] follows from Condition~\refcondrealizII for the
  $\Tpi\TpiP\TpiTp$-model $\StrAp$.
  \item[\refcondrealizp] follows from Condition~\refcondrealizp for the
  $\Tpi\TpiP\TpiTp$-model $\StrAp$.
  \item[\refcondrealizk] follows from Condition~\refcondrealizk for the
  $\Tpi\TpiP\TpiTp$-model $\StrAp$ together with the assumption
  $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$.
\end{itemize}
\end{proof}


\begin{definition}
Let $\StrA$ be a $\ClSig\SigS\sms$-structure.
\emph{The type instance} $\TpiP\TpiT[\StrA] = \Tpi\TpiP\TpiT$ of $\StrA$ is
defined by:
\begin{align*}
  \TpiP &= \setbd{\tpIa\StrA\ea}{\ea \in \domA} \\
  \TpiT &= \setbd{\tpIab\StrA\ea\eb}{\ea \in \domA, \eb \in \domA \sub \set\ea}.
\end{align*}
That is, $\TpiP$ is the set of $1$-types realized in $\StrA$ and $\TpiT$ is the
set of $2$-types realized in $\StrA$.
\end{definition}
\begin{remark}\label{rem:tpi-str}
Then $\TpiP\TpiT[\StrA] = \Tpi\TpiP\TpiT$ is indeed a type instance over
$\ClSig\SigS\sms$ and $\StrA$ is a model for $\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof} 
That $\TpiP$ and $\TpiT$ are nonempty follows from the observation that the
cardinality of $\StrA$ is at least $2$.
First we verify the conditions for $\Tpi\TpiP\TpiT$ to be a type instance over
$\ClSig\SigS\sms$.
\begin{itemize}
  \item[\refcondtpii]
  If $\tpTt \in \TpiT$, then $\tpTt = \tpIab\StrA\ea\eb$ for
  some $\ea \neq \eb \in \domA$, hence $\inv\tpTt = \tpIab\StrA\eb\ea \in
  \TpiT$, so $\TpiT$ is closed under inversion.
  \item[\refcondtpic]
  If $\tpTt \in \TpiT$, then $\tpTt = \tpIab\StrA\ea\eb$, hence
  $\xtp\tpTt = \tpIa\StrA\ea \in \TpiP$, so $(\xtp\restriction\TpiT) \subseteq
  \TpiP$.
\end{itemize}
Next we verify the conditions for $\StrA$ to be a model for the type instance
$\Tpi\TpiP\TpiT$.
\begin{itemize}
  \item[\refcondrealizI] follows by definition of $\TpiP$.
  \item[\refcondrealizII] follows by definition of $\TpiT$.
  \item[\refcondrealizp] follows by definition of $\TpiP$.
  \item[\refcondrealizk] Let $\tpIp \in \TpiP$ be realized by a a unique element
  $\ea \in \domA$. Then there is no $\eb \in \domA \sub \set\ea$ such that
  $\tpIa\StrA\eb = \tpIp$, so no $\tpTt \in \TpiT$ connects $\tpIp$ with itself, therefore $\tpIp$ is a king
  type.
\end{itemize}
\end{proof}

\begin{remark}\label{rem:tpi-str-ex}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, 
let $\StrA$ be a model for $\Tpi\TpiP\TpiT$
and let $\Tpi\TpiPp\TpiTp =\TpiP\TpiT[\StrA]$ be the type instance of $\StrA$.
Then $\TpiPp = \TpiP$, $\TpiTp \subseteq \TpiT$ and $\TKgi\TpiP\TpiTp =
\TKgi\TpiP\TpiT$.
\end{remark}
\begin{proof}
Immediate by~\Cref{rem:tpi-char}.
\end{proof}
\begin{remark}\label{rem:tpi-str-inv}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,
let $\StrA$ be a model for $\Tpi\TpiP\TpiT$
and let $\StrB$ be a $\SigS$-structure.
If $\TpiP\TpiT[\StrB] = \TpiP\TpiT[\StrA]$ then $\StrB$ is also a model for
$\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
By~\Cref{rem:tpi-str-ex} we have $\TpiP\TpiT[\StrA] = \TpiP\TpiT[\StrB] =
\Tpi\TpiP\TpiTp$ where $\TpiTp \subseteq \TpiT$ and $\TKgi\TpiP\TpiTp =
\TKgi\TpiP\TpiT$. Then by~\Cref{rem:tpi-sub-ex} any model for $\Tpi\TpiP\TpiTp$
is also a model for $\Tpi\TpiT\TpiT$.
\end{proof}
% Structure:
% 1. type instance + connectability
% 2. tpi-sub: inexact
% 3. model
% 4. tpi-char: exact
% 5. tpi-sub-ex
% 6. tpi-str
% 7. tpi-str-ex
% 8. tpi-inv
\subsection{Type realizability}
\begin{definition}
The \emph{(finite) type realizability problem} is the following:
given a classified signature $\ClSig\SigS\sms$ and a type instance
$\Tpi\TpiP\TpiT$ over $\SigS$, is there a (finite)
$\ClSig\SigS\sms$-structure that realizes $\Tpi\TpiP\TpiT$.
Denote the type realizability problem for $\vFo2$ by
$\Real{\vFo2}$ and its finite version by $\FinReal{\vFo2}$.
\end{definition}

We begin the study of the type realizability problem by reducing the
classified satisfiability problem to it.

\begin{remark}\label{rem:red-sat-to-real}
Let $\ClSig\SigS\sms$ be a classified signature and let $\falp(\xx,\yy)$ be a
quantifier-free $\vFoF2\SigS$-formula.
Define the following sets of types:
\begin{itemize}
  \item $\TpiP^\falp \subseteq \TpI\SigS$ is the set of those $1$-types
  consistent with $\falp(\xx,\yy)$ and the intended
  interpretation~\cref{eq:twovar-ms-iinter}.
  \item $\TpiT^\falp \subseteq \TpT\SigS$ is the set of those $2$-types $\tpTt$
  such that both $\tpTt$ and $\inv\tpTt$ are consistent with $\falp(\xx,\yy)$
  and the intended interpretation~\cref{eq:twovar-ms-iinter}.
\end{itemize}
Then a $\ClSig\SigS\sms$-structure $\StrA$ is a classified model for
$\falp(\xx,\yy)$ iff there are some subsets $\TpiP \subseteq \TpiP^\falp$ and
$\TpiT \subseteq \TpiT^\falp$ such that $\Tpi\TpiP\TpiT$ is a type instance
over $\SigS$ and $\StrA$ realizes $\Tpi\TpiP\TpiT$.
% TODO: Prove this!

Recall that the number of possible $1$-types or $2$-types over $\SigS$ is
exponentially bounded by the length $\sizes$ of $\SigS$ and that the cardinality
of a $1$-type or a $2$-type over $\SigS$ is polynomially bounded by $\sizes$.
Hence we can reduce the (finite) classified satisfiability problem to the
(finite) type realizability problem in nondeterministic exponential time:
\[
  \FinAClSat{\vFo2} \red\cNExpTime \FinAReal{\vFo2}.
\]
\end{remark}

\begin{definition}
We say that $\Tpi\TpiT\TpiP$ is a type instance over \emph{the classified
signature} $\ClSig\SigS\sms$ if $\Tpi\TpiT\TpiP$ is a type instance over $\SigS$
and with the implicit requirement that we are interested only in models of
$\Tpi\TpiT\TpiP$ that are $\ClSig\SigS\sms$-structures, that is the intended
interpretation of a type instance over a classified signature is the class of
classified structures. Note that this is exactly the content of the type
realizability problem.
\end{definition}

The next definition characterizes the $2$-types emitted by an element in a model
of a type instance.
\begin{definition}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.
A \emph{star-type} $\stps \subseteq \TpiT$ over $\Tpi\TpiP\TpiT$ is a nonempty
set of $2$-types satisfying the following conditions:
\begin{itemize}
  \item[\condstpx]\label{cond:stpx}
  If $\tpTt, \tpTtp \in \stps$, then $\xtp\tpTt = \xtp\tpTtp$, that is the
  $\xx$-type of every element of $\stps$ is the same.

  Denote the $\xx$-type of any element of $\stps$ by $\tpIp = \xtp\stps$.
  \item[\condstpkx]\label{cond:stpkx}
  If $\tpIp = \tpIk \in \TKgi\TpiP\TpiT$ is a king type, then no
  $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item[\condstpky]\label{cond:stpky}
  If $\tpIk \in \TKgi\TpiP\TpiT \sub \set{\tpIp}$ is any king type distinct
  from $\tpIp$ (note that $\tpIp$ may possibly be a worker type), then
  a unique $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item[\condstpm]\label{cond:stpm} If $\sm \in \sms$, then $\sm(\xx,\yy)
  \in \tpTt$ for some (possibly many) $\tpTt \in \stps$.
\end{itemize}
A star-type $\stps$ is a \emph{king star-type} if $\xtp\stps \in
\TKgi\TpiP\TpiT$ is a king type. 
Otherwise the star-type $\stps$ is called a \emph{worker star-type}.
Note that the size of a star-type is polynomially bounded by the size of the
type instance.
\end{definition}

\begin{definition}\label{def:stp-str}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$
and let $\StrA$ be a model for $\Tpi\TpiP\TpiT$.
If $\ea \in \domA$, \emph{the star-type} $\stps = \stpIa\StrA\ea$ of $\ea$ is
defined by:
\[
  \stpIa\StrA\ea = \setbd{\tpIab\StrA\ea\eb}{\eb \in \domA \sub \set{\ea}}.
\]
\end{definition}
\begin{remark}\label{rem:stp-str}
Then $\stps$ is indeed a star-type over $\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
That $\stps$ is nonempty follows from the observation that $\StrA$ as a
$\ClSig\SigS\sms$-structure must have cardinality at least $2$.
We verify the conditions for a star-type:
\begin{itemize}
  \item[\refcondstpx]
  Let $\tpTt,\tpTtp \in \stps$. 
  Then $\tpTt = \tpIab\StrA\ea\eb$ and $\tpTtp = \tpIab\StrA\ea\ec$ for some
  $\eb,\ec \in \domA \sub \set{\ea}$, so $\xtp\tpTt = \tpIa\StrA\ea =
  \xtp\tpTtp$.
\end{itemize}
  Let $\tpIp = \xtp\stps = \tpIa\StrA\ea$.
\begin{itemize}[resume]
  \item[\refcondstpkx]
  Suppose that $\tpIp = \tpIk \in \TKgi\TpiP\TpiT$ is a king type,
  so $\tpIk \not\conn\TpiT \tpIk$. Since $\stps \subseteq \TpiT$ and every
  $\tpTt \in \stps$ has $\xtp\tpTt = \tpIk$, we must have that no 
  $\tpTt \in \stps$ has $\ytp\tpTt = \tpIk$.
  \item[\refcondstpky]
  Let $\tpIk \in \TKgi\TpiP\TpiT \sub \set{\tpIp}$. By
  Condition~\refcondrealizk for $\StrA$, there is a unique $\eb \in \domA$
  realizing $\tpIk$. Since $\tpIk \neq \tpIp$, we have $\eb \neq \ea$.
  Hence $\tpTt = \tpIab\StrA\ea\eb$ is the unique $\tpTt \in \stps$ that has
  $\ytp\tpTt = \tpIk$.
  \item[\refcondstpm]
  Let $\sm \in \sms$. Since $\StrA$ is a $\ClSig\SigS\sms$-structure, it must
  satisfy the intended interpretation~\cref{eq:twovar-ms-iinter}, so in
  particular there is some $\eb \in \domA \sub \set{\ea}$ such that $\tpTt =
  \tpIab\StrA\ea\eb$ has $\sm(\xx,\yy) \in \tpTt$.
\end{itemize}
\end{proof}
\begin{remark}\label{rem:stp-sub}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$. Let $\TpiTp
\subseteq \TpiT$ be a nonempty subset that is closed under inversion. According
to~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is a type instance over
$\ClSig\SigS\sms$. Suppose that $\TKgi\TpiP\TpiT = \TKgi\TpiP\TpiTp$.

Then if $\stps \subseteq \TpiTp$ is a star-type over $\Tpi\TpiP\TpiT$, then it
is also a star-type over $\Tpi\TpiP\TpiTp$.
\end{remark}
\begin{proof}
We verify the conditions for a star-type over $\Tpi\TpiP\TpiTp$:
\begin{itemize}
  \item[\refcondstpx]
  follows from Condition~\refcondstpx for the star-type $\stps$ over
  $\Tpi\TpiP\TpiT$.
  \item[\refcondstpkx]
  follows from Condition~\refcondstpkx for the star-type $\stps$ over
  $\Tpi\TpiP\TpiT$ together with the assumption $\TKgi\TpiP\TpiT =
  \TKgi\TpiP\TpiTp$.
  \item[\refcondstpky]
  follows from Condition~\refcondstpky for the star-type $\stps$ over
  $\Tpi\TpiP\TpiT$ together with the assumption $\TKgi\TpiP\TpiT =
  \TKgi\TpiP\TpiTp$.
  \item[\refcondstpm]
  follows from Condition~\refcondstpm for the star-type $\stps$ over
  $\Tpi\TpiP\TpiT$.
\end{itemize}
\end{proof}

\begin{remark}[Star-type extension]\label{rem:star-type-ext}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,
let $\stps$ be a star-type over $\Tpi\TpiP\TpiT$ and let $\tpIp = \xtp\stps$.
Let $\tpTt \in \TpiT$ be a $2$-type such that $\xtp\tpTt = \tpIp$ and
$\ytp\tpTt$ is not a king type.
Then $\stpsp = \stps \cup \set{\tpTt}$ is also a star-type over
$\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
It is straightforward to verify the conditions for a star-type:
\begin{itemize}
  \item[\refcondstpx] follows from the assumption that $\xtp\tpIp = \xtp\stps$.
  \item[\refcondstpkx] follows from the assumption that $\ytp\tpIp$ is not a
  king type.
  \item[\refcondstpky] follows from the assumption that $\ytp\tpIp$ is not a
  king type.
  \item[\refcondstpm] follows since $\stpsp$ extends $\stps$.
\end{itemize}
\end{proof}

\begin{definition}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.
A \emph{certificate} $\Cert$ for the type instance
$\Tpi\TpiP\TpiT$ is a nonempty set of star-types over $\Tpi\TpiP\TpiT$
satisfying the following conditions:
\begin{itemize}
  \item[\condcerti]\label{cond:certi}
  If $\tpTt\in\stps$ for some $\stps\in\Cert$, then $\inv\tpTt\in\stps'$ for
  some $\stps'\in\Cert$, that is there are star-types for the endpoints of every
  $2$-type used in the certificate. Equivalently, $\TpiTp = \cup\Cert$ is closed
  under inversion.
  Note that by~\Cref{rem:tpi-sub}, $\Tpi\TpiP\TpiTp$ is also a type instance
  over $\SigS$. Call $\Tpi\TpiP\TpiTp$ the \emph{filtered type instance} of
  $\Cert$.
  \item[\condcertK]\label{cond:certK}
  We require that $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$, that is the notion of a
  king type with respect to the filtered type instance coincides with the notion
  of a king type with respect to the original type instance.
  Note that then by~\Cref{rem:stp-sub}, we may think of $\Tpi\TpiP\TpiTp$ as a
  type instance over $\ClSig\SigS\sms$ and also that every star-type
  $\stps \in \Cert$ is a also a star-type over $\Tpi\TpiP\TpiTp$. 
  
  
  \item[\condcertp]\label{cond:certp}
  If $\tpIp \in \TpiP$, then some (possibly many) $\stps \in \Cert$ has
  $\xtp\stps = \tpIp$, that is there is a star-type for every $1$-type.
  \item[\condcertk]\label{cond:certk}
  If $\tpIk \in \TKgi\TpiP\TpiT$, then a unique $\stps \in \Cert$ has
  $\xtp\stps = \tpIk$, that is there is a unique star-type for every king-type.
  Note that the existence is already implied by Condition~\refcondcertp.
  \item[\condcertc]\label{cond:certc}
  Let $\tpIp, \tpIpp \in \TpiP$. If it is not the case that $\tpIp =
  \tpIpp = \tpIk \in \TKgi\TpiP\TpiT$, then some $\tpTt \in \TpiTp$ has
  $\xtp\tpTt = \tpIp$ and $\ytp\tpTt = \tpIpp$, that is if $\tpIp$ and $\tpIpp$
  are not the same king type, then they are connectable.
\end{itemize}
\end{definition}

\begin{remark}\label{rem:filtered-realiz}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,
let $\Cert$ be a certificate for $\Tpi\TpiP\TpiT$ and let $\TpiTp = \cup\Cert$.
If a structure $\StrA$ realizes the filtered type instance $\Tpi\TpiP\TpiTp$,
then it realizes $\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
Follows from~\Cref{rem:tpi-str-ext}.
\end{proof}

Note that in general the size of a certificate may be exponential in
the size of the type instance. However, polynomial certificates exist:
\begin{lemma}[Certificate extraction]\label{lem:cert-extract}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$,
let $\StrA$ be a model for $\Tpi\TpiP\TpiT$ and let 
$\Tpi\TpiP\TpiTp = \TpiP\TpiT[\StrA]$, $\TpiTp \subseteq \TpiT$ according
to~\Cref{rem:str-tpi-kings-eq} be the type instance of $\StrA$.
For every $2$-type $\tpTt \in \TpiTp$,
let $\eat\tpTt \neq \ebt\tpTt \in \domA$ be two distinct elements realizing
$\tpTt$: $\tpIab\StrA{\eat\tpTt}{\ebt\tpTt} = \tpTt$. The choice of the
elements is made symmetrically, that is $\eat{\inv\tpTt} = \ebt\tpTt$ and
$\ebt{\inv\tpTt} = \eat\tpTt$ for every $\tpTt\in\TpiTp$.
Let 
\[
  \Cert = \setbd{\stpIa\StrA{\eat\tpTt}}{\tpTt\in\TpiTp}.
\]
Then $\Cert$ is a certificate for $\Tpi\TpiP\TpiT$. Moreover, its size is
linearly bounded by $\card{\TpiTp}$, hence also by the size of $\Tpi\TpiP\TpiT$.
\end{lemma}
\begin{proof}
That $\Cert$ is nonempty follows from the observation that $\StrA$ must have
cardinality at least $2$. That $\Cert$ is a set of star-types over
$\Tpi\TpiP\TpiT$ follows from~\Cref{rem:stp-str}.
We verify the conditions for a certificate:
\begin{itemize}
  \item[\refcondcerti] 
  That $\cup\Cert = \TpiTp$ is closed under inversion follows from
  Condition~\refcondtpii for the type instance $\Tpi\TpiP\TpiTp$.
  \item[\refcondcertK]
  That $\TKgi\TpiP\TpiTp = \TKgi\TpiP\TpiT$ follows
  from~\Cref{rem:str-tpi-kings-eq}.
  \item[\refcondcertp]
  That every $1$-type $\tpIp \in \TpiP$ has a star-type $\stps \in \Cert$ such
  that $\xtp\stps = \tpIp$ follows from Condition~\refcondrealizp for $\StrA$.
  \item[\refcondcertk]
  That every king-type $\tpIk \in \TKgi\TpiP\TpiT$ has a unique star-type
  $\stps \in \Cert$ such that $\xtp\stps = \tpIk$ follows from
  Condition~\refcondrealizk for $\StrA$.
  \item[\refcondcertc]
  Let $\tpIp, \tpIpp \in \TpiP$ be such that they are not the same king type.
  We will find distinct elements $\ea \neq \eb \in \domA$ such that
  $\tpIa\StrA\ea = \tpIp$ and $\tpIa\StrA\eb = \tpIpp$. Then $\tpTt =
  \tpIab\StrA\ea\eb \in \TpiTp$ will connect $\tpIp$ and $\tpIpp$.
  
  First suppose that $\tpIp$ is a worker type. By
  Conditions~\refcondrealizI and~\refcondrealizk for $\StrA$, we must have that
  $\tpIp$ is realized at least $2$ times in $\StrA$. Let $\ea_1 \neq \ea_2 \in
  \domA$ be two distinct elements realizing $\tpIp$ and let $\eb \in \domA$ be
  an element realizing $\tpIpp$. Then $H = \set{\ea_1,\ea_2} \sub \set{\eb}$ is
  nonempty and let $\ea \in H$. Then $\ea \neq \eb$ and $\tpTt =
  \tpIab\StrA\ea\eb \in \TpiTp$.
  
  Next suppose that $\tpIp \in \TKgi\TpiP\TpiT$ is a king type. Then $\tpIpp
  \neq \tpIp$ by assumption, so for any two elements $\ea, \eb \in \domA$ such
  that $\tpIa\StrA\ea = \tpIp$ and $\tpIa\StrA\eb = \tpIpp$ we have that $\ea
  \neq \eb$, so $\tpTt = \tpIab\StrA\ea\eb \in \TpiTp$ is appropriate.
\end{itemize}
\end{proof}

\begin{lemma}[Certificate expansion]\label{lem:cert-expand}
Let $\Cert$ be a certificate for the type instance $\Tpi\TpiP\TpiT$ over the
classified signature $\ClSig\SigS\sms$.
Then $\Tpi\TpiP\TpiT$ has a finite model.

More precisely, let $\pt \geq \card{\TpiT}$ be a parameter.
TODO: From upstairs!
\end{lemma}
\begin{proof}
We adapt the standard strategy\footnote{with the slight difference that our
approach doesn't need \emph{a court}, since the information about it is implicit
in the certificate} used in the proof of the finite model property for the logic
$\vFo2$, as presented in~\cite{gradel1999logics}.
Let $\TpiTp = \cup\Cert$.
We build a model $\StrA$ for $\Tpi\TpiP\TpiTp$ as follows (clearly, this will
also be a model for .
The domain $\domA$ of $\StrA$ is the union of the following disjoint sets of
elements:
\begin{itemize}
  \item The singleton set $\As\stps = \set{\as\stps}$ for every king
  star-type $\stps\in\Cert$, $\xtp\stps \in \TKgi\TpiP\TpiTp$.
  \item The three disjoint copies of $\pt$ elements
  $\As\stps = \Asi\stps0 \cup \Asi\stps1 \cup \Asi\stps2$ for every
  worker star-type $\stps \in \Cert$, $\xtp\stps \in \TPsi\TpiP\TpiTp$, where
  $\Asi\stps\ii = \set{\asij\stps\ii1, \asij\stps\ii2, \dots, \asij\stps\ii\pt}$
  for $\ii \in \set{0,1,2}$.
\end{itemize}
Let $\itpsOP : \domA \to \Cert$ denote the intended star-type of the elements:
$\itps\ea = \stps$ on $\As\stps$.
Let $\itpiOP : \domA \to \TpiP$ denote the intended $1$-type of the elements:
$\itpi\ea = \xtp(\stps(\ea))$.
We proceed to consistently assign $2$-types to pairs of distinct elements from
the structure on stages.
\begin{description}
  \item[Realization of kings] We first find witnesses for the intended
  star-types of the kings.
  Let $\stps \in \Cert$, $\tpIk = \xtp\stps \in \TKgi\TpiP\TpiTp$
  be a king star-type.
  Consider the unique element $\ea = \ea^\stps$ having intended star-type
  $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\ebt\tpTt$ for the
  assignment $\tpIab\StrA\ea{\ebb\tpTt} = \tpTt$, such that all elements
  $\ebb\tpTt$ are distinct and are distinct from $\ea$ and also $\ytp\tpTt =
  \itpi{\ebt\tpTt}$.
  \begin{enumerate}
  \item If $\ytp\tpTt = \tpIkp \in \TKgi\TpiP\TpiTp$ is a king type,
  by~\refstpcond2 we have $\tpIkp \neq \tpIk$. By~\refcertcond3
  there is a unique star-type $\stpsp$ having $\xtp\stpsp = \tpIkp$ and a unique
  king $\ebt\tpTt = \eat\stpsp \neq \ea$ having intended star-type $\stpsp$.
  Note that this assignment is symmetric, that is at the point of considering
  the type $\inv\tpTt \in \stpsp$ for the king $\ebt\tpTt$, we would choose $\ea$ as
  the opposite side of the assignment: we claim that $\inv\tpTt \in
  \stpsp$ and it is the unique $2$-type from $\stpsp$ having $\ytp{\inv\tpTt}
  = \tpIk$.
  Indeed, $\inv\tpTt \in \TpiTp$, since $\TpiTp$ is closed under inversion;
  By \refstpcond3 we have that there is a unique $\tpTtp \in \stpsp$ connecting
  $\tpIkp$ and $\tpIk$. Since $\stpsp$ is the unique star-type in $\Cert$
  having $\xtp\stpsp = \tpIkp$, we have that $\tpTtp$ is the unique $2$-type
  from $\TpiTp$ connecting $\tpIkp$ and $\tpIk$. Hence we must have $\tpTtp =
  \inv\tpTt$.
  Note that by \refstpcond3 asserting that for the star-type $\stps$ there is a
  unique $2$-type $\tpTt \in \stps$ that connects it to a king type (distinct
  from the origin), we have assigned a $2$-types between every pair of distinct
  kings.
  
  \item If $\ytp\tpTt = \tpIpp \in \TPsi\TpiP\TpiTp$ is a worker type (hence
  $\tpIpp \neq \tpIk$), we simultaneously find distinct elements $\ebt\tpTu$
  for all $2$-types $\tpTu \in \stps$ that are parallel to $\tpTt$.
  Let
  \[
    \TpiU = \setbd{\tpTu \in \stps}{(\tpTu \para \tpTt)} = 
    \setbd{\tpTu\in \stps}{\ytp\tpTu = \tpIpp}
  \] be the set of all such $2$-types $\tpTu$.
  Since $\TpiU \subseteq \stps \subseteq \TpiTp$, there are
  at most $t$ $2$-types $\tpTu$ in $\TpiU$. Since $\TpiTp = \cup\Cert$ and
  $\TpiTp$ is closed under inversion, for every $\tpTu \in \TpiU$
  we can find a star-type $\stpspt\tpTu \in \Cert$ containing its inverse:
  $\inv\tpTu \in \stpspt\tpTu$.
  Since $\xtp\stpspt\tpTu = \xtp{\inv\tpTu} = \tpIpp$ is not a king type, there
  are enough distinct elements $\ebt\tpTu \in \Asi{\stpspt\tpTu}0$ having
  intended star-type $\stpspt\tpTu$. Note that these will be distinct from
  $\ea$, since $\ea$ is a king.
  We assign $\tpIab\StrA\ea{\ebt\tpTu} = \tpTu$ for all $\tpTu \in \TpiU$.
  \end{enumerate}
  \item[Realization of workers] We now find witnesses for the intended
  star-types of the remaining worker elements.
  Let $\stps \in \Cert$ be such that $\tpIp = \xtp\stps \in \TPsi\TpiP\TpiTp$ is
  a worker type. Let $\ea = \asij\stps\ii\jj$, where $\ii \in \set{0,1,2}$ and
  $\jj \in [1,\pt]$ be an arbitrary worker with intended star-type $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\eb_\tpTt$ for the
  assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$, and again we will ensure that
  all $\ebt\tpTt$ are distinct and distinct from $\ea$ and also that $\ytp\tpTt
  = \itpi{\ebt\tpTt}$.
  \begin{enumerate}
    \item If $\ytp\tpTt = \tpIkp$ is a king type then let $\ec$ be the
    element realizing it: $\tpIp(\ec) = \tpIkp$.
    We consider two cases.
    First suppose that $\tpIab\StrA\ec\ea = \tpTu$ has already been assigned
    during the realization of kings.
    By that construction we must have that $\ea = \ebt\tpTu$ and so
    $\stps = \itps\ea = \stpspt\tpTu$, so that $\inv\tpTu \in
    \itps\ea$. Note that $\ytp{\inv\tpTu} = \tpIkp$.
    We claim that $\inv\tpTu = \tpTt$. This is immediate by
    Condition~\refstpcond3, which asserts that there is a unique $2$-type
    $\tpTt \in \stps$ having $\ytp\tpTt = \tpIkp$ --- a king type.
    Hence in this case the needed $2$-types $\tpTt \in \stps$ have already been
    assigned in the opposite direction during the realization of kings.
    
    Next suppose that $\tpIab\StrA\ec\ea$ has not been assigned during the
    realization of kings. Then just assign $\tpIab\StrA\ea\ec = \tpTt$.
    Note that this may extend the actual star-type of the king $\ec$ beyond its
    intended star-type $\itps\ec$ by adding the type $\inv\tpTt$, but
    by~\Cref{rem:star-type-ext}, this extension is still a star-type. That is,
    in the end, the structure may realize \emph{more} than the intended
    star-types, but, importantly, \emph{not less}.
    \item If $\ytp\tpTt = \tpIpp$ is not a king type, we simultaneously find
    distinct workers $\ebt\tpTu$ for all $\tpTu \in \stps$ that are parallel to
    $\tpTt$.
    Let $\TpiU = \setbd{\tpTu \in \stps}{\ytp\tpTu = \tpIpp}$ be the set of
    all such $2$-types $\tpTu$.
    The key to consistency is to use elements from the \emph{next copy} as
    witnesses. Let $\iip = (\ii+1 \bmod 3) \in \set{0,1,2}$. Since $\TpiU
    \subseteq \stps \subseteq \TpiTp$, there are at most $\pt$ $2$-types $\tpTu$ in $\TpiU$. Since $\TpiTp = \cup\Cert$ and $\TpiTp$ is
    closed under inversion, for every $\tpTu \in \TpiU$ we can find a star-type
    $\stpspt\tpTu \in \Cert$ containing its inverse: $\inv\tpTu \in
    \stpspt\tpTu$. Since $\xtp{\stpspt\tpTu} = \xtp{\inv\tpTu} = \tpIpp$ is not
    a king type, there are enough distinct elements $\ebt\tpTu \in
    \Asi{\stpspt\tpTu}\iip$ from the next copy of workers having intended
    star-type $\stpspt\tpTu$. Since these elements are from the next copy, they
    are distinct from $\ea$.
    We assign $\tpIab\StrA\ea{\ebt\tpTu} = \tpTu$ for all $\tpTu \in \TpiU$.
    None of these assignments clash with each other, since they have been made
    between pairs of elements from consecutive copies.
  \end{enumerate}
  \item[Completion] For any pair of distinct elements $\ea, \eb \in \domA$ that
  has not yet been assigned a $2$-type, assign $\tpIab\StrA\ea\eb = \tpTt$ to
  arbitrary $2$-type $\tpTt$ that connects the $1$-types $\tpIp(\ea)$ and
  $\tpIp(\eb)$. This is possible because during realization of kings we have
  assigned a $2$-type between every pair of distinct kings and by~\refcertcond4.
\end{description}
This structure is a $\ClSig\SigS\sms$-structure by~\refstpcond4 and
is a model for $\Tpi\TpiP\TpiT$ by~\refcertcond2.
\end{proof}

\begin{proposition}
The logic $\vFo2$ has the finite model property. The (finite) type realizability
problem for $\vFo2$ is in $\cNP$.
\end{proposition}
\begin{proof}
Let $\Tpi\TpiP\TpiT$ be a type instance for the classified signature
$\ClSig\SigS\sms$. Guess a polynomial certificate for $\Tpi\TpiP\TpiT$.
By~\Cref{lem:cert-extract} and~\Cref{lem:cert-expand}, such a certificate exists
iff $\Tpi\TpiP\TpiT$ is realizable.
The logic has the finite model property since the model constructed
in~\Cref{lem:cert-expand} is finite.
\end{proof}
Recall \Cref{rem:red-sat-to-real}, stating that a structure is a model for a
formula iff it is a model for the type instance consisting of the types
consistent with the formula, so as a corollary we get the standard result:
\begin{corollary}
The logic $\vFo2$ has the finite model property and its (finite) satisfiability
problem is in $\cNExpTime$.
\end{corollary}