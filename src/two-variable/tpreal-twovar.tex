% Type realizibility of the two-variable first-order logic
Recall from~\Cref{sec:scott-nf} about normal forms that every $\vFo2$-sentence
$\fphi$ can be reduced in deterministic polynomial time to a sentence
$\sctr\fphi$ in Scott normal form:
\[
  \forall\xx\forall\yy (\falpp0(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy(
  \falpp\ii(\xx,\yy) \land \xx \neq \yy),
\]
where $\nm \geq 1$, all the formulas $\falpp\ii$ are quantifier-free and use at
most linearly many new unary predicate symbols.
The semantic connection between $\fphi$ and $\sctr\fphi$ is that they are
essentially equisatisfiable. More precisely, every model for $\fphi$ of
cardinality at least $2$ can be enriched to a model for $\sctr\fphi$ and also
every model of $\sctr\fphi$ (which by $\nm \geq 1$ must have cardinality at
least $2$) is a model for $\fphi$.
We refer to $\falpp0$ as the \emph{universal part} of the formula $\sctr\fphi$
and to $\falpp\ii$ for $\ii\in[1,\nm]$ as the \emph{existential parts} of
$\sctr\fphi$.

For any formula $\sctr\fphi$ in Scott normal form, we may replace its
existential parts by fresh binary predicate symbols:
for $\ii \in [1,\nm]$ let $\smm\ii$ be a fresh binary predicate symbol with
intended interpretation
$\forall\xx\forall\yy (\smm\ii(\xx,\yy) \lequ \falpp\ii(\xx,\yy))$.
Since this is a universal sentence, it can be added to the universal part
$\falpp0$.
The symbols $\gls{message-symbol-m-i}$ are the \emph{message symbols}.
Hence $\sctr\fphi$ can be transformed in deterministic polynomial time to the
form:
\begin{equation}\label{eq:twovar-msg-nf}
  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy
  (\smm\ii(\xx,\yy) \land \xx \neq \yy),
\end{equation}
where the universal part $\falp$ is quantifier-free and over an extended
signature.
For convenience, we make the existential parts part of the signature, so we can
focus only on the universal part.
The following term is similar to the one defined in~\cite{MALQ:MALQ201400102}:
\begin{definition}
A \emph{classified signature} $\gls{classified-signature-S-m}$ for the
two-variable first-order logic $\vFo2$ is a predicate signature $\SigS$ together
with a nonempty sequence $\sms = \smm1\smm2\dots\smm\nm$ of distinct binary
predicate symbols from $\SigS$ having intended interpretation
\begin{equation}\label{eq:twovar-ms-iinter}
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy 
  (\smm\ii(\xx,\yy) \land \xx \neq \yy).
\end{equation}
\end{definition}
That is, a classified signature \emph{automatically includes} the
existential parts, so $\ClSig\SigS\sms$-structures \emph{automatically satisfy}
the the existential parts:
\begin{definition}
A structure $\StrA$ for the classified signature $\ClSig\SigS\sms$ is a
structure for the predicate signature $\SigS$ that satisfies the intended
interpretation~\cref{eq:twovar-ms-iinter} of the message symbols.
Note that $\StrA$ must have cardinality at least $2$ by $\nm \geq 1$.
\end{definition}

\begin{definition}\label{def:clsig-twovar}
The \emph{(finite) classified satisfiability problem for two-variable
first-order logic} is:
given a classified signature $\ClSig\SigS\sms$ and a quantifier-free
$\vFoF2\SigS$-formula $\falp(\xx,\yy)$, is there a (finite)
$\ClSig\SigS\sms$-structure $\StrA$ satisfying~\cref{eq:twovar-msg-nf}.
Note that since $\StrA$ is a $\ClSig\SigS\sms$-structure, it must also
satisfy~\cref{eq:twovar-ms-iinter} and must have cardinality at least $2$.
Denote the classified satisfiability problem by $\ClSat{\vFo2}$ and its finite
version by $\FinClSat{\vFo2}$.
\end{definition}

\begin{remark}
The problem of (finite) satisfiability reduces in nondeterministic polynomial
time to the problem of (finite) classified satisfiability:
\[
  \FinASat{\vFo2} \red\cNP \FinAClSat{\vFo2}.
\]
\end{remark}
\begin{proof}

Note that (finite) satisfiability in the class of models of cardinality $1$ is
trivially decidable in nondeterministic polynomial time --- just guess the
atomic $1$-type (whose size is polynomially bounded by the size of the
predicate signature) of the unique element of the structure and check (in
deterministic polynomial time) that it satisfies the original formula.

Scott normal form shows that (finite) satisfiability in the class of models of
cardinality at least $2$ reduces in deterministic polynomial time to (finite)
classified satisfiability.
Hence the following nondeterministic polynomial time procedure reduces an
instance $(\SigS, \fphi)$ of the (finite) satisfiability problem to an instance
$(\ClSig\SigSp\sms, \falp)$ of the (finite) classified satisfiability problem:
First check if $\fphi$ is satisfiable in the class of models of cardinality $1$.
If that is the case, then extend $\SigS$ to $\SigSp$ by adding a single message
symbol $\smm1$ and let $\falp = (\xx = \xx)$ be a fixed predicate tautology.
Otherwise transform $\fphi$ into the form~\cref{eq:twovar-msg-nf} and let
$\falp$ be the universal part of that normal form.
\end{proof}

A \emph{type instance} $\TI \subseteq \TpT\SigS$ over the classified signature
$\ClSig\SigS\sms$ is a nonempty set of \twotypes/ that is closed under
inversion.
The set of \onetypes/ included in the type instance $\TI$ is
$\TP\TI = \setbd{\xtp\tpt}{\tpt\in\TI}$.
Two \onetypes/ $\tpp,\tppp \in \TP\TI$ are \emph{connectable} if some
$\tpTt\in\TI$ connects them.
Connectability is symmetric, however it is not necessarily neither transitive
nor reflexive.
A \onetype/ is a \emph{king type} if it is not connectable with itself;
the set of king types is $\TK\TI$.
A \onetype/ that is not a king type is a \emph{worker type};
the set of worker types is $\TW\TI$.

If $\tpp\in\TP\TI$, the \emph{neighbours} $\nb\TI\tpp\subseteq\TP\TI$ of $\tpp$
are:
\[
  \nb\TI\tpp = \begin{cases}
    \TP\TI &\text{if } \tpp \text{ is a worker type} \\
    \TP\TI \sub \set\tpp &\text{otherwise, that is if } \tpIp \text{ is a king
    type.}
  \end{cases}
\]

If $\StrA$ is a $\ClSig\SigS\sms$-structure, the \emph{type instance} of $\StrA$
is:
\[
  \TIS\StrA = \setbd{\tpIab\StrA\ea\eb}{
    \ea \in \domA, \eb \in \domA \sub\set\ea}.
\]
That is $\TI = \TIS\StrA$ is the set of \twotypes/ realized in $\StrA$.
Note that this is indeed a type instance over $\ClSig\SigS\sms$ since $\StrA$
has cardinality at least $2$ and since it is closed under inversion by
construction.
If $\TI$ is the type instance of $\StrA$, then $\StrA$ is a \emph{model} for
$\TI$.
The element $\ea$ is a \emph{king} if it realizes a king type; otherwise $\ea$
is a \emph{worker}.

\begin{remark}\label{rem:type-char}
Then $\TP\TI = \setbd{\tpIa\StrA\ea}{\ea\in\domA}$ is the set of \onetypes/ that
are realized in $\StrA$; $\TK\TI$ is the set of \onetypes/ that are realized by a unique element in
$\StrA$ and $\TW\TI$ is the set of \onetypes/ that are realized by at least $2$
elements in $\StrA$.
If $\ea \in \domA$ realizes $\tpp=\tpIa\StrA\ea$, then the neighbours
$\nb\TI\tpp = \setbd{\tpIa\StrA\eb}{\eb \in \domA \sub \set\ea}$ are exactly the
\onetypes/ realized by elements other than $\ea$.
\end{remark}

\begin{definition}
The \emph{(finite) type realizability problem} for $\vFo2$ is: given a
classified signature $\ClSig\SigS\sms$ and a type instance $\TI$ over
$\ClSig\SigS\sms$, is there a (finite) model for $\TI$.
Denote the type realizability problem by $\Real{\vFo2}$ and its finite version
by $\FinReal{\vFo2}$.
\end{definition}

\begin{remark}\label{rem:red-sat-to-real}
Let $\ClSig\SigS\sms$ be a classified signature and let $\falp(\xx,\yy)$ be a
quantifier-free $\vFoF2\SigS$-formula.
Let $\TI^\falp \subseteq \TpT\SigS$ is the set of those \twotypes/ that are
consistent with $\falp(\xx,\yy)$ and the intended interpretation
for classified signatures~\cref{eq:twovar-ms-iinter}.
Then a $\ClSig\SigS\sms$-structure $\StrA$ is a classified model for
$\falp(\xx,\yy)$ iff $\TIS\StrA \subseteq \TI^\falp$.

Recall that the number of possible $1$-types or $2$-types over $\SigS$ is
exponentially bounded by the size of $\SigS$ and that the size of a $1$-type or
a $2$-type over $\SigS$ is linearly bounded by the size of $\SigS$.
Hence the (finite) classified satisfiability problem reduces to the
(finite) type realizability problem in nondeterministic exponential time:
\[
  \FinAClSat{\vFo2} \red\cNExpTime \FinAReal{\vFo2}.
\]
\end{remark}

\begin{definition}
Let $\TI$ be a type instance over $\ClSig\SigS\sms$.
A \emph{star-type} $\stps \subseteq \TI$ over $\TI$ is a nonempty
set of \twotypes/ satisfying the following conditions:
\begin{itemize}
  \item[\condstpx]\label{cond:stpx}
  If $\tpt, \tptp \in \stps$, then $\tpx\tpt = \tpx\tptp$.
  Denote $\tpx\tpt$ for any $\tpt \in \stps$ by $\tpp=\tpx\stps$.
  The star-type is a \emph{king star-type} if $\tpp$ is a king type.
  Otherwise the star-type is a \emph{worker star-type}.
  
  \item[\condstppy]\label{cond:stppy}
  If $\tppp \in \nb\TI\tpp$, then some $\tpt\in\stps$ has
  $\tpy\tpt = \tppp$.
  
  \item[\condstpky]\label{cond:stpky}
  If $\tpkp \in \nb\TI\tpp\cap\TK\TI$, then a unique $\tpt\in\stps$ has
  $\tpy\tpt = \tpkp$. The existence follows from~\refcondstppy.
  
  \item[\condstpm]\label{cond:stpm}
  If $\sm \in \sms$, then some $\tpt\in\stps$ has $\sm(\xx,\yy) \in \tpTt$.
\end{itemize}
The size of a star-type is linear with respect to the size of the type instance.
\end{definition}

If $\StrA$ is a model for $\TI$, the \emph{star-type}
$\stpIa\StrA\ea$ of any element $\ea \in \domA$ is:
\[
  \stpIa\StrA\ea = \setbd{\tpIab\StrA\ea\eb}{\eb \in \domA \sub \set\ea}.
\]
\begin{remark}
Indeed $\stps=\stpIa\StrA\ea$ is a star-type over $\TI$.
\end{remark}
\begin{proof}
That $\stps$ is nonempty follows from the observation that $\domA$ has
cardinality at most $2$.
We check the conditions for $\stps$ to be a star-type over $\TI$:
\begin{itemize}
  \item[\refcondstpx]
  Let $\tpt,\tptp\in\stps$.
  Then $\tpt=\tpIab\StrA\ea\eb$ and $\tptp=\tpIab\StrA\ea\ebp$ for some
  $\eb,\ebp\in\domA\sub\set{\ea}$.
  Then $\tpx\tpt=\tpIa\StrA\ea=\tpx\tptp=\tpp$.
  \item[\refcondstppy]
  Let $\tppp\in\nb\TI\tpp$.
  If $\tppp$ is a worker type then at least $2$ elements in $\StrA$ realize
  $\tppp$.
  Let $\eb\neq\ec\in\domA$ realize $\tppp$.
  Let $\ebp\in\set{\eb,\ec}\sub\set\ea$.
  Then $\tpt = \tpIab\StrA\ea\ebp\in\stps$ has $\tpy\tpt=\tppp$.
  If $\tppp$ is a king type then $\tppp\neq\tpp$ and some
  $\eb\in\domA\sub\set\ea$ realizes $\tppp$.
  Then $\tpt = \tpIab\StrA\ea\eb\in\stps$ has $\tpy\tpt=\tppp$.
  \item[\refcondstpky]
  Let $\tpkp\in\nb\TI\tpp\cap\TK\TI$. Then $\tpkp\neq\tpp$.
  Suppose towards a contradiction that some $\tpt\neq\tptp\in\stps$ have
  $\tpy\tpt=\tpy\tptp=\tpkp$.
  Then $\tpt=\tpIab\StrA\ea\eb$ and $\tptp=\tpIab\StrA\ea\ebp$ for some
  $\eb\neq\ebp\in\domA\sub\set\ea$.
  Then $\tpIa\StrA\eb=\tpIa\StrA\ebp=\tpkp$ --- a contradiction with the
  observation that king types are realized by a unique element in $\StrA$.
  \item[\refcondstpm]
  Let $\sm\in\sms$. Since $\StrA$ is a $\ClSig\SigS\sms$-structure, some
  $\eb\in\domA\sub\set\ea$ has $\sm(\xx,\yy) \in \tpIab\StrA\ea\eb$.
  Now $\tpt = \tpIab\StrA\ea\eb \in \stps$.
\end{itemize}
\end{proof}

\begin{definition}
Let $\TI$ be a type instance over $\ClSig\SigS\sms$.
A \emph{certificate} $\Cert$ for $\TI$ is a nonempty set of star-types over
$\TI$ satisfying the following conditions:
\begin{itemize}
  \item[\condcertT]\label{cond:certT}
  If $\tpt\in\TI$ then some $\stps\in\Cert$ has $\tpt\in\stps$,
  that is there is a star-type containing each \twotype/.
  Note that if $\tpp\in\TP\TI$ then some $\stps\in\Cert$ has $\tpx\stps=\tpp$.
  Indeed, if $\tpp\in\TP\TI$ then some $\tpt\in\TI$ has $\tpx\tpt=\tpp$.
  \item[\condcertk]\label{cond:certk}
  If $\tpk \in \TK\TI$, then a unique $\stps\in\Cert$ has $\xtp\stps = \tpIk$.
  The existence follows from~\refcondcertT.
\end{itemize}
\end{definition}

Note that in general the size of a certificate may be exponential in
the size of the type instance. However, polynomial certificates exist:
\begin{lemma}[Certificate extraction]\label{lem:cert-extract}
Let $\StrA$ be a model for the type instance $\TI$.
For each \twotype/ $\tpt\in\TI$ let $\eat\tpt \neq \ebt\tpt \in \domA$
be two distinct elements realizing $\tpt$, that is
$\tpIab\StrA{\eat\tpt}{\ebt\tpt} = \tpt$.
Let $\Cert = \setbd{\stpIa\StrA{\eat\tpt}}{\tpt \in \TI}$.
Then $\Cert$ is a certificate for $\TI$.
The size of $\Cert$ is quadratic with respect to the size of the type instance.
\end{lemma}
\begin{proof}
That $\Cert$ is nonempty follows from $\TI$ being nonempty.
We check the conditions for a certificate for $\TI$:
\begin{itemize}
  \item[\refcondcertT]
  Let $\tpt\in\TI$.
  Then $\tpt=\tpIab\StrA{\eat\tpt}{\ebt\tpt} \in \stpIa\StrA{\eat\tpt} \in
  \Cert$.
  \item[\refcondcertk]
  Let $\tpk\in\TK\TI$ and let $\stps,\stpsp \in \Cert$ have
  $\tpx\stps = \tpx\stpsp = \tpk$. We claim that $\stps = \stpsp$.
  We have $\stps=\stpIa\StrA{\eat\tpt}$ and $\stpsp=\stpIa\StrA{\eat\tptp}$
  for some $\tpt,\tptp\in\TI$.
  We claim that $\eat\tpt=\eat\tptp$. Indeed, if $\eat\tpt\neq\eat\tptp$ then
  $\tptpp = \tpIab\StrA{\eat\tpt}{\eat\tptp} \in \stpIa\StrA{\eat\tpt}$ connects
  $\tpk$ with itself --- a contradiction.
  So $\eat\tpt = \eat\tptp$, hence $\stps=\stpsp$.
\end{itemize}
\end{proof}

\begin{theorem}[Certificate expansion]\label{lem:cert-expand}
Let $\Cert$ be a certificate for the type instance $\TI$ over the classified
signature $\ClSig\SigS\sms$.
Then $\TI$ has a finite model.
More precisely, let $\pt \geq \card\TI$ be a parameter.
Then $\TI$ has a finite model in which each worker type is realized at least
$\pt$ times.
\end{theorem}
\begin{proof}
We adapt the standard strategy\footnote{with the slight difference that our
approach doesn't need \emph{a court}, since the information about it is implicit
in the certificate} used in the proof of the finite model property for the logic
$\vFo2$, as presented in~\cite{gradel1999logics}.
We build a model $\StrA$ for $\TI$ as follows.
The domain $\domA$ of $\StrA$ is the union of the following disjoint sets of
elements:
\begin{itemize}
  \item
  The singleton set $\As\stps = \set{\as\stps}$ for every king star-type
  $\stps\in\Cert$, $\xtp\stps \in \TK\TI$.
  The elements $\as\stps$ are the \emph{kings}.
  \item 
  The three disjoint copies of $\pt$ elements
  $\As\stps = \Asi\stps0 \cup \Asi\stps1 \cup \Asi\stps2$ for every
  worker star-type $\stps \in \Cert$, $\xtp\stps \in \TW\TI$,
  where $\Asi\stps\ii = \set{\asij\stps\ii1, \asij\stps\ii2, \dots,
  \asij\stps\ii\pt}$ for $\ii \in \set{0,1,2}$.
  The elements $\asij\stps\ii\jj$ are the \emph{workers}.
\end{itemize}
Let $\itpsOP : \domA \to \Cert$ denote the intended star-type of the elements:
$\itps\ea = \stps$ on $\As\stps$.
Let $\itpiOP : \domA \to \TP\TI$ denote the intended \onetype/ of the elements:
$\itpi\ea = \tpx(\stps(\ea))$.
We consistently assign \twotypes/ between distinct elements on stages.
\begin{description}
  \item[Realization of kings]
  We first assign \twotypes/ consistently between the kings and any other
  element.
  Let $\ea\in\domA$ be any king.
  Then $\ea = \as\stps$ for some king star-type $\stps\in\Cert$.
  Let $\tpk = \tpp(\ea) = \tpx\stps$ be the intended (king) \onetype/ of $\ea$.
  Let $\eb \in \domA \sub \set\ea$ be any other element and let
  $\stpsp=\stps(\eb)$ and $\tppp=\tpp(\eb)$ be its intended star-type and
  \onetype/, respectively.
  By~\refcondcertk, $\stpsp \neq \stps$ and $\tppp \neq \tpk$,
  so $\tpk \in \nb\TI\tppp \cap \TK\TI$.
  By~\refcondstpky, a unique $\tptp\in\stpsp$ has $\tpy\tptp = \tpk$.
  We assign $\tpIab\StrA\eb\ea = \tptp$.
  We claim that this assignment is consistent.
  First, it is symmetric: suppose that $\eb$ is a king, so that $\tppp$ is a
  king type.
  Then by~\refcondstpky, there is a unique $\tpt\in\stps$ having
  $\tpy\tpt = \tppp$.
  Since $\TI$ is closed under inversion, $\inv\tpt \in \stpspp$ for some
  $\stpspp\in\Cert$.
  Since $\tpx\stpspp = \tppp$ is a king type, by~\refcondcertk{} $\stpspp =
  \stpsp$ and by~\refcondstpky, $\inv\tpt = \tptp$.
  That is, at the opposite situation we would assign exactly the inverse type
  consistently.
  Next, the assignment covers the star-type $\stps$. Indeed, let $\tpt\in\stps$
  be any \twotype/ that needs to be realized.
  Since $\tpk$ is a king type, $\tppp=\tpy\tpt\neq\tpk$.
  Since $\TI$ is closed under inversion, $\inv\tpt \in \stpsp$ for some
  $\stpsp\in\Cert$. Since $\tpx\stpsp = \tppp \neq \tpk$, $\stpsp \neq \stps$
  and $\tpk \in \nb\TI\tppp \cap \TK\TI$, so $\tptp = \inv\tpt \in \stpsp$ is
  the unique having $\tpy\tptp = \tpk$, and for every element $\eb\in\domA$
  having intended star-type $\stpsp$, we would have assigned
  $\tpIab\StrA\eb\ea = \tptp$, so $\tpIab\StrA\ea\eb = \tpt$ is realized.
  Note that these assigments fix the \twotype/ between any king and any other
  element.
  \item[Realization of workers]
  Next we consistently assign \twotypes/ between workers.
  Let $\ea\in\domA$ be any worker and let $\stps=\stps(\ea)$ and
  $\tpp=\tpp(\ea)$ be its intended star-type and \onetype/, respectively.
  Then $\ea = \asij\stps\ii\jj$ for some $\ii\in\set{0,1,2}$ and
  $\jj\in[1,\pt]$.
  Let $\iip=(\ii+1\bmod3)\in\set{0,1,2}$ be the index of \emph{the next copy} of
  the workers.
  Let $\tpt\in\stps$ be any \twotype/ such that $\tppp = \tpy\tpt$ is a worker
  type (the case where $\tpy\tpt$ is a king type has been taken care of during
  the realization of kings).
  Let $\TU = \setbd{\tpu\in\stps}{\tpy\tpu = \tppp}$ be the set of all
  \twotypes/ from $\stps$ parallel to $\tpt$.
  We simultaneously find distinct elements $\ebt\tpu$ that are distinct from
  $\ea$ for the assignments $\tpIab\StrA\ea{\ebt\tpu} = \tpu$.
  By~\refcondcertT{} and since $\TI$ is closed under inversion, for every
  $\tpu\in\TU$ there is some star-type $\stpspt\tpu \in \Cert$ such that
  $\inv\tpu \in \stpspt\tpu$.
  Note that $\tpx{\stpspt\tpu} = \tppp$ is a worker type.
  Since $\TU\subseteq\TI$ we have $\card{\TU} \leq \pt$, so there are enough
  distinct peasants from the next copy $\ebt\tpu \in \Asi{\stpspt\tpu}\iip$ for
  the assignments $\tpIab\StrA\ea{\ebt\tpu} = \tpu$.
  These assignments do not clash with each other, since they are made between
  \emph{consecutive copies} of worker elements.
  \item[Completion]
  Suppose that $\ea\neq\eb \in \domA$ are any two distinct elements such that
  $\tpIab\StrA\ea\eb$ has not yet been assigned. 
  Then both $\tpp(\ea)$ and $\tpp(\eb)$ are worker types, so $\tpp(\eb) \in
  \nb\TI{\tpp(\ea)} = \TP\TI$.
  By~\refcondstppy, some $\tpt\in\stps(\ea)$ has $\tpy\tpt = \tpp(\eb)$, so we
  may assign $\tpIab\StrA\ea\eb = \tpt$.
\end{description}
The structure $\StrA$ is a $\ClSig\SigS\sms$-structure by~\refcondstpm{} and is
a model for $\TI$ by~\refcondcertT.
\end{proof}

\begin{proposition}\label{prop:tprealiz-1}
The type realizability problem for $\vFo2$ coincides with the finite type
realizability problem and is in $\cNP$.
\end{proposition}
\begin{proof}
Let $\Tpi\TpiP\TpiT$ be a type instance for the classified signature
$\ClSig\SigS\sms$. Guess a polynomial certificate for $\Tpi\TpiP\TpiT$.
By~\Cref{lem:cert-extract} and~\Cref{lem:cert-expand}, such a certificate exists
iff $\Tpi\TpiP\TpiT$ is realizable.
The general version coincides with the finite version since the model
constructed in~\Cref{lem:cert-expand} is finite.
\end{proof}
\begin{corollary}[\cite{gradel1997decision}]
The logic $\vFo2$ has the finite model property and its (finite) satisfiability
problem is in $\cNExpTime$.
\end{corollary}