% Type realizibility of the two-variable first-order logic
Recall from~\Cref{sec:scott-nf} about normal forms that every $\vFo2$-sentence
$\fphi$ can be reduced in polynomial time to a sentence $\sctr\fphi$ in Scott
normal form:
\[
  \forall\xx\forall\yy (\falpp0(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy(
  \falpp\ii(\xx,\yy) \land \xx \neq \yy),
\]
where the formulas $\falpp\ii$ are quantifier-free and use at most linearly many
new unary predicate symbols. We refer to $\falpp0$ as the \emph{universal part},
or the $\forall\forall$-part of the formula $\sctr\fphi$ and to $\falpp\ii$ as
the \emph{existential parts}, or the $\forall\exists$-parts of the formula,
for $\ii \in [1,\nm]$.
For any formula in Scott normal form, we may replace its existential parts
by fresh binary predicate symbols: for $\ii \in [1,\nm]$, let $\smm\ii$ be a
fresh binary predicate symbol with the intended interpretation
$\forall\xx\forall\yy (\smm\ii(\xx,\yy) \lequ \falpp\ii(\xx,\yy))$.
Since this is a universal sentence, it can be incorporated into the
$\forall\forall$-part $\falpp0$ of the formula.
We refer to the symbols $\gls{message-symbol-m-i}$ as the \emph{message
symbols}.
Hence the formula can be transformed in polynomial time to the form:
\begin{equation}\label{eq:twovar-msg-nf}
  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy
  (\smm\ii(\xx,\yy) \land \xx \neq \yy),
\end{equation}
where the $\forall\forall$-part $\falp$ is quantifier-free and over an extended
signature. For convenience, we make the existential parts of the formula part of
the signature, so we can focus only on the universal part. The following is a
term similar to the one defined in~\cite{MALQ:MALQ201400102}:
\begin{definition}
A \emph{classified signature} $\gls{classified-signature-S-m}$ for the
two-variable first-order logic $\vFo2$ is a predicate signature $\SigS$ together
with a sequence $\sms = \smm1\smm2\dots\smm\nm$ of distinct binary predicate
symbols from $\SigS$ having intended interpretation
\begin{equation}\label{eq:twovar-ms-iinter}
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy 
  (\smm\ii(\xx,\yy) \land \xx \neq \yy).
\end{equation}
\end{definition}
That is, a classified signature \emph{automatically includes} the
$\forall\exists$-parts of formulas and $\ClSig\SigS\sms$-structures
\emph{automatically satisfy} the $\forall\exists$-parts. We also require that
all $\ClSig\SigS\sms$-structures contain at least two elements (that can be
enforced by adding the formula $\forall\xx\exists\yy(\xx\neq\yy)$ to the
intended interpretation of $\SigS$ and it doesn't make the problem simpler,
since satisfiability in the class of structures of cardianlity $1$ is trivial).

\begin{definition}\label{def:clsig-twovar}
The \emph{(finite) classified satisfiability problem for two-variable
first-order logic} is:
given a classified signature $\ClSig\SigS\sms$ and a quantifier-free
$\vFoF2\SigS$-formula $\falp(\xx,\yy)$, is there a (finite)
$\ClSig\SigS\sms$-structure satisfying~\cref{eq:twovar-msg-nf}.
Note that by virtue of the structure being a $\ClSig\SigS\sms$-structure, it
will also satisfy~\cref{eq:twovar-ms-iinter} and have cardinality at least $2$.
Denote tha classified satisfiability problem for two-variable first-order logic
by $\ClSat{\vFo2}$ and its finite version by $\FinClSat{\vFo2}$.
\end{definition}

Scott normal form shows that (finite) satisfiability reduces in polynomial time
to (finite) classified satisfiability, since satisfiability in structures of
cardinality $1$ is trivial:
\[
  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.
\]

\begin{definition}\label{def:tpinst-twovar}
A \emph{type instance} $(\TpiP,\TpiT)$ over the classified
signature $\ClSig\SigS\sms$ is a pair of a nonempty set of $1$-types
$\TpiP\subseteq\TpI\SigS$ and a nonempty set of $2$-types
$\TpiT\subseteq\TpT\SigS$ such that:
\begin{itemize}
  \item The set of $2$-types $\TpiT$ is closed under inversion, that is
  $\inv\tpTt\in\TpiT$ for every $\tpTt\in\TpiT$.
  \item Every $2$-type $\tpTt\in\TpiT$ connects $1$-types from $\TpiP$,
  that is $\xtp\tpTt\in\TpiP$ and $\ytp\tpTt\in\TpiP$ for every $\tpTt\in\TpiT$.
  Equivalently, (since $\TpiT$ is closed under inversion)
  $(\xtp\restriction\TpiT)\subseteq\TpiP$.
\end{itemize}

A $\ClSig\SigS\sms$-structure $\StrA$ \emph{realizes} (or is a model of) the
type instance $(\TpiP,\TpiT)$, if all $1$-types and $2$-types realized in
$\StrA$ come from the type instance, that is if:
\begin{itemize}
  \item $\tpIa\StrA\ea \in \TpiP$ for all $\ea\in\domA$, and
  \item $\tpIab\StrA\ea\eb \in \TpiT$ for all $\ea \in \domA$
and $\eb \in \domA \sub \set{\ea}$.
\end{itemize}
The structure $\StrA$ \emph{fully realizes} $(\TpiP,\TpiT)$, if additionally for
every $1$-type $\tpIp \in \TpiP$ there is an element $\ea \in \domA$ realizing $\tpIp$
(we don't require analogous condition for the $2$-types).

The \emph{type instance} of $\StrA$ is the type instance $(\TpiP,\TpiT)$ defined
by:
\begin{align*}
  \TpiP &= \setbd{\tpIa\StrA\ea}{\ea\in\domA} \\
  \TpiT &= \setbd{\tpIab\StrA\ea\eb}{\ea\neq\eb \in \domA}.
\end{align*}
Clearly, $(\TpiP,\TpiT)$ is indeed a type instance and $\StrA$ fully realizes
$(\TpiP,\TpiT)$.

The \emph{(finite) (full) type realizibility problem for $\vFo2$} is the
following:
given a classified signature $\ClSig\SigS\sms$ and a type instance
$(\TpiP,\TpiT)$ over $\ClSig\SigS\sms$, is there a (finite)
$\ClSig\SigS\sms$-structure that (fully) realizes $(\TpiP,\TpiT)$.
Denote the type realizibility problem\footnote{The reason we study the type
realizibility problem instead of directly studying the satisfiability problem is
that it is flexible enough to allow us to employ its solutions in simpler cases
to construct solutions in more complicated cases.} for $\vFo2$ by
$\Real{\vFo2}$ and its finite version by $\FinReal{\vFo2}$.
Similarly, denote the full type realizibility problem for $\vFo2$ by
$\FullReal{\vFo2}$ and its finite version by $\FinFullReal{\vFo2}$.
\end{definition}

\begin{remark}\label{rem:red-real-to-full-real}
Since the type instance $(\TpiP',\TpiT')$ of every model $\StrA$ of the type
instance $(\TpiP,\TpiT)$ consists of subsets: $\TpiP' \subseteq \TpiP$ and $\TpiT'
\subseteq \TpiT$, by guessing these subsets we can reduce the (finite) type
realizability problem to the (finite) full type realizability problem in
nondeterministic polynomial time:
\[
  \FinAReal{\vFo2} \red\cNP \FinAFullReal{\vFo2}.
\]
\end{remark}

\begin{remark}\label{rem:red-sat-to-real}
Let $\alpha(\xx,\yy)$ be a quantifier-free $\vFoF2\SigS$-formula.
Let $(\TpiP,\TpiT)$ be a type instance, where $\TpiP$ is the set of those
$1$-types consistent with $\alpha(\xx,\yy)$ and the intended
interpretation~\cref{eq:twovar-ms-iinter} and where $\TpiT$ is the set of
those $2$-types $\tpTt$ over $\ClSig\SigS\sms$ such that both $\tpTt$ and 
$\inv\tpTt$ are consistent with $\alpha$ and the intended interpretation~\cref{eq:twovar-ms-iinter}. Then a $\ClSig\SigS\sms$-structure
$\StrA$ is a model for $\alpha$ iff it is a model for $(\TpiP,\TpiT)$.

Recall that the number of possible $1$-types or $2$-types over $\SigS$ is
exponentially bounded by the length $\sizes$ of $\SigS$ and that the cardinality
of a $1$-type or a $2$-type over $\SigS$ is polynomially bounded by $\sizes$.
Hence we can reduce the (finite) classified satisfiability problem to the
(finite) type realizibility problem in deterministic exponential time:
\[
  \FinAClSat{\vFo2} \red\cExpTime \FinAReal{\vFo2}.
\]
\end{remark}

\begin{definition}\label{def:connectable}
Let $(\TpiP,\TpiT)$ be a type instance over $\ClSig\SigS\sms$.
Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{connectable} 
(written $\gls{connectable-p-pp}$), 
if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some $\tpTt \in \TpiT$.
Note that connectability is symmetric since $\TpiT$ is closed under inversion.
However, connectability is not necessarly neither transitive nor reflexive:

A $1$-type $\tpIk \in \TpiP$ is a \emph{king type} if $\tpIk \not\conn \tpIk$.
A $1$-type $\tpIp \in \TpiP$ that is not a king type is a \emph{peasant type}.
The set of king types for the type instance $(\TpiP,\TpiT)$ is $\TKg =
\TKg(\TpiP,\TpiT)$ and the set of peasant types is $\TPs = \TPs(\TpiP,\TpiT) =
\TpiP \sub \TKg(\TpiP,\TpiT)$.
\end{definition}
\begin{remark}\label{rem:twovar-king-once}
If $\StrA$ is a full model for $(\TpiP,\TpiT)$, then every two distinct elements
$\ea \neq \eb \in \domA$ realize connectable $1$-types. Hence every king type
$\tpIk \in \TpiK(\TpiP,\TpiT)$ must be realized once in $\StrA$.
\end{remark}

The next definition characterizes the local structure of the ray of $2$-types
realized around an element of a full model of a type instance.
\begin{definition}
A \emph{star-type} $\stps \subseteq \TpiT$ for the type instance
$\Tpi\TpiP\TpiT$ is a nonempty set of $2$-types satisfying the following conditions:
\begin{enumerate}
  \item\label{cond:star-1} If $\tpTt, \tpTtp \in \stps$, then $\xtp\tpTt =
  \xtp\tpTtp$, that is the $\xx$-type of every element of $\stps$ is the same.
  Denote the $\xx$-type of every element of $\stps$ by $\xtp\stps$.
  \item\label{cond:star-2} If $\tpIk = \xtp\stps \in \TKg$ is a king type,
  then no $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item\label{cond:star-3} If $\tpIk \in \TKg \sub \set{\xtp\stps}$ is any king
  type distinct from $\xtp\stps$ (note that here $\xtp\stps$ may as well be a
  peasant type), then only one $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item\label{cond:star-4} If $\sm \in \sms$, then $\sm(\xx,\yy) \in \tpTt$ for
  some (possibly many) $\tpTt \in \stps$.
\end{enumerate}
Note that the size of a star-type is polynomially bounded by the size of the
type instance.

If $\StrA$ is a full $\Tpi\TpiP\TpiT$-model and $\ea \in \domA$, the
\emph{star-type realized by $\ea$} is:
\[
  \stpIa\StrA\ea = \setbd{\tpIab\StrA\ea\eb}{\eb \in \domA \sub \set{\ea}}.
\]
\end{definition}
We now verify that the star-type realized by $\ea$ is indeed a star-type:
\begin{remark}
Let $(\TpiP,\TpiT)$ be a type instance for $\ClSig\SigS\sms$, $\StrA$ be
a full $(\TpiP,\TpiT)$-model and let $\ea \in \domA$. Then the star-type
$\stps = \stpIa\StrA\ea$ realized by $\ea$ is a star-type for the type instance
$(\TpiP,\TpiT)$.
\end{remark}
\begin{proof}
The star-type $\stps$ is nonempty since $\StrA$ --- a
$\ClSig\SigS\sms$-structure --- contains at least $2$ elements. We verify the
conditions for a star-type:
\begin{enumerate}
  \item If $\tpTt, \tpTtp \in \stps$, then $\tpTt = \tpIab\StrA\ea\eb$ and
  $\tpTtp = \tpIab\StrA\ea\ec$ for some $\eb,\ec\neq\ea\in\domA$, hence
  $\xtp\tpTt = \tpIa\StrA\ea = \xtp\tpTtp$.
  \item If $\tpIk = \xtp\stps\in\TKg$ is a king type, then by definition we have
  that no $2$-type $\tpTt\in\TpiT$ has $\xtp\tpTt = \tpIk$ and $\ytp\tpTt =
  \tpIk$, and so no $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$ since
  $\stps\subseteq\TpiT$ since $\StrA$ realizes $(\TpiP,\TpiT)$.
  \item Let $\tpIk\in\TKg\sub\set{\xtp\stps}$ be any king type.
  By~\Cref{rem:twovar-king-once}, there is a unique element $\ec \neq \ea \in
  \domA$ realizing $\tpIk$. Then the $2$-type $\tpTt = \tpIab\StrA\ea\ec$ is the
  unique satisfying $\tpTt\in\stps$ and $\ytp\tpTt = \tpIk$.
  \item Since $\StrA$ is a $\ClSig\SigS\sms$-structure, it automatically
  satisfies the $\forall\exists$-parts of~\cref{eq:twovar-ms-iinter}, hence for 
  every $\sm \in \sms$ there must be some $\eb \neq \ea \in \domA$ such that
  $\sm(\xx,\yy) \in \tpIab\StrA\ea\eb$.
\end{enumerate}
\end{proof}

\begin{remark}[Star-type extension]\label{rem:star-type-ext}
Let $\stps$ be a star-type having $\xx$-type $\tpIp = \xtp\stps$.
Let $\tpTt \in \TpiT$ be a $2$-type and suppose that $\xtp\tpTt = \tpIp$ and
that $\ytp\tpTt$ is not a king type.
Then $\stps \cup \set{\tpTt}$ is also a star-type.
\end{remark}

\begin{definition}
A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is a
nonempty set of star-types for $\Tpi\TpiP\TpiT$ satisfying the following
conditions:
\begin{enumerate}
  \item\label{cond:cert-0} If $\tpTt\in\stps$ for some $\stps\in\Cert$, then
  $\inv\tpTt\in\stps'$ for some $\stps'\in\Cert$, that is there are witnesses
  for the endpoints for every $2$-type used in the certificate.
  Equivalently, $\cup\Cert$ is closed under inversion. Let $\TpiTp = \cup\Cert$.
  Clearly, $\TpiTp\subseteq\TpiT$. We require that $\Tpi\TpiP\TpiTp$ is a type
  instance --- the \emph{refined type instance} --- and that all star-types
  $\stps\in\Cert$ be star-types \emph{for that refined type instance}.
  In this context we define the king types $\TKg = \TKg(\TpiP,\TpiTp)$ and the
  peasant types $\TPs = \TPs(\TpiP,\TpiTp)$ with respect to the refined type
  instance. Note that since $\TpiTp \subseteq \TpiT$, a king type with respect
  to the original type instance must remain a king type with respect to the
  refined type instance. However, there might be king types with respect to the
  original type instance that were peasant types with respect of the original
  type instance (this might happen if we remove all $2$-types connecting a
  peasant type when going from $\TpiT$ to $\TpiTp$).
  \item\label{cond:cert-1} If $\tpIp \in \TpiP$ then some (possibly many) $\stps
  \in \Cert$ has $\xtp\stps = \tpIp$, that is every $1$-type is witnessed.
  \item\label{cond:cert-2} If $\tpIk \in \TpiK$ is a king type with respect to
  the refined type instance $\Tpi\TpiP\TpiTp$, then one $\stps \in \Cert$ has
  $\xtp\stps = \tpIk$, that is every king type is witnessed once.
  Note that the existence is already implied by condition~\ref{cond:cert-1}.
\end{enumerate}
\end{definition}
Note that in general the size of a certificate may be exponential in terms of
the size of the type instance. However, polynomial certificates exist:
\begin{lemma}[Certificate extraction]\label{lem:cert-extract}
Let $\StrA$ be a full model for the type instance $\Tpi\TpiP\TpiT$.
Let $\TpiTp \subseteq \TpiT$ be the (nonempty) set of $2$-types realized in
$\StrA$. Note that $\TpiTp$ is closed under inversion. 
For every $2$-type $\tpTt \in \TpiTp$,
let $\ea_\tpTt \neq \eb_\tpTt \in \domA$ be two distinct elements realizing
$\tpTt$: $\tpIab\StrA{\ea_\tpTt}{\eb_\tpTt} = \tpTt$. Also, the choice of the
elements can be made symmetric, that is $\ea_{\inv\tpTt} = \eb_\tpTt$ and
$\eb_{\inv\tpTt} = \ea_\tpTt$ for every $\tpTt\in\TpiTp$.
Let 
\[
  \Cert = \setbd{\stpIa\StrA{\ea_\tpTt}}{\tpTt\in\TpiTp}.
\]
Then $\Cert$ is a certificate for the type instance. Moreover, its size is
linearly bounded by $\card{\TpiT}$, hence also by the size of the type instance.
\end{lemma}
\begin{proof}
We check the conditions for a certificate:
\begin{enumerate}
  \item That $\Tpi\TpiP\TpiTp$ is a type instance follows from the observations
  that $\cup\Cert = \TpiTp$, $\TpiTp \subseteq \TpiT$ and that all $\xx$-types
  and $\yy$-types of $2$-types from $\TpiTp$ are contained in $\TpiP$. Note that
  $\StrA$ is a full model for the type instance $\Tpi\TpiP\TpiTp$, hence every
  star-type $\stpIa\StrA\ea$ is a star-type for the type instance
  $\Tpi\TpiP\TpiTp$.
  \item That every $1$-type is witnessed follows from the observation that
  $\StrA$ is a full model for $\Tpi\TpiP\TpiTp$
  \item If $\tpIk \in \TpiP$ is a king type, by~\Cref{rem:twovar-king-once} it
  is realized once in $\StrA$.
  Let $\ec \in \domA$ be the unique element realizing $\tpIk$.
  If $\stps \in \Cert$ has $\xtp\stps = \tpIk$, then $\stps = \stpIa\StrA\ec$,
  so such $\stps$ is unique (more precisely, for every $\tpTt\in\TpiTp$ such
  that $\xtp\tpTt = \tpIk$ we must have that $\ea_\tpTt = \ec$).
\end{enumerate}
\end{proof}
% TODO: Fix the proof
\begin{lemma}[Certificate expansion]\label{lem:cert-expand}
Let $\Cert$ be a certificate for the connected type instance $\Tpi\TpiP\TpiT$.
Then $\Tpi\TpiP\TpiT$ has a finite full model. More precisely, let $t \geq
\card\TpiT$. Then $\Tpi\TpiP\TpiT$ has a finite model $\StrA$ in which for every
star-type $\stps \in \Cert$ such that $\xtp\stps$ is not a king type, there are
at least $t$ elements $\ea \in \domA$ such that $\stps \subseteq
\stpIa\StrA\ea$.
\end{lemma}
\begin{proof}
We adapt the standard strategy used in the proof of the finite model property
for the logic $\vFo2$, as presented in~\cite{gradel1999logics}\footnote{with
the slight difference that our approach doesn't need \emph{a court},
since the information about it is implicit in the certificate}.
We build a model $\StrA$ for $\Tpi\TpiP\TpiT$ as follows.
The domain $\domA$ of $\StrA$ is the union of the disjoint sets of elements
$\domA^\stps$ for all $\stps \in \Cert$, that have intended star-type $\stps$
as follows.
If $\xtp\stps$ is a king type, $\domA^\stps = \set{\ea^\stps}$ is a
singleton. Call the element $\ea^\stps$ a \emph{king}.
Otherwise, if $\xtp\stps$ is not a king type, $\domA^\stps = \domA^\stps_0
\cup \domA^\stps_1 \cup \domA^\stps_2$ consists of three disjoint copies of $t$
elements:  $A^\stps_i = \set{\ea^\stps_{i1}, \ea^\stps_{i2}, \dots,
\ea^\stps_{it}}$, where $i \in \set{0,1,2}$. Call these elements
\emph{peasants}.
Let $\stps : \domA \to \Cert$ denote the intended star-type of the elements:
$\stps(\ea) = \stps$ for all $\ea \in \domA^\stps$.
Let $\tpIp : \domA \to \TpiP$ denote the intended $1$-type of the elements:
$\tpIp(\ea) = \xtp(\stps(\ea))$.
We proceed to consistently assign $2$-types to pairs of distinct elements from
the structure on stages.
\begin{description}
  \item[Realization of kings] We first find witnesses for the intended
  star-types of the kings.
  Let $\stps \in \Cert$ be such that $\tpIk = \xtp\stps$ is a king type.
  Consider the unique element $\ea = \ea^\stps$ having intended star-type
  $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\eb_\tpTt$ for the
  assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$.
  \begin{enumerate}
  \item If $\ytp\tpTt = \tpIkp$ is a king type, by Condition~\ref{cond:star-4}
  for star-types we have $\tpIkp \neq \tpIk$, so there is a unique star-type
  $\stps'$ having $\xtp\stps' = \tpIk'$ and a unique king $\eb_\tpTt =
  \ea^{\stps'} \neq \ea$ having intended star-type $\stps'$. Note that this
  assigment is symmetric, that is at the point of considering the type
  $\inv\tpTt$ for the king $\eb_\tpTt$, we would choose $\ea$ as the
  opposite side of the assignment (recall that by definition $\TpiT$ is closed
  under inversions).
  \item If $\ytp\tpTt = \tpIpp \in \TPs$ is is a peasant type (hence
  $\tpIpp \neq \tpIk$), we simultaneously find distinct elements $\eb_{\tpTt'}$
  for all $\tpTtp \in \stps$ having $\ytp\tpTtp = \tpIpp$.
  Let $\TpiTp = \setbd{\tpTtp \in \stps}{\ytp\tpTtp = \tpIpp}$ be the set of
  all such $\tpTtp$.
  Since $\TpiTp \subseteq \TpiT$, there are
  at most $t$ such $2$-types $\tpTtp$. By Condition~\ref{cond:cert-2} for
  certificate, we can find a star-type $\stps_{\tpTtp} \in \Cert$ containing
  $\inv{(\tpTtp)}$ for every $\tpTtp \in \TpiTp$. Since $\xtp\stps_{\tpTtp} =
  \tpIpp$ is not a king type, there are enough elements 
  $\eb_{\tpTtp} \in \domA_0^{\stps_{\tpTtp}}$ having intended star-type
  $\stps_{\tpTtp}$.
  We assign $\tpIab\StrA\ea{\eb_\tpTtp} = \tpTtp$.
  \end{enumerate}
  \item[Realization of peasants] We now find witnesses for the remaining
  elements that realize $1$-types which are not king types. Let $\stps \in \Cert$ be such that $\tpIp =
  \xtp\stps \in \TPs$ is a peasant type. Let $a = a_{ij}^\stps$ be an arbitrary
  element with intended star-type $\stps$. For every $\tpTt \in \stps$ we will find an
  element $\eb_\tpTt$ for the assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$.
  \begin{enumerate}
    \item If $\ytp\tpTt = \tpIkp$ is a king type then let $\ec$ be the element
    realizing it: $\tpIp(\ec) = \tpIkp$.
    We consider two cases.
    First suppose that $\tpIab\StrA\ec\ea = \tpTtp$ has already been assigned
    during the realization of kings.
    By construction we must have that $\inv{(\tpTtp)} \in \stps(\ea) = \stps$.
    Since $\ytp\inv{(\tpTtp)} = \tpIkp$ is a king type,
    by Condition~\ref{cond:cert-2}
    for certificate, the king type $\tpIkp$ is witnessed once in the star-type
    $\stps$. Hence $\tpTt = \inv{(\tpTt')}$, and so $\tpTt$ is already witnessed
    by $\eb_\tpTt = \ec$.
    
    Next suppose that $\tpIab\StrA\ec\ea$ has not been assigned during the
    realization of kings. Then just assign $\tpIab\StrA\ea\ec = \tpTt$.
    Note that this may extend the actual star-type of the king $\ec$ beyond its
    intended star-type $\stps(\ec)$ by adding the type $\inv\tpTt$, but
    by~\Cref{rem:star-type-ext}, this extension is still a star-type. That is,
    in the end, the structure may realize \emph{more} than the intended
    star-types, but, importantly, \emph{not less}.
    \item If $\ytp\tpTt = \tpIpp$ is not a king type, we simultaneously find
    distinct peasants $\eb_{\tpTtp}$ for all $\tpTtp \in \stps$ having
    $\ytp\tpTtp = \tpIpp$.
    Let $\tpTtp = \setbd{\tpTtp \in \stps}{\ytp\tpTtp = \tpIpp}$ be the set of
    all such $\tpTtp$.
    By Condition~\ref{cond:cert-3} for certificate, we can find a star-type
    $\stps_\tpTtp \in \Cert$ containing $\inv{(\tpTtp)}$ for every $\tpTtp \in
    \TpiTp$. The key to consistency is to use elements from the \emph{next copy}
    of peasants: let $i' = (i+1 \bmod 3) \in \set{0,1,2}$. Since
    $\xtp{\stps_{\tpTtp}} = \tpIpp$ is not a king type, there are enough
    peasants ${\eb_\tpTtp} \in \domA_{i'}^{\stps_{\tpTtp}}$ having intended
    star-type $\stps_{\tpTtp}$. We assign $\tpIab\StrA\ea{\eb_\tpTtp} = \tpTtp$.
    None of these assignments clash with each other.
  \end{enumerate}
  \item[Completion] For any pair of distinct elements $\ea, \eb \in \domA$ that
  has not yet been assigned a $2$-type, assign $\tpIab\StrA\ea\eb = \tpTt$ to
  arbitrary $2$-type $\tpTt$ that connects the $1$-types $\tpIp(\ea)$ and
  $\tpIp(\eb)$. This is possible because the type instance $\Tpi\TpiP\TpiT$ is
  connected.
\end{description}
\end{proof}

\begin{proposition}
The logic $\vFo2$ has the finite model property. The (finite) full type
realizibility problem for $\vFo2$ is in $\cNP$.
\end{proposition}
\begin{proof}
Let $\Tpi\TpiP\TpiT$ be a type instance. If it is not connected, then it has no
model by~\Cref{rem:twovar-king-once}. It is trivial to check satisfiability in
the class of structures of cardinality $1$. If this fails to yield a model,
guess a certificate of polynomial size (and verify in polynomial time that this
is indeed a certificate).
By~\Cref{lem:cert-extract} and~\Cref{lem:cert-expand} such a certificate exists
iff $\Tpi\TpiP\TpiT$ is fully satisfiable.
\end{proof}
Combining this with the reductions given in~\Cref{rem:red-real-to-full-real}
and~\Cref{rem:red-sat-to-real} gives us another proof of a standard result:
\begin{corollary}
The logic $\vFo2$ has the finite model property and its (finite) satisfiability
problem is in $\cNExpTime$.
\end{corollary}