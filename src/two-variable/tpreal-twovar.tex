% Type realizibility of the two-variable first-order logic
Recall from~\Cref{sec:scott-nf} about normal forms that every $\vFo2$-sentence
$\fphi$ can be reduced in polynomial time sentence $\sctr\fphi$ in Scott normal
form:
\[
  \forall\xx\forall\yy (\falpp0(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy(
  \falpp\ii(\xx,\yy) \land \xx \neq \yy),
\]
where the formulas $\falpp\ii$ are quantifier-free and use at most linearly many
new unary predicate symbols. We refer to $\falpp0$ as the \emph{universal part},
or the $\forall\forall$-part of the formula $\sctr\fphi$ and to $\falpp\ii$ as
the \emph{existential parts}, or the $\forall\exists$-parts of the formula,
for $\ii \in [1,\nm]$.
For any formula in Scott normal form, we may replace its existential parts
by fresh binary predicate symbols: for $\ii \in [1,\nm]$, let $\smm\ii$ be a
fresh binary predicate symbol with the intended interpretation
$\forall\xx\forall\yy (\smm\ii(\xx,\yy) \lequ \falpp\ii(\xx,\yy))$.
Since this is a universal sentence, it can be incorporated into the
$\forall\forall$-part $\falpp0$ of the formula.
We refer to the symbols $\gls{message-symbol-m-i}$ as the \emph{message
symbols}.
Hence the formula can be transformed in polynomial time to the form:
\begin{equation}\label{eq:twovar-msg-nf}
  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy
  (\smm\ii(\xx,\yy) \land \xx \neq \yy),
\end{equation}
where the $\forall\forall$-part $\falp$ is quantifier-free and over an extended
signature. For convenience, we make the existential parts of the formula part of
the signature, so we can focus only on the universal part. The following is a
term similar to the one defined in~\cite{MALQ:MALQ201400102}:
\begin{definition}
A \emph{classified signature} $\gls{classified-signature-S-m}$ for the
two-variable first-order logic $\vFo2$ is a predicate signature $\SigS$ together
with a sequence $\sms = \smm1\smm2\dots\smm\nm$ of distinct binary predicate
symbols from $\SigS$ having intended interpretation
\begin{equation}\label{eq:twovar-ms-iinter}
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy 
  (\smm\ii(\xx,\yy) \land \xx \neq \yy).
\end{equation}
\end{definition}
That is, a classified signature \emph{automatically includes} the
$\forall\exists$-part of formulas and $\ClSig\SigS\sms$-structures
automatically satisfy the $\forall\exists$-part.

\begin{definition}
The \emph{(finite) classified satisfiability problem for two-variable
first-order logic} is:
given a classified signature $\ClSig\SigS\sms$ and a quantifier-free
$\vFoF2\SigS$-formula $\falp(\xx,\yy)$, is there a (finite)
$\ClSig\SigS\sms$-structure satisfying~\cref{eq:twovar-msg-nf}.
Denote tha classified satisfiability problem for two-variable first-order logic
by $\ClSat{\vFo2}$ and its finite version by $\FinClSat{\vFo2}$.
\end{definition}

Scott normal form shows that (finite) satisfiability reduces in polynomial time
to (finite) classified satisfiability:
\[
  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.
\]

Let $\ClSig\SigS\sms$ be a classified signature for $\vFo2$.
\begin{definition}
A \emph{type instance} $\gls{type-instance-P-T}$ over $\ClSig\SigS\sms$ is a
pair of a set of $1$-types $\TpiP \subseteq \TpI\SigS$ and a set of $2$-types
$\TpiT \subseteq \TpT\SigS$ such that $\xtp\tpTt \in \TpiP$ and $\ytp\tpTt \in
\TpiP$ for all $\tpTt \in \TpiT$.

A $\ClSig\SigS\sms$-structure $\StrA$ \emph{realizes} (or is a model of)
$\Tpi\TpiP\TpiT$ if it contains at least $2$ elements, $\tpIa\StrA\ea \in \TpiP$
for all $\ea \in \domA$ and $\tpIab\StrA\ea\eb \in \TpiT$ for all $\ea \in \domA$
and $\eb \in \domA \sub \set{\ea}$.
The structure \emph{fully realizes} $\Tpi\TpiP\TpiT$ if additionally for every
$1$-type $\tpIp \in \TpiP$ there is $\ea \in \domA$ such that $\tpIa\StrA\ea =
\tpIp$ (we don't require an analogous condition for the $2$-types).
The \emph{characteristic type instance} of $\StrA$ is the type instance
$\Tpi\TpiP\TpiT$ defined by:
\begin{align*}
\TpiP &= \setbd{\tpIa\StrA\ea}{\ea\in\domA} \\
\TpiT &= \setbd{\tpIab\StrA\ea\eb}{\ea\neq\eb \in \domA}.
\end{align*}

The \emph{(finite) (full) type realizibility problem for $\vFo2$} is the
following:
given a classified signature $\ClSig\SigS\sms$ and a type instance
$\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$, is there a (finite)
$\ClSig\SigS\sms$-structure that (fully) realizes $\Tpi\TpiP\TpiT$.
Denote the type realizibility problem for $\vFo2$ by
$\Real{\vFo2}$ and its finite version by $\FinReal{\vFo2}$.
Denote the full type realizibility problem for $\vFo2$ by
$\FullReal{\vFo2}$ and its finite version by $\FinFullReal{\vFo2}$.
\end{definition}

\begin{remark}\label{rem:red-real-to-full-real}
Since the set of $1$-types realized in any model of $\Tpi\TpiP\TpiT$ is a subset
of $\TpiP$, by guessing this subset we can reduce the (finite) type
satisfiability problem to the (finite) full type satisfiability problem in
nondeterministic polynomial time:
\[
  \FinAReal{\vFo2} \red\cNP \FinAFullReal{\vFo2}.
\]
\end{remark}

\begin{remark}\label{rem:red-sat-to-real}
Let $\alpha(\xx,\yy)$ be a quantifier-free $\vFoF2\SigS$-formula. Let $\TpiP$ be
the set of those $1$-types over $\ClSig\SigS\sms$ that are consistent with
$\alpha$ and $\TpiT$ be the set of those $2$-types over $\ClSig\SigS\sms$ that
are consistent with $\alpha$ and the intended
interpretation~\cref{eq:twovar-ms-iinter}. Then a $\ClSig\SigS\sms$-structure
$\StrA$ is a model for $\alpha$ iff it is a model for $\Tpi\TpiP\TpiT$.

Recall that the number of possible $1$-types or $2$-types over $\SigS$ is
exponentially bounded by the length $\sizes$ of $\SigS$ and that the cardinality
of a $1$-type or a $2$-type over $\SigS$ is polynomially bounded by $\sizes$.
Hence we can reduce the (finite) classified satisfiability problem to the
(finite) type realizibility problem in exponential time:
\[
  \FinASat{\vFo2} \red\cExpTime \FinAReal{\vFo2}.
\]
\end{remark}

We study the type realizibility problem instead of directly studying the
satisfiability problem because it is flexible enough to allow us to employ its
solutions in simpler logics to construct a solution in logics with more
equivalences.

Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.
\begin{definition}
Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{connectable} (written
$\gls{connectable-p-pp}$), if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for
some $\tpTt \in \TpiT$. A $1$-type $\tpIk \in \TpiP$ is a \emph{king type} if
$\tpIk \not\conn \tpIk$.
\end{definition}
\begin{remark}\label{rem:twovar-king-once}
If two distinct $1$-types $\tpIp, \tpIpp \in \TpiP$ are not connectable, then
$\Tpi\TpiP\TpiT$ is not fully realizible.

If $\StrA$ is a full model for $\Tpi\TpiP\TpiT$ then every two distinct elements
$\ea \neq \eb \in \domA$ realize connectable $1$-types. Hence every king type
$\tpIk \in \TpiP$ is realized once in $\StrA$.

A type instance $\Tpi\TpiP\TpiT$ is \emph{connected} if every two distinct
$1$-types $\tpIp, \tpIpp \in \TpiP$ are connectable.
\end{remark}

The next definition characterizes the local structure of the ray of $2$-types
realized around an element of a structure.
\begin{definition}
A \emph{star-type} $\stps \subseteq \TpiT$ for the type instance
$\Tpi\TpiP\TpiT$ is a nonempty set of $2$-types satisfying the following conditions:
\begin{enumerate}
  \item\label{cond:star-1} If $\tpTt, \tpTtp \in \stps$ then $\xtp\tpTt =
  \xtp\tpTtp$, that is the $\xx$-type of every element of $\stps$ is the same.
  Denote the $\xx$-type of every element of $\stps$ by $\xtp\stps$.
  \item\label{cond:star-2} If $\tpIk = \xtp\stps$ is a king type, then no $\tpTt
  \in \stps$ has $\ytp\tpTt = \tpIk$.
  \item\label{cond:star-3} If $\tpIk \neq \xtp\stps$ is any king type, then one
  $\tpTt \in \stps$ has $\ytp\tpTt = \tpIk$.
  \item\label{cond:star-4} If $\sm \in \sms$, then $\sm \in \tpTt$ for some
  (possibly many) $\tpTt \in \stps$.
\end{enumerate}
Note that the size of a star-type is polynomially bounded by the size of the
type instance.

If $\StrA$ is a $\Tpi\TpiP\TpiT$-structure and $\ea \in \domA$, the
\emph{star-type realized by $\ea$} is:
\[
  \stpIa\StrA\ea = \setbd{\tpIab\StrA\ea\eb}{\eb \in \domA \sub \set{\ea}}.
\]
It is straighforward to check that this indeed defines a star-type.
\end{definition}

\begin{remark}[Star-type extension]\label{rem:star-type-ext}
Let $\stps$ be a star-type, with $\xx$-type $\tpIp = \xtp\stps$.
Let $\tpTt \in \TpiT$ be a $2$-type and suppose that $\xtp\tpTt = \tpIp$ and
that $\ytp\tpTt$ is not a king type.
Then $\stps \cup \set{\tpTt}$ is also a star-type.
\end{remark}

\begin{definition}
A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is a
nonempty set of star-types satisfying the following conditions:
\begin{enumerate}
  \item\label{cond:cert-1} If $\tpIp \in \TpiP$ then some (possibly many) $\stps
  \in \Cert$ has $\xtp\stps = \tpIp$, that is every $1$-type is witnessed.
  \item\label{cond:cert-2} If $\tpIk \in \TpiP$ is a king type, then one $\stps
  \in \Cert$ has $\xtp\stps = \tpIk$, that is every king type is witnessed once.
  \item\label{cond:cert-3} If $\tpTt \in \cup\Cert$, then $\inv\tpTt \in
  \cup\Cert$, that is there are witnesses for the endpoints of every $2$-type used in the certificate.
\end{enumerate}
\end{definition}
Note that in general the size of a certificate may be exponential in terms of
the size of the type instance. However, polynomial certificates exist:
\begin{lemma}[Certificate extraction]\label{lem:cert-extract}
Let $\StrA$ be a full model for the type instance $\Tpi\TpiP\TpiT$. Recall that
by definition the cardinality of $\StrA$ is at least $2$.
Let $\TpiTp \subseteq \TpiT$ be the set of $2$-types realized in $\StrA$.
For every $2$-type $\tpTt \in \TpiTp$ realized in $\StrA$, let $(\ea_\tpTt,
\eb_\tpTt) \in \domA\cprod\domA$ be a pair of distinct elements realizing
$\tpTt$.
Let 
\[
  \Cert = \setbd{\stpIa\StrA{\ea_\tpTt}, \stpIa\StrA{\eb_\tpTt}}{\tpTt \in
  \TpiTp}.
\]
Then $\Cert$ is a certificate for the type instance. Moreover, its size is
linearly bounded by $\card{\TpiT}$, hence also by the size of the type instance.
\end{lemma}
\begin{proof}
We check the conditions for a certificate:
\begin{enumerate}
  \item Let $\tpIp \in \TpiP$ be a $1$-type. Since $\StrA$ is a full
  model for $\Tpi\TpiP\TpiT$ and $\domA$ has cardinality at least $2$, we may
  choose a pair of distinct elements such that the first element realizes
  $\tpIp$.
  \item If $\tpIk \in \TpiP$ is a king type, by~\Cref{rem:twovar-king-once} it
  is realized once in $\StrA$.
  Let $\ec \in \domA$ be the unique element realizing $\tpIk$.
  If $\stps \in \Cert$ has $\xtp\stps = \tpIk$, then $\stps = \stpIa\StrA\ec$
  so such $\stps$ is unique.
  \item That $\tpTt \in \cup\Cert$ implies $\inv\tpTt \in \cup\Cert$ follows
  immediately from the definition of $\Cert$.
\end{enumerate}
\end{proof}

\begin{lemma}[Certificate expansion]\label{lem:cert-expand}
Let $\Cert$ be a certificate for the connected type instance $\Tpi\TpiP\TpiT$.
Then $\Tpi\TpiP\TpiT$ has a finite full model.
\end{lemma}
\begin{proof}
We adapt the standard strategy used in the proof of the finite model property
for the logic $\vFo2$, as presented in~\cite{gradel1999logics}\footnote{with
the slight modification that our approach doesn't need \emph{a king court},
since the information about it is implicit in the certificate}.
Let $t = \card{\TpiT}$.
We build a model $\StrA$ for $\Tpi\TpiP\TpiT$ as follows.
The domain $\domA$ of $\StrA$ is the union of the disjoint sets of elements
$\domA^\stps$ for all $\stps \in \Cert$, that have intended star-type $\stps$
as follows.
If $\xtp\stps$ is a king type, $\domA^\stps = \set{\ea^\stps}$ is a
singleton. Call the element $\ea^\stps$ a \emph{king}.
Otherwise, if $\xtp\stps$ is not a king type, $\domA^\stps = \domA^\stps_0
\cup \domA^\stps_1 \cup \domA^\stps_2$ consists of three disjoint copies of $t$
elements:  $A^\stps_i = \set{\ea^\stps_{i1}, \ea^\stps_{i2}, \dots,
\ea^\stps_{it}}$, where $i \in \set{0,1,2}$. Call these elements
\emph{peasants}.
Let $\stps : \domA \to \Cert$ denote the intended star-type of the elements:
$\stps(\ea) = \stps$ for all $\ea \in \domA^\stps$.
Let $\tpIp : \domA \to \TpiP$ denote the intended $1$-type of the elements:
$\tpIp(\ea) = \xtp(\stps(\ea))$.
We proceed to consistently assign $2$-types to pairs of distinct elements from
the structure on stages.
\begin{description}
  \item[Realization of kings] We first find witnesses for the intended
  star-types of the kings.
  Let $\stps \in \Cert$ be such that $\tpIk = \xtp\stps$ is a king type.
  Consider the unique element $\ea = \ea^\stps$ having intended star-type
  $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\eb_\tpTt$ for the
  assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$.
  \begin{enumerate}
  \item If $\ytp\tpTt = \tpIkp$ is a king type, by Condition~\ref{cond:star-2}
  for star-types we have $\tpIkp \neq \tpIk$, so there is a unique star-type
  $\stps'$ having $\xtp\stps' = \tpIk'$ and a unique king $\eb_\tpTt =
  \ea^{\stps'} \neq \ea$ having intended star-type $\tpIkp$. Note that this
  assigment is symmetric, that is at the point of considering the type
  $\inv\tpTt$ for the king $\eb_\tpTt$, we would choose $\ea$ as the
  opposite side of the assignment.
  \item If $\ytp\tpTt = \tpIpp$ is not a king type (hence
  $\tpIpp \neq \tpIk$), we simultaneously find distinct elements $\eb_{\tpTt'}$ for all $\tpTtp \in
  \stps$ having $\ytp\tpTtp = \tpIpp$.
  Let $\TpiTp = \setbd{\tpTtp \in \stps}{\ytp\tpTtp = \tpIpp}$ be the set of
  all such $\tpTtp$.
  Since $\TpiTp \subseteq \TpiT$, there are
  at most $t$ such $2$-types $\tpTtp$. By Condition~\ref{cond:cert-3} for
  certificate, we can find a star-type $\stps_{\tpTtp} \in \Cert$ containing
  $\inv{(\tpTtp)}$ for every $\tpTtp \in \TpiTp$. Since $\xtp\stps_{\tpTtp} =
  \tpIpp$ is not a king type, there are enough elements 
  $\eb_{\tpTtp} \in \domA_0^{\stps_{\tpTtp}}$ having intended star-type
  $\stps_{\tpTtp}$.
  We assign $\tpIab\StrA\ea{\eb_\tpTtp} = \tpTtp$.
  \end{enumerate}
  \item[Realization of peasants] We now find witnesses for the remaining
  elements that realize $1$-types which are not king types. Let $\stps \in \Cert$ be such that $\tpIp =
  \xtp\stps$ is not a king type. Let $a = a_{ij}^\stps$ be an arbitrary element
  with intended star-type $\stps$. For every $\tpTt \in \stps$ we will find an
  element $\eb_\tpTt$ for the assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$.
  \begin{enumerate}
    \item If $\ytp\tpTt = \tpIkp$ is a king type then let $\ec$ be the element
    realizing it: $\tpIp(\ec) = \tpIkp$.
    We consider two cases.
    First suppose that $\tpIab\StrA\ec\ea = \tpTtp$ has already been assigned
    during the realization of kings.
    By construction we must have that $\inv{(\tpTtp)} \in \stps(\ea) = \stps$.
    Since $\ytp\inv{(\tpTtp)} = \tpIkp$ is a king type,
    by Condition~\ref{cond:cert-2}
    for certificate, the king type $\tpIkp$ is witnessed once in the star-type
    $\stps$. Hence $\tpTt = \inv{(\tpTt')}$, and so $\tpTt$ is already witnessed
    by $\eb_\tpTt = \ec$.
    
    Next suppose that $\tpIab\StrA\ec\ea$ has not been assigned during the
    realization of kings. Then just assign $\tpIab\StrA\ea\ec = \tpTt$.
    Note that this may extend the actual star-type of the king $\ec$ beyond its
    intended star-type $\stps(\ec)$ by adding the type $\inv\tpTt$, but
    by~\Cref{rem:star-type-ext}, this extension is still a star-type. That is,
    in the end, the structure may realize \emph{more} than the intended
    star-types, but, importantly, \emph{not less}.
    \item If $\ytp\tpTt = \tpIpp$ is not a king type, we simultaneously find
    distinct peasants $\eb_{\tpTtp}$ for all $\tpTtp \in \stps$ having
    $\ytp\tpTtp = \tpIpp$.
    Let $\tpTtp = \setbd{\tpTtp \in \stps}{\ytp\tpTtp = \tpIpp}$ be the set of
    all such $\tpTtp$.
    By Condition~\ref{cond:cert-3} for certificate, we can find a star-type
    $\stps_\tpTtp \in \Cert$ containing $\inv{(\tpTtp)}$ for every $\tpTtp \in
    \TpiTp$. The key to consistency is to use elements from the \emph{next copy}
    of peasants: let $i' = (i+1 \bmod 3) \in \set{0,1,2}$. Since
    $\xtp{\stps_{\tpTtp}} = \tpIpp$ is not a king type, there are enough
    peasants ${\eb_\tpTtp} \in \domA_{i'}^{\stps_{\tpTtp}}$ having intended
    star-type $\stps_{\tpTtp}$. We assign $\tpIab\StrA\ea{\eb_\tpTtp} = \tpTtp$.
    None of these assignments clash with each other.
  \end{enumerate}
  \item[Completion] For any pair of distinct elements $\ea, \eb \in \domA$ that
  has not yet been assigned a $2$-type, assign $\tpIab\StrA\ea\eb = \tpTt$ to
  arbitrary $2$-type $\tpTt$ that connects the $1$-types $\tpIp(\ea)$ and
  $\tpIp(\eb)$. This is possible because the type instance $\Tpi\TpiP\TpiT$ is
  connected.
\end{description}
\end{proof}

\begin{proposition}
The logic $\vFo2$ has the finite model property. The (finite) full type
realizibility problem for $\vFo2$ is in $\cNP$.
\end{proposition}
\begin{proof}
Let $\Tpi\TpiP\TpiT$ be a type instance. If it is not connected, then it has no
model by~\Cref{rem:twovar-king-once}. It is trivial to check satisfiability in
the class of structures of cardinality $1$. If this fails to yield a model,
guess a certificate of polynomial size (and verify in polynomial time that this
is indeed a certificate).
By~\Cref{lem:cert-extract} and~\Cref{lem:cert-expand} such a certificate exists
iff $\Tpi\TpiP\TpiT$ is fully satisfiable.
\end{proof}
Combining this with the reductions given in~\Cref{rem:red-real-to-full-real}
and~\Cref{rem:red-sat-to-real} gives us another proof of a standard result:
\begin{corollary}
The logic $\vFo2$ has the finite model property and its (finite) satisfiability
problem is in $\cNExpTime$.
\end{corollary}