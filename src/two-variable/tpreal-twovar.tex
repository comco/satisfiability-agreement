% Type realizibility of the two-variable first-order logic
Recall from~\Cref{sec:scott-nf} about normal forms that every $\vFo2$-sentence
$\fphi$ can be reduced in polynomial time to a sentence $\sctr\fphi$ in Scott
normal form:
\[
  \forall\xx\forall\yy (\falpp0(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy(
  \falpp\ii(\xx,\yy) \land \xx \neq \yy),
\]
where the formulas $\falpp\ii$ are quantifier-free and use at most linearly many
new unary predicate symbols. We refer to $\falpp0$ as the \emph{universal part},
or the $\forall\forall$-part of the formula $\sctr\fphi$ and to $\falpp\ii$ as
the \emph{existential parts}, or the $\forall\exists$-parts of the formula,
for $\ii \in [1,\nm]$.
For any formula in Scott normal form, we may replace its existential parts
by fresh binary predicate symbols: for $\ii \in [1,\nm]$, let $\smm\ii$ be a
fresh binary predicate symbol with the intended interpretation
$\forall\xx\forall\yy (\smm\ii(\xx,\yy) \lequ \falpp\ii(\xx,\yy))$.
Since this is a universal sentence, it can be incorporated into the
$\forall\forall$-part $\falpp0$ of the formula.
We refer to the symbols $\gls{message-symbol-m-i}$ as the \emph{message
symbols}.
Hence the formula can be transformed in polynomial time to the form:
\begin{equation}\label{eq:twovar-msg-nf}
  \forall\xx\forall\yy (\falp(\xx,\yy) \lor \xx = \yy) \land
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy
  (\smm\ii(\xx,\yy) \land \xx \neq \yy),
\end{equation}
where the $\forall\forall$-part $\falp$ is quantifier-free and over an extended
signature. For convenience, we make the existential parts of the formula part of
the signature, so we can focus only on the universal part. The following is a
term similar to the one defined in~\cite{MALQ:MALQ201400102}:
\begin{definition}
A \emph{classified signature} $\gls{classified-signature-S-m}$ for the
two-variable first-order logic $\vFo2$ is a predicate signature $\SigS$ together
with a sequence $\sms = \smm1\smm2\dots\smm\nm$ of distinct binary predicate
symbols from $\SigS$ having intended interpretation
\begin{equation}\label{eq:twovar-ms-iinter}
  \bigwedge_{1 \leq \ii \leq \nm} \forall\xx\exists\yy 
  (\smm\ii(\xx,\yy) \land \xx \neq \yy).
\end{equation}
\end{definition}
That is, a classified signature \emph{automatically includes} the
$\forall\exists$-parts of formulas and $\ClSig\SigS\sms$-structures
\emph{automatically satisfy} the $\forall\exists$-parts. We also require that
all $\ClSig\SigS\sms$-structures contain at least two elements (that can be
enforced by adding the formula $\forall\xx\exists\yy(\xx\neq\yy)$ to the
intended interpretation of $\SigS$ and it doesn't make the problem simpler,
since satisfiability in the class of structures of cardianlity $1$ is trivial).

\begin{definition}\label{def:clsig-twovar}
The \emph{(finite) classified satisfiability problem for two-variable
first-order logic} is:
given a classified signature $\ClSig\SigS\sms$ and a quantifier-free
$\vFoF2\SigS$-formula $\falp(\xx,\yy)$, is there a (finite)
$\ClSig\SigS\sms$-structure satisfying~\cref{eq:twovar-msg-nf}.
Note that by virtue of the structure being a $\ClSig\SigS\sms$-structure, it
will also satisfy~\cref{eq:twovar-ms-iinter} and have cardinality at least $2$.
Denote tha classified satisfiability problem for two-variable first-order logic
by $\ClSat{\vFo2}$ and its finite version by $\FinClSat{\vFo2}$.
\end{definition}

Scott normal form shows that (finite) satisfiability reduces in polynomial time
to (finite) classified satisfiability, since satisfiability in structures of
cardinality $1$ is trivial:
\[
  \FinASat{\vFo2} \red\cP \FinAClSat{\vFo2}.
\]

\begin{definition}\label{def:tpinst-twovar}
A \emph{type instance} $\Tpi\TpiP\TpiT$ over the classified
signature $\ClSig\SigS\sms$ is a pair of a nonempty set of $1$-types
$\TpiP\subseteq\TpI\SigS$ and a nonempty set of $2$-types
$\TpiT\subseteq\TpT\SigS$ such that:
\begin{itemize}
  \item The set of $2$-types $\TpiT$ is closed under inversion, that is
  $\inv\tpTt\in\TpiT$ for every $\tpTt\in\TpiT$.
  \item Every $2$-type $\tpTt\in\TpiT$ connects $1$-types from $\TpiP$,
  that is $\xtp\tpTt\in\TpiP$ and $\ytp\tpTt\in\TpiP$ for every $\tpTt\in\TpiT$.
  Equivalently, since $\TpiT$ is closed under inversion, we require that
  $(\xtp\restriction\TpiT)\subseteq\TpiP$.
\end{itemize}

A $\ClSig\SigS\sms$-structure $\StrA$ \emph{realizes} (or is a model of) the
type instance $\Tpi\TpiP\TpiT$, if all $1$-types and $2$-types realized in
$\StrA$ come from the type instance and also every $1$-type from the type
instance is realized, that is if:
\begin{itemize}
  \item $\tpIa\StrA\ea \in \TpiP$ for all $\ea\in\domA$,
  \item $\tpIab\StrA\ea\eb \in \TpiT$ for all $\ea\in\domA$ and
  $\eb \in \domA\sub\set{\ea}$, and
  \item for every $1$-type $\tpIp \in \TpiP$ there is an element $\ea \in \domA$
realizing $\tpIp$ (we don't require an analogous condition for the $2$-types).
\end{itemize}

The \emph{type instance} of $\StrA$ is the type instance $\Tpi\TpiP\TpiT$
defined by:
\begin{align*}
  \TpiP &= \setbd{\tpIa\StrA\ea}{\ea \in \domA} \\
  \TpiT &= \setbd{\tpIab\StrA\ea\eb}{\ea\neq\eb \in \domA}.
\end{align*}
Clearly, $\Tpi\TpiP\TpiT$ is indeed a type instance and $\StrA$ realizes
$\Tpi\TpiP\TpiT$.

The \emph{(finite) type realizibility problem\footnote{The reason we study the
type realizibility problem instead of directly studying the satisfiability problem is that it is flexible enough to allow us to employ its
solutions in simpler cases to construct solutions in more complicated cases.}
for $\vFo2$} is the following:
given a classified signature $\ClSig\SigS\sms$ and a type instance
$\Tpi\TpiP\TpiT$ over $\ClSig\SigS\sms$, is there a (finite)
$\ClSig\SigS\sms$-structure that realizes $\Tpi\TpiP\TpiT$.
Denote the type realizibility problem for $\vFo2$ by
$\Real{\vFo2}$ and its finite version by $\FinReal{\vFo2}$.
\end{definition}

\begin{remark}\label{rem:red-sat-to-real}
Let $\alpha(\xx,\yy)$ be a quantifier-free $\vFoF2\SigS$-formula.
Let $\Tpi\TpiP\TpiT$ be a type instance, where $\TpiP$ is the set of those
$1$-types consistent with $\alpha(\xx,\yy)$ and the intended
interpretation~\cref{eq:twovar-ms-iinter} and where $\TpiT$ is the set of
those $2$-types $\tpTt$ over $\ClSig\SigS\sms$ such that both $\tpTt$ and 
$\inv\tpTt$ are consistent with $\alpha$ and the intended interpretation~\cref{eq:twovar-ms-iinter}. Then a $\ClSig\SigS\sms$-structure
$\StrA$ is a model for $\alpha$ iff there are some $\TpiPp \subseteq \TpiP$ and
$\TpiTp \subseteq \TpiT$ such that $\Tpi\TpiPp\TpiTp$ is a type instance and
$\StrA$ is a model for $\Tpi\TpiPp\TpiTp$.

Recall that the number of possible $1$-types or $2$-types over $\SigS$ is
exponentially bounded by the length $\sizes$ of $\SigS$ and that the cardinality
of a $1$-type or a $2$-type over $\SigS$ is polynomially bounded by $\sizes$.
Hence we can reduce the (finite) classified satisfiability problem to the
(finite) type realizibility problem in nondeterministic exponential time:
\[
  \FinAClSat{\vFo2} \red\cNExpTime \FinAReal{\vFo2}.
\]
\end{remark}

\begin{definition}\label{def:connectable}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$.
Two $1$-types $\tpIp, \tpIpp \in \TpiP$ are \emph{connectable} 
(written $\gls{connectable-p-pp}$), 
if $\tpIp = \xtp\tpTt$ and $\tpIpp = \ytp\tpTt$ for some $\tpTt \in \TpiT$.
Connectability is symmetric since $\TpiT$ is closed under inversion.
However, connectability is not necessarily neither transitive nor reflexive:

A $1$-type $\tpIk \in \TpiP$ is a \emph{king type} if $\tpIk \not\conn \tpIk$.
A $1$-type $\tpIp \in \TpiP$ that is not a king type is a \emph{peasant type}.
The set of king types for the type instance $\Tpi\TpiP\TpiT$ is
$\TKg = \TKgi\TpiP\TpiT$ and the set of peasant types is
$\TPs = \TPsi\TpiP\TpiT = \TpiP \sub \TKg(\TpiP,\TpiT)$.
\end{definition}
\begin{remark}\label{rem:twovar-king-once}
If $\StrA$ is a model for $\Tpi\TpiP\TpiT$ then any two distinct
elements $\ea \neq \eb \in \domA$ realize connectable $1$-types. Hence every king type
$\tpIk \in \TKgi\TpiP\TpiT$ must be realized once in $\StrA$.
\end{remark}

The next definition characterizes the local structure of the ray of $2$-types
realized around an element in a model of a type instance.
\begin{definition}
A \emph{star-type} $\stps \subseteq \TpiT$ over the type instance
$\Tpi\TpiP\TpiT$ is a nonempty set of $2$-types satisfying the following conditions:
\begin{itemize}
  \item[\stpcond1]\label{cond:stp-1} If $\tpTt, \tpTtp \in \stps$, then
  $\xtp\tpTt = \xtp\tpTtp$, that is the $\xx$-type of every element of $\stps$ is the same.
  Denote the $\xx$-type of every element of $\stps$ by $\xtp\stps$.
  \item[\stpcond2]\label{cond:stp-2} If $\tpIk = \xtp\stps \in \TKg$ is a
  king type, then no $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item[\stpcond3]\label{cond:stp-3} If $\tpIk \in \TKg \sub \set{\xtp\stps}$
  is any king type distinct from $\xtp\stps$ (note that here $\xtp\stps$ may as well be a
  peasant type), then only one $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$.
  \item[\stpcond4]\label{cond:stp-4} If $\sm \in \sms$, then $\sm(\xx,\yy)
  \in \tpTt$ for some (possibly many) $\tpTt \in \stps$.
\end{itemize}
If $\stps$ is a star-type such that $\xtp\stps$ is a king type, then $\stps$ is
a \emph{king star-type}. Otherwise $\stps$ is a \emph{peasant star-type}.

Note that the size of a star-type is polynomially bounded by the size of the
type instance.

If $\StrA$ is a model for $\Tpi\TpiP\TpiT$ and $\ea \in \domA$, the
\emph{star-type realized by $\ea$} is:
\[
  \stpIa\StrA\ea = \setbd{\tpIab\StrA\ea\eb}{\eb \in \domA \sub \set{\ea}}.
\]
\end{definition}
We verify that the star-type realized by $\ea$ is indeed a star-type:
\begin{remark}
Let $\Tpi\TpiP\TpiT$ be a type instance over $\ClSig\SigS\sms$, let $\StrA$ be
a model for $\Tpi\TpiP\TpiT$ and let $\ea \in \domA$ be any element of the
model.
Then the star-type $\stps = \stpIa\StrA\ea$ realized by $\ea$ is a star-type
over the type instance
$(\TpiP,\TpiT)$.
\end{remark}
\begin{proof}
The star-type $\stps$ is nonempty, since $\StrA$ --- a
$\ClSig\SigS\sms$-structure --- contains at least $2$ elements. We verify the
conditions for a star-type:
\begin{itemize}
  \item[\refstpcond1] If $\tpTt, \tpTtp \in \stps$, then $\tpTt =
  \tpIab\StrA\ea\eb$ and $\tpTtp = \tpIab\StrA\ea\ec$ for some $\eb,\ec\neq\ea\in\domA$, hence
  $\xtp\tpTt = \tpIa\StrA\ea = \xtp\tpTtp$.
  \item[\refstpcond2] If $\tpIk = \xtp\stps\in\TKg$ is a king type, then by
  definition we have that no $2$-type $\tpTt\in\TpiT$ has $\xtp\tpTt = \tpIk$ and $\ytp\tpTt =
  \tpIk$, and so no $\tpTt\in\stps$ has $\ytp\tpTt = \tpIk$ since
  $\stps\subseteq\TpiT$ since $\StrA$ realizes $\Tpi\TpiP\TpiT$.
  \item[\refstpcond3] Let $\tpIk\in\TKg\sub\set{\xtp\stps}$ be any king type.
  By~\Cref{rem:twovar-king-once}, there is a unique element $\ec \neq \ea \in
  \domA$ realizing $\tpIk$. Then the $2$-type $\tpTt = \tpIab\StrA\ea\ec$ is the
  unique satisfying $\tpTt\in\stps$ and $\ytp\tpTt = \tpIk$.
  \item[\refstpcond4] Since $\StrA$ is a $\ClSig\SigS\sms$-structure, it
  automatically satisfies the $\forall\exists$-parts of~\cref{eq:twovar-ms-iinter}, hence for 
  every $\sm \in \sms$ there must be some $\eb \in \domA \sub \set{\ea}$ such
  that $\sm(\xx,\yy) \in \tpIab\StrA\ea\eb$.
\end{itemize}
\end{proof}

\begin{remark}[Star-type extension]\label{rem:star-type-ext}
Let $\stps$ be a star-type over $\Tpi\TpiP\TpiT$ and let $\tpIp = \xtp\stps$.
Let $\tpTt \in \TpiT$ be a $2$-type such that $\xtp\tpTt = \tpIp$ and
$\ytp\tpTt$ is not a king type.
Then $\stpsp = \stps \cup \set{\tpTt}$ is also a star-type over
$\Tpi\TpiP\TpiT$.
\end{remark}
\begin{proof}
It is straightforward to verify the conditions for a star-type:~\refstpcond1
follows from the assumption that $\xtp\tpIp = \xtp\stps$.
Conditions~\refstpcond2 and~\refstpcond3 follow from the assumption that
$\ytp\tpIp$ is not a king type.
Condition~\refstpcond4 follows from the assumption that $\stpsp$ extends the
star-type $\stps$.
\end{proof}

\begin{definition}
A \emph{certificate} $\Cert$ for the type instance $\Tpi\TpiP\TpiT$ is a
nonempty set of star-types for $\Tpi\TpiP\TpiT$ satisfying the following
conditions:
\begin{itemize}
  \item[\certcond1]\label{cond:cert-1} If $\tpTt\in\stps$ for some
  $\stps\in\Cert$, then $\inv\tpTt\in\stps'$ for some $\stps'\in\Cert$, that is there are witnesses
  for the endpoints of every $2$-type used in the certificate.
  Equivalently, $\cup\Cert$ is closed under inversion.
  
  Let $\TpiTp = \cup\Cert$.
  Clearly, $\TpiTp\subseteq\TpiT$. We require that $\Tpi\TpiP\TpiTp$ is a type
  instance --- the \emph{filtered type instance} --- and that all star-types
  $\stps\in\Cert$ be star-types \emph{for the filtered type instance}.
  In this context we refer to the king types $\TKg = \TKgi\TpiP\TpiTp$ and the
  peasant types $\TPs = \TPsi\TpiP\TpiTp$ with respect to the filtered type
  instance. Note that since $\TpiTp \subseteq \TpiT$, a king type with respect
  to the original type instance must remain a king type with respect to the
  refined type instance. However, there might be king types with respect to the
  filtered type instance that were peasant types with respect of the original
  type instance. This might happen if we remove all $2$-types connecting a
  peasant type with itself when going from $\TpiT$ to $\TpiTp$.
  \item[\certcond2]\label{cond:cert-2} If $\tpIp \in \TpiP$ then some (possibly
  many) $\stps \in \Cert$ has $\xtp\stps = \tpIp$, that is every $1$-type is witnessed.
  \item[\certcond3]\label{cond:cert-3} If $\tpIk \in \TKgi\TpiP\TpiTp$ is a king
  type, then only one $\stps \in \Cert$ has $\xtp\stps = \tpIk$, that is every
  king type is witnessed once.
  Note that the existence is already implied by~\refcertcond2.
  \item[\certcond4]\label{cond:cert-4} If $\tpIp,\tpIpp \in \TpiP$ are (possibly
  the same) $1$-types that are not connectable, that is no $\tpTt\in\TpiTp$ has
  $\xtp\tpTt = \tpIp$ and $\ytp\tpTt = \tpIpp$, then $\tpIp = \tpIpp \in
  \TKg(\TpiP,\TpiTp)$, that is two $1$-types are not connectable iff they are
  the same king type.
\end{itemize}
\end{definition}
Note that in general the size of a certificate may be exponential in terms of
the size of the type instance. However, polynomial certificates exist:
\begin{lemma}[Certificate extraction]\label{lem:cert-extract}
Let $\StrA$ be a model for the type instance $\Tpi\TpiP\TpiT$.
Let $\TpiTp \subseteq \TpiT$ be the (nonempty) set of $2$-types realized in
$\StrA$, so $\Tpi\TpiP\TpiTp$ is the type instance of $\StrA$.
Note that $\TpiTp$ is closed under inversion.
For every $2$-type $\tpTt \in \TpiTp$,
let $\eat\tpTt \neq \ebt\tpTt \in \domA$ be two distinct elements realizing
$\tpTt$: $\tpIab\StrA{\eat\tpTt}{\ebt\tpTt} = \tpTt$. The choice of the
elements is made symmetrically, that is $\eat{\inv\tpTt} = \ebt\tpTt$ and
$\ebt{\inv\tpTt} = \eat\tpTt$ for every $\tpTt\in\TpiTp$.
Let 
\[
  \Cert = \setbd{\stpIa\StrA{\eat\tpTt}}{\tpTt\in\TpiTp}.
\]
Then $\Cert$ is a certificate for $\Tpi\TpiP\TpiT$. Moreover, its size is
linearly bounded by $\card{\TpiTp}$, hence also by the size of $\Tpi\TpiP\TpiT$.
\end{lemma}
\begin{proof}
We check the conditions for a certificate:
\begin{itemize}
  \item[\refcertcond1] That $\Tpi\TpiP\TpiTp$ is a type instance follows from
  the observations that $\cup\Cert = \TpiTp$, $\TpiTp \subseteq \TpiT$ and that all $\xx$-types
  and $\yy$-types of $2$-types from $\TpiTp$ are contained in $\TpiP$. Note that
  $\StrA$ is a model for the type instance $\Tpi\TpiP\TpiTp$, hence every
  star-type $\stpIa\StrA\ea$ is a star-type for the type instance
  $\Tpi\TpiP\TpiTp$.
  \item[\refcertcond2] That every $1$-type is witnessed follows from the
  observation that $\StrA$ is a model for $\Tpi\TpiP\TpiTp$.
  \item[\refcertcond3] If $\tpIk \in \TKgi\TpiP\TpiTp$ is a king type,
  by~\Cref{rem:twovar-king-once} it is realized once in $\StrA$.
  Let $\ec \in \domA$ be the unique element realizing $\tpIk$.
  If $\stps \in \Cert$ has $\xtp\stps = \tpIk$, then $\stps = \stpIa\StrA\ec$,
  so such $\stps$ is unique. More precisely, for every $\tpTt\in\TpiTp$ such
  that $\xtp\tpTt = \tpIk$, we must have that $\eat\tpTt = \ec$.
  \item[\refcertcond4] Let $\tpIp, \tpIpp \in \TpiP$ be two $1$-types and
  suppose that no $\tpTt\in\TpiTp$ connects them. Let $\ea\in\domA$ be an element realizing
  $\tpIp$ and $\eb$ be an element realizing $\tpIpp$. If $\ea \neq \eb$, then
  $\tpTt = \tpIab\StrA\ea\eb \in \stpIa\StrA{\ea_\tpTt} \subseteq \TpiTp$ will
  connect $\tpIp$ and $\tpIpp$, which is impossible. Hence we must have that
  $\ea = \eb$, so $\tpIp = \tpIpp \in \TKgi\TpiP\TpiTp$.
\end{itemize}
\end{proof}

\begin{lemma}[Certificate expansion]\label{lem:cert-expand}
Let $\Cert$ be a certificate for the type instance $\Tpi\TpiP\TpiT$ over the
classified signature $\ClSig\SigS\sms$.
Then $\Tpi\TpiP\TpiT$ has a finite model.

More precisely, let $\TpiTp = \cup\Cert \subseteq \TpiT$
and let $\pt \geq \card\TpiTp$ be a parameter.
Then the filtered type instance $\Tpi\TpiP\TpiTp$ has a finite model $\StrA$ in
which every king star-type $\stps\in\Cert$, $\xtp\stps \in \TKgi\TpiP\TpiTp$ is realized only once and every peasant star-type
$\stps\in\Cert$, $\xtp\stps \in \TPsi\TpiP\TpiTp$ is realized at least $\pt$
times.
\end{lemma}
\begin{proof}
We adapt the standard strategy\footnote{with the slight difference that our
approach doesn't need \emph{a court}, since the information about it is implicit
in the certificate} used in the proof of the finite model property for the logic
$\vFo2$, as presented in~\cite{gradel1999logics}.
We build a model $\StrA$ for $\Tpi\TpiP\TpiTp$ as follows.
The domain $\domA$ of $\StrA$ is the union of the following disjoint sets of
elements:
\begin{itemize}
  \item The singleton set $\As\stps = \set{\as\stps}$ for every king
  star-type $\stps\in\Cert$, $\xtp\stps \in \TKgi\TpiP\TpiTp$.
  Call the elements $\as\stps$ the kings.
  \item The three disjoint copies of $\pt$ elements
  $\As\stps = \Asi\stps0 \cup \Asi\stps1 \cup \Asi\stps2$ for every
  peasant star-type $\stps \in \Cert$, $\xtp\stps \in \TPsi\TpiP\TpiTp$, where
  $\Asi\stps\ii = \set{\asij\stps\ii1, \asij\stps\ii2, \dots, \asij\stps\ii\pt}$
  for $\ii \in \set{0,1,2}$.
  Call the elements $\asij\stps\ii\jj$ the peasants.
\end{itemize}
Let $\itpsOP : \domA \to \Cert$ denote the intended star-type of the elements:
$\itps\ea = \stps$ on $\As\stps$.
Let $\itpiOP : \domA \to \TpiP$ denote the intended $1$-type of the elements:
$\itpi\ea = \xtp(\stps(\ea))$.
We proceed to consistently assign $2$-types to pairs of distinct elements from
the structure on stages.
\begin{description}
  \item[Realization of kings] We first find witnesses for the intended
  star-types of the kings.
  Let $\stps \in \Cert$, $\tpIk = \xtp\stps \in \TKgi\TpiP\TpiTp$
  be a king star-type.
  Consider the unique element $\ea = \ea^\stps$ having intended star-type
  $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\ebt\tpTt$ for the
  assignment $\tpIab\StrA\ea{\ebb\tpTt} = \tpTt$, such that all elements
  $\ebb\tpTt$ are distinct and are distinct from $\ea$ and also $\ytp\tpTt =
  \itpi{\ebt\tpTt}$.
  \begin{enumerate}
  \item If $\ytp\tpTt = \tpIkp \in \TKgi\TpiP\TpiTp$ is a king type,
  by~\refstpcond2 we have $\tpIkp \neq \tpIk$. By~\refcertcond3
  there is a unique star-type $\stpsp$ having $\xtp\stpsp = \tpIkp$ and a unique
  king $\ebt\tpTt = \eat\stpsp \neq \ea$ having intended star-type $\stpsp$.
  Note that this assigment is symmetric, that is at the point of considering the
  type $\inv\tpTt \in \stpsp$ for the king $\ebt\tpTt$, we would choose $\ea$ as
  the opposite side of the assignment: we claim that $\inv\tpTt \in
  \stpsp$ and it is the unique $2$-type from $\stpsp$ having $\ytp{\inv\tpTt}
  = \tpIk$.
  Indeed, $\inv\tpTt \in \TpiTp$, since $\TpiTp$ is closed under inversion;
  By \refstpcond3 we have that there is a unique $\tpTtp \in \stpsp$ connecting
  $\tpIkp$ and $\tpIk$. Since $\stpsp$ is the unique star-type in $\Cert$
  having $\xtp\stpsp = \tpIkp$, we have that $\tpTtp$ is the unique $2$-type
  from $\TpiTp$ connecting $\tpIkp$ and $\tpIk$. Hence we must have $\tpTtp =
  \inv\tpTt$.
  Note that by \refstpcond3 asserting that for the star-type $\stps$ there is a
  unique $2$-type $\tpTt \in \stps$ that connects it to a king type (distinct
  from the origin), we have assigned a $2$-types between every pair of distinct
  kings.
  
  \item If $\ytp\tpTt = \tpIpp \in \TPsi\TpiP\TpiTp$ is a peasant type (hence
  $\tpIpp \neq \tpIk$), we simultaneously find distinct elements $\ebt\tpTu$
  for all $2$-types $\tpTu \in \stps$ that are parallel to $\tpTt$.
  Let
  \[
    \TpiU = \setbd{\tpTu \in \stps}{(\tpTu \para \tpTt)} = 
    \setbd{\tpTu\in \stps}{\ytp\tpTu = \tpIpp}
  \] be the set of all such $2$-types $\tpTu$.
  Since $\TpiU \subseteq \stps \subseteq \TpiTp$, there are
  at most $t$ $2$-types $\tpTu$ in $\TpiU$. Since $\TpiTp = \cup\Cert$ and
  $\TpiTp$ is closed under inversion, for every $\tpTu \in \TpiU$
  we can find a star-type $\stpspt\tpTu \in \Cert$ containing its inverse:
  $\inv\tpTu \in \stpspt\tpTu$.
  Since $\xtp\stpspt\tpTu = \xtp{\inv\tpTu} = \tpIpp$ is not a king type, there
  are enough distinct elements $\ebt\tpTu \in \Asi{\stpspt\tpTu}0$ having
  intended star-type $\stpspt\tpTu$. Note that these will be distinct from
  $\ea$, since $\ea$ is a king.
  We assign $\tpIab\StrA\ea{\ebt\tpTu} = \tpTu$ for all $\tpTu \in \TpiU$.
  \end{enumerate}
  \item[Realization of peasants] We now find witnesses for the intended
  star-types of the remaining peasant elements.
  Let $\stps \in \Cert$ be such that $\tpIp = \xtp\stps \in \TPsi\TpiP\TpiTp$ is
  a peasant type. Let $\ea = \asij\stps\ii\jj$, where $\ii \in \set{0,1,2}$ and
  $\jj \in [1,\pt]$ be an arbitrary peasant with intended star-type $\stps$.
  For every $\tpTt \in \stps$ we will find an element $\eb_\tpTt$ for the
  assignment $\tpIab\StrA\ea{\eb_\tpTt} = \tpTt$, and again we will ensure that
  all $\ebt\tpTt$ are distinct and distinct from $\ea$ and also that $\ytp\tpTt
  = \itpi{\ebt\tpTt}$.
  \begin{enumerate}
    \item If $\ytp\tpTt = \tpIkp$ is a king type then let $\ec$ be the
    element realizing it: $\tpIp(\ec) = \tpIkp$.
    We consider two cases.
    First suppose that $\tpIab\StrA\ec\ea = \tpTu$ has already been assigned
    during the realization of kings.
    By that construction we must have that $\ea = \ebt\tpTu$ and so
    $\stps = \itps\ea = \stpspt\tpTu$, so that $\inv\tpTu \in
    \itps\ea$. Note that $\ytp{\inv\tpTu} = \tpIkp$.
    We claim that $\inv\tpTu = \tpTt$. This is immediate by
    Condition~\refstpcond3, which asserts that there is a unique $2$-type
    $\tpTt \in \stps$ having $\ytp\tpTt = \tpIkp$ --- a king type.
    Hence in this case the needed $2$-types $\tpTt \in \stps$ have already been
    assigned in the opposite direction during the realization of kings.
    
    Next suppose that $\tpIab\StrA\ec\ea$ has not been assigned during the
    realization of kings. Then just assign $\tpIab\StrA\ea\ec = \tpTt$.
    Note that this may extend the actual star-type of the king $\ec$ beyond its
    intended star-type $\itps\ec$ by adding the type $\inv\tpTt$, but
    by~\Cref{rem:star-type-ext}, this extension is still a star-type. That is,
    in the end, the structure may realize \emph{more} than the intended
    star-types, but, importantly, \emph{not less}.
    \item If $\ytp\tpTt = \tpIpp$ is not a king type, we simultaneously find
    distinct peasants $\ebt\tpTu$ for all $\tpTu \in \stps$ that are parallel to
    $\tpTt$.
    Let $\TpiU = \setbd{\tpTu \in \stps}{\ytp\tpTu = \tpIpp}$ be the set of
    all such $2$-types $\tpTu$.
    The key to consistency is to use elements from the \emph{next copy} as
    witnesses. Let $\iip = (\ii+1 \bmod 3) \in \set{0,1,2}$. Since $\TpiU
    \subseteq \stps \subseteq \TpiTp$, there are at most $\pt$ $2$-types $\tpTu$ in $\TpiU$. Since $\TpiTp = \cup\Cert$ and $\TpiTp$ is
    closed under inversion, for every $\tpTu \in \TpiU$ we can find a star-type
    $\stpspt\tpTu \in \Cert$ containing its inverse: $\inv\tpTu \in
    \stpspt\tpTu$. Since $\xtp{\stpspt\tpTu} = \xtp{\inv\tpTu} = \tpIpp$ is not
    a king type, there are enough distinct elements $\ebt\tpTu \in
    \Asi{\stpspt\tpTu}\iip$ from the next copy of peasants having intended
    star-type $\stpspt\tpTu$. Since these elements are from the next copy, they
    are distinct from $\ea$.
    We assign $\tpIab\StrA\ea{\ebt\tpTu} = \tpTu$ for all $\tpTu \in \TpiU$.
    None of these assignments clash with each other, since they have been made
    between pairs of elements from consecutive copies.
  \end{enumerate}
  \item[Completion] For any pair of distinct elements $\ea, \eb \in \domA$ that
  has not yet been assigned a $2$-type, assign $\tpIab\StrA\ea\eb = \tpTt$ to
  arbitrary $2$-type $\tpTt$ that connects the $1$-types $\tpIp(\ea)$ and
  $\tpIp(\eb)$. This is possible because during realization of kings we have
  assigned a $2$-type between every pair of distinct kings and by~\refcertcond4.
\end{description}
This structure is a $\ClSig\SigS\sms$-structure by~\refstpcond4 and
is a model for $\Tpi\TpiP\TpiT$ by~\refcertcond2.
\end{proof}

\begin{proposition}
The logic $\vFo2$ has the finite model property. The (finite) type realizibility
problem for $\vFo2$ is in $\cNP$.
\end{proposition}
\begin{proof}
Let $\Tpi\TpiP\TpiT$ be a type instance for the classified signature
$\ClSig\SigS\sms$. Guess a polynomial certificate for $\Tpi\TpiP\TpiT$.
By~\Cref{lem:cert-extract} and~\Cref{lem:cert-expand}, such a certificate exists
iff $\Tpi\TpiP\TpiT$ is realizable.
The logic has the finite model property since the model constructed
in~\Cref{lem:cert-expand} is finite.
\end{proof}
Recall \Cref{rem:red-sat-to-real}, stating that a structure is a model for a
formula iff it is a model for the type instance consisting of the types
consistent with the formula, so as a corollary we get the standard result:
\begin{corollary}
The logic $\vFo2$ has the finite model property and its (finite) satisfiability
problem is in $\cNExpTime$.
\end{corollary}